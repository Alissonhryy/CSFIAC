<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#6366f1">
    <meta name="description" content="Sistema de gestão de cursos CSF + Qualificação e Renda">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>CSF + Qualificação e Renda</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Adicionando SheetJS para leitura de Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Adicionando Chart.js para gráfico pizza -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Adicionando html2canvas para captura de tela -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --background: #0f172a;
            --sidebar: #020617;
            --surface: #1e293b;
            --surface-hover: #334155;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: #334155;
            --overlay: rgba(0, 0, 0, 0.7);
            --card: #1e293b; /* Adicionado para consistência */
        }

        /* Modo Claro */
        :root.light-mode {
            --background: #f8fafc;
            --sidebar: #ffffff;
            --surface: #ffffff;
            --surface-hover: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --card: #ffffff;
            --overlay: rgba(0, 0, 0, 0.5);
        }
        
        /* Tema Verde */
        :root.theme-green {
            --primary: #10b981;
            --primary-hover: #059669;
        }
        
        :root.theme-green:not(.light-mode) {
            --background: #0f172a;
            --sidebar: #064e3b;
            --surface: #065f46;
            --surface-hover: #047857;
            --text-primary: #f8fafc;
            --text-secondary: #d1fae5;
            --text-muted: #a7f3d0;
            --border: #10b981;
            --overlay: rgba(15, 23, 42, 0.8);
            --card: #065f46;
        }
        
        :root.theme-green.light-mode {
            --background: #ecfdf5;
            --sidebar: #d1fae5;
            --surface: #a7f3d0;
            --surface-hover: #6ee7b7;
            --text-primary: #064e3b;
            --text-secondary: #065f46;
            --text-muted: #10b981;
            --border: #10b981;
            --overlay: rgba(16, 185, 129, 0.5);
            --card: #d1fae5;
        }
        
        /* Tema Roxo */
        :root.theme-purple {
            --primary: #8b5cf6;
            --primary-hover: #7c3aed;
        }
        
        :root.theme-purple:not(.light-mode) {
            --background: #0f172a;
            --sidebar: #581c87;
            --surface: #6b21a8;
            --surface-hover: #7c3aed;
            --text-primary: #f8fafc;
            --text-secondary: #e9d5ff;
            --text-muted: #ddd6fe;
            --border: #8b5cf6;
            --overlay: rgba(15, 23, 42, 0.8);
            --card: #6b21a8;
        }
        
        :root.theme-purple.light-mode {
            --background: #faf5ff;
            --sidebar: #f3e8ff;
            --surface: #e9d5ff;
            --surface-hover: #ddd6fe;
            --text-primary: #581c87;
            --text-secondary: #6b21a8;
            --text-muted: #8b5cf6;
            --border: #8b5cf6;
            --overlay: rgba(139, 92, 246, 0.5);
            --card: #f3e8ff;
        }

        /* Tema Azul */
        :root.theme-blue {
            --primary: #3b82f6;
            --primary-hover: #2563eb;
        }
        
        :root.theme-blue:not(.light-mode) {
            --background: #0f172a;
            --sidebar: #1e3a8a;
            --surface: #1e40af;
            --surface-hover: #2563eb;
            --text-primary: #f8fafc;
            --text-secondary: #dbeafe;
            --text-muted: #bfdbfe;
            --border: #3b82f6;
            --overlay: rgba(15, 23, 42, 0.8);
            --card: #1e40af;
        }
        
        :root.theme-blue.light-mode {
            --background: #eff6ff;
            --sidebar: #dbeafe;
            --surface: #bfdbfe;
            --surface-hover: #93c5fd;
            --text-primary: #1e3a8a;
            --text-secondary: #1e40af;
            --text-muted: #3b82f6;
            --border: #3b82f6;
            --overlay: rgba(59, 130, 246, 0.5);
            --card: #dbeafe;
        }

        /* Tema Laranja */
        :root.theme-orange {
            --primary: #f97316;
            --primary-hover: #ea580c;
        }
        
        :root.theme-orange:not(.light-mode) {
            --background: #0f172a;
            --sidebar: #7c2d12;
            --surface: #9a3412;
            --surface-hover: #c2410c;
            --text-primary: #f8fafc;
            --text-secondary: #fed7aa;
            --text-muted: #fdba74;
            --border: #f97316;
            --overlay: rgba(15, 23, 42, 0.8);
            --card: #9a3412;
        }
        
        :root.theme-orange.light-mode {
            --background: #fff7ed;
            --sidebar: #ffedd5;
            --surface: #fed7aa;
            --surface-hover: #fdba74;
            --text-primary: #7c2d12;
            --text-secondary: #9a3412;
            --text-muted: #f97316;
            --border: #f97316;
            --overlay: rgba(249, 115, 22, 0.5);
            --card: #ffedd5;
        }

        /* Tema Rosa */
        :root.theme-pink {
            --primary: #ec4899;
            --primary-hover: #db2777;
        }
        
        :root.theme-pink:not(.light-mode) {
            --background: #0f172a;
            --sidebar: #831843;
            --surface: #9f1239;
            --surface-hover: #be185d;
            --text-primary: #f8fafc;
            --text-secondary: #fce7f3;
            --text-muted: #fbcfe8;
            --border: #ec4899;
            --overlay: rgba(15, 23, 42, 0.8);
            --card: #9f1239;
        }
        
        :root.theme-pink.light-mode {
            --background: #fdf2f8;
            --sidebar: #fce7f3;
            --surface: #fbcfe8;
            --surface-hover: #f9a8d4;
            --text-primary: #831843;
            --text-secondary: #9f1239;
            --text-muted: #ec4899;
            --border: #ec4899;
            --overlay: rgba(236, 72, 153, 0.5);
            --card: #fce7f3;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--background);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Login Screen */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--background);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-overlay.hidden {
            display: none;
        }

        .login-card {
            background: var(--surface);
            padding: 2.5rem;
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .login-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 2rem;
            justify-content: center;
            flex-direction: column;
        }

        .login-logo .material-icons {
            font-size: 80px;
            color: var(--primary);
        }

        .login-logo h1 {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
        }

        .login-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 14px;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        /* Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--sidebar);
            border-right: 1px solid var(--border);
            position: fixed;
            height: 100vh;
            display: flex;
            flex-direction: column;
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-direction: column;
            justify-content: center;
        }

        .sidebar-logo .material-icons {
            font-size: 48px;
            color: var(--primary);
        }

        .sidebar-logo h1 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            text-align: center;
        }

        .sidebar-nav {
            flex: 1;
            padding: 1rem 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: var(--surface);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--surface);
            color: var(--primary);
            border-left-color: var(--primary);
        }

        .nav-item .material-icons {
            font-size: 22px;
        }

        .sidebar-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .user-details h4 {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .user-details span {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .logout-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            margin-left: auto;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: var(--surface);
            color: var(--danger);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 2rem;
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px;
        }

        /* Botão fixo para abrir sidebar no mobile */
        .mobile-sidebar-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 56px;
            height: 56px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            z-index: 999;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .mobile-sidebar-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }

        .mobile-sidebar-toggle:active {
            transform: scale(0.95);
        }

        @media (max-width: 768px) {
            .mobile-sidebar-toggle {
                display: flex;
            }
        }

        .search-box {
            flex: 1;
            max-width: 400px;
            position: relative;
        }

        .search-box .material-icons {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        .search-box input {
            width: 100%;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 12px 12px 44px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .search-box input::placeholder {
            color: var(--text-muted);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .header-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #7c3aed);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: var(--surface);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--surface-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-icon {
            padding: 10px;
            aspect-ratio: 1;
        }

        .btn .material-icons {
            transition: transform 0.3s ease;
        }

        .btn:hover .material-icons {
            transform: scale(1.2) rotate(10deg);
        }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        /* Transformando KPI cards em cards interativos com animações */
        .kpi-card {
            background: var(--surface);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .kpi-card:hover::before {
            opacity: 1;
        }

        .kpi-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border-color: var(--primary);
        }

        .kpi-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .kpi-icon {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.4s ease;
        }

        .kpi-card:hover .kpi-icon {
            transform: rotate(10deg) scale(1.1);
        }

        .kpi-icon::after {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 14px;
            padding: 2px;
            background: linear-gradient(135deg, currentColor, transparent);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .kpi-card:hover .kpi-icon::after {
            opacity: 0.6;
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .kpi-icon.purple { 
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(168, 85, 247, 0.3)); 
            color: #c4b5fd;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
        }
        .kpi-icon.green { 
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.3)); 
            color: #6ee7b7;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }
        .kpi-icon.blue { 
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.3)); 
            color: #93c5fd;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }
        .kpi-icon.orange { 
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.3)); 
            color: #fcd34d;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
        }

        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
            transition: all 0.4s ease;
            position: relative;
        }

        .kpi-card:hover .kpi-value {
            transform: scale(1.05);
            color: var(--primary);
        }

        .kpi-label {
            color: var(--text-muted);
            font-size: 0.875rem;
            margin-top: 0.5rem;
            transition: color 0.3s ease;
        }

        .kpi-card:hover .kpi-label {
            color: var(--text-secondary);
        }

        /* Course Cards */
        .courses-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 1.5rem;
        }

        /* Cards de cursos com animações mais interativas */
        .course-card {
            background: var(--surface);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .course-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .course-card:hover::before {
            left: 100%;
        }

        .course-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border-color: var(--primary);
        }

        .course-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .course-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            transition: color 0.3s ease;
        }

        .course-card:hover .course-title {
            color: var(--primary);
        }

        .course-id {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .course-actions {
            display: flex;
            gap: 4px;
        }

        .course-actions button {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
            position: relative;
        }

        .course-actions button::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 8px;
            background: currentColor;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .course-actions button:hover::before {
            opacity: 0.1;
        }

        .course-actions button:hover {
            transform: scale(1.2) rotate(5deg);
        }

        .course-actions button:hover {
            background: var(--surface-hover);
            color: var(--text-primary);
        }

        .course-actions button.delete:hover {
            color: var(--danger);
        }

        .course-actions button.drive:hover {
            color: var(--success);
        }

        .course-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .course-info-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .course-info-item .material-icons {
            font-size: 18px;
            color: var(--text-muted);
        }

        /* Estilo para anotação do curso no card */
        .course-note {
            background: rgba(99, 102, 241, 0.1);
            border-left: 3px solid var(--primary);
            padding: 8px 12px;
            margin-top: 10px;
            border-radius: 0 8px 8px 0;
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .course-note .material-icons {
            font-size: 16px;
            color: var(--primary);
            flex-shrink: 0;
            margin-top: 2px;
        }

        .course-note-text {
            word-break: break-word;
            line-height: 1.4;
        }

        /* Adicionando animação pulsante aos status badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            position: relative;
            transition: all 0.3s ease;
        }

        .status-badge::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.2);
            }
        }

        .status-badge.concluido { 
            background: rgba(16, 185, 129, 0.15); 
            color: #34d399;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.2);
        }
        .status-badge.andamento { 
            background: rgba(59, 130, 246, 0.15); 
            color: #60a5fa;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
        }
        .status-badge.pendente { 
            background: rgba(245, 158, 11, 0.15); 
            color: #fbbf24;
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.2);
        }
        .status-badge.cancelado { 
            background: rgba(239, 68, 68, 0.15); 
            color: #f87171;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.2);
        }

        /* Badges de status mais visíveis e informativos */
        .status-badge {
            font-size: 0.85rem;
            padding: 8px 16px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 2px solid currentColor;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* Animações de loading mais elaboradas */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(10px);
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(99, 102, 241, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-content {
            text-align: center;
            color: white;
            margin-top: 20px;
        }

        /* Feedback visual em ações */
        .action-feedback {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            z-index: 10001;
            animation: slideInRight 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Progresso visual nos cards */
        .course-progress {
            width: 100%;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin-top: 12px;
            overflow: hidden;
        }

        .course-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-hover));
            border-radius: 2px;
            transition: width 0.6s ease;
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }

        /* Ações rápidas mais acessíveis */
        .quick-actions {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .course-card:hover .quick-actions {
            opacity: 1;
        }

        .quick-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .quick-action-btn:hover {
            transform: scale(1.1);
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        /* Estilos para modo de visualização */
        .view-mode-selector {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .view-mode-btn {
            padding: 8px 12px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .view-mode-btn:hover {
            background: var(--surface-hover);
            color: var(--text-primary);
        }

        .view-mode-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Estilos para modo lista */
        .courses-list .course-card {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            padding: 1.5rem;
        }

        /* Estilos para modo timeline */
        .courses-timeline {
            position: relative;
            padding-left: 2rem;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 2rem;
            padding-left: 2rem;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--overlay);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--surface);
            border-radius: 20px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--surface-hover);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding: 1.5rem;
            border-top: 1px solid var(--border);
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 16px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-input.error, .form-select.error, .form-textarea.error {
            border-color: var(--danger);
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
            animation: shake 0.3s ease;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .form-error {
            color: var(--danger);
            font-size: 0.75rem;
            margin-top: 0.5rem;
            display: none;
        }

        .form-error.show {
            display: block;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* Label opcional para campos não obrigatórios */
        .optional-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-weight: 400;
            margin-left: 4px;
        }

        /* Calendar */
        .calendar-container {
            background: var(--surface);
            border-radius: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
            /* Adicionando efeitos de hover e transições suaves */
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .calendar-container:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            /* Adicionando gradiente sutil no header */
            background: linear-gradient(135deg, var(--surface) 0%, rgba(99, 102, 241, 0.05) 100%);
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .calendar-nav button {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            /* Melhorando animações dos botões de navegação */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .calendar-nav button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(99, 102, 241, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s;
        }

        .calendar-nav button:hover::before {
            width: 100px;
            height: 100px;
        }

        .calendar-nav button:hover {
            background: var(--surface-hover);
            color: var(--primary);
            transform: scale(1.1);
        }

        .calendar-nav button:active {
            transform: scale(0.95);
        }

        .calendar-title {
            font-size: 1.25rem;
            font-weight: 600;
            /* Adicionando gradiente de texto */
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .calendar-day-header {
            padding: 1rem;
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            background: var(--background);
            /* Adicionando animação de pulso nos headers */
            animation: headerPulse 3s ease-in-out infinite;
        }

        @keyframes headerPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .calendar-day {
            min-height: 100px;
            padding: 0.5rem;
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            background: var(--surface);
            /* Adicionando transições e efeitos hover interativos */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .calendar-day::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .calendar-day:hover::before {
            opacity: 1;
        }

        .calendar-day:hover {
            transform: scale(1.05);
            z-index: 10;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
            border-color: var(--primary);
        }

        .calendar-day:nth-child(7n) {
            border-right: none;
        }

        .calendar-day.other-month {
            background: var(--background);
            opacity: 0.5;
            transition: opacity 0.3s;
        }

        .calendar-day.other-month:hover {
            opacity: 0.8;
        }

        .calendar-day.today {
            background: rgba(99, 102, 241, 0.1);
            /* Adicionando animação de brilho no dia atual */
            position: relative;
            animation: todayGlow 2s ease-in-out infinite;
        }

        @keyframes todayGlow {
            0%, 100% {
                box-shadow: inset 0 0 20px rgba(99, 102, 241, 0.2);
            }
            50% {
                box-shadow: inset 0 0 30px rgba(99, 102, 241, 0.4);
            }
        }

        .calendar-date {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            position: relative;
            z-index: 1;
            transition: all 0.3s;
        }

        .calendar-day:hover .calendar-date {
            color: var(--primary);
            transform: scale(1.1);
        }

        .calendar-day.today .calendar-date {
            background: var(--primary);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            /* Adicionando animação de pulso no dia atual */
            animation: datePulse 1.5s ease-in-out infinite;
        }

        @keyframes datePulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        .calendar-event {
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 4px;
            margin-bottom: 4px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
            z-index: 1;
            /* Adicionando transições e efeitos nos eventos */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: left center;
        }

        .calendar-event:hover {
            transform: scale(1.05) translateX(4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 20;
        }

        .calendar-event.start { 
            background: var(--success); 
            color: white;
            /* Adicionando animação de entrada */
            animation: eventSlideIn 0.5s ease-out;
        }
        
        .calendar-event.end { 
            background: var(--danger); 
            color: white;
            animation: eventSlideIn 0.5s ease-out;
        }
        
        .calendar-event.ongoing { 
            background: var(--info); 
            color: white;
            animation: eventSlideIn 0.5s ease-out;
        }

        @keyframes eventSlideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Adicionando estilo para o botão "Hoje" */
        #todayBtn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        #todayBtn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s;
        }

        #todayBtn:hover::before {
            width: 200px;
            height: 200px;
        }

        #todayBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        #todayBtn:active {
            transform: translateY(0);
        }

        /* Pages */
        .page-section {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1), transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .page-section.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
            animation: pageFadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes pageFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        /* Instructors */
        .instructor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .instructor-card {
            background: var(--surface);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            text-align: center;
        }

        .instructor-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary), #a855f7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 600;
            margin: 0 auto 1rem;
        }

        .instructor-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .instructor-specialty {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .instructor-stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            padding: 1rem 0;
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            margin-bottom: 1rem;
        }

        .instructor-stat {
            text-align: center;
        }

        .instructor-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .instructor-stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .instructor-actions {
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        .instructor-actions .btn-whatsapp {
            background: #25D366;
            color: white;
        }

        .instructor-actions .btn-whatsapp:hover {
            background: #128C7E;
        }

        /* Settings */
        .settings-card {
            background: var(--surface);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid var(--border);
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
        }

        .settings-card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }

        .settings-card h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text);
        }

        .settings-card h3 .material-icons {
            color: var(--primary);
            font-size: 28px;
        }

        .settings-card .description {
            color: var(--text-muted);
            margin-bottom: 1.5rem;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .file-upload-area {
            border: 2px dashed var(--border);
            border-radius: 16px;
            padding: 3.5rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.02) 0%, rgba(99, 102, 241, 0.05) 100%);
            margin: 1rem 0;
            position: relative;
            overflow: hidden;
        }

        .file-upload-area::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .file-upload-area:hover::before {
            opacity: 1;
        }

        .file-upload-area:hover {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.08) 0%, rgba(99, 102, 241, 0.12) 100%);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.15);
        }

        .file-upload-area .material-icons {
            font-size: 64px;
            color: var(--primary);
            margin-bottom: 1.25rem;
            display: block;
            transition: transform 0.3s ease;
        }

        .file-upload-area:hover .material-icons {
            transform: scale(1.1);
        }

        .file-upload-area .upload-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text);
            margin: 0 0 0.75rem 0;
            line-height: 1.4;
        }

        .file-upload-area .upload-subtitle {
            font-size: 0.95rem;
            color: var(--text-muted);
            margin: 0.5rem 0;
            line-height: 1.5;
        }

        .file-upload-area .upload-formats {
            font-size: 0.875rem;
            color: var(--primary);
            margin: 0.75rem 0 0.5rem 0;
            font-weight: 500;
        }

        .file-upload-area .upload-columns {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin: 0.5rem auto 0 auto;
            max-width: 90%;
            line-height: 1.4;
        }

        .file-info {
            margin-top: 1.5rem;
            padding: 1.25rem;
            background: var(--background);
            border-radius: 12px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .file-info .material-icons {
            color: var(--primary);
            font-size: 24px;
        }

        .file-info p {
            margin: 0;
            font-size: 0.95rem;
            color: var(--text);
            font-weight: 500;
        }

        .export-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .export-actions .btn {
            justify-content: center;
        }

        .danger-zone {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.05) 0%, rgba(239, 68, 68, 0.02) 100%);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .danger-zone-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #ef4444;
            font-weight: 600;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
        }

        .danger-zone-title .material-icons {
            font-size: 20px;
        }

        .danger-zone-description {
            color: var(--text-muted);
            margin-bottom: 1rem;
            font-size: 0.9rem;
            line-height: 1.5;
        }


        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-state .material-icons {
            font-size: 64px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
        }

        .toast {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            min-width: 300px;
            max-width: 500px;
        }
        
        .toast span:last-child {
            flex: 1;
            word-wrap: break-word;
        }

        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.warning { border-left: 4px solid var(--warning); }
        .toast.info { border-left: 4px solid var(--info); }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Users Section */
        .users-table {
            width: 100%;
            border-collapse: collapse;
        }

        .users-table th,
        .users-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .users-table th {
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.875rem;
            text-transform: uppercase;
        }

        .users-table tr:hover td {
            background: var(--surface-hover);
        }

        .role-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .role-badge.admin { background: rgba(239, 68, 68, 0.15); color: #f87171; }
        .role-badge.editor { background: rgba(59, 130, 246, 0.15); color: #60a5fa; }
        .role-badge.viewer { background: rgba(16, 185, 129, 0.15); color: #34d399; }

        /* Novo layout do Activity Log - estilo timeline moderno */
        .activity-log {
            max-height: 500px;
            overflow-y: auto;
            padding: 1rem;
        }

        .activity-log-grid {
            display: grid;
            gap: 0;
        }

        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 1rem 0;
            position: relative;
        }

        .activity-item:not(:last-child)::before {
            content: '';
            position: absolute;
            left: 18px;
            top: 48px;
            bottom: -8px;
            width: 2px;
            background: var(--border);
        }

        .activity-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            position: relative;
            z-index: 1;
        }

        .activity-icon.add { background: var(--success); color: white; }
        .activity-icon.edit { background: var(--info); color: white; }
        .activity-icon.delete { background: var(--danger); color: white; }

        .activity-content {
            flex: 1;
            background: var(--background);
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid var(--border);
        }

        .activity-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .activity-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .activity-time {
            font-size: 0.75rem;
            color: var(--text-muted);
            background: var(--surface);
            padding: 4px 8px;
            border-radius: 6px;
        }

        .activity-description {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .activity-user {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 0.75rem;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .activity-user .material-icons {
            font-size: 14px;
        }

        /* Novo layout do Relatório Geral */
        .report-preview {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 16px;
            padding: 2rem;
            color: #ffffff;
        }

        .report-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid rgba(255,255,255,0.1);
        }

        .report-header h2 {
            color: #ffffff;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .report-header p {
            color: rgba(255,255,255,0.7);
            font-size: 0.9rem;
        }

        .report-kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .report-kpi-card {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .report-kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: #ffffff;
        }

        .report-kpi-label {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.7);
            text-transform: uppercase;
            margin-top: 0.25rem;
        }

        .report-kpi-card.green .report-kpi-value { color: #34d399; }
        .report-kpi-card.blue .report-kpi-value { color: #60a5fa; }
        .report-kpi-card.yellow .report-kpi-value { color: #fbbf24; }
        .report-kpi-card.red .report-kpi-value { color: #f87171; }
        .report-kpi-card.purple .report-kpi-value { color: #a78bfa; }

        .report-section {
            margin-bottom: 1.5rem;
        }

        .report-section h3 {
            color: #ffffff;
            font-size: 1rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .report-section h3 .material-icons {
            font-size: 20px;
            color: var(--primary);
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .report-table th,
        .report-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .report-table th {
            background: rgba(255,255,255,0.05);
            font-weight: 600;
            color: rgba(255,255,255,0.9);
        }

        .report-table td {
            color: rgba(255,255,255,0.8);
        }

        .report-table tr:hover td {
            background: rgba(255,255,255,0.05);
        }

        .report-chart {
            display: flex;
            justify-content: center;
            margin: 1.5rem 0;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .report-city-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 0.75rem;
        }

        .report-city-item {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .report-city-name {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.9);
        }

        .report-city-count {
            background: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Course Details */
        .course-detail-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .course-detail-item:last-child {
            border-bottom: none;
        }

        .course-detail-item .material-icons {
            color: var(--primary);
            font-size: 24px;
        }

        .course-detail-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .course-detail-value {
            font-size: 1rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .course-detail-value a {
            color: var(--info);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .course-detail-value a:hover {
            text-decoration: underline;
        }

        /* Seção de mudar senha */
        .password-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .mobile-menu-btn {
                display: block;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .courses-grid {
                grid-template-columns: 1fr;
            }

            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .calendar-day {
                min-height: 60px;
            }

            .calendar-event {
                font-size: 0.6rem;
                padding: 2px 4px;
            }

            .report-kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Novo design interativo para a aba de configurações */
        .settings-card {
            background: var(--card);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .settings-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), #a855f7, var(--primary));
            transform: scaleX(0);
            transition: transform 0.4s ease;
        }

        .settings-card:hover::before {
            transform: scaleX(1);
        }

        .settings-card:hover {
            box-shadow: 0 20px 40px rgba(99, 102, 241, 0.12);
            transform: translateY(-4px);
            border-color: var(--primary);
        }

        .settings-section-header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--border);
        }

        .settings-icon-large {
            width: 72px;
            height: 72px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary), #a855f7);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
            animation: pulse-glow 3s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3); }
            50% { box-shadow: 0 12px 32px rgba(99, 102, 241, 0.5); }
        }

        .settings-icon-large .material-icons {
            font-size: 40px;
            color: white;
        }

        .settings-header-content h3 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text);
            margin: 0 0 0.5rem 0;
        }

        .settings-header-content p {
            color: var(--text-muted);
            font-size: 0.95rem;
            margin: 0;
        }

        .interactive-upload-zone {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            /* Fixed padding to prevent content cutoff */
            padding: 4rem 2.5rem;
            min-height: 350px;
            border: 3px dashed rgba(99, 102, 241, 0.3);
            border-radius: 24px;
            cursor: pointer;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.03), rgba(168, 85, 247, 0.03));
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: visible;
            margin: 2rem 0;
        }

        .interactive-upload-zone::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.2), transparent);
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.5s ease;
            pointer-events: none;
        }

        .interactive-upload-zone:hover::after {
            transform: translate(-50%, -50%) scale(1);
        }

        .interactive-upload-zone:hover {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.08), rgba(168, 85, 247, 0.08));
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 60px rgba(99, 102, 241, 0.25);
            border-width: 3px;
        }

        .interactive-upload-zone.drag-over {
            border-color: #a855f7;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(99, 102, 241, 0.15));
            transform: scale(1.05);
        }

        .upload-icon-container {
            position: relative;
            display: inline-block;
            margin-bottom: 1.5rem;
        }

        .upload-icon-bg {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), #a855f7);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 12px 40px rgba(99, 102, 241, 0.3);
            transition: all 0.4s ease;
            /* Removed z-index that was causing overlap issues */
        }

        .upload-icon-bg .material-icons {
            font-size: 64px;
            color: white;
            animation: bounce-icon 2s ease-in-out infinite;
        }

        @keyframes bounce-icon {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .interactive-upload-zone:hover .upload-icon-bg {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 16px 48px rgba(99, 102, 241, 0.4);
        }

        .interactive-upload-zone:hover .upload-icon-bg .material-icons {
            color: white;
        }

        .upload-text-main {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.75rem;
            /* Added margin-top for proper spacing */
            margin-top: 1.5rem;
        }

        .upload-text-sub {
            font-size: 1.1rem;
            color: var(--text-muted);
            margin-bottom: 1.5rem;
            text-align: center;
            max-width: 90%;
        }

        .upload-format-tags {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .format-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1));
            border: 2px solid rgba(99, 102, 241, 0.3);
            border-radius: 50px;
            font-weight: 600;
            color: var(--primary);
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .format-tag .material-icons {
            font-size: 20px;
        }

        .interactive-upload-zone:hover .format-tag {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(168, 85, 247, 0.2));
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .file-selected-display {
            display: none;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.1));
            border: 2px solid rgba(34, 197, 94, 0.5);
            border-radius: 16px;
            margin-top: 1.5rem;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.4s ease;
        }
        
        .file-selected-display.show {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Loading States */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(99, 102, 241, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Melhorias de acessibilidade */
        button:focus-visible,
        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }
        
        /* Melhorias de performance - will-change */
        .kpi-card,
        .course-card,
        .instructor-card {
            will-change: transform;
        }
        
        /* Melhorias de responsividade */
        @media (max-width: 480px) {
            .modal {
                max-width: 95%;
                margin: 1rem;
            }
            
            .kpi-grid {
                grid-template-columns: 1fr;
            }
            
            .report-kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .toast {
                min-width: auto;
                max-width: calc(100vw - 2rem);
            }
        }


        .file-selected-display .material-icons {
            font-size: 32px;
            color: #22c55e;
        }

        .file-info-text {
            flex: 1;
        }

        .file-info-text strong {
            display: block;
            color: var(--text);
            margin-bottom: 0.25rem;
            font-size: 1rem;
        }

        .file-info-text span {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .columns-info-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(99, 102, 241, 0.08));
            border: 2px solid rgba(99, 102, 241, 0.2);
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }

        .columns-info-card .material-icons {
            font-size: 28px;
            color: var(--primary);
            flex-shrink: 0;
        }

        .columns-info-card strong {
            display: block;
            color: var(--text);
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .columns-info-card p {
            color: var(--text-muted);
            margin: 0;
            line-height: 1.6;
            font-size: 0.9rem;
        }

        .export-buttons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .export-button-card {
            background: linear-gradient(135deg, var(--card), rgba(99, 102, 241, 0.02));
            border: 2px solid var(--border);
            border-radius: 20px;
            padding: 2rem;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .export-button-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.1), transparent);
            transition: left 0.6s ease;
        }

        .export-button-card:hover::before {
            left: 100%;
        }

        .export-button-card:hover {
            border-color: var(--primary);
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 16px 48px rgba(99, 102, 241, 0.2);
        }

        .export-icon-wrapper {
            width: 80px;
            height: 80px;
            margin: 0 auto 1.5rem;
            border-radius: 20px;
            background: linear-gradient(135deg, var(--primary), #a855f7);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.4s ease;
        }

        .export-button-card:hover .export-icon-wrapper {
            transform: rotate(360deg) scale(1.1);
        }

        .export-icon-wrapper .material-icons {
            font-size: 40px;
            color: white;
        }

        .export-button-card h4 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text);
            margin: 0 0 0.5rem 0;
        }

        .export-button-card p {
            color: var(--text-muted);
            margin: 0;
            font-size: 0.9rem;
        }

        .danger-zone-card {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.05), rgba(220, 38, 38, 0.05));
            border: 2px solid rgba(239, 68, 68, 0.3);
        }

        .danger-zone-card:hover {
            border-color: #ef4444;
            box-shadow: 0 20px 40px rgba(239, 68, 68, 0.15);
        }

        .danger-zone-card .settings-icon-large {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            animation: pulse-danger 3s ease-in-out infinite;
        }

        @keyframes pulse-danger {
            0%, 100% { box-shadow: 0 8px 24px rgba(239, 68, 68, 0.3); }
            50% { box-shadow: 0 12px 32px rgba(239, 68, 68, 0.5); }
        }

        .danger-warning-box {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid rgba(239, 68, 68, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            display: flex;
            align-items: start;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .danger-warning-box .material-icons {
            font-size: 28px;
            color: #ef4444;
        }

        .danger-warning-box p {
            color: var(--text);
            margin: 0;
            line-height: 1.6;
        }

        .danger-warning-box strong {
            color: #ef4444;
        }

        /* Estilos para organização por LOTE */
        .lote-section {
            background: var(--surface);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border);
        }

        .lote-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .lote-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .lote-count {
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .lote-edit-input {
            background: var(--background);
            border: 2px solid var(--primary);
            border-radius: 8px;
            padding: 8px 12px;
            color: var(--text-primary);
            font-size: 1.25rem;
            font-weight: 700;
            width: 300px;
        }

        .lote-edit-actions {
            display: flex;
            gap: 8px;
            margin-left: 12px;
        }

        .lote-edit-actions button {
            padding: 8px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .lote-edit-actions button:hover {
            transform: scale(1.1);
        }
        
        /* Busca Avançada e Filtros */
        .advanced-search-panel {
            background: var(--surface);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border);
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .filter-group label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .filter-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        /* Notificações e Alertas */
        .notification-bell {
            position: relative;
        }
        
        .notification-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            z-index: 1000;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            animation: pulse 2s infinite;
        }
        
        .notifications-panel {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 380px;
            max-height: 500px;
            background: var(--surface);
            border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
            overflow: hidden;
        }
        
        .notifications-panel.active {
            display: flex;
            flex-direction: column;
        }
        
        .notifications-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .notifications-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        .notification-item {
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 0.5rem;
            background: var(--background);
            border-left: 4px solid var(--primary);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .notification-item:hover {
            background: var(--surface-hover);
            transform: translateX(4px);
        }
        
        .notification-item.urgent {
            border-left-color: var(--danger);
        }
        
        .notification-item.warning {
            border-left-color: var(--warning);
        }
        
        .notification-item-minimal {
            transition: all 0.2s ease;
        }
        
        .notification-item-minimal:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .notification-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }
        
        .notification-message {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        
        .notification-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        /* Histórico de Alterações */
        .history-timeline {
            position: relative;
            padding-left: 2rem;
        }
        
        .history-item {
            position: relative;
            padding-bottom: 1.5rem;
            border-left: 2px solid var(--border);
            padding-left: 1.5rem;
        }
        
        .history-item::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 0;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--primary);
        }
        
        .history-item:last-child {
            border-left: none;
        }
        
        .history-changes {
            background: var(--background);
            border-radius: 8px;
            padding: 0.75rem;
            margin-top: 0.5rem;
            font-size: 0.85rem;
        }
        
        .history-change-item {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
        }
        
        .history-change-old {
            color: var(--danger);
            text-decoration: line-through;
        }
        
        .history-change-new {
            color: var(--success);
        }
        
        /* Modo Claro/Escuro Toggle */
        .theme-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary);
            border: none;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: all 0.3s;
        }
        
        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.5);
        }
        
        /* Paginação */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 2rem;
            padding: 1rem;
        }
        
        .pagination button {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .pagination button:hover:not(:disabled) {
            background: var(--surface-hover);
            border-color: var(--primary);
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination button.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* Ordenação */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .sortable-header:hover {
            color: var(--primary);
        }
        
        .sort-icon {
            font-size: 16px;
            opacity: 0.5;
            transition: all 0.2s;
        }
        
        .sort-icon.active {
            opacity: 1;
            color: var(--primary);
        }
        
        /* Tooltips */
        .tooltip {
            position: relative;
        }
        
        .tooltip-content {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--surface);
            color: var(--text-primary);
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            pointer-events: none;
            z-index: 1000;
            border: 1px solid var(--border);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            margin-bottom: 8px;
        }
        
        .tooltip-content::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--surface);
        }
        
        .tooltip:hover .tooltip-content {
            opacity: 1;
            visibility: visible;
        }
        
        /* Preview de Importação */
        .import-preview {
            background: var(--surface);
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            border: 1px solid var(--border);
            max-height: 400px;
            overflow-y: auto;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        
        .preview-table th,
        .preview-table td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        .preview-table th {
            background: var(--background);
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .preview-table tr:hover td {
            background: var(--surface-hover);
        }
        
        .preview-error {
            color: var(--danger);
            font-size: 0.75rem;
        }
        
        .preview-success {
            color: var(--success);
        }
        
        /* Estatísticas por Período */
        /* Opções de Tema */
        .theme-option {
            position: relative;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .theme-option:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }
        
        .theme-option.active {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        
        .theme-option.active .theme-check {
            display: flex !important;
        }
        
        .themes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }
        
        /* Atalhos de teclado - Indicador */
        .keyboard-shortcut {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-left: auto;
        }
        
        .keyboard-key {
            background: var(--background);
            border: 1px solid var(--border);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.7rem;
        }
        
        /* Backup automático */
        .backup-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-muted);
            padding: 0.5rem;
        }
        
        .backup-status.active {
            color: var(--success);
        }
        

    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-card">
            <div class="login-logo">
                <span class="material-icons" id="loginDefaultIcon">school</span>
                <h1 id="loginProjectName">CSF Manager</h1>
            </div>
            <div class="login-error" id="loginError">
                Credenciais inválidas. Tente novamente.
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">Usuário</label>
                    <input type="text" class="form-input" id="loginUsername" placeholder="Digite seu usuário" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Senha</label>
                    <input type="password" class="form-input" id="loginPassword" placeholder="Digite sua senha" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <span class="material-icons">login</span>
                    Entrar
                </button>
            </form>
        </div>
    </div>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <span class="material-icons" id="sidebarDefaultIcon">school</span>
                    <h1 id="sidebarProjectName">CSF Manager</h1>
                </div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-item active" data-page="dashboard">
                    <span class="material-icons">dashboard</span>
                    Dashboard
                </div>
                <div class="nav-item" data-page="courses">
                    <span class="material-icons">book</span>
                    Cursos
                </div>
                <div class="nav-item" data-page="calendar">
                    <span class="material-icons">calendar_month</span>
                    Calendário
                </div>
                <div class="nav-item" data-page="instructors">
                    <span class="material-icons">people</span>
                    Instrutores
                </div>
                <div class="nav-item" data-page="users" id="usersNavItem" style="display: none;">
                    <span class="material-icons">admin_panel_settings</span>
                    Usuários
                </div>
                <div class="nav-item" data-page="settings">
                    <span class="material-icons">settings</span>
                    Configurações
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <div class="user-details">
                        <h4 id="userName">Admin</h4>
                        <span id="userRole">Administrador</span>
                    </div>
                    <button class="logout-btn" id="logoutBtn" title="Sair">
                        <span class="material-icons">logout</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Botão fixo para abrir sidebar no mobile -->
        <button id="mobileSidebarToggle" class="mobile-sidebar-toggle" title="Abrir menu">
            <span class="material-icons">menu</span>
        </button>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Notificações Panel -->
            <div class="notifications-panel" id="notificationsPanel">
                <div class="notifications-header">
                    <h3>Notificações</h3>
                    <button class="btn btn-secondary" id="closeNotificationsBtn" style="padding: 0.25rem 0.5rem;">
                        <span class="material-icons">close</span>
                    </button>
                </div>
                <div class="notifications-list" id="notificationsList">
                    <!-- Notificações serão renderizadas aqui -->
                </div>
            </div>
            
            <!-- Aviso de dados não salvos -->
            <!-- Toggle de Tema -->
            <button class="theme-toggle" id="themeToggle" title="Alternar tema">
                <span class="material-icons" id="themeIcon">dark_mode</span>
            </button>
            
            <!-- Dashboard Page -->
            <section class="page-section active" id="dashboardPage">
                <div class="header">
                    <button class="mobile-menu-btn" id="mobileMenuBtn">
                        <span class="material-icons">menu</span>
                    </button>
                </div>

                <!-- KPI Cards -->
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-icon purple">
                                <span class="material-icons">school</span>
                            </div>
                        </div>
                        <div class="kpi-value" id="totalCourses">0</div>
                        <div class="kpi-label">Total de Cursos</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-icon green">
                                <span class="material-icons">check_circle</span>
                            </div>
                        </div>
                        <div class="kpi-value" id="completedCourses">0</div>
                        <div class="kpi-label">Concluídos</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-icon blue">
                                <span class="material-icons">pending</span>
                            </div>
                        </div>
                        <div class="kpi-value" id="ongoingCourses">0</div>
                        <div class="kpi-label">Em Andamento</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-icon orange">
                                <span class="material-icons">groups</span>
                            </div>
                        </div>
                        <div class="kpi-value" id="totalStudents">0</div>
                        <div class="kpi-label">Total Concludentes</div>
                    </div>
                </div>

                <!-- Relatório de Cursos no Dashboard -->
                <div class="report-section" style="margin-top: 2rem;">
                    <div class="page-header">
                        <h2 class="page-title">Relatório de Cursos</h2>
                        <div class="header-actions">
                            <button class="btn btn-primary" id="downloadReportBtn">
                                <span class="material-icons">download</span>
                                Baixar Relatório
                            </button>
                        </div>
                    </div>
                    <div id="dashboardReport">
                        <!-- Relatório será renderizado aqui -->
                    </div>
                </div>
            </section>

            <!-- Courses Page -->
            <section class="page-section" id="coursesPage">
                <div class="page-header">
                    <h2 class="page-title">Cursos</h2>
                    <div class="header-actions">
                        <button class="btn btn-secondary notification-bell" id="notificationBtn" title="Notificações" style="position: relative; overflow: visible;">
                            <span class="material-icons">notifications</span>
                            <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                        </button>
                        <button class="btn btn-primary" id="newCourseBtn">
                            <span class="material-icons">add</span>
                            Novo Curso
                        </button>
                    </div>
                </div>
                
                <!-- Busca Avançada e Filtros -->
                <div class="advanced-search-panel">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                        <h3 style="font-size: 1.1rem; font-weight: 600;">Busca e Filtros</h3>
                        <button class="btn btn-secondary" id="toggleFiltersBtn" style="padding: 0.5rem 1rem;">
                            <span class="material-icons">filter_list</span>
                            Filtros
                        </button>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                        <button class="btn btn-secondary" id="searchToggleBtn" style="padding: 0.5rem; min-width: auto;">
                            <span class="material-icons">search</span>
                        </button>
                        <input type="text" id="searchInput" class="form-input" placeholder="Buscar por nome, cidade, instrutor..." style="width: 100%; display: none;">
                    </div>
                    <div id="filtersContainer" class="filters-grid" style="display: none;">
                        <div class="filter-group">
                            <label>Status</label>
                            <select id="filterStatus" class="form-select">
                                <option value="">Todos</option>
                                <option value="Concluído">Concluído</option>
                                <option value="Em Andamento">Em Andamento</option>
                                <option value="Pendente">Pendente</option>
                                <option value="Cancelado">Cancelado</option>
                    </select>
                        </div>
                        <div class="filter-group">
                            <label>Cidade</label>
                            <input type="text" id="filterCity" class="form-input" placeholder="Filtrar por cidade">
                        </div>
                        <div class="filter-group">
                            <label>Instrutor</label>
                            <select id="filterInstructor" class="form-select">
                                <option value="">Todos</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Período</label>
                            <input type="date" id="filterStartDate" class="form-input" placeholder="Data início">
                        </div>
                        <div class="filter-group">
                            <label>Até</label>
                            <input type="date" id="filterEndDate" class="form-input" placeholder="Data fim">
                        </div>
                        <div class="filter-actions">
                            <button class="btn btn-primary" id="applyFiltersBtn">Aplicar Filtros</button>
                            <button class="btn btn-secondary" id="clearFiltersBtn">Limpar</button>
                        </div>
                    </div>
                </div>
                
                
                <div id="coursesByLoteContainer">
                    <!-- Cursos organizados por LOTE serão renderizados aqui -->
                </div>
                
                <!-- Paginação -->
                <div class="pagination" id="paginationContainer" style="display: none;">
                    <button id="prevPageBtn" class="btn btn-secondary">
                        <span class="material-icons">chevron_left</span>
                    </button>
                    <span id="pageInfo" style="padding: 0 1rem;"></span>
                    <button id="nextPageBtn" class="btn btn-secondary">
                        <span class="material-icons">chevron_right</span>
                    </button>
                </div>
            </section>

            <!-- Calendar Page -->
            <section class="page-section" id="calendarPage">
                <div class="page-header">
                    <h2 class="page-title">Calendário</h2>
                </div>
                <div class="calendar-container">
                    <div class="calendar-header">
                        <div class="calendar-nav">
                            <button id="prevMonth">
                                <span class="material-icons">chevron_left</span>
                            </button>
                            <h3 class="calendar-title" id="calendarTitle">Dezembro 2024</h3>
                            <button id="nextMonth">
                                <span class="material-icons">chevron_right</span>
                            </button>
                        </div>
                        <button class="btn btn-secondary" id="todayBtn">Hoje</button>
                    </div>
                    <div class="calendar-grid" id="calendarGrid">
                        <!-- Calendar will be rendered here -->
                    </div>
                </div>
            </section>

            <!-- Instructors Page -->
            <section class="page-section" id="instructorsPage">
                <div class="page-header">
                    <h2 class="page-title">Instrutores</h2>
                    <div class="header-actions">
                        <button class="btn btn-secondary" id="importInstructorsBtn">
                            <span class="material-icons">upload_file</span>
                            Importar Dados
                        </button>
                    <button class="btn btn-primary" id="newInstructorBtn">
                        <span class="material-icons">person_add</span>
                        Novo Instrutor
                    </button>
                    </div>
                </div>
                <div class="instructor-grid" id="instructorGrid">
                    <!-- Instructors will be rendered here -->
                </div>
            </section>

            <!-- Users Page (Admin Only) -->
            <section class="page-section" id="usersPage">
                <div class="page-header">
                    <h2 class="page-title">Gerenciar Usuários</h2>
                    <button class="btn btn-primary" id="newUserBtn">
                        <span class="material-icons">person_add</span>
                        Novo Usuário
                    </button>
                </div>
                
                <!-- Adicionando seção para alterar nome do administrador -->
                <div class="settings-card">
                    <h3>
                        <span class="material-icons">badge</span>
                        Alterar Meu Nome
                    </h3>
                    <form id="changeNameForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Nome Atual</label>
                                <input type="text" class="form-input" id="currentNameDisplay" disabled>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Novo Nome</label>
                                <input type="text" class="form-input" id="newAdminName" placeholder="Digite o novo nome">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <span class="material-icons">save</span>
                            Alterar Nome
                        </button>
                    </form>
                </div>

                <!-- Seção de mudar senha do admin -->
                <div class="settings-card">
                    <h3>
                        <span class="material-icons">lock</span>
                        Alterar Minha Senha
                    </h3>
                    <form id="changePasswordForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Senha Atual</label>
                                <input type="password" class="form-input" id="currentPassword" placeholder="Digite sua senha atual">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Nova Senha</label>
                                <input type="password" class="form-input" id="newPassword" placeholder="Digite a nova senha">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Confirmar Nova Senha</label>
                            <input type="password" class="form-input" id="confirmPassword" placeholder="Confirme a nova senha">
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <span class="material-icons">save</span>
                            Alterar Senha
                        </button>
                    </form>
                </div>

                <div class="settings-card">
                    <h3>
                        <span class="material-icons">group</span>
                        Lista de Usuários
                    </h3>
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Função</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- Users will be rendered here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Novo layout do log de atividades -->
                <div class="settings-card">
                    <h3>
                        <span class="material-icons">history</span>
                        Log de Atividades
                    </h3>
                    <div class="activity-log" id="activityLog">
                        <!-- Activity log will be rendered here -->
                    </div>
                </div>
                
                <!-- Histórico de Alterações Detalhado -->
                <div class="settings-card">
                    <h3>
                        <span class="material-icons">timeline</span>
                        Histórico de Alterações
                    </h3>
                    <div id="changeHistoryContainer">
                        <!-- Histórico será renderizado aqui -->
                    </div>
                </div>
            </section>

            <!-- Settings Page -->
            <section class="page-section" id="settingsPage">
                <div class="page-header">
                    <h2 class="page-title">Configurações</h2>
                </div>

                <!-- Seção de importação com design interativo e animado -->
                <div class="settings-card">
                    <div class="settings-section-header">
                        <div class="settings-icon-large">
                            <span class="material-icons">cloud_upload</span>
                        </div>
                        <div class="settings-header-content">
                            <h3>Importar Dados</h3>
                            <p>Importe cursos em lote usando planilhas Excel de forma rápida e fácil</p>
                        </div>
                    </div>
                    
                    <label class="interactive-upload-zone" for="excelFileInput" id="uploadZone">
                        <div class="upload-icon-container">
                            <div class="upload-icon-bg">
                                <span class="material-icons">file_upload</span>
                            </div>
                        </div>
                        <div class="upload-text-main">Arraste seu arquivo aqui</div>
                        <div class="upload-text-sub">ou clique para selecionar do seu computador</div>
                        <div class="upload-format-tags">
                            <span class="format-tag">
                                <span class="material-icons">description</span>
                                Excel (.xlsx)
                            </span>
                            <span class="format-tag">
                                <span class="material-icons">table_chart</span>
                                Excel (.xls)
                            </span>
                        </div>
                    </label>
                    <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display: none;">
                    <input type="file" id="instructorsFileInput" accept=".xlsx,.xls" style="display: none;">
                    
                    <!-- Preview de Importação -->
                    <div class="import-preview" id="importPreview" style="display: none;">
                        <h4 style="margin-bottom: 1rem;">Preview dos Dados a Importar</h4>
                        <div id="previewTableContainer"></div>
                        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary" id="confirmImportBtn">Confirmar Importação</button>
                            <button class="btn btn-secondary" id="cancelImportBtn">Cancelar</button>
                        </div>
                    </div>
                    
                    <div class="file-selected-display" id="fileInfoBox">
                        <span class="material-icons">check_circle</span>
                        <div class="file-info-text">
                            <strong>Arquivo selecionado:</strong>
                            <span id="selectedFileName"></span>
                        </div>
                    </div>

                    <div class="columns-info-card">
                        <span class="material-icons">info</span>
                        <div>
                            <strong>Colunas esperadas na planilha:</strong>
                            <p>CURSO • ID • LOTE • CIDADE • DATA INÍCIO • DATA FIM • ENDEREÇO • STATUS • CONCLUDENTES • CARGA HORÁRIA • INSTRUTOR • TELEFONE</p>
                        </div>
                    </div>
                </div>

                <!-- Seção de exportação com cards interativos e animados -->
                <div class="settings-card">
                    <div class="settings-section-header">
                        <div class="settings-icon-large">
                            <span class="material-icons">download</span>
                        </div>
                        <div class="settings-header-content">
                            <h3>Exportar Dados</h3>
                            <p>Faça download dos seus dados em formato CSV para backup ou análise</p>
                        </div>
                    </div>
                    
                    <div class="export-buttons-grid">
                        <button class="export-button-card" id="exportCoursesBtn">
                            <div class="export-icon-wrapper">
                                <span class="material-icons">school</span>
                            </div>
                            <h4>Exportar Cursos</h4>
                            <p>Lista completa de todos os cursos cadastrados</p>
                        </button>
                        
                        <button class="export-button-card" id="exportInstructorsBtn">
                            <div class="export-icon-wrapper">
                                <span class="material-icons">people</span>
                            </div>
                            <h4>Exportar Instrutores</h4>
                            <p>Todos os instrutores e suas informações</p>
                        </button>
                    </div>
                </div>

                <!-- Seção de Nome do Projeto -->
                <div class="settings-card">
                    <div class="settings-section-header">
                        <div class="settings-icon-large">
                            <span class="material-icons">title</span>
                        </div>
                        <div class="settings-header-content">
                            <h3>Nome do Projeto</h3>
                            <p>Personalize o nome do projeto que aparece na tela de login e na sidebar</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.5rem;">
                        <div class="form-group">
                            <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem;">
                                <span class="material-icons" style="font-size: 18px;">edit</span>
                                Nome do Projeto
                            </label>
                            <input type="text" id="projectNameInput" class="form-input" placeholder="Ex: CSF Manager" maxlength="50">
                            <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">
                                O nome aparecerá na tela de login e na sidebar
                            </p>
                            <button type="button" class="btn btn-primary" id="saveProjectNameBtn" style="margin-top: 1rem;">
                                <span class="material-icons">save</span>
                                Salvar Nome
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Seção de Temas -->
                <div class="settings-card">
                    <div class="settings-section-header">
                        <div class="settings-icon-large">
                            <span class="material-icons">palette</span>
                        </div>
                        <div class="settings-header-content">
                            <h3>Temas</h3>
                            <p>Personalize a aparência da plataforma escolhendo um dos temas disponíveis</p>
                        </div>
                    </div>
                    
                    <div class="themes-grid" style="margin-top: 1.5rem;">
                        <div class="theme-option" data-theme="default">
                            <div class="theme-preview" style="background: linear-gradient(135deg, #6366f1, #4f46e5); height: 120px; border-radius: 12px; margin-bottom: 1rem; position: relative; overflow: hidden;">
                                <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 40px; background: rgba(0,0,0,0.2); display: flex; align-items: center; padding: 0 12px;">
                                    <div style="width: 8px; height: 8px; background: white; border-radius: 50%; margin-right: 8px;"></div>
                                    <div style="flex: 1; height: 4px; background: rgba(255,255,255,0.5); border-radius: 2px;"></div>
                                </div>
                            </div>
                            <h4 style="margin-bottom: 0.5rem; font-weight: 600;">Padrão</h4>
                            <p style="font-size: 0.875rem; color: var(--text-secondary); margin: 0;">Tema original com cores índigo</p>
                            <div class="theme-check" style="position: absolute; top: 12px; right: 12px; width: 24px; height: 24px; background: var(--primary); border-radius: 50%; display: none; align-items: center; justify-content: center; color: white;">
                                <span class="material-icons" style="font-size: 16px;">check</span>
                            </div>
                        </div>
                        
                        <div class="theme-option" data-theme="green">
                            <div class="theme-preview" style="background: linear-gradient(135deg, #10b981, #059669); height: 120px; border-radius: 12px; margin-bottom: 1rem; position: relative; overflow: hidden;">
                                <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 40px; background: rgba(0,0,0,0.2); display: flex; align-items: center; padding: 0 12px;">
                                    <div style="width: 8px; height: 8px; background: white; border-radius: 50%; margin-right: 8px;"></div>
                                    <div style="flex: 1; height: 4px; background: rgba(255,255,255,0.5); border-radius: 2px;"></div>
                                </div>
                            </div>
                            <h4 style="margin-bottom: 0.5rem; font-weight: 600;">Verde</h4>
                            <p style="font-size: 0.875rem; color: var(--text-secondary); margin: 0;">Tema com tons de verde natural</p>
                            <div class="theme-check" style="position: absolute; top: 12px; right: 12px; width: 24px; height: 24px; background: #10b981; border-radius: 50%; display: none; align-items: center; justify-content: center; color: white;">
                                <span class="material-icons" style="font-size: 16px;">check</span>
                            </div>
                        </div>
                        
                        <div class="theme-option" data-theme="purple">
                            <div class="theme-preview" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); height: 120px; border-radius: 12px; margin-bottom: 1rem; position: relative; overflow: hidden;">
                                <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 40px; background: rgba(0,0,0,0.2); display: flex; align-items: center; padding: 0 12px;">
                                    <div style="width: 8px; height: 8px; background: white; border-radius: 50%; margin-right: 8px;"></div>
                                    <div style="flex: 1; height: 4px; background: rgba(255,255,255,0.5); border-radius: 2px;"></div>
                                </div>
                            </div>
                            <h4 style="margin-bottom: 0.5rem; font-weight: 600;">Roxo</h4>
                            <p style="font-size: 0.875rem; color: var(--text-secondary); margin: 0;">Tema com tons de roxo elegante</p>
                            <div class="theme-check" style="position: absolute; top: 12px; right: 12px; width: 24px; height: 24px; background: #8b5cf6; border-radius: 50%; display: none; align-items: center; justify-content: center; color: white;">
                                <span class="material-icons" style="font-size: 16px;">check</span>
                            </div>
                        </div>

                        <div class="theme-option" data-theme="blue">
                            <div class="theme-preview" style="background: linear-gradient(135deg, #3b82f6, #2563eb); height: 120px; border-radius: 12px; margin-bottom: 1rem; position: relative; overflow: hidden;">
                                <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 40px; background: rgba(0,0,0,0.2); display: flex; align-items: center; padding: 0 12px;">
                                    <div style="width: 8px; height: 8px; background: white; border-radius: 50%; margin-right: 8px;"></div>
                                    <div style="flex: 1; height: 4px; background: rgba(255,255,255,0.5); border-radius: 2px;"></div>
                                </div>
                            </div>
                            <h4 style="margin-bottom: 0.5rem; font-weight: 600;">Azul</h4>
                            <p style="font-size: 0.875rem; color: var(--text-secondary); margin: 0;">Tema com tons de azul profissional</p>
                            <div class="theme-check" style="position: absolute; top: 12px; right: 12px; width: 24px; height: 24px; background: #3b82f6; border-radius: 50%; display: none; align-items: center; justify-content: center; color: white;">
                                <span class="material-icons" style="font-size: 16px;">check</span>
                            </div>
                        </div>

                        <div class="theme-option" data-theme="orange">
                            <div class="theme-preview" style="background: linear-gradient(135deg, #f97316, #ea580c); height: 120px; border-radius: 12px; margin-bottom: 1rem; position: relative; overflow: hidden;">
                                <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 40px; background: rgba(0,0,0,0.2); display: flex; align-items: center; padding: 0 12px;">
                                    <div style="width: 8px; height: 8px; background: white; border-radius: 50%; margin-right: 8px;"></div>
                                    <div style="flex: 1; height: 4px; background: rgba(255,255,255,0.5); border-radius: 2px;"></div>
                                </div>
                            </div>
                            <h4 style="margin-bottom: 0.5rem; font-weight: 600;">Laranja</h4>
                            <p style="font-size: 0.875rem; color: var(--text-secondary); margin: 0;">Tema com tons de laranja vibrante</p>
                            <div class="theme-check" style="position: absolute; top: 12px; right: 12px; width: 24px; height: 24px; background: #f97316; border-radius: 50%; display: none; align-items: center; justify-content: center; color: white;">
                                <span class="material-icons" style="font-size: 16px;">check</span>
                            </div>
                        </div>

                        <div class="theme-option" data-theme="pink">
                            <div class="theme-preview" style="background: linear-gradient(135deg, #ec4899, #db2777); height: 120px; border-radius: 12px; margin-bottom: 1rem; position: relative; overflow: hidden;">
                                <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 40px; background: rgba(0,0,0,0.2); display: flex; align-items: center; padding: 0 12px;">
                                    <div style="width: 8px; height: 8px; background: white; border-radius: 50%; margin-right: 8px;"></div>
                                    <div style="flex: 1; height: 4px; background: rgba(255,255,255,0.5); border-radius: 2px;"></div>
                                </div>
                            </div>
                            <h4 style="margin-bottom: 0.5rem; font-weight: 600;">Rosa</h4>
                            <p style="font-size: 0.875rem; color: var(--text-secondary); margin: 0;">Tema com tons de rosa moderno</p>
                            <div class="theme-check" style="position: absolute; top: 12px; right: 12px; width: 24px; height: 24px; background: #ec4899; border-radius: 50%; display: none; align-items: center; justify-content: center; color: white;">
                                <span class="material-icons" style="font-size: 16px;">check</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Customização de Tema -->
                    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid var(--border);">
                        <h4 style="margin-bottom: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                            <span class="material-icons">tune</span>
                            Customizar Tema
                        </h4>
                        <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1.5rem;">
                            Personalize as cores do tema escolhendo suas próprias cores
                        </p>
                        
                        <div class="custom-theme-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                            <div class="form-group">
                                <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span class="material-icons" style="font-size: 18px;">palette</span>
                                    Cor Principal
                                </label>
                                <input type="color" id="customPrimaryColor" class="form-input" style="height: 50px; padding: 4px; cursor: pointer;" value="#6366f1">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span class="material-icons" style="font-size: 18px;">format_color_fill</span>
                                    Cor de Fundo
                                </label>
                                <input type="color" id="customBackgroundColor" class="form-input" style="height: 50px; padding: 4px; cursor: pointer;" value="#0f172a">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span class="material-icons" style="font-size: 18px;">view_sidebar</span>
                                    Cor da Sidebar
                                </label>
                                <input type="color" id="customSidebarColor" class="form-input" style="height: 50px; padding: 4px; cursor: pointer;" value="#020617">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span class="material-icons" style="font-size: 18px;">square</span>
                                    Cor de Superfície
                                </label>
                                <input type="color" id="customSurfaceColor" class="form-input" style="height: 50px; padding: 4px; cursor: pointer;" value="#1e293b">
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn btn-primary" id="applyCustomThemeBtn">
                                <span class="material-icons">check</span>
                                Aplicar Cores Personalizadas
                            </button>
                            <button class="btn btn-secondary" id="resetCustomThemeBtn">
                                <span class="material-icons">refresh</span>
                                Restaurar Padrão
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Zona de perigo com visual de alerta interativo -->
                <div class="settings-card danger-zone-card">
                    <div class="settings-section-header">
                        <div class="settings-icon-large">
                            <span class="material-icons">warning</span>
                        </div>
                        <div class="settings-header-content">
                            <h3>Zona de Perigo</h3>
                            <p>Ações irreversíveis que afetam todo o sistema</p>
                        </div>
                    </div>
                    
                    <div class="danger-warning-box">
                        <span class="material-icons">error</span>
                        <p>Esta ação irá excluir <strong>permanentemente</strong> todos os cursos, instrutores e dados relacionados. Esta operação <strong>não pode ser desfeita</strong>. Proceda com extrema cautela.</p>
                    </div>
                    
                    <button class="btn btn-danger" id="clearDataBtn">
                        <span class="material-icons">delete_forever</span>
                        Limpar Todos os Dados do Sistema
                    </button>
                </div>
            </section>
        </main>
    </div>

    <!-- Course Modal - Campos opcionais -->
    <div class="modal-overlay" id="courseModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="courseModalTitle">Novo Curso</h3>
                <button class="modal-close" onclick="closeModal('courseModal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="courseForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Nome do Curso <span class="optional-label">(opcional)</span></label>
                        <input type="text" class="form-input" id="courseName" placeholder="Ex: Segurança do Trabalho NR-10">
                        <span class="form-error" id="courseNameError">Nome do curso é obrigatório</span>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ID <span class="optional-label">(opcional)</span></label>
                            <input type="number" class="form-input" id="courseIdLote" placeholder="Ex: 1001">
                        </div>
                        <div class="form-group">
                            <label class="form-label">LOTE <span class="optional-label">(opcional)</span></label>
                            <input type="text" class="form-input" id="courseLote" placeholder="Ex: Lote A">
                        </div>
                    </div>
                    <!-- Adicionando campo de Carga Horária com 3 opções -->
                    <div class="form-group">
                        <label class="form-label">Carga Horária</label>
                        <select class="form-select" id="courseCargaHoraria">
                            <option value="">Selecione a carga horária</option>
                            <option value="20H">20H</option>
                            <option value="40H">40H</option>
                            <option value="60H">60H</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Cidade <span class="optional-label">(opcional)</span></label>
                            <input type="text" class="form-input" id="courseCity" placeholder="Ex: São Paulo">
                            <span class="form-error" id="courseCityError">Cidade é obrigatória</span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Local <span class="optional-label">(opcional)</span></label>
                            <input type="text" class="form-input" id="courseLocation" placeholder="Ex: Centro de Treinamento">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Data Início <span class="optional-label">(opcional)</span></label>
                            <input type="date" class="form-input" id="courseStart">
                            <span class="form-error" id="courseStartError">Data de início é obrigatória</span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Data Fim <span class="optional-label">(opcional)</span></label>
                            <input type="date" class="form-input" id="courseEnd">
                            <span class="form-error" id="courseEndError">Data de fim é obrigatória</span>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="courseStatus">
                                <option value="Pendente">Pendente</option>
                                <option value="Em Andamento">Em Andamento</option>
                                <option value="Concluído">Concluído</option>
                                <option value="Cancelado">Cancelado</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Concludentes <span class="optional-label">(opcional)</span></label>
                            <input type="number" class="form-input" id="courseStudents" placeholder="0" min="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Instrutor <span class="optional-label">(opcional)</span></label>
                        <div style="display: flex; gap: 8px;">
                            <select class="form-select" id="courseInstructor" style="flex: 1;">
                                <option value="">Selecione um instrutor</option>
                            </select>
                            <button type="button" class="btn btn-secondary btn-icon" onclick="openQuickInstructorModal()" title="Adicionar Instrutor">
                                <span class="material-icons">person_add</span>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Link do Google Drive <span class="optional-label">(opcional)</span></label>
                        <input type="url" class="form-input" id="courseDriveLink" placeholder="https://drive.google.com/...">
                    </div>
                    <!-- Campo de anotação do curso -->
                    <div class="form-group">
                        <label class="form-label">Anotação <span class="optional-label">(opcional)</span></label>
                        <textarea class="form-input" id="courseNote" placeholder="Digite uma anotação que ficará visível no card do curso..." rows="3" style="resize: vertical;"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('courseModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="material-icons">save</span>
                        Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Course Modal -->
    <div class="modal-overlay" id="viewCourseModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="viewCourseTitle">Detalhes do Curso</h3>
                <button class="modal-close" onclick="closeModal('viewCourseModal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="modal-body" id="viewCourseBody">
                <!-- Course details will be rendered here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('viewCourseModal')"> Fechar</button>
                <button type="button" class="btn btn-primary" id="editCourseFromViewBtn">
                    <span class="material-icons">edit</span>
                    Editar
                </button>
            </div>
        </div>
    </div>

    <!-- Instructor Modal - Campos opcionais -->
    <div class="modal-overlay" id="instructorModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="instructorModalTitle">Novo Instrutor</h3>
                <button class="modal-close" onclick="closeModal('instructorModal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="instructorForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Nome <span class="optional-label">(opcional)</span></label>
                        <input type="text" class="form-input" id="instructorName" placeholder="Nome completo">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Especialidade <span class="optional-label">(opcional)</span></label>
                        <input type="text" class="form-input" id="instructorSpecialty" placeholder="Ex: Segurança do Trabalho">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Telefone <span class="optional-label">(opcional)</span></label>
                        <input type="tel" class="form-input" id="instructorPhone" placeholder="(00) 00000-0000">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email <span class="optional-label">(opcional)</span></label>
                        <input type="email" class="form-input" id="instructorEmail" placeholder="email@exemplo.com">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('instructorModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="material-icons">save</span>
                        Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Quick Instructor Modal -->
    <div class="modal-overlay" id="quickInstructorModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Adicionar Instrutor Rápido</h3>
                <button class="modal-close" onclick="closeModal('quickInstructorModal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="quickInstructorForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Nome do Instrutor <span class="optional-label">(opcional)</span></label>
                        <input type="text" class="form-input" id="quickInstructorName">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('quickInstructorModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="material-icons">add</span>
                        Adicionar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Modal - Campos opcionais -->
    <div class="modal-overlay" id="userModal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h3 id="userModalTitle">Novo Usuário</h3>
                <button class="modal-close" onclick="closeModal('userModal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="userForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Nome <span class="optional-label">(opcional)</span></label>
                        <input type="text" class="form-input" id="newUserName" placeholder="Nome do usuário">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Usuário (login) <span class="optional-label">(opcional)</span></label>
                        <input type="text" class="form-input" id="newUserUsername" placeholder="Nome de usuário para login">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email <span class="optional-label">(opcional)</span></label>
                        <input type="email" class="form-input" id="newUserEmail" placeholder="email@exemplo.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Senha <span class="optional-label">(opcional)</span></label>
                        <input type="password" class="form-input" id="newUserPassword" placeholder="Senha do usuário">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Função</label>
                        <select class="form-select" id="newUserRole">
                            <option value="viewer">Visualizador</option>
                            <option value="editor">Editor</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('userModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="material-icons">save</span>
                        Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Report Modal -->
    <div class="modal-overlay" id="reportModal">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <h3>Relatório de Cursos</h3>
                <button class="modal-close" onclick="closeModal('reportModal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="report-preview" id="reportContent">
                    <!-- Report content will be rendered here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('reportModal')"> Fechar</button>
                <button type="button" class="btn btn-primary" onclick="downloadReportAsImage()">
                    <span class="material-icons">image</span>
                    Baixar como Imagem
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBq5qmLy6HAzZAeC4KCVjLfdCM77ttOU3A",
            authDomain: "csf-iac.firebaseapp.com",
            projectId: "csf-iac",
            storageBucket: "csf-iac.firebasestorage.app",
            messagingSenderId: "484645494526",
            appId: "1:484645494526:web:f5ecc23c7c0edbca320faf",
            measurementId: "G-XL3WY01E73"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        let firebaseAvailable = false;

        // State
        let cursos = [];
        let instrutores = [];
        let usuarios = [];
        let activityLogs = [];
        let currentUser = null;
        let editingCourseId = null;
        let editingInstructorId = null;
        let editingUserId = null;
        let currentMonth = new Date();
        let viewingCourseId = null;
        let loteNames = {}; // Inicializar variável loteNames
        let isLoading = false; // Estado de loading
        let debounceTimer = null; // Timer para debounce

        const defaultUsers = [
            { id: 'admin1', name: 'Administrador', username: 'Csfiac', password: '032147', role: 'admin' },
            { id: 'editor1', name: 'Editor', username: 'Iac', password: 'Iac@123', role: 'editor' },
            { id: 'viewer1', name: 'Visualizador', username: 'viewer', password: 'viewer123', role: 'viewer' }
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeApp();
            checkAuth();
            setupEventListeners();
            setupDragAndDrop(); // Chamada para configurar o drag and drop
            setupModalCloseOnOutsideClick(); // Configurar fechamento de modais ao clicar fora
            // Carregar nome do projeto ao inicializar
            loadProjectName();
        });

        async function initializeApp() {
            try {
                await db.collection('_test_connection').doc('test').get();
                firebaseAvailable = true;
                console.log('Firebase conectado com sucesso!');
                await initializeUsers();
            } catch (error) {
                console.warn('Firebase não disponível, usando localStorage:', error.message);
                firebaseAvailable = false;
                initializeLocalStorage();
            }
        }

        function initializeLocalStorage() {
            if (!localStorage.getItem('usuarios')) {
                localStorage.setItem('usuarios', JSON.stringify(defaultUsers));
            }
            if (!localStorage.getItem('cursos')) {
                localStorage.setItem('cursos', JSON.stringify([]));
            }
            if (!localStorage.getItem('instrutores')) {
                localStorage.setItem('instrutores', JSON.stringify([]));
            }
            if (!localStorage.getItem('activityLogs')) {
                localStorage.setItem('activityLogs', JSON.stringify([]));
            }
            if (!localStorage.getItem('loteNames')) {
                localStorage.setItem('loteNames', JSON.stringify({}));
            }
            loteNames = JSON.parse(localStorage.getItem('loteNames') || '{}');
            
            // Sincronizar loteNames do Firebase se disponível
            if (firebaseAvailable) {
                syncLoteNamesFromFirebase();
            }
        }
        
        async function syncLoteNamesFromFirebase() {
            try {
                const snapshot = await db.collection('loteNames').get();
                if (!snapshot.empty) {
                    const firebaseLoteNames = {};
                    snapshot.docs.forEach(doc => {
                        firebaseLoteNames[doc.id] = doc.data().name;
                    });
                    // Mesclar com localStorage
                    loteNames = { ...loteNames, ...firebaseLoteNames };
                    localStorage.setItem('loteNames', JSON.stringify(loteNames));
                }
            } catch (error) {
                console.warn('Erro ao sincronizar loteNames do Firebase:', error);
            }
        }

        async function initializeUsers() {
            try {
                const snapshot = await db.collection('usuarios').get();
                if (snapshot.empty) {
                    for (const user of defaultUsers) {
                        await db.collection('usuarios').doc(user.id).set(user);
                    }
                }
            } catch (error) {
                console.error('Error initializing users:', error);
            }
        }

        function checkAuth() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showApp();
            }
        }

        // Auth Functions
        async function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            const defaultUser = defaultUsers.find(u => u.username === username && u.password === password);
            
            if (defaultUser) {
                currentUser = { ...defaultUser };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                document.getElementById('loginError').classList.remove('show');
                showApp();
                logActivity('Login', `${currentUser.name} fez login`, 'add');
                return;
            }
            
            if (!firebaseAvailable) {
                const localUsers = JSON.parse(localStorage.getItem('usuarios') || '[]');
                const localUser = localUsers.find(u => u.username === username && u.password === password);
                
                if (localUser) {
                    currentUser = { ...localUser };
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    document.getElementById('loginError').classList.remove('show');
                    showApp();
                    logActivity('Login', `${currentUser.name} fez login`, 'add');
                    return;
                }
                
                document.getElementById('loginError').classList.add('show');
                return;
            }

            try {
                const snapshot = await db.collection('usuarios').where('username', '==', username).get();
                
                if (!snapshot.empty) {
                    const userDoc = snapshot.docs[0];
                    const userData = userDoc.data();
                    
                    if (userData.password === password) {
                        currentUser = { id: userDoc.id, ...userData };
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        document.getElementById('loginError').classList.remove('show');
                        showApp();
                        logActivity('Login', `${currentUser.name} fez login`, 'add');
                        return;
                    }
                }
                
                document.getElementById('loginError').classList.add('show');
            } catch (error) {
                console.error('Erro no login Firebase:', error);
                document.getElementById('loginError').classList.add('show');
            }
        }

        function showApp() {
            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
            
            const roleLabels = { admin: 'Administrador', editor: 'Editor', viewer: 'Visualizador' };
            document.getElementById('userRole').textContent = roleLabels[currentUser.role];
            
            if (document.getElementById('currentNameDisplay')) {
                document.getElementById('currentNameDisplay').value = currentUser.name;
            }
            
            if (currentUser.role === 'admin') {
                document.getElementById('usersNavItem').style.display = 'flex';
            } else {
                document.getElementById('usersNavItem').style.display = 'none';
            }

            if (currentUser.role === 'viewer') {
                document.getElementById('newCourseBtn').style.display = 'none';
                document.getElementById('newInstructorBtn').style.display = 'none';
            } else {
                document.getElementById('newCourseBtn').style.display = 'flex';
                document.getElementById('newInstructorBtn').style.display = 'flex';
            }

            loadData();
            
            // Garantir renderização inicial após carregar dados
            setTimeout(() => {
                renderCalendar();
                if (document.getElementById('coursesPage')?.classList.contains('active')) {
                    renderCoursesByLote();
                }
            }, 500);
        }

        // Data Loading - Otimizado com debounce
        let dataUpdateTimer = null;
        function loadData() {
            if (firebaseAvailable) {
                db.collection('cursos').onSnapshot(snapshot => {
                    cursos = snapshot.docs.map(doc => {
                        const courseData = { id: doc.id, ...doc.data() };
                        // Normalizar status ao carregar
                        if (courseData.status) {
                            courseData.status = normalizeStatus(courseData.status);
                        }
                        return courseData;
                    });
                    
                    // Verificar notificações após carregar dados
                    setTimeout(() => {
                        checkUpcomingCourseDeadlines();
                    }, 500);
                    
                    // Debounce para evitar múltiplas renderizações
                    if (dataUpdateTimer) clearTimeout(dataUpdateTimer);
                    dataUpdateTimer = setTimeout(() => {
                    updateKPIs();
                    renderCalendar();
                    renderDashboardReport();
                    if (document.getElementById('coursesPage')?.classList.contains('active')) {
                        renderCoursesByLote();
                    }
                    // Verificar notificações após carregar dados
                    checkUpcomingCourseDeadlines();
                    }, 100);
                }, error => {
                    console.error('Erro ao carregar cursos:', error);
                    loadFromLocalStorage();
                });

                db.collection('instrutores').onSnapshot(snapshot => {
                    instrutores = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderInstructors();
                    updateInstructorSelect();
                }, error => {
                    console.error('Erro ao carregar instrutores:', error);
                    loadFromLocalStorage();
                });

                db.collection('usuarios').onSnapshot(snapshot => {
                    usuarios = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderUsers();
                    // Update current user name if it changed
                    if (currentUser && currentUser.id) {
                        const updatedUser = usuarios.find(u => u.id === currentUser.id);
                        if (updatedUser && updatedUser.name !== currentUser.name) {
                            currentUser = { ...currentUser, name: updatedUser.name };
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                            document.getElementById('userName').textContent = currentUser.name;
                            document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
                        }
                        if (updatedUser && updatedUser.role !== currentUser.role) {
                             currentUser = { ...currentUser, role: updatedUser.role };
                             localStorage.setItem('currentUser', JSON.stringify(currentUser));
                             const roleLabels = { admin: 'Administrador', editor: 'Editor', viewer: 'Visualizador' };
                             document.getElementById('userRole').textContent = roleLabels[currentUser.role];
                            if (currentUser.role === 'admin') {
                                document.getElementById('usersNavItem').style.display = 'flex';
                            } else {
                                document.getElementById('usersNavItem').style.display = 'none';
                            }
                             if (currentUser.role === 'viewer') {
                                document.getElementById('newCourseBtn').style.display = 'none';
                                document.getElementById('newInstructorBtn').style.display = 'none';
                            } else {
                                document.getElementById('newCourseBtn').style.display = 'flex';
                                document.getElementById('newInstructorBtn').style.display = 'flex';
                            }
                        }
                    }
                }, error => {
                    console.error('Erro ao carregar usuários:', error);
                    loadFromLocalStorage();
                });

                db.collection('activities').orderBy('timestamp', 'desc').limit(100).onSnapshot(snapshot => {
                    activityLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderActivityLogs();
                }, error => {
                    console.error('Erro ao carregar logs:', error);
                    loadFromLocalStorage();
                });
            } else {
                loadFromLocalStorage();
            }
        }

        function loadFromLocalStorage() {
            cursos = JSON.parse(localStorage.getItem('cursos') || '[]');
            // Normalizar status de todos os cursos ao carregar
            cursos = cursos.map(course => {
                if (course.status) {
                    course.status = normalizeStatus(course.status);
                }
                return course;
            });
            instrutores = JSON.parse(localStorage.getItem('instrutores') || '[]');
            usuarios = JSON.parse(localStorage.getItem('usuarios') || '[]');
            activityLogs = JSON.parse(localStorage.getItem('activityLogs') || '[]');
            loteNames = JSON.parse(localStorage.getItem('loteNames') || '{}');
            
            // Salvar cursos normalizados de volta
            localStorage.setItem('cursos', JSON.stringify(cursos));
            
            // Usar requestAnimationFrame para otimizar renderizações
            requestAnimationFrame(() => {
            updateKPIs();
            renderCalendar();
            renderInstructors();
            updateInstructorSelect();
            renderUsers();
            renderActivityLogs();
            renderDashboardReport();
            if (document.getElementById('coursesPage')?.classList.contains('active')) {
                renderCoursesByLote();
            }
            // Verificar notificações após carregar dados
            setTimeout(() => {
                checkUpcomingCourseDeadlines();
            }, 500);
            });
        }

        // Navigation
        function navigateTo(page) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.page === page);
            });

            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
            });

            document.getElementById(`${page}Page`).classList.add('active');
            document.getElementById('sidebar').classList.remove('active');
            
            // Renderizar conteúdo específico da página
            if (page === 'settings') {
                renderChangeHistory();
                updateInstructorFilter();
                // Atualizar tema ativo na interface
                const savedColorTheme = localStorage.getItem('colorTheme') || 'default';
                document.querySelectorAll('.theme-option').forEach(option => {
                    option.classList.toggle('active', option.dataset.theme === savedColorTheme);
                });
                // Reinicializar customização de tema quando entrar na página
                setTimeout(() => initializeCustomTheme(), 100);
            }
            
            if (page === 'courses') {
                renderCoursesByLote();
            } else if (page === 'dashboard') {
                renderDashboardReport();
            } else if (page === 'calendar') {
                renderCalendar();
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        // Render Functions
        function renderCourses(searchTerm = '') {
            const grid = document.getElementById('coursesGrid');
            let filtered = cursos;

            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filtered = cursos.filter(c => 
                    c.curso?.toLowerCase().includes(term) ||
                    c.cidade?.toLowerCase().includes(term) ||
                    c.instrutor?.toLowerCase().includes(term) ||
                    c.loteResponsavel?.toLowerCase().includes(term)
                );
            }

            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <span class="material-icons">school</span>
                        <h3>Nenhum curso encontrado</h3>
                        <p>${searchTerm ? 'Tente uma busca diferente' : 'Adicione seu primeiro curso'}</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filtered.map(course => {
                const statusClass = getStatusClass(course.status);
                const canEdit = currentUser?.role !== 'viewer';
                
                return `
                    <div class="course-card" onclick="openViewCourseModal('${course.id}')">
                        <div class="course-header">
                            <div>
                                <div class="course-title">${course.curso || 'Sem nome'}</div>
                                <div class="course-id">ID da Turma: ${course.idLote || 'N/A'}${course.loteResponsavel ? ' | ' + course.loteResponsavel : ''}</div>
                            </div>
                            ${canEdit ? `
                                <div class="course-actions" onclick="event.stopPropagation()">
                                    ${course.driveLink ? `
                                        <button class="drive" onclick="openDriveLink('${course.driveLink}')" title="Abrir Google Drive">
                                            <span class="material-icons">folder</span>
                                        </button>
                                    ` : ''}
                                    <button onclick="openCourseModal('${course.id}')" title="Editar">
                                        <span class="material-icons">edit</span>
                                    </button>
                                    <button class="delete" onclick="deleteCourse('${course.id}')" title="Excluir">
                                        <span class="material-icons">delete</span>
                                    </button>
                                </div>
                            ` : `
                                <div class="course-actions" onclick="event.stopPropagation()">
                                    ${course.driveLink ? `
                                        <button class="drive" onclick="openDriveLink('${course.driveLink}')" title="Abrir Google Drive">
                                            <span class="material-icons">folder</span>
                                        </button>
                                    ` : ''}
                                </div>
                            `}
                        </div>
                        <div class="course-info">
                            <div class="course-info-item">
                                <span class="material-icons">location_on</span>
                                ${course.cidade || 'Local não definido'}${course.local ? ' - ' + course.local : ''}
                            </div>
                            <div class="course-info-item">
                                <span class="material-icons">event</span>
                                <span>Período: ${course.inicio && course.fim ? formatDate(course.inicio) + ' - ' + formatDate(course.fim) : course.inicio ? formatDate(course.inicio) : course.fim ? formatDate(course.fim) : 'Não informado'}</span>
                            </div>
                            <div class="course-info-item">
                                <span class="material-icons">person</span>
                                ${course.instrutor || 'Instrutor não definido'}
                            </div>
                            <div class="course-info-item">
                                <span class="material-icons">groups</span>
                                ${course.alunos || 0} concludentes
                            </div>
                            <div>
                                <span class="status-badge ${statusClass}">${normalizeStatus(course.status)}</span>
                            </div>
                        </div>
                        <!-- Exibição da anotação no card -->
                        ${course.nota ? `
                            <div class="course-note">
                                <span class="material-icons">sticky_note_2</span>
                                <span class="course-note-text">${course.nota}</span>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function openDriveLink(link) {
            if (link) {
                window.open(link, '_blank');
            }
        }

        function openViewCourseModal(courseId) {
            viewingCourseId = courseId;
            const course = cursos.find(c => c.id === courseId);
            if (!course) return;

            document.getElementById('viewCourseTitle').textContent = course.curso || 'Detalhes do Curso';
            
            const statusClass = getStatusClass(course.status);
            
            const body = document.getElementById('viewCourseBody');
            body.innerHTML = `
                <div class="course-detail-item">
                    <span class="material-icons">school</span>
                    <div>
                        <div class="course-detail-label">Nome do Curso</div>
                        <div class="course-detail-value">${course.curso || 'Não informado'}</div>
                    </div>
                </div>
                <div class="course-detail-item">
                    <span class="material-icons">tag</span>
                    <div>
                        <div class="course-detail-label">ID</div>
                        <div class="course-detail-value">${course.idLote || 'N/A'}</div>
                    </div>
                </div>
                <div class="course-detail-item">
                    <span class="material-icons">folder</span>
                    <div>
                        <div class="course-detail-label">Lote</div>
                        <div class="course-detail-value">${course.lote || course.loteResponsavel || 'Não informado'}</div>
                    </div>
                </div>
                <div class="course-detail-item">
                    <span class="material-icons">hourglass_bottom</span>
                    <div>
                        <div class="course-detail-label">Carga Horária</div>
                        <div class="course-detail-value">${course.cargaHoraria || 'Não informada'}</div>
                    </div>
                </div>
                <div class="course-detail-item">
                    <span class="material-icons">location_city</span>
                    <div>
                        <div class="course-detail-label">Cidade</div>
                        <div class="course-detail-value">${course.cidade || 'Não informado'}</div>
                    </div>
                </div>
                <div class="course-detail-item">
                    <span class="material-icons">place</span>
                    <div>
                        <div class="course-detail-label">Endereço</div>
                        <div class="course-detail-value">${course.local || 'Não informado'}</div>
                    </div>
                </div>
                <div class="course-detail-item">
                    <span class="material-icons">event</span>
                    <div>
                        <div class="course-detail-label">Período</div>
                        <div class="course-detail-value">${course.inicio && course.fim ? formatDate(course.inicio) + ' - ' + formatDate(course.fim) : course.inicio ? formatDate(course.inicio) : course.fim ? formatDate(course.fim) : 'Não informado'}</div>
                    </div>
                </div>
                <div class="course-detail-item">
                    <span class="material-icons">person</span>
                    <div>
                        <div class="course-detail-label">Instrutor</div>
                        <div class="course-detail-value">${course.instrutor || 'Não definido'}</div>
                    </div>
                </div>
                <div class="course-detail-item">
                    <span class="material-icons">groups</span>
                    <div>
                        <div class="course-detail-label">Concludentes</div>
                        <div class="course-detail-value">${course.alunos || 0}</div>
                    </div>
                </div>
                <div class="course-detail-item">
                    <span class="material-icons">info</span>
                    <div>
                        <div class="course-detail-label">Status</div>
                        <div class="course-detail-value"><span class="status-badge ${statusClass}">${course.status || 'Pendente'}</span></div>
                    </div>
                </div>
                ${course.driveLink ? `
                <div class="course-detail-item">
                    <span class="material-icons">folder</span>
                    <div>
                        <div class="course-detail-label">Google Drive</div>
                        <div class="course-detail-value">
                            <a href="${course.driveLink}" target="_blank">
                                <span class="material-icons" style="font-size: 18px;">open_in_new</span>
                                Abrir pasta do curso
                            </a>
                        </div>
                    </div>
                </div>
                ` : ''}
                 ${course.nota ? `
                <div class="course-detail-item">
                    <span class="material-icons">chat_bubble_outline</span>
                    <div>
                        <div class="course-detail-label">Observação</div>
                        <div class="course-detail-value">${course.nota}</div>
                    </div>
                </div>
                ` : ''}
            `;

            const editBtn = document.getElementById('editCourseFromViewBtn');
            if (currentUser?.role !== 'viewer') {
                editBtn.style.display = 'flex';
                editBtn.onclick = () => {
                    closeModal('viewCourseModal');
                    openCourseModal(courseId);
                };
            } else {
                editBtn.style.display = 'none';
            }

            document.getElementById('viewCourseModal').classList.add('active');
        }

        function renderInstructors() {
            const grid = document.getElementById('instructorGrid');

            if (instrutores.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <span class="material-icons">people</span>
                        <h3>Nenhum instrutor cadastrado</h3>
                        <p>Adicione seu primeiro instrutor</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = instrutores.map(instructor => {
                const coursesCount = cursos.filter(c => c.instrutor === instructor.nome).length;
                const canEdit = currentUser?.role !== 'viewer';
                const phone = instructor.telefone ? instructor.telefone.replace(/\D/g, '') : '';

                return `
                    <div class="instructor-card">
                        <div class="instructor-avatar">${instructor.nome?.charAt(0) || '?'}</div>
                        <div class="instructor-name">${instructor.nome || 'Sem nome'}</div>
                        <div class="instructor-specialty">${instructor.especialidade || 'Sem especialidade'}</div>
                        <div class="instructor-stats">
                            <div class="instructor-stat">
                                <div class="instructor-stat-value">${coursesCount}</div>
                                <div class="instructor-stat-label">Cursos</div>
                            </div>
                        </div>
                        <div class="instructor-actions">
                            ${phone ? `
                                <button class="btn btn-whatsapp btn-icon" onclick="openWhatsApp('${phone}')" title="Enviar mensagem no WhatsApp">
                                    <span class="material-icons">chat</span>
                                </button>
                            ` : ''}
                            ${canEdit ? `
                                <button class="btn btn-secondary btn-icon" onclick="openInstructorModal('${instructor.id}')" title="Editar">
                                    <span class="material-icons">edit</span>
                                </button>
                                <button class="btn btn-danger btn-icon" onclick="deleteInstructor('${instructor.id}')" title="Excluir">
                                    <span class="material-icons">delete</span>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openWhatsApp(phone) {
            const formattedPhone = phone.startsWith('55') ? phone : '55' + phone;
            window.open(`https://wa.me/${formattedPhone}`, '_blank');
        }

        function renderUsers() {
            const tbody = document.getElementById('usersTableBody');
            
            tbody.innerHTML = usuarios.map(user => {
                const roleClass = user.role;
                const roleLabel = { admin: 'Admin', editor: 'Editor', viewer: 'Viewer' }[user.role];
                const isCurrentUser = user.id === currentUser?.id;

                return `
                    <tr>
                        <td>${user.name}</td>
                        <td>${user.email || user.username || '-'}</td>
                        <td><span class="role-badge ${roleClass}">${roleLabel}</span></td>
                        <td>
                            ${!isCurrentUser ? `
                                <button class="btn btn-secondary btn-icon" onclick="openUserModal('${user.id}')" title="Editar">
                                    <span class="material-icons">edit</span>
                                </button>
                                <button class="btn btn-danger btn-icon" onclick="deleteUser('${user.id}')" title="Excluir">
                                    <span class="material-icons">delete</span>
                                </button>
                            ` : '<span style="color: var(--text-muted)">Usuário atual</span>'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderActivityLogs() {
            const container = document.getElementById('activityLog');
            
            if (activityLogs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <span class="material-icons">history</span>
                        <h3>Nenhuma atividade registrada</h3>
                        <p>As atividades aparecerão aqui</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="activity-log-grid">
                    ${activityLogs.map(log => {
                        const iconClass = log.type || 'add';
                        const iconName = iconClass === 'add' ? 'add' : iconClass === 'edit' ? 'edit' : 'delete';
                        return `
                            <div class="activity-item">
                                <div class="activity-icon ${iconClass}">
                                    <span class="material-icons">${iconName}</span>
                                </div>
                                <div class="activity-content">
                                    <div class="activity-header">
                                        <div class="activity-title">${log.action}</div>
                                        <div class="activity-time">${formatTimestamp(log.timestamp)}</div>
                                    </div>
                                    <div class="activity-description">${log.description}</div>
                                    <div class="activity-user">
                                        <span class="material-icons">person</span>
                                        ${log.user || 'Sistema'}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function updateKPIs() {
            document.getElementById('totalCourses').textContent = cursos.length;
            document.getElementById('completedCourses').textContent = cursos.filter(c => normalizeStatus(c.status) === 'Concluído').length;
            document.getElementById('ongoingCourses').textContent = cursos.filter(c => normalizeStatus(c.status) === 'Em Andamento').length;
            document.getElementById('totalStudents').textContent = cursos.reduce((sum, c) => sum + (parseInt(c.alunos) || 0), 0);
        }

        function updateInstructorSelect() {
            const select = document.getElementById('courseInstructor');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">Selecione um instrutor</option>' +
                instrutores.map(i => `<option value="${i.nome}">${i.nome}</option>`).join('');
            
            select.value = currentValue;
        }

        // Calendar Functions
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            if (!grid) return;
            
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();

            const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
                           'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const calendarTitle = document.getElementById('calendarTitle');
            if (calendarTitle) {
                calendarTitle.textContent = `${months[month]} ${year}`;
            }

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDay = firstDay.getDay();
            const daysInMonth = lastDay.getDate();

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let html = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb']
                .map(day => `<div class="calendar-day-header">${day}</div>`)
                .join('');

            const prevMonth = new Date(year, month, 0);
            for (let i = startDay - 1; i >= 0; i--) {
                html += `<div class="calendar-day other-month"><div class="calendar-date">${prevMonth.getDate() - i}</div></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const isToday = date.getTime() === today.getTime();
                const dateStr = date.toISOString().split('T')[0];

                const events = cursos.filter(c => {
                    if (!c.inicio || !c.fim) return false;
                    return c.inicio === dateStr || c.fim === dateStr || 
                           (c.inicio < dateStr && c.fim > dateStr);
                });

                let eventsHtml = events.slice(0, 3).map(c => {
                    let eventClass = 'ongoing';
                    if (c.inicio === dateStr) eventClass = 'start';
                    else if (c.fim === dateStr) eventClass = 'end';
                    return `<div class="calendar-event ${eventClass}" title="${c.curso}">${c.curso}</div>`;
                }).join('');

                if (events.length > 3) {
                    eventsHtml += `<div class="calendar-event" style="background: var(--text-muted);">+${events.length - 3} mais</div>`;
                }

                html += `
                    <div class="calendar-day${isToday ? ' today' : ''}">
                        <div class="calendar-date">${day}</div>
                        ${eventsHtml}
                    </div>
                `;
            }

            const totalCells = startDay + daysInMonth;
            const remainingCells = 7 - (totalCells % 7);
            if (remainingCells < 7) {
                for (let i = 1; i <= remainingCells; i++) {
                    html += `<div class="calendar-day other-month"><div class="calendar-date">${i}</div></div>`;
                }
            }

            grid.innerHTML = html;
        }

        function changeMonth(delta) {
            currentMonth.setMonth(currentMonth.getMonth() + delta);
            renderCalendar();
        }

        function goToToday() {
            currentMonth = new Date();
            renderCalendar();
        }

        // Modal Functions
        function openCourseModal(courseId = null) {
            editingCourseId = courseId;
            const modal = document.getElementById('courseModal');
            const title = document.getElementById('courseModalTitle');
            const form = document.getElementById('courseForm');

            form.reset();
            document.querySelectorAll('.form-error').forEach(el => el.classList.remove('show'));

            if (courseId) {
                const course = cursos.find(c => c.id === courseId);
                if (course) {
                    title.textContent = 'Editar Curso';
                    document.getElementById('courseName').value = course.curso || '';
                    document.getElementById('courseIdLote').value = course.idLote || '';
                    document.getElementById('courseLote').value = course.lote || course.loteResponsavel || '';
                    document.getElementById('courseCargaHoraria').value = course.cargaHoraria || '';
                    document.getElementById('courseCity').value = course.cidade || '';
                    document.getElementById('courseStart').value = course.inicio || '';
                    document.getElementById('courseEnd').value = course.fim || '';
                    document.getElementById('courseStatus').value = course.status || 'Pendente';
                    document.getElementById('courseStudents').value = course.alunos || 0;
                    document.getElementById('courseInstructor').value = course.instrutor || '';
                    document.getElementById('courseDriveLink').value = course.driveLink || '';
                    document.getElementById('courseNote').value = course.nota || '';
                }
            } else {
                title.textContent = 'Novo Curso';
            }

            modal.classList.add('active');
        }

        function openInstructorModal(instructorId = null) {
            editingInstructorId = instructorId;
            const modal = document.getElementById('instructorModal');
            if (!modal) {
                console.error('Modal de instrutor não encontrado!');
                return;
            }
            const title = document.getElementById('instructorModalTitle');
            const form = document.getElementById('instructorForm');
            if (!form) {
                console.error('Formulário de instrutor não encontrado!');
                return;
            }

            form.reset();
            document.querySelectorAll('.form-error').forEach(el => el.classList.remove('show'));

            if (instructorId) {
                const instructor = instrutores.find(i => i.id === instructorId);
                if (instructor) {
                    title.textContent = 'Editar Instrutor';
                    document.getElementById('instructorName').value = instructor.nome || '';
                    document.getElementById('instructorSpecialty').value = instructor.especialidade || '';
                    document.getElementById('instructorPhone').value = instructor.telefone || '';
                    document.getElementById('instructorEmail').value = instructor.email || '';
                }
            } else {
                title.textContent = 'Novo Instrutor';
            }

            modal.classList.add('active');
        }

        function openQuickInstructorModal() {
            document.getElementById('quickInstructorForm').reset();
            document.querySelectorAll('.form-error').forEach(el => el.classList.remove('show'));
            document.getElementById('quickInstructorModal').classList.add('active');
        }

        function openUserModal(userId = null) {
            editingUserId = userId;
            const modal = document.getElementById('userModal');
            const title = document.getElementById('userModalTitle');
            const form = document.getElementById('userForm');

            form.reset();
            document.querySelectorAll('.form-error').forEach(el => el.classList.remove('show'));

            if (userId) {
                const user = usuarios.find(u => u.id === userId);
                if (user) {
                    title.textContent = 'Editar Usuário';
                    document.getElementById('newUserName').value = user.name || '';
                    document.getElementById('newUserUsername').value = user.username || '';
                    document.getElementById('newUserEmail').value = user.email || '';
                    document.getElementById('newUserPassword').value = '';
                    document.getElementById('newUserRole').value = user.role || 'viewer';
                }
            } else {
                title.textContent = 'Novo Usuário';
            }

            modal.classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            const form = document.getElementById(`${modalId.replace('Modal', 'Form')}`);
            if (form) {
                form.reset();
            }
            document.querySelectorAll(`#${modalId} .form-error`).forEach(el => el.classList.remove('show'));
        }
        
        // Fechar modal ao clicar fora dele
        function setupModalCloseOnOutsideClick() {
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', function(e) {
                    // Fechar apenas se clicou diretamente no overlay (não no modal interno)
                    if (e.target === overlay) {
                        const modalId = overlay.id;
                        closeModal(modalId);
                    }
                });
            });
        }

        async function handleCourseSubmit(e) {
            e.preventDefault();
            
            // Validações
            const idLote = document.getElementById('courseIdLote').value.trim();
            const lote = document.getElementById('courseLote').value.trim();
            const inicio = document.getElementById('courseStart').value;
            const fim = document.getElementById('courseEnd').value;
            
            // Limpar erros anteriores
            document.querySelectorAll('.form-error').forEach(el => el.classList.remove('show'));
            
            let hasError = false;
            
            // Validar ID do LOTE (opcional, mas se preenchido deve ser válido)
            if (idLote && (isNaN(parseInt(idLote)) || parseInt(idLote) <= 0)) {
                document.getElementById('courseIdLote').classList.add('error');
                showToast('ID do LOTE deve ser um número positivo', 'error');
                hasError = true;
            }
            
            // Validar LOTE (opcional, mas se preenchido deve ter pelo menos 2 caracteres)
            if (lote && lote.length < 2) {
                document.getElementById('courseLote').classList.add('error');
                showToast('LOTE deve ter pelo menos 2 caracteres', 'error');
                hasError = true;
            }
            
            // Validar datas
            if (inicio && fim) {
                const startDate = new Date(inicio);
                const endDate = new Date(fim);
                if (endDate < startDate) {
                    document.getElementById('courseEnd').classList.add('error');
                    showToast('Data de fim não pode ser anterior à data de início', 'error');
                    hasError = true;
                }
            }
            
            // Validar URL do Drive se fornecida
            const driveLink = document.getElementById('courseDriveLink').value.trim();
            if (driveLink && !isValidUrl(driveLink)) {
                document.getElementById('courseDriveLink').classList.add('error');
                showToast('URL do Google Drive inválida', 'error');
                hasError = true;
            }
            
            if (hasError) return;
            
            // Remover classes de erro dos campos válidos
            document.querySelectorAll('.form-input, .form-select').forEach(el => {
                if (!el.classList.contains('error')) {
                    el.classList.remove('error');
                }
            });
            
            const courseData = {
                curso: document.getElementById('courseName').value.trim(),
                idLote: idLote ? parseInt(idLote) : 0,
                lote: lote || '',
                loteResponsavel: lote || '',
                cargaHoraria: document.getElementById('courseCargaHoraria').value,
                cidade: document.getElementById('courseCity').value.trim(),
                inicio: inicio,
                fim: fim,
                status: normalizeStatus(document.getElementById('courseStatus').value || 'Pendente'),
                alunos: parseInt(document.getElementById('courseStudents').value) || 0,
                local: document.getElementById('courseLocation').value.trim(),
                instrutor: document.getElementById('courseInstructor').value,
                driveLink: driveLink,
                nota: document.getElementById('courseNote').value.trim()
            };
            
            // Validar número de alunos
            if (courseData.alunos < 0) {
                showToast('Número de concludentes não pode ser negativo', 'error');
                return;
            }

            // Mostrar loading
            setLoadingState(true);

            try {
                let changes = {};
                if (editingCourseId) {
                    const oldCourse = cursos.find(c => c.id === editingCourseId);
                    if (oldCourse) {
                        Object.keys(courseData).forEach(key => {
                            if (oldCourse[key] !== courseData[key]) {
                                changes[key] = { old: oldCourse[key], new: courseData[key] };
                            }
                        });
                    }
                }
                
                if (firebaseAvailable) {
                    if (editingCourseId) {
                        await db.collection('cursos').doc(editingCourseId).update(courseData);
                        if (Object.keys(changes).length > 0) {
                            addToChangeHistory('update', 'course', changes);
                        }
                    } else {
                        await db.collection('cursos').add(courseData);
                        addToChangeHistory('create', 'course', { nome: courseData.curso });
                    }
                } else {
                    const existingCourses = JSON.parse(localStorage.getItem('cursos') || '[]');
                    if (editingCourseId) {
                        const index = existingCourses.findIndex(c => c.id === editingCourseId);
                        if (index !== -1) {
                            existingCourses[index] = { ...existingCourses[index], ...courseData };
                            if (Object.keys(changes).length > 0) {
                                addToChangeHistory('update', 'course', changes);
                            }
                        }
                    } else {
                        courseData.id = 'course_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        existingCourses.push(courseData);
                        addToChangeHistory('create', 'course', { nome: courseData.curso });
                    }
                    localStorage.setItem('cursos', JSON.stringify(existingCourses));
                    loadFromLocalStorage();
                }
                
                if (editingCourseId) {
                    showToast('Curso atualizado com sucesso!', 'success');
                    logActivity('Edição de Curso', `Editou o curso "${courseData.curso || 'Sem nome'}"`, 'edit');
                } else {
                    showToast('Curso criado com sucesso!', 'success');
                    logActivity('Novo Curso', `Adicionou o curso "${courseData.curso || 'Sem nome'}"`, 'add');
                }
                closeModal('courseModal');
                
                // Atualizar renderização de forma otimizada
                requestAnimationFrame(() => {
                    renderCalendar();
                    renderDashboardReport();
                    if (document.getElementById('coursesPage')?.classList.contains('active')) {
                        renderCoursesByLote();
                    }
                });
            } catch (error) {
                console.error('Error saving course:', error);
                showToast('Erro ao salvar curso: ' + (error.message || 'Erro desconhecido'), 'error');
            } finally {
                setLoadingState(false);
            }
        }
        
        function isValidUrl(string) {
            try {
                const url = new URL(string);
                return url.protocol === 'http:' || url.protocol === 'https:';
            } catch (_) {
                return false;
            }
        }
        
        function setLoadingState(loading) {
            isLoading = loading;
            const overlay = document.getElementById('loadingOverlay');
            const buttons = document.querySelectorAll('button[type="submit"]');
            
            if (overlay) {
                if (loading) {
                    overlay.classList.add('active');
                } else {
                    overlay.classList.remove('active');
                }
            }
            
            buttons.forEach(btn => {
                if (loading) {
                    btn.disabled = true;
                    btn.style.opacity = '0.6';
                    btn.style.cursor = 'not-allowed';
                } else {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                }
            });
        }

        async function handleInstructorSubmit(e) {
            e.preventDefault();
            
            // Validações
            document.querySelectorAll('.form-error').forEach(el => el.classList.remove('show'));
            
            const nome = document.getElementById('instructorName').value.trim();
            const email = document.getElementById('instructorEmail').value.trim();
            const telefone = document.getElementById('instructorPhone').value.trim();
            
            let hasError = false;
            
            // Validar email se fornecido
            if (email && !isValidEmail(email)) {
                document.getElementById('instructorEmail').classList.add('error');
                showToast('Email inválido', 'error');
                hasError = true;
            }
            
            // Validar telefone se fornecido
            if (telefone && !isValidPhone(telefone)) {
                document.getElementById('instructorPhone').classList.add('error');
                showToast('Telefone inválido. Use o formato (00) 00000-0000', 'error');
                hasError = true;
            }
            
            if (hasError) return;
            
            const instructorData = {
                nome: nome || 'Instrutor sem nome',
                especialidade: document.getElementById('instructorSpecialty').value.trim(),
                telefone: telefone,
                email: email
            };
            
            // Remover classes de erro
            document.querySelectorAll('.form-input').forEach(el => el.classList.remove('error'));

            setLoadingState(true);

            try {
                if (firebaseAvailable) {
                    if (editingInstructorId) {
                        await db.collection('instrutores').doc(editingInstructorId).update(instructorData);
                    } else {
                        await db.collection('instrutores').add(instructorData);
                    }
                } else {
                    const existingInstructors = JSON.parse(localStorage.getItem('instrutores') || '[]');
                    if (editingInstructorId) {
                        const index = existingInstructors.findIndex(i => i.id === editingInstructorId);
                        if (index !== -1) {
                            existingInstructors[index] = { ...existingInstructors[index], ...instructorData };
                        }
                    } else {
                        instructorData.id = 'instructor_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        existingInstructors.push(instructorData);
                    }
                    localStorage.setItem('instrutores', JSON.stringify(existingInstructors));
                    loadFromLocalStorage();
                }
                
                if (editingInstructorId) {
                    showToast('Instrutor atualizado com sucesso!', 'success');
                    logActivity('Edição de Instrutor', `Editou o instrutor "${instructorData.nome || 'Sem nome'}"`, 'edit');
                } else {
                    showToast('Instrutor criado com sucesso!', 'success');
                    logActivity('Novo Instrutor', `Adicionou o instrutor "${instructorData.nome || 'Sem nome'}"`, 'add');
                }
                closeModal('instructorModal');
            } catch (error) {
                console.error('Error saving instructor:', error);
                showToast('Erro ao salvar instrutor: ' + (error.message || 'Erro desconhecido'), 'error');
            } finally {
                setLoadingState(false);
            }
        }
        
        function isValidEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }
        
        function isValidPhone(phone) {
            // Aceita formatos: (00) 00000-0000, (00) 0000-0000, 00000000000, etc.
            const cleaned = phone.replace(/\D/g, '');
            return cleaned.length >= 10 && cleaned.length <= 11;
        }

        async function handleQuickInstructorSubmit(e) {
            e.preventDefault();
            
            const nome = document.getElementById('quickInstructorName').value.trim();

            try {
                if (firebaseAvailable) {
                    await db.collection('instrutores').add({ nome: nome || 'Novo Instrutor' });
                } else {
                    const existingInstructors = JSON.parse(localStorage.getItem('instrutores') || '[]');
                    existingInstructors.push({
                        id: 'instructor_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        nome: nome || 'Novo Instrutor'
                    });
                    localStorage.setItem('instrutores', JSON.stringify(existingInstructors));
                    loadFromLocalStorage();
                }
                showToast('Instrutor adicionado!', 'success');
                logActivity('Novo Instrutor', `Adicionou o instrutor "${nome || 'Novo Instrutor'}" (rápido)`, 'add');
                closeModal('quickInstructorModal');
            } catch (error) {
                console.error('Error adding instructor:', error);
                showToast('Erro ao adicionar instrutor', 'error');
            }
        }

        async function handleUserSubmit(e) {
            e.preventDefault();
            
            // Validações
            document.querySelectorAll('.form-error').forEach(el => el.classList.remove('show'));
            
            const name = document.getElementById('newUserName').value.trim();
            const username = document.getElementById('newUserUsername').value.trim();
            const email = document.getElementById('newUserEmail').value.trim();
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value || 'viewer';
            
            let hasError = false;
            
            // Validar username (obrigatório e único)
            if (!username || username.length < 3) {
                document.getElementById('newUserUsername').classList.add('error');
                showToast('Username é obrigatório e deve ter pelo menos 3 caracteres', 'error');
                hasError = true;
            } else {
                // Verificar se username já existe
                const existingUser = usuarios.find(u => u.username === username && u.id !== editingUserId);
                if (existingUser) {
                    document.getElementById('newUserUsername').classList.add('error');
                    showToast('Username já está em uso', 'error');
                    hasError = true;
                }
            }
            
            // Validar email se fornecido
            if (email && !isValidEmail(email)) {
                document.getElementById('newUserEmail').classList.add('error');
                showToast('Email inválido', 'error');
                hasError = true;
            }
            
            // Validar senha (obrigatória para novos usuários)
            if (!editingUserId && (!password || password.length < 4)) {
                document.getElementById('newUserPassword').classList.add('error');
                showToast('Senha é obrigatória e deve ter pelo menos 4 caracteres', 'error');
                hasError = true;
            }
            
            // Validar senha se fornecida na edição
            if (editingUserId && password && password.length < 4) {
                document.getElementById('newUserPassword').classList.add('error');
                showToast('Senha deve ter pelo menos 4 caracteres', 'error');
                hasError = true;
            }
            
            if (hasError) return;
            
            const userData = {
                name: name || 'Novo Usuário',
                username: username,
                email: email,
                password: password || (editingUserId ? usuarios.find(u => u.id === editingUserId)?.password : '123456'),
                role: role
            };
            
            // Remover classes de erro
            document.querySelectorAll('.form-input').forEach(el => el.classList.remove('error'));

            setLoadingState(true);

            try {
                if (firebaseAvailable) {
                    if (editingUserId) {
                        await db.collection('usuarios').doc(editingUserId).update(userData);
                    } else {
                        await db.collection('usuarios').add(userData);
                    }
                } else {
                    const existingUsers = JSON.parse(localStorage.getItem('usuarios') || '[]');
                    if (editingUserId) {
                        const index = existingUsers.findIndex(u => u.id === editingUserId);
                        if (index !== -1) {
                            existingUsers[index] = { ...existingUsers[index], ...userData };
                        }
                    } else {
                        userData.id = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        existingUsers.push(userData);
                    }
                    localStorage.setItem('usuarios', JSON.stringify(existingUsers));
                    loadFromLocalStorage();
                }
                
                if (editingUserId) {
                    showToast('Usuário atualizado com sucesso!', 'success');
                    logActivity('Edição de Usuário', `Editou o usuário "${userData.name}"`, 'edit');
                } else {
                    showToast('Usuário criado com sucesso!', 'success');
                    logActivity('Novo Usuário', `Adicionou o usuário "${userData.name}"`, 'add');
                }
                closeModal('userModal');
            } catch (error) {
                console.error('Error saving user:', error);
                showToast('Erro ao salvar usuário: ' + (error.message || 'Erro desconhecido'), 'error');
            } finally {
                setLoadingState(false);
            }
        }

        async function handleChangePassword(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!currentPassword || !newPassword || !confirmPassword) {
                showToast('Preencha todos os campos', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showToast('As senhas não coincidem', 'error');
                return;
            }

            if (newPassword.length < 4) {
                showToast('A nova senha deve ter pelo menos 4 caracteres', 'error');
                return;
            }

            // Verificar senha atual
            if (currentUser.password !== currentPassword) {
                showToast('Senha atual incorreta', 'error');
                return;
            }

            try {
                if (firebaseAvailable) {
                    await db.collection('usuarios').doc(currentUser.id).update({ password: newPassword });
                } else {
                    const existingUsers = JSON.parse(localStorage.getItem('usuarios') || '[]');
                    const index = existingUsers.findIndex(u => u.id === currentUser.id);
                    if (index !== -1) {
                        existingUsers[index].password = newPassword;
                        localStorage.setItem('usuarios', JSON.stringify(existingUsers));
                    }
                }

                // Atualizar o usuário atual
                currentUser.password = newPassword;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));

                showToast('Senha alterada com sucesso!', 'success');
                logActivity('Alteração de Senha', `${currentUser.name} alterou sua senha`, 'edit');
                
                // Limpar formulário
                document.getElementById('changePasswordForm').reset();
            } catch (error) {
                console.error('Error changing password:', error);
                showToast('Erro ao alterar senha', 'error');
            }
        }

        async function handleChangeName(e) {
            e.preventDefault();
            
            const newName = document.getElementById('newAdminName').value.trim();
            const currentNameDisplay = document.getElementById('currentNameDisplay');

            if (!newName) {
                showToast('Digite um novo nome', 'error');
                return;
            }

            if (newName.length < 2) {
                showToast('O nome deve ter pelo menos 2 caracteres', 'error');
                return;
            }

            const oldName = currentUser.name;

            try {
                if (firebaseAvailable) {
                    await db.collection('usuarios').doc(currentUser.id).update({ name: newName });
                } else {
                    const existingUsers = JSON.parse(localStorage.getItem('usuarios') || '[]');
                    const index = existingUsers.findIndex(u => u.id === currentUser.id);
                    if (index !== -1) {
                        existingUsers[index].name = newName;
                        localStorage.setItem('usuarios', JSON.stringify(existingUsers));
                    }
                }

                // Atualizar o usuário atual
                currentUser.name = newName;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));

                // Atualizar a sidebar
                document.getElementById('userName').textContent = newName;
                document.getElementById('userAvatar').textContent = newName.charAt(0).toUpperCase();
                
                // Atualizar o campo de nome atual
                currentNameDisplay.value = newName;

                showToast('Nome alterado com sucesso!', 'success');
                logActivity('Alteração de Nome', `${oldName} alterou seu nome para "${newName}"`, 'edit');
                
                // Limpar formulário
                document.getElementById('newAdminName').value = '';
            } catch (error) {
                console.error('Error changing name:', error);
                showToast('Erro ao alterar nome', 'error');
            }
        }


        async function deleteCourse(id) {
            if (!confirm('Tem certeza que deseja excluir este curso?')) return;

            try {
                const course = cursos.find(c => c.id === id);
                
                if (firebaseAvailable) {
                    await db.collection('cursos').doc(id).delete();
                } else {
                    const existingCourses = JSON.parse(localStorage.getItem('cursos') || '[]');
                    const filteredCourses = existingCourses.filter(c => c.id !== id);
                    localStorage.setItem('cursos', JSON.stringify(filteredCourses));
                    loadFromLocalStorage();
                }
                
                if (course) {
                    addToChangeHistory('delete', 'course', { nome: course.curso || course.nome || 'Curso sem nome' });
                }
                
                showToast('Curso excluído!', 'success');
                logActivity('Exclusão de Curso', `Excluiu o curso "${course?.curso}"`, 'delete');
                
                    // Atualizar renderização
                    renderCalendar();
                    renderDashboardReport();
                    if (document.getElementById('coursesPage')?.classList.contains('active')) {
                        renderCoursesByLote();
                    }
            } catch (error) {
                console.error('Error deleting course:', error);
                showToast('Erro ao excluir curso', 'error');
            }
        }

        async function deleteInstructor(id) {
            if (!confirm('Tem certeza que deseja excluir este instrutor?')) return;

            try {
                const instructor = instrutores.find(i => i.id === id);
                
                if (firebaseAvailable) {
                    await db.collection('instrutores').doc(id).delete();
                } else {
                    const existingInstructors = JSON.parse(localStorage.getItem('instrutores') || '[]');
                    const filteredInstructors = existingInstructors.filter(i => i.id !== id);
                    localStorage.setItem('instrutores', JSON.stringify(filteredInstructors));
                    loadFromLocalStorage();
                }
                
                showToast('Instrutor excluído!', 'success');
                logActivity('Exclusão de Instrutor', `Excluiu o instrutor "${instructor?.nome}"`, 'delete');
            } catch (error) {
                console.error('Error deleting instructor:', error);
                showToast('Erro ao excluir instrutor', 'error');
            }
        }

        async function deleteUser(id) {
            if (!confirm('Tem certeza que deseja excluir este usuário?')) return;

            try {
                const user = usuarios.find(u => u.id === id);
                
                if (firebaseAvailable) {
                    await db.collection('usuarios').doc(id).delete();
                } else {
                    const existingUsers = JSON.parse(localStorage.getItem('usuarios') || '[]');
                    const filteredUsers = existingUsers.filter(u => u.id !== id);
                    localStorage.setItem('usuarios', JSON.stringify(filteredUsers));
                    loadFromLocalStorage();
                }
                
                showToast('Usuário excluído!', 'success');
                logActivity('Exclusão de Usuário', `Excluiu o usuário "${user?.name}"`, 'delete');
            } catch (error) {
                console.error('Error deleting user:', error);
                showToast('Erro ao excluir usuário', 'error');
            }
        }

        // Import/Export Functions
        async function handleExcelUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Validar tipo de arquivo
            const validTypes = ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 
                               'application/vnd.ms-excel',
                               'application/excel'];
            const validExtensions = ['.xlsx', '.xls'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            
            if (!validTypes.includes(file.type) && !validExtensions.includes(fileExtension)) {
                showToast('Por favor, selecione um arquivo Excel (.xlsx ou .xls)', 'error');
                return;
            }
            
            // Validar tamanho (máximo 10MB)
            if (file.size > 10 * 1024 * 1024) {
                showToast('Arquivo muito grande. Tamanho máximo: 10MB', 'error');
                return;
            }

            document.getElementById('selectedFileName').textContent = file.name;
            document.getElementById('fileInfoBox').classList.add('show');
            
            // Mostrar loading
            setLoadingState(true);
            showToast('Processando arquivo...', 'info');

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    // Usar cellDates: true para converter datas automaticamente
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    // raw: false converte valores, mas mantém datas como objetos Date quando possível
                    const json = XLSX.utils.sheet_to_json(worksheet, { raw: false, defval: '' });

                    let imported = 0;
                    let errors = [];
                    
                    // Processar em lotes para melhor performance
                    const batchSize = 10;
                    for (let i = 0; i < json.length; i += batchSize) {
                        const batch = json.slice(i, i + batchSize);
                        
                        for (const row of batch) {
                            try {
                        const loteValue = row['LOTE'] || row['lote'] || row['Lote'] || '';
                        
                        // Função auxiliar para buscar valor de coluna com múltiplas variações (case-insensitive e flexível)
                        function getColumnValue(row, variations) {
                            // Normalizar string para comparação (remover acentos, espaços extras, etc)
                            function normalizeForComparison(str) {
                                return str.toLowerCase()
                                    .trim()
                                    .replace(/\s+/g, ' ')
                                    .replace(/[çÇ]/g, 'c')
                                    .replace(/[áàâãä]/g, 'a')
                                    .replace(/[éèêë]/g, 'e')
                                    .replace(/[íìîï]/g, 'i')
                                    .replace(/[óòôõö]/g, 'o')
                                    .replace(/[úùûü]/g, 'u')
                                    .replace(/[ñ]/g, 'n');
                            }
                            
                            // Primeiro, tentar variações exatas
                            for (const variation of variations) {
                                if (row[variation] !== undefined && row[variation] !== null && row[variation] !== '') {
                                    const value = row[variation];
                                    // Se for Date, retornar diretamente
                                    if (value instanceof Date) return value;
                                    // Caso contrário, converter para string
                                    const strValue = String(value).trim();
                                    if (strValue) return strValue;
                                }
                            }
                            
                            // Se não encontrou, tentar busca case-insensitive e flexível
                            const rowKeys = Object.keys(row);
                            for (const variation of variations) {
                                const variationNormalized = normalizeForComparison(variation);
                                for (const key of rowKeys) {
                                    const keyNormalized = normalizeForComparison(key);
                                    if (keyNormalized === variationNormalized) {
                                        const value = row[key];
                                        // Se for Date, retornar diretamente
                                        if (value instanceof Date) {
                                            if (i === 0 && imported === 0) {
                                                console.log(`✓ Encontrado "${variation}" como "${key}" com valor Date:`, value);
                                            }
                                            return value;
                                        }
                                        // Caso contrário, converter para string
                                        const strValue = String(value).trim();
                                        if (strValue) {
                                            if (i === 0 && imported === 0) {
                                                console.log(`✓ Encontrado "${variation}" como "${key}" com valor:`, strValue);
                                            }
                                            return strValue;
                                        }
                                    }
                                }
                            }
                            
                            // Última tentativa: busca parcial (contém)
                            for (const variation of variations) {
                                const variationNormalized = normalizeForComparison(variation);
                                // Buscar palavras-chave importantes
                                const keywords = variationNormalized.split(' ').filter(w => w.length > 3);
                                for (const key of rowKeys) {
                                    const keyNormalized = normalizeForComparison(key);
                                    // Verificar se todas as palavras-chave estão presentes
                                    if (keywords.length > 0 && keywords.every(kw => keyNormalized.includes(kw))) {
                                        const value = row[key];
                                        // Se for Date, retornar diretamente
                                        if (value instanceof Date) {
                                            if (i === 0 && imported === 0) {
                                                console.log(`✓ Encontrado "${variation}" parcialmente como "${key}" com valor Date:`, value);
                                            }
                                            return value;
                                        }
                                        // Caso contrário, converter para string
                                        const strValue = String(value).trim();
                                        if (strValue) {
                                            if (i === 0 && imported === 0) {
                                                console.log(`✓ Encontrado "${variation}" parcialmente como "${key}" com valor:`, strValue);
                                            }
                                            return strValue;
                                        }
                                    }
                                }
                            }
                            
                            return '';
                        }
                        
                        // Buscar endereço com todas as variações possíveis
                        const endereco = getColumnValue(row, [
                            'ENDEREÇO', 'endereço', 'Endereço', 'ENDERECO', 'endereco', 'Endereco',
                            'LOCAL DO CURSO', 'local do curso', 'Local do Curso', 'Local Do Curso',
                            'LOCAL', 'local', 'Local',
                            'LOCAL_DO_CURSO', 'local_do_curso', 'Local_Do_Curso'
                        ]);
                        
                        // Debug do endereço encontrado (apenas primeira linha)
                        if (i === 0 && imported === 0 && !endereco) {
                            console.warn('⚠ Endereço NÃO encontrado. Colunas disponíveis:', Object.keys(row));
                        }
                        
                        const courseData = {
                            curso: getColumnValue(row, ['CURSO', 'curso', 'Curso']) || '',
                            idLote: parseInt(getColumnValue(row, ['ID', 'id', 'Id']) || '0') || 0,
                            lote: loteValue,
                            loteResponsavel: loteValue,
                            cidade: getColumnValue(row, ['CIDADE', 'cidade', 'Cidade', 'CIDADE ', 'cidade ']) || '',
                            inicio: (() => {
                                const dateValue = getColumnValue(row, [
                                    'DATA INÍCIO', 'DATA INICIO', 'data início', 'data inicio', 
                                    'INÍCIO', 'inicio', 'INICIO', 'Data Início', 'Data Inicio',
                                    'DATA INICIO', 'Data Inicio', 'Data inicio'
                                ]);
                                // Se for um objeto Date, converter diretamente
                                if (dateValue instanceof Date) {
                                    const year = dateValue.getFullYear();
                                    const month = String(dateValue.getMonth() + 1).padStart(2, '0');
                                    const day = String(dateValue.getDate()).padStart(2, '0');
                                    const formatted = `${year}-${month}-${day}`;
                                    if (i === 0 && imported === 0) {
                                        console.log('Data início (Date object):', dateValue, '→ Formatada:', formatted);
                                    }
                                    return formatted;
                                }
                                
                                const formatted = formatExcelDate(dateValue);
                                if (i === 0 && imported === 0 && dateValue) {
                                    console.log('Data início original:', dateValue, typeof dateValue, '→ Formatada:', formatted);
                                }
                                return formatted;
                            })(),
                            fim: (() => {
                                const dateValue = getColumnValue(row, [
                                    'DATA FIM', 'data fim', 'FIM', 'fim', 'Data Fim',
                                    'DATA FIM ', 'Data Fim', 'Data fim'
                                ]);
                                
                                // Se for um objeto Date, converter diretamente
                                if (dateValue instanceof Date) {
                                    const year = dateValue.getFullYear();
                                    const month = String(dateValue.getMonth() + 1).padStart(2, '0');
                                    const day = String(dateValue.getDate()).padStart(2, '0');
                                    const formatted = `${year}-${month}-${day}`;
                                    if (i === 0 && imported === 0) {
                                        console.log('Data fim (Date object):', dateValue, '→ Formatada:', formatted);
                                    }
                                    return formatted;
                                }
                                
                                const formatted = formatExcelDate(dateValue);
                                if (i === 0 && imported === 0 && dateValue) {
                                    console.log('Data fim original:', dateValue, typeof dateValue, '→ Formatada:', formatted);
                                }
                                return formatted;
                            })(),
                            local: endereco,
                            status: normalizeStatus(getColumnValue(row, ['STATUS', 'status', 'Status']) || 'Pendente'),
                            alunos: parseInt(getColumnValue(row, ['CONCLUDENTES', 'concludentes', 'Concludentes']) || '0') || 0,
                            cargaHoraria: getColumnValue(row, [
                                'CARGA HORÁRIA', 'carga horária', 'CARGA HORARIA', 'carga horaria',
                                'Carga Horária', 'Carga Horaria', 'CARGA_HORÁRIA', 'carga_horária'
                            ]) || '',
                            instrutor: getColumnValue(row, ['INSTRUTOR', 'instrutor', 'Instrutor']) || '',
                            telefone: getColumnValue(row, ['TELEFONE', 'telefone', 'Telefone']) || '',
                            driveLink: '',
                            nota: ''
                        };

                        const newId = 'course_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9) + '_' + imported;
                        const courseWithId = {...courseData, id: newId};
                        
                        if (firebaseAvailable) {
                            try {
                                const docRef = await db.collection('cursos').add(courseData);
                                const courseWithFirebaseId = {...courseData, id: docRef.id};
                                cursos.push(courseWithFirebaseId);
                                        imported++;
                            } catch (err) {
                                console.error('Erro ao adicionar curso no Firebase:', err);
                                        errors.push(`Linha ${i + 1}: ${err.message || 'Erro desconhecido'}`);
                            }
                        } else {
                            const existingCourses = JSON.parse(localStorage.getItem('cursos') || '[]');
                            existingCourses.push(courseWithId);
                            cursos.push(courseWithId);
                            localStorage.setItem('cursos', JSON.stringify(existingCourses));
                        imported++;
                                }
                            } catch (err) {
                                console.error('Erro ao processar linha:', err);
                                errors.push(`Linha ${i + 1}: ${err.message || 'Erro ao processar'}`);
                            }
                        }
                        
                        // Pequeno delay entre lotes para não sobrecarregar
                        if (i + batchSize < json.length) {
                            await new Promise(resolve => setTimeout(resolve, 50));
                        }
                    }

                    // Sempre remover loading primeiro
                    setLoadingState(false);

                    if (imported > 0) {
                        let message = `${imported} curso${imported !== 1 ? 's' : ''} importado${imported !== 1 ? 's' : ''} com sucesso!`;
                        if (errors.length > 0) {
                            message += ` (${errors.length} erro${errors.length !== 1 ? 's' : ''})`;
                        }
                        showToast(message, errors.length > 0 ? 'warning' : 'success');
                        logActivity('Importação', `Importou ${imported} curso${imported !== 1 ? 's' : ''} de planilha`, 'add');
                        
                        // Atualizar KPIs e renderizações de forma otimizada
                        requestAnimationFrame(() => {
                        updateKPIs();
                        renderCalendar();
                        renderDashboardReport();
                        if (document.getElementById('coursesPage')?.classList.contains('active')) {
                            renderCoursesByLote();
                        }
                        });
                        
                        // Se Firebase, aguardar atualização completa do banco
                        if (firebaseAvailable) {
                            setTimeout(() => {
                                loadData();
                            }, 1000);
                    } else {
                            // Atualizar dados locais
                            loadFromLocalStorage();
                    }
                    } else {
                        if (json.length === 0) {
                            showToast('Planilha vazia ou formato inválido. Verifique o arquivo.', 'error');
                    } else {
                        showToast('Nenhum curso foi importado. Verifique o formato da planilha.', 'warning');
                        }
                    }
                    
                    // Limpar o input de arquivo
                    const excelFileInput = document.getElementById('excelFileInput');
                    if (excelFileInput) {
                        excelFileInput.value = '';
                    }
                    const fileInfoBox = document.getElementById('fileInfoBox');
                    if (fileInfoBox) {
                        fileInfoBox.classList.remove('show');
                    }
                } catch (error) {
                    console.error('Error importing:', error);
                    setLoadingState(false); // Garantir que o loading seja removido mesmo em caso de erro
                    showToast('Erro ao importar arquivo: ' + (error.message || 'Erro desconhecido'), 'error');
                    
                    // Limpar o input de arquivo mesmo em caso de erro
                    const excelFileInput = document.getElementById('excelFileInput');
                    if (excelFileInput) {
                        excelFileInput.value = '';
                    }
                    const fileInfoBox = document.getElementById('fileInfoBox');
                    if (fileInfoBox) {
                        fileInfoBox.classList.remove('show');
                    }
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function formatExcelDate(value) {
            if (!value && value !== 0) return '';
            
            // Se for número (serial date do Excel)
            if (typeof value === 'number') {
                try {
                    // Excel serial date: número de dias desde 1/1/1900
                    // Excel usa 1/1/1900 como dia 1, mas JavaScript usa 1/1/1970 como epoch
                    // Ajuste: Excel epoch é 25569 dias antes do Unix epoch
                    const excelEpoch = new Date(1899, 11, 30); // 30/12/1899 (dia 0 do Excel)
                    const millisecondsPerDay = 86400 * 1000;
                    
                    // Validar se o número é razoável (entre 1 e 100000, que cobre de 1900 a ~2173)
                    if (value < 1 || value > 100000) {
                        console.warn('Valor de data Excel fora do range esperado:', value);
                        return '';
                    }
                    
                    const date = new Date(excelEpoch.getTime() + (value - 1) * millisecondsPerDay);
                    
                    // Verificar se a data é válida
                    if (!isNaN(date.getTime()) && date.getFullYear() >= 1900 && date.getFullYear() <= 2100) {
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        return `${year}-${month}-${day}`;
                    } else {
                        console.warn('Data inválida gerada:', date, 'do valor:', value);
                    }
                } catch (e) {
                    console.warn('Erro ao converter data numérica:', value, e);
                }
            }
            
            // Se for string, tentar vários formatos
            if (typeof value === 'string') {
                const trimmed = value.trim();
                if (!trimmed) return '';
                
                // Remover caracteres estranhos que podem aparecer
                const cleaned = trimmed.replace(/[^\d\/\-\.]/g, '');
                
                // Formato brasileiro: DD/MM/YYYY ou DD-MM-YYYY
                const brFormat = cleaned.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
                if (brFormat) {
                    let day = brFormat[1].padStart(2, '0');
                    let month = brFormat[2].padStart(2, '0');
                    let year = brFormat[3];
                    if (year.length === 2) {
                        year = '20' + year; // Assume século 21
                    }
                    // Validar valores
                    const dayNum = parseInt(day);
                    const monthNum = parseInt(month);
                    const yearNum = parseInt(year);
                    if (dayNum >= 1 && dayNum <= 31 && monthNum >= 1 && monthNum <= 12 && yearNum >= 1900 && yearNum <= 2100) {
                        const date = new Date(`${year}-${month}-${day}`);
                        if (!isNaN(date.getTime())) {
                    return date.toISOString().split('T')[0];
                }
                    }
                }
                
                // Formato ISO: YYYY-MM-DD
                const isoFormat = cleaned.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
                if (isoFormat) {
                    const year = isoFormat[1];
                    const month = isoFormat[2].padStart(2, '0');
                    const day = isoFormat[3].padStart(2, '0');
                    const date = new Date(`${year}-${month}-${day}`);
                    if (!isNaN(date.getTime())) {
                        return date.toISOString().split('T')[0];
                    }
                }
                
                // Tentar parse direto (pode ser uma data já formatada)
                try {
                    const date = new Date(trimmed);
                    if (!isNaN(date.getTime()) && date.getFullYear() >= 1900 && date.getFullYear() <= 2100) {
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        return `${year}-${month}-${day}`;
                    }
                } catch (e) {
                    console.warn('Erro ao fazer parse da data:', trimmed, e);
                }
            }
            
            // Se chegou aqui, não conseguiu converter
            console.warn('Não foi possível converter a data:', value, typeof value);
            return '';
        }
        
        // Função para importar instrutores
        async function handleInstructorsUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Validar tipo de arquivo
            const validTypes = ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 
                               'application/vnd.ms-excel',
                               'application/excel'];
            const validExtensions = ['.xlsx', '.xls'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            
            if (!validTypes.includes(file.type) && !validExtensions.includes(fileExtension)) {
                showToast('Por favor, selecione um arquivo Excel (.xlsx ou .xls)', 'error');
                return;
            }
            
            // Validar tamanho (máximo 10MB)
            if (file.size > 10 * 1024 * 1024) {
                showToast('Arquivo muito grande. Tamanho máximo: 10MB', 'error');
                return;
            }
            
            // Mostrar loading
            setLoadingState(true);
            showToast('Processando arquivo de instrutores...', 'info');
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    // Usar cellDates: true para converter datas automaticamente
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    // raw: false converte valores, mas mantém datas como objetos Date quando possível
                    const json = XLSX.utils.sheet_to_json(worksheet, { raw: false, defval: '' });
                    
                    let imported = 0;
                    let errors = [];
                    
                    for (let i = 0; i < json.length; i++) {
                        const row = json[i];
                        try {
                            const nome = (row['NOME'] || row['nome'] || '').trim();
                            const telefone = (row['TELEFONE'] || row['telefone'] || '').trim();
                            
                            // Validar que pelo menos o nome foi fornecido
                            if (!nome) {
                                errors.push(`Linha ${i + 2}: Nome não fornecido`);
                                continue;
                            }
                            
                            const instructorData = {
                                nome: nome,
                                telefone: telefone,
                                especialidade: '',
                                email: ''
                            };
                            
                            if (firebaseAvailable) {
                                try {
                                    await db.collection('instrutores').add(instructorData);
                                    imported++;
                                } catch (err) {
                                    console.error('Erro ao adicionar instrutor no Firebase:', err);
                                    errors.push(`Linha ${i + 2}: ${err.message || 'Erro desconhecido'}`);
                                }
                            } else {
                                const existingInstructors = JSON.parse(localStorage.getItem('instrutores') || '[]');
                                instructorData.id = 'instructor_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9) + '_' + imported;
                                existingInstructors.push(instructorData);
                                instrutores.push(instructorData);
                                localStorage.setItem('instrutores', JSON.stringify(existingInstructors));
                                imported++;
                            }
                        } catch (err) {
                            console.error('Erro ao processar linha:', err);
                            errors.push(`Linha ${i + 2}: ${err.message || 'Erro ao processar'}`);
                        }
                    }
                    
                    // Sempre remover loading primeiro
                    setLoadingState(false);
                    
                    if (imported > 0) {
                        let message = `${imported} instrutor${imported !== 1 ? 'es' : ''} importado${imported !== 1 ? 's' : ''} com sucesso!`;
                        if (errors.length > 0) {
                            message += ` (${errors.length} erro${errors.length !== 1 ? 's' : ''})`;
                        }
                        showToast(message, errors.length > 0 ? 'warning' : 'success');
                        logActivity('Importação de Instrutores', `Importou ${imported} instrutor${imported !== 1 ? 'es' : ''} de planilha`, 'add');
                        
                        // Atualizar renderização
                        requestAnimationFrame(() => {
                            renderInstructors();
                            updateInstructorSelect();
                        });
                        
                        // Se Firebase, aguardar atualização completa do banco
                        if (firebaseAvailable) {
                            setTimeout(() => {
                                loadData();
                            }, 1000);
                        } else {
                            loadFromLocalStorage();
                        }
                    } else {
                        if (json.length === 0) {
                            showToast('Planilha vazia ou formato inválido. Verifique o arquivo.', 'error');
                        } else {
                            showToast('Nenhum instrutor foi importado. Verifique o formato da planilha (colunas: NOME, TELEFONE).', 'warning');
                        }
                    }
                    
                    // Limpar o input de arquivo
                    const instructorsFileInput = document.getElementById('instructorsFileInput');
                    if (instructorsFileInput) {
                        instructorsFileInput.value = '';
                    }
                } catch (error) {
                    console.error('Error importing instructors:', error);
                    setLoadingState(false);
                    showToast('Erro ao importar arquivo: ' + (error.message || 'Erro desconhecido'), 'error');
                    
                    // Limpar o input de arquivo mesmo em caso de erro
                    const instructorsFileInput = document.getElementById('instructorsFileInput');
                    if (instructorsFileInput) {
                        instructorsFileInput.value = '';
                    }
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function exportCoursesToCsv() {
            const headers = ['CURSO', 'ID', 'LOTE-RESPONSÁVEL', 'CARGA HORÁRIA', 'CIDADE/MUNICÍPIO', 'INÍCIO', 'FIM', 'CONCLUDENTES', 'LOCAL DO CURSO', 'INSTRUTOR', 'STATUS', 'GOOGLE DRIVE', 'OBSERVAÇÃO'];
            const rows = cursos.map(c => [
                c.curso || '',
                c.idLote || '',
                c.loteResponsavel || '',
                c.cargaHoraria || '', // Adicionado Carga Horária
                c.cidade || '',
                c.inicio || '',
                c.fim || '',
                c.alunos || 0,
                c.local || '',
                c.instrutor || '',
                c.status || '',
                c.driveLink || '',
                c.nota || '' // Adicionado nota
            ]);

            downloadCsv([headers, ...rows], 'cursos.csv');
            showToast('Cursos exportados!', 'success');
        }

        function exportInstructorsToCsv() {
            const headers = ['NOME', 'ESPECIALIDADE', 'TELEFONE', 'EMAIL'];
            const rows = instrutores.map(i => [
                i.nome || '',
                i.especialidade || '',
                i.telefone || '',
                i.email || ''
            ]);

            downloadCsv([headers, ...rows], 'instrutores.csv');
            showToast('Instrutores exportados!', 'success');
        }

        function downloadCsv(data, filename) {
            const csv = data.map(row => 
                row.map(cell => {
                    const escapedCell = String(cell).replace(/"/g, '""');
                    return `"${escapedCell}"`;
                }).join(',')
            ).join('\n');
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        async function clearAllData() {
            if (!confirm('ATENÇÃO: Esta ação irá excluir TODOS os cursos e instrutores. Deseja continuar?')) return;
            if (!confirm('Tem certeza absoluta? Esta ação não pode ser desfeita!')) return;

            try {
                if (firebaseAvailable) {
                    const coursesSnapshot = await db.collection('cursos').get();
                    const instructorsSnapshot = await db.collection('instrutores').get();

                    const batch = db.batch();
                    coursesSnapshot.docs.forEach(doc => batch.delete(doc.ref));
                    instructorsSnapshot.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                } else {
                    localStorage.setItem('cursos', JSON.stringify([]));
                    localStorage.setItem('instrutores', JSON.stringify([]));
                }

                showToast('Todos os dados foram excluídos!', 'success');
                logActivity('Limpeza de Dados', 'Excluiu todos os cursos e instrutores', 'delete');
                loadData();
            } catch (error) {
                console.error('Error clearing data:', error);
                showToast('Erro ao limpar dados', 'error');
            }
        }

        function openReportModal() {
            generateReport();
            document.getElementById('reportModal').classList.add('active');
        }

        function generateReport() {
            // Mostrar todos os cursos (sem filtro de período)
            let coursesToReport = [...cursos];
            
            const total = coursesToReport.length;
            const concluidos = coursesToReport.filter(c => normalizeStatus(c.status) === 'Concluído').length;
            const andamento = coursesToReport.filter(c => normalizeStatus(c.status) === 'Em Andamento').length;
            const pendentes = coursesToReport.filter(c => normalizeStatus(c.status) === 'Pendente').length;
            const cancelados = coursesToReport.filter(c => normalizeStatus(c.status) === 'Cancelado').length;
            const totalAlunos = coursesToReport.reduce((sum, c) => sum + (parseInt(c.alunos) || 0), 0);

            const today = new Date();
            const reportDate = today.toLocaleDateString('pt-BR', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            // Cursos por cidade
            const cursosporCidade = {};
            coursesToReport.forEach(c => {
                const cidade = c.cidade || 'Não definido';
                cursosporCidade[cidade] = (cursosporCidade[cidade] || 0) + 1;
            });

            document.getElementById('reportContent').innerHTML = `
                <div class="report-header">
                    <h2>
                        <span class="material-icons" style="color: var(--primary);">assessment</span>
                        CSF Manager - Relatório de Cursos
                    </h2>
                    <p>${reportDate}</p>
                </div>

                <div class="report-kpi-grid">
                    <div class="report-kpi-card purple">
                        <div class="report-kpi-value">${total}</div>
                        <div class="report-kpi-label">Total de Cursos</div>
                    </div>
                    <div class="report-kpi-card green">
                        <div class="report-kpi-value">${concluidos}</div>
                        <div class="report-kpi-label">Concluídos</div>
                    </div>
                    <div class="report-kpi-card blue">
                        <div class="report-kpi-value">${andamento}</div>
                        <div class="report-kpi-label">Em Andamento</div>
                    </div>
                    <div class="report-kpi-card yellow">
                        <div class="report-kpi-value">${pendentes}</div>
                        <div class="report-kpi-label">Pendentes</div>
                    </div>
                    <div class="report-kpi-card red">
                        <div class="report-kpi-value">${cancelados}</div>
                        <div class="report-kpi-label">Cancelados</div>
                    </div>
                    <div class="report-kpi-card">
                        <div class="report-kpi-value">${totalAlunos}</div>
                        <div class="report-kpi-label">Concludentes</div>
                    </div>
                </div>

                <div class="report-section">
                    <h3>
                        <span class="material-icons">pie_chart</span>
                        Distribuição por Status
                    </h3>
                    <div class="report-chart">
                        <canvas id="statusChart" width="280" height="280"></canvas>
                    </div>
                </div>

                <div class="report-section">
                    <h3>
                        <span class="material-icons">location_city</span>
                        Cursos por Cidade
                    </h3>
                    <div class="report-city-grid">
                        ${Object.entries(cursosporCidade).map(([cidade, qtd]) => `
                            <div class="report-city-item">
                                <span class="report-city-name">${cidade}</span>
                                <span class="report-city-count">${qtd}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="report-section">
                    <h3>
                        <span class="material-icons">list</span>
                        Lista de Cursos ${coursesToReport.length > 15 ? '(Primeiros 15)' : ''}
                    </h3>
                    <table class="report-table">
                        <tr>
                            <th>Curso</th>
                            <th>Cidade</th>
                            <th>Período</th>
                            <th>Status</th>
                        </tr>
                        ${coursesToReport.slice(0, 15).map(c => `
                            <tr>
                                <td>${c.curso || 'N/A'}</td>
                                <td>${c.cidade || 'N/A'}</td>
                                <td>${formatDate(c.inicio)} - ${formatDate(c.fim)}</td>
                                <td>${c.status || 'Pendente'}</td>
                            </tr>
                        `).join('')}
                        ${cursos.length > 15 ? `<tr><td colspan="4" style="text-align: center; opacity: 0.7;">... e mais ${cursos.length - 15} cursos</td></tr>` : ''}
                    </table>
                </div>
            `;

            setTimeout(() => {
                const ctx = document.getElementById('statusChart')?.getContext('2d');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Concluídos', 'Em Andamento', 'Pendentes', 'Cancelados'],
                            datasets: [{
                                data: [concluidos, andamento, pendentes, cancelados],
                                backgroundColor: ['#34d399', '#60a5fa', '#fbbf24', '#f87171'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: false,
                            maintainAspectRatio: false,
                            cutout: '60%',
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        color: '#ffffff',
                                        padding: 15,
                                        font: {
                                            size: 12
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }, 100);
        }

        async function downloadReportAsImage() {
            // Tentar encontrar o relatório no dashboard primeiro
            let element = document.getElementById('dashboardReport');
            
            // Se não encontrar ou estiver vazio, tentar no modal
            if (!element || !element.innerHTML.trim()) {
                element = document.getElementById('reportContent');
            }
            
            if (!element || !element.innerHTML.trim()) {
                showToast('Relatório não encontrado. Gere o relatório primeiro.', 'warning');
                return;
            }
            
            try {
                setLoadingState(true);
                showToast('Gerando relatório...', 'info');
                
                // Aguardar um pouco para garantir que o conteúdo está renderizado
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Verificar se html2canvas está disponível
                if (typeof html2canvas === 'undefined') {
                    showToast('Biblioteca html2canvas não carregada. Recarregue a página.', 'error');
                    setLoadingState(false);
                    return;
                }
                
                const isLightMode = document.documentElement.classList.contains('light-mode');
                const canvas = await html2canvas(element, {
                    backgroundColor: isLightMode ? '#f8fafc' : '#0f172a',
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    allowTaint: true,
                    windowWidth: element.scrollWidth,
                    windowHeight: element.scrollHeight
                });
                
                const link = document.createElement('a');
                const date = new Date().toISOString().split('T')[0];
                link.download = `relatorio-cursos-${date}.png`;
                link.href = canvas.toDataURL('image/png');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast('Relatório baixado com sucesso!', 'success');
            } catch (error) {
                console.error('Error generating image:', error);
                showToast('Erro ao gerar imagem: ' + (error.message || 'Erro desconhecido'), 'error');
            } finally {
                setLoadingState(false);
            }
        }

        // Utility Functions
        function formatDate(dateStr) {
            if (!dateStr) return 'Não informado';
            
            // Se já estiver no formato brasileiro, retornar como está
            if (typeof dateStr === 'string' && /^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) {
                return dateStr;
            }
            
            try {
                // Tentar formato ISO (YYYY-MM-DD)
                if (typeof dateStr === 'string' && dateStr.includes('-')) {
                    const parts = dateStr.split('-');
                    if (parts.length === 3) {
                        const [year, month, day] = parts;
                        // Validar se são números válidos
                        const yearNum = parseInt(year);
                        const monthNum = parseInt(month);
                        const dayNum = parseInt(day);
                        
                        if (!isNaN(yearNum) && !isNaN(monthNum) && !isNaN(dayNum) &&
                            yearNum >= 1900 && yearNum <= 2100 &&
                            monthNum >= 1 && monthNum <= 12 &&
                            dayNum >= 1 && dayNum <= 31) {
                return `${day.padStart(2, '0')}/${month.padStart(2, '0')}/${year}`;
                        }
                    }
                }
                
                // Tentar parse como Date
                const date = new Date(dateStr);
                if (!isNaN(date.getTime()) && date.getFullYear() >= 1900 && date.getFullYear() <= 2100) {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${day}/${month}/${year}`;
                }
            } catch (e) {
                console.warn('Erro ao formatar data:', dateStr, e);
            }
            
            // Se não conseguiu formatar, retornar "Não informado" em vez do valor original
            return 'Não informado';
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleString('pt-BR');
        }

        function normalizeStatus(status) {
            if (!status) return 'Pendente';
            // Normalizar: remover espaços extras, converter para primeira letra maiúscula
            const normalized = status.toString().trim();
            
            // Mapear variações comuns
            const statusMap = {
                'concluido': 'Concluído',
                'concluído': 'Concluído',
                'concluida': 'Concluído',
                'concluída': 'Concluído',
                'concluidos': 'Concluído',
                'concluídos': 'Concluído',
                'concluido ': 'Concluído',
                'concluído ': 'Concluído',
                'em andamento': 'Em Andamento',
                'em andamento ': 'Em Andamento',
                'andamento': 'Em Andamento',
                'pendente': 'Pendente',
                'pendente ': 'Pendente',
                'cancelado': 'Cancelado',
                'cancelada': 'Cancelado',
                'cancelados': 'Cancelado',
                'canceladas': 'Cancelado',
                'cancelado ': 'Cancelado'
            };
            
            const lower = normalized.toLowerCase();
            if (statusMap[lower]) {
                return statusMap[lower];
            }
            
            // Se já está no formato correto, retornar como está
            if (['Concluído', 'Em Andamento', 'Pendente', 'Cancelado'].includes(normalized)) {
                return normalized;
            }
            
            // Tentar capitalizar primeira letra de cada palavra
            return normalized.split(' ').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
            ).join(' ');
        }

        function getStatusClass(status) {
            const normalized = normalizeStatus(status);
            const classes = {
                'Concluído': 'concluido',
                'Em Andamento': 'andamento',
                'Pendente': 'pendente',
                'Cancelado': 'cancelado'
            };
            return classes[normalized] || 'pendente';
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'check_circle',
                error: 'error',
                warning: 'warning',
                info: 'info'
            };
            
            toast.innerHTML = `
                <span class="material-icons">${icons[type] || icons.success}</span>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            
            // Animar entrada
            requestAnimationFrame(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(0)';
            });
            
            // Remover após 4 segundos (aumentado de 3 para melhor leitura)
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        async function logActivity(action, description, type = 'add') {
            const logEntry = {
                action,
                description,
                type,
                user: currentUser?.name || 'Sistema',
                timestamp: firebaseAvailable ? firebase.firestore.FieldValue.serverTimestamp() : new Date()
            };

            try {
                if (firebaseAvailable) {
                    await db.collection('activities').add(logEntry);
                } else {
                    const currentLogs = JSON.parse(localStorage.getItem('activityLogs') || '[]');
                    currentLogs.unshift({...logEntry, timestamp: new Date()});
                    localStorage.setItem('activityLogs', JSON.stringify(currentLogs.slice(0, 100)));
                    renderActivityLogs();
                }
            } catch (error) {
                console.error('Error logging activity:', error);
            }
        }

        function setupDragAndDrop() {
            const uploadZone = document.getElementById('uploadZone');
            const excelFileInput = document.getElementById('excelFileInput');

            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('drag-over');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('drag-over');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('drag-over');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    excelFileInput.files = files;
                    handleExcelUpload({ target: excelFileInput });
                }
            });

            // Prevent default drag behaviors for the whole document
            document.addEventListener('dragover', (e) => e.preventDefault());
            document.addEventListener('drop', (e) => e.preventDefault());
        }

        // Função para filtrar cursos por LOTE

        // Função para renderizar cursos organizados por LOTE
        function renderCoursesByLote() {
            const container = document.getElementById('coursesByLoteContainer');
            if (!container) return;

            let filtered = cursos;
            
            // Aplicar filtros avançados
            filtered = filterCourses(filtered);
            
            // Aplicar ordenação
            filtered = sortCourses(filtered);
            
            // Aplicar paginação
            const totalItems = filtered.length;
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedCourses = filtered.slice(startIndex, endIndex);
            
            // Renderizar paginação
            renderPagination(totalItems);
            
            // Renderizar todos os cursos sem organização por LOTE
            if (paginatedCourses.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <span class="material-icons">school</span>
                        <h3>Nenhum curso encontrado</h3>
                        <p>${filtered.length === 0 ? 'Adicione seu primeiro curso' : 'Nenhum curso corresponde aos filtros aplicados'}</p>
                    </div>
                `;
                return;
            }

            // Renderizar baseado no modo de visualização
            let coursesHTML = '';
            const statusClass = (course) => getStatusClass(course.status);
            const canEdit = currentUser?.role !== 'viewer';

            if (currentViewMode === 'list') {
                // Modo Lista
                coursesHTML = `
                    <div class="courses-list" style="display: flex; flex-direction: column; gap: 1rem;">
                        ${paginatedCourses.map(course => `
                            <div class="course-card" style="display: flex; align-items: center; gap: 1.5rem; padding: 1.5rem;" onclick="openViewCourseModal('${course.id}')">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                                        <h3 style="margin: 0; font-size: 1.1rem;">${course.curso || 'Sem nome'}</h3>
                                        <span class="status-badge ${statusClass(course)}">${normalizeStatus(course.status)}</span>
                            </div>
                                    <div style="display: flex; gap: 2rem; flex-wrap: wrap; color: var(--text-secondary); font-size: 0.875rem;">
                                        <span><span class="material-icons" style="font-size: 16px; vertical-align: middle;">location_on</span> ${course.cidade || 'N/A'}</span>
                                        <span><span class="material-icons" style="font-size: 16px; vertical-align: middle;">event</span> ${course.inicio && course.fim ? formatDate(course.inicio) + ' - ' + formatDate(course.fim) : 'N/A'}</span>
                                        <span><span class="material-icons" style="font-size: 16px; vertical-align: middle;">person</span> ${course.instrutor || 'N/A'}</span>
                                        <span><span class="material-icons" style="font-size: 16px; vertical-align: middle;">groups</span> ${course.alunos || 0} concludentes</span>
                                    </div>
                                </div>
                                ${canEdit ? `
                                    <div class="course-actions" onclick="event.stopPropagation()">
                                        <button onclick="openCourseModal('${course.id}')" title="Editar">
                                    <span class="material-icons">edit</span>
                                </button>
                                        <button class="delete" onclick="deleteCourse('${course.id}')" title="Excluir">
                                            <span class="material-icons">delete</span>
                                        </button>
                                    </div>
                            ` : ''}
                        </div>
                        `).join('')}
                    </div>
                `;
            } else if (currentViewMode === 'timeline') {
                // Modo Timeline
                const sortedByDate = [...paginatedCourses].sort((a, b) => {
                    const dateA = a.inicio ? new Date(a.inicio) : new Date(0);
                    const dateB = b.inicio ? new Date(b.inicio) : new Date(0);
                    return dateA - dateB;
                });
                
                coursesHTML = `
                    <div class="courses-timeline" style="position: relative; padding-left: 2rem;">
                        ${sortedByDate.map((course, index) => {
                            const date = course.inicio ? new Date(course.inicio) : null;
                                return `
                                <div class="timeline-item" style="position: relative; margin-bottom: 2rem; padding-left: 2rem;">
                                    <div style="position: absolute; left: -8px; top: 0; width: 16px; height: 16px; background: var(--primary); border-radius: 50%; border: 3px solid var(--background);"></div>
                                    ${index < sortedByDate.length - 1 ? '<div style="position: absolute; left: -1px; top: 16px; width: 2px; height: calc(100% + 1rem); background: var(--border);"></div>' : ''}
                                    <div class="course-card" onclick="openViewCourseModal('${course.id}')">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                            <div>
                                                <div style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 0.5rem;">
                                                    ${date ? date.toLocaleDateString('pt-BR') : 'Data não informada'}
                                                </div>
                                                <h3 style="margin: 0; font-size: 1.1rem;">${course.curso || 'Sem nome'}</h3>
                                            </div>
                                            <span class="status-badge ${statusClass(course)}">${normalizeStatus(course.status)}</span>
                                        </div>
                                        <div style="display: flex; gap: 1.5rem; flex-wrap: wrap; color: var(--text-secondary); font-size: 0.875rem;">
                                            <span><span class="material-icons" style="font-size: 16px; vertical-align: middle;">location_on</span> ${course.cidade || 'N/A'}</span>
                                            <span><span class="material-icons" style="font-size: 16px; vertical-align: middle;">person</span> ${course.instrutor || 'N/A'}</span>
                                            <span><span class="material-icons" style="font-size: 16px; vertical-align: middle;">groups</span> ${course.alunos || 0} concludentes</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else {
                // Modo Grid (padrão)
                coursesHTML = `
                    <div class="courses-grid">
                        ${paginatedCourses.map(course => `
                                    <div class="course-card" onclick="openViewCourseModal('${course.id}')">
                                        <div class="course-header">
                                            <div>
                                                <div class="course-title">${course.curso || 'Sem nome'}</div>
                                        <div class="course-id">ID: ${course.idLote || 'N/A'}${course.lote || course.loteResponsavel ? ' | LOTE: ' + (course.lote || course.loteResponsavel) : ''}</div>
                                            </div>
                                            ${canEdit ? `
                                                <div class="course-actions" onclick="event.stopPropagation()">
                                                    ${course.driveLink ? `
                                                        <button class="drive" onclick="openDriveLink('${course.driveLink}')" title="Abrir Google Drive">
                                                            <span class="material-icons">folder</span>
                                                        </button>
                                                    ` : ''}
                                                    <button onclick="openCourseModal('${course.id}')" title="Editar">
                                                        <span class="material-icons">edit</span>
                                                    </button>
                                                    <button class="delete" onclick="deleteCourse('${course.id}')" title="Excluir">
                                                        <span class="material-icons">delete</span>
                                                    </button>
                                                </div>
                                            ` : ''}
                                        </div>
                                        <div class="course-info">
                                            <div class="course-info-item">
                                                <span class="material-icons">location_on</span>
                                                ${course.cidade || 'Local não definido'}${course.local ? ' - ' + course.local : ''}
                                            </div>
                                            <div class="course-info-item">
                                                <span class="material-icons">event</span>
                                        <span>Período: ${course.inicio && course.fim ? formatDate(course.inicio) + ' - ' + formatDate(course.fim) : course.inicio ? formatDate(course.inicio) : course.fim ? formatDate(course.fim) : 'Não informado'}</span>
                                            </div>
                                            <div class="course-info-item">
                                                <span class="material-icons">person</span>
                                                ${course.instrutor || 'Instrutor não definido'}
                                            </div>
                                            <div class="course-info-item">
                                                <span class="material-icons">groups</span>
                                                ${course.alunos || 0} concludentes
                                            </div>
                                            <div>
                                        <span class="status-badge ${statusClass(course)}">${normalizeStatus(course.status)}</span>
                                            </div>
                                        </div>
                                        ${course.nota ? `
                                            <div class="course-note">
                                                <span class="material-icons">sticky_note_2</span>
                                                <span class="course-note-text">${course.nota}</span>
                                            </div>
                                        ` : ''}
                                    </div>
                        `).join('')}
                    </div>
                `;
            }

            container.innerHTML = coursesHTML;
        }

        function getDisplayLoteName(lote) {
            return loteNames[lote] || lote;
        }

        function editLoteName(lote) {
            const titleElement = document.getElementById(`lote-title-${lote.replace(/\s+/g, '-')}`);
            if (!titleElement) return;

            const currentName = getDisplayLoteName(lote);
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'lote-edit-input';
            input.value = currentName;
            
            const saveBtn = document.createElement('button');
            saveBtn.className = 'btn btn-success btn-icon';
            saveBtn.innerHTML = '<span class="material-icons">save</span>';
            saveBtn.onclick = () => saveLoteName(lote, input.value);

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'btn btn-secondary btn-icon';
            cancelBtn.innerHTML = '<span class="material-icons">close</span>';
            cancelBtn.onclick = () => {
                titleElement.parentElement.innerHTML = `<span id="lote-title-${lote.replace(/\s+/g, '-')}">${getDisplayLoteName(lote)}</span><span class="lote-count">${cursos.filter(c => (c.lote || c.loteResponsavel || 'Sem LOTE') === lote).length} curso${cursos.filter(c => (c.lote || c.loteResponsavel || 'Sem LOTE') === lote).length !== 1 ? 's' : ''}</span>`;
            };

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'lote-edit-actions';
            actionsDiv.appendChild(saveBtn);
            actionsDiv.appendChild(cancelBtn);

            titleElement.parentElement.innerHTML = '';
            titleElement.parentElement.appendChild(input);
            titleElement.parentElement.appendChild(actionsDiv);
            input.focus();
        }

        async function saveLoteName(lote, newName) {
            if (!newName.trim()) {
                showToast('Nome do LOTE não pode estar vazio', 'error');
                return;
            }

            if (newName.trim().length < 2) {
                showToast('Nome do LOTE deve ter pelo menos 2 caracteres', 'error');
                return;
            }

            setLoadingState(true);
            
            try {
            loteNames[lote] = newName.trim();
            localStorage.setItem('loteNames', JSON.stringify(loteNames));

                // Salvar no Firebase se disponível
                if (firebaseAvailable) {
                    try {
                        await db.collection('loteNames').doc(lote).set({ name: newName.trim() });
                    } catch (error) {
                        console.warn('Erro ao salvar loteName no Firebase:', error);
                    }
                }

                // Atualizar cursos com o novo nome do lote (otimizado)
                const coursesToUpdate = cursos.filter(course => 
                    (course.lote || course.loteResponsavel || 'Sem LOTE') === lote
                );

            if (firebaseAvailable) {
                    // Atualizar em batch no Firebase
                    const batch = db.batch();
                    coursesToUpdate.forEach(course => {
                        const courseRef = db.collection('cursos').doc(course.id);
                        batch.update(courseRef, {
                            lote: newName.trim(),
                            loteResponsavel: newName.trim()
                        });
                        // Atualizar localmente também
                        course.lote = newName.trim();
                        course.loteResponsavel = newName.trim();
                });
                    await batch.commit();
            } else {
                    coursesToUpdate.forEach(course => {
                        course.lote = newName.trim();
                        course.loteResponsavel = newName.trim();
                    });
                localStorage.setItem('cursos', JSON.stringify(cursos));
            }

            showToast('Nome do LOTE atualizado!', 'success');
                logActivity('Edição de LOTE', `Renomeou o LOTE "${lote}" para "${newName.trim()}"`, 'edit');
                
                // Renderizar de forma otimizada
                requestAnimationFrame(() => {
                    renderCoursesByLote();
                });
            } catch (error) {
                console.error('Erro ao salvar nome do LOTE:', error);
                showToast('Erro ao atualizar nome do LOTE', 'error');
            } finally {
                setLoadingState(false);
            }
        }

        function renderDashboardReport() {
            const container = document.getElementById('dashboardReport');
            if (!container) return;

            const total = cursos.length;
            const concluidos = cursos.filter(c => normalizeStatus(c.status) === 'Concluído').length;
            const andamento = cursos.filter(c => normalizeStatus(c.status) === 'Em Andamento').length;
            const pendentes = cursos.filter(c => normalizeStatus(c.status) === 'Pendente').length;
            const cancelados = cursos.filter(c => normalizeStatus(c.status) === 'Cancelado').length;
            const totalAlunos = cursos.reduce((sum, c) => sum + (parseInt(c.alunos) || 0), 0);
            
            // Estatísticas adicionais
            const cursosPorCidade = {};
            const cursosPorInstrutor = {};
            const cursosPorLote = {};
            const cargaHorariaTotal = cursos.reduce((sum, c) => {
                const carga = parseInt(c.cargaHoraria) || 0;
                return sum + carga;
            }, 0);
            
            cursos.forEach(c => {
                const cidade = c.cidade || 'Não definido';
                cursosPorCidade[cidade] = (cursosPorCidade[cidade] || 0) + 1;
                
                const instrutor = c.instrutor || 'Não definido';
                cursosPorInstrutor[instrutor] = (cursosPorInstrutor[instrutor] || 0) + 1;
                
                const lote = c.lote || c.loteResponsavel || 'Sem LOTE';
                cursosPorLote[lote] = (cursosPorLote[lote] || 0) + 1;
            });
            
            const topCidades = Object.entries(cursosPorCidade)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            const topInstrutores = Object.entries(cursosPorInstrutor)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            const totalLotes = Object.keys(cursosPorLote).length;
            
            // Calcular percentuais
            const percentConcluidos = total > 0 ? ((concluidos / total) * 100).toFixed(1) : 0;
            const percentAndamento = total > 0 ? ((andamento / total) * 100).toFixed(1) : 0;
            const percentPendentes = total > 0 ? ((pendentes / total) * 100).toFixed(1) : 0;
            const percentCancelados = total > 0 ? ((cancelados / total) * 100).toFixed(1) : 0;
            const mediaAlunos = total > 0 ? (totalAlunos / total).toFixed(1) : 0;

            container.innerHTML = `
                <div class="report-kpi-grid">
                    <div class="report-kpi-card purple">
                        <div class="report-kpi-value">${total}</div>
                        <div class="report-kpi-label">Total de Cursos</div>
                    </div>
                    <div class="report-kpi-card green">
                        <div class="report-kpi-value">${concluidos}</div>
                        <div class="report-kpi-label">Concluídos (${percentConcluidos}%)</div>
                    </div>
                    <div class="report-kpi-card blue">
                        <div class="report-kpi-value">${andamento}</div>
                        <div class="report-kpi-label">Em Andamento (${percentAndamento}%)</div>
                    </div>
                    <div class="report-kpi-card yellow">
                        <div class="report-kpi-value">${pendentes}</div>
                        <div class="report-kpi-label">Pendentes (${percentPendentes}%)</div>
                    </div>
                    ${cancelados > 0 ? `
                    <div class="report-kpi-card red">
                        <div class="report-kpi-value">${cancelados}</div>
                        <div class="report-kpi-label">Cancelados (${percentCancelados}%)</div>
                    </div>
                    ` : ''}
                    <div class="report-kpi-card">
                        <div class="report-kpi-value">${totalAlunos}</div>
                        <div class="report-kpi-label">Total Concludentes</div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem; margin-top: 2rem;">
                    <!-- Gráfico Pizza de Status -->
                    <div class="settings-card">
                        <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 8px;">
                            <span class="material-icons">pie_chart</span>
                            Distribuição por Status
                        </h3>
                        <div style="display: flex; justify-content: center; margin: 1.5rem 0;">
                            <canvas id="dashboardStatusChart" width="300" height="300"></canvas>
                        </div>
                    </div>
                    
                    <!-- Top Cidades -->
                    <div class="settings-card">
                        <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 8px;">
                            <span class="material-icons">location_city</span>
                            Top 5 Cidades
                        </h3>
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            ${topCidades.map(([cidade, qtd]) => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--background); border-radius: 8px; border: 1px solid var(--border);">
                                    <span style="color: var(--text-primary);">${cidade}</span>
                                    <span style="background: var(--primary); color: white; padding: 4px 12px; border-radius: 12px; font-weight: 600; font-size: 0.875rem;">${qtd}</span>
                                </div>
                            `).join('')}
                            ${topCidades.length === 0 ? '<p style="color: var(--text-muted); text-align: center;">Nenhuma cidade cadastrada</p>' : ''}
                        </div>
                    </div>
                    
                    <!-- Top Instrutores -->
                    <div class="settings-card">
                        <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 8px;">
                            <span class="material-icons">people</span>
                            Top 5 Instrutores
                        </h3>
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            ${topInstrutores.map(([instrutor, qtd]) => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--background); border-radius: 8px; border: 1px solid var(--border);">
                                    <span style="color: var(--text-primary);">${instrutor}</span>
                                    <span style="background: var(--success); color: white; padding: 4px 12px; border-radius: 12px; font-weight: 600; font-size: 0.875rem;">${qtd}</span>
                                </div>
                            `).join('')}
                            ${topInstrutores.length === 0 ? '<p style="color: var(--text-muted); text-align: center;">Nenhum instrutor cadastrado</p>' : ''}
                        </div>
                    </div>
                    
                    <!-- Distribuição por LOTE -->
                    <div class="settings-card">
                        <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 8px;">
                            <span class="material-icons">folder</span>
                            Distribuição por LOTE
                        </h3>
                        <div style="display: flex; flex-direction: column; gap: 1rem; max-height: 300px; overflow-y: auto;">
                            ${Object.entries(cursosPorLote).sort((a, b) => b[1] - a[1]).map(([lote, qtd]) => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--background); border-radius: 8px; border: 1px solid var(--border);">
                                    <span style="color: var(--text-primary);">${getDisplayLoteName(lote)}</span>
                                    <span style="background: var(--info); color: white; padding: 4px 12px; border-radius: 12px; font-weight: 600; font-size: 0.875rem;">${qtd}</span>
                                </div>
                            `).join('')}
                            ${Object.keys(cursosPorLote).length === 0 ? '<p style="color: var(--text-muted); text-align: center;">Nenhum LOTE cadastrado</p>' : ''}
                        </div>
                    </div>
                </div>
            `;
            
            // Renderizar gráfico pizza após um pequeno delay para garantir que o canvas esteja no DOM
            setTimeout(() => {
                const ctx = document.getElementById('dashboardStatusChart')?.getContext('2d');
                if (ctx && Chart) {
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Concluídos', 'Em Andamento', 'Pendentes', 'Cancelados'],
                            datasets: [{
                                data: [concluidos, andamento, pendentes, cancelados],
                                backgroundColor: ['#34d399', '#60a5fa', '#fbbf24', '#f87171'],
                                borderWidth: 0,
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            cutout: '60%',
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        color: '#f8fafc',
                                        padding: 15,
                                        font: {
                                            size: 12,
                                            weight: '500'
                                        }
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    padding: 12,
                                    titleFont: {
                                        size: 14,
                                        weight: '600'
                                    },
                                    bodyFont: {
                                        size: 13
                                    },
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed || 0;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                            return `${label}: ${value} (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }, 100);
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Login
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const page = item.dataset.page;
                    navigateTo(page);
                });
            });

            // Mobile menu
            document.getElementById('mobileMenuBtn').addEventListener('click', toggleSidebar);

            // Filtro de LOTE na página de Cursos

            // Buttons
            const newCourseBtn = document.getElementById('newCourseBtn');
            if (newCourseBtn) {
                newCourseBtn.addEventListener('click', () => openCourseModal());
            }
            const newInstructorBtn = document.getElementById('newInstructorBtn');
            if (newInstructorBtn) {
                newInstructorBtn.addEventListener('click', () => openInstructorModal());
            }
            const importInstructorsBtn = document.getElementById('importInstructorsBtn');
            if (importInstructorsBtn) {
                importInstructorsBtn.addEventListener('click', () => {
                    document.getElementById('instructorsFileInput').click();
                });
            }
            document.getElementById('newUserBtn').addEventListener('click', () => openUserModal());
            
            // Mobile menu
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('click', toggleSidebar);
            }
            
            // Botão fixo para abrir sidebar no mobile
            const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
            if (mobileSidebarToggle) {
                mobileSidebarToggle.addEventListener('click', toggleSidebar);
            }
            
            // Botão de download do relatório
            const downloadReportBtn = document.getElementById('downloadReportBtn');
            if (downloadReportBtn) {
                downloadReportBtn.addEventListener('click', () => {
                    downloadReportAsImage();
                });
            }

            // Calendar
            document.getElementById('prevMonth').addEventListener('click', () => changeMonth(-1));
            document.getElementById('nextMonth').addEventListener('click', () => changeMonth(1));
            document.getElementById('todayBtn').addEventListener('click', goToToday);

            // Forms
            document.getElementById('courseForm').addEventListener('submit', handleCourseSubmit);
            document.getElementById('instructorForm').addEventListener('submit', handleInstructorSubmit);
            document.getElementById('quickInstructorForm').addEventListener('submit', handleQuickInstructorSubmit);
            document.getElementById('userForm').addEventListener('submit', handleUserSubmit);
            document.getElementById('changePasswordForm').addEventListener('submit', handleChangePassword);
            document.getElementById('changeNameForm').addEventListener('submit', handleChangeName); 

            // Settings - O preview será tratado em initializeImportPreview
            document.getElementById('instructorsFileInput').addEventListener('change', handleInstructorsUpload);
            document.getElementById('exportCoursesBtn').addEventListener('click', exportCoursesToCsv);
            document.getElementById('exportInstructorsBtn').addEventListener('click', exportInstructorsToCsv);
            document.getElementById('clearDataBtn').addEventListener('click', clearAllData);
            
            // Novas funcionalidades
            initializeAdvancedFeatures();
        }

        function handleLogout() {
            // Salvar automaticamente antes de sair
            saveAllChanges();
            currentUser = null;
            localStorage.removeItem('currentUser');
            window.location.reload();
        }
        
        // ========== IMPLEMENTAÇÃO DAS NOVAS FUNCIONALIDADES ==========
        
        // Variáveis globais para novas funcionalidades
        let currentFilters = {};
        let currentSort = { field: 'name', direction: 'asc' };
        let currentPage = 1;
        let itemsPerPage = 10000; // Mostrar todos os cursos
        let notifications = [];
        let changeHistory = [];
        let unsavedChanges = false;
        let previewData = null;
        let backupInterval = null;
        // Inicializar todas as novas funcionalidades
        function initializeAdvancedFeatures() {
            initializeTheme();
            initializeNotifications();
            initializeSearchAndFilters();
            initializePagination();
            initializeSorting();
            initializeKeyboardShortcuts();
            initializeAutoSave();
            initializeBackup();
            initializeTooltips();
            initializeSearchToggle();
            initializeChangeHistory();
            initializeImportPreview();
            initializeCustomTheme();
            initializeProjectName();
        }
        
        // 1. Modo Escuro/Claro e Temas
        function initializeTheme() {
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = document.getElementById('themeIcon');
            const savedTheme = localStorage.getItem('theme') || 'dark';
            const savedColorTheme = localStorage.getItem('colorTheme') || 'default';
            
            // Aplicar modo claro/escuro primeiro
            if (savedTheme === 'light') {
                document.documentElement.classList.add('light-mode');
                if (themeIcon) themeIcon.textContent = 'light_mode';
            }
            
            // Toggle claro/escuro
            if (themeToggle && themeIcon) {
                themeToggle.addEventListener('click', () => {
                    document.documentElement.classList.toggle('light-mode');
                    const isLight = document.documentElement.classList.contains('light-mode');
                    themeIcon.textContent = isLight ? 'light_mode' : 'dark_mode';
                    localStorage.setItem('theme', isLight ? 'light' : 'dark');
                });
            }
            
            // Aplicar tema de cor salvo (depois do modo claro/escuro)
            applyColorTheme(savedColorTheme);
            
            // Inicializar seleção de temas de cor
            initializeColorThemes();
        }
        
        function initializeColorThemes() {
            const themeOptions = document.querySelectorAll('.theme-option');
            const savedColorTheme = localStorage.getItem('colorTheme') || 'default';
            
            // Marcar tema ativo
            themeOptions.forEach(option => {
                const theme = option.dataset.theme;
                if (theme === savedColorTheme) {
                    option.classList.add('active');
                }
                
                option.addEventListener('click', () => {
                    // Remover active de todos
                    themeOptions.forEach(opt => opt.classList.remove('active'));
                    // Adicionar active ao selecionado
                    option.classList.add('active');
                    // Aplicar tema
                    applyColorTheme(theme);
                    localStorage.setItem('colorTheme', theme);
                    showToast(`Tema "${option.querySelector('h4').textContent}" aplicado!`, 'success');
                });
            });
        }
        
        function applyColorTheme(theme) {
            // Remover todos os temas de cor
            document.documentElement.classList.remove('theme-blue', 'theme-green', 'theme-purple', 'theme-orange', 'theme-pink', 'theme-custom');
            
            // Se for tema customizado, aplicar cores salvas
            if (theme === 'custom') {
                applyCustomTheme();
                document.documentElement.classList.add('theme-custom');
            } else if (theme && theme !== 'default') {
                // Aplicar novo tema (default não precisa de classe)
                document.documentElement.classList.add(`theme-${theme}`);
                // Limpar cores customizadas quando trocar para tema pré-definido
                clearCustomTheme();
            } else {
                // Tema padrão
                clearCustomTheme();
            }
        }
        
        function applyCustomTheme() {
            const customColors = JSON.parse(localStorage.getItem('customThemeColors') || '{}');
            if (Object.keys(customColors).length > 0) {
                Object.entries(customColors).forEach(([key, value]) => {
                    document.documentElement.style.setProperty(`--${key}`, value);
                });
            }
        }
        
        function clearCustomTheme() {
            // Remover estilos inline de cores customizadas
            const customColorKeys = ['primary', 'primary-hover', 'background', 'sidebar', 'surface', 'surface-hover'];
            customColorKeys.forEach(key => {
                document.documentElement.style.removeProperty(`--${key}`);
            });
        }
        
        function initializeCustomTheme() {
            const applyBtn = document.getElementById('applyCustomThemeBtn');
            const resetBtn = document.getElementById('resetCustomThemeBtn');
            const primaryInput = document.getElementById('customPrimaryColor');
            const backgroundInput = document.getElementById('customBackgroundColor');
            const sidebarInput = document.getElementById('customSidebarColor');
            const surfaceInput = document.getElementById('customSurfaceColor');
            
            // Carregar cores salvas
            const savedColors = JSON.parse(localStorage.getItem('customThemeColors') || '{}');
            if (savedColors.primary) primaryInput.value = savedColors.primary;
            if (savedColors.background) backgroundInput.value = savedColors.background;
            if (savedColors.sidebar) sidebarInput.value = savedColors.sidebar;
            if (savedColors.surface) surfaceInput.value = savedColors.surface;
            
            if (applyBtn) {
                applyBtn.addEventListener('click', () => {
                    const customColors = {
                        primary: primaryInput.value,
                        'primary-hover': adjustColorBrightness(primaryInput.value, -10),
                        background: backgroundInput.value,
                        sidebar: sidebarInput.value,
                        surface: surfaceInput.value,
                        'surface-hover': adjustColorBrightness(surfaceInput.value, 10)
                    };
                    
                    localStorage.setItem('customThemeColors', JSON.stringify(customColors));
                    localStorage.setItem('colorTheme', 'custom');
                    
                    // Aplicar tema customizado
                    applyColorTheme('custom');
                    
                    // Atualizar seleção visual
                    document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('active'));
                    
                    showToast('Tema personalizado aplicado com sucesso!', 'success');
                });
            }
            
            if (resetBtn) {
                resetBtn.addEventListener('click', () => {
                    if (confirm('Deseja restaurar as cores padrão do tema?')) {
                        localStorage.removeItem('customThemeColors');
                        localStorage.setItem('colorTheme', 'default');
                        
                        // Restaurar valores padrão
                        primaryInput.value = '#6366f1';
                        backgroundInput.value = '#0f172a';
                        sidebarInput.value = '#020617';
                        surfaceInput.value = '#1e293b';
                        
                        applyColorTheme('default');
                        
                        // Atualizar seleção visual
                        document.querySelectorAll('.theme-option').forEach(opt => {
                            opt.classList.toggle('active', opt.dataset.theme === 'default');
                        });
                        
                        showToast('Cores padrão restauradas!', 'success');
                    }
                });
            }
        }
        
        function adjustColorBrightness(hex, percent) {
            // Converter hex para RGB
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            
            // Ajustar brilho
            const newR = Math.max(0, Math.min(255, r + (r * percent / 100)));
            const newG = Math.max(0, Math.min(255, g + (g * percent / 100)));
            const newB = Math.max(0, Math.min(255, b + (b * percent / 100)));
            
            // Converter de volta para hex
            return '#' + [newR, newG, newB].map(x => {
                const hex = Math.round(x).toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            }).join('');
        }
        
        // Gerenciamento de Nome do Projeto
        function initializeProjectName() {
            const projectNameInput = document.getElementById('projectNameInput');
            const saveProjectNameBtn = document.getElementById('saveProjectNameBtn');
            
            // Carregar nome salvo
            const savedName = localStorage.getItem('projectName') || 'CSF Manager';
            if (projectNameInput) {
                projectNameInput.value = savedName;
            }
            
            // Salvar nome do projeto
            if (saveProjectNameBtn) {
                saveProjectNameBtn.addEventListener('click', () => {
                    const projectName = projectNameInput.value.trim();
                    if (!projectName) {
                        showToast('Por favor, digite um nome para o projeto', 'warning');
                        return;
                    }
                    
                    localStorage.setItem('projectName', projectName);
                    updateProjectName(projectName);
                    showToast('Nome do projeto atualizado!', 'success');
                });
            }
            
            // Permitir salvar com Enter
            if (projectNameInput) {
                projectNameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        saveProjectNameBtn.click();
                    }
                });
            }
        }
        
        function loadProjectName() {
            const projectName = localStorage.getItem('projectName') || 'CSF Manager';
            updateProjectName(projectName);
        }
        
        function updateProjectName(name) {
            const loginProjectName = document.getElementById('loginProjectName');
            const sidebarProjectName = document.getElementById('sidebarProjectName');
            
            if (loginProjectName) {
                loginProjectName.textContent = name;
            }
            
            if (sidebarProjectName) {
                sidebarProjectName.textContent = name;
            }
        }
        
        // Aplicar tema ao carregar a página
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                const savedColorTheme = localStorage.getItem('colorTheme') || 'default';
                applyColorTheme(savedColorTheme);
            });
        } else {
            const savedColorTheme = localStorage.getItem('colorTheme') || 'default';
            applyColorTheme(savedColorTheme);
        }
        
        // 2. Notificações e Alertas
        let notificationModalOpen = false;
        
        function initializeNotifications() {
            // Configurar botão de notificação apenas uma vez
            const setupNotificationButton = () => {
                const notificationBtn = document.getElementById('notificationBtn');
                if (notificationBtn && !notificationBtn.hasAttribute('data-notification-setup')) {
                    notificationBtn.setAttribute('data-notification-setup', 'true');
                    notificationBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        if (!notificationModalOpen) {
                            showNotificationsModal();
                        }
                    });
                }
            };
            
            // Tentar configurar imediatamente
            setupNotificationButton();
            
            // Tentar novamente após um delay (caso o botão ainda não exista)
            setTimeout(setupNotificationButton, 500);
            
            // Carregar notificações salvas
            loadNotifications();
            checkForNotifications();
            
            // Verificar cursos próximos do vencimento
            checkUpcomingCourseDeadlines();
        }
        
        function addNotification(title, message, type = 'info', urgent = false) {
            const notification = {
                id: Date.now(),
                title,
                message,
                type,
                urgent,
                timestamp: new Date(),
                read: false
            };
            
            notifications.unshift(notification);
            if (notifications.length > 50) notifications.pop();
            
            saveNotifications();
            renderNotifications();
            updateNotificationBadge();
        }
        
        function renderNotifications() {
            const list = document.getElementById('notificationsList');
            if (!list) return;
            
            list.innerHTML = notifications.length === 0 
                ? '<div style="padding: 2rem; text-align: center; color: var(--text-muted);">Nenhuma notificação</div>'
                : notifications.map(n => `
                    <div class="notification-item ${n.urgent ? 'urgent' : ''} ${n.type}" data-id="${n.id}">
                        <div class="notification-title">${n.title}</div>
                        <div class="notification-message">${n.message}</div>
                        <div class="notification-time">${formatTimestamp(n.timestamp)}</div>
                    </div>
                `).join('');
            
            // Marcar como lida ao clicar
            list.querySelectorAll('.notification-item').forEach(item => {
                item.addEventListener('click', () => {
                    const id = parseInt(item.dataset.id);
                    const notification = notifications.find(n => n.id === id);
                    if (notification) {
                        notification.read = true;
                        saveNotifications();
                        updateNotificationBadge();
                    }
                });
            });
        }
        
        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            const unreadCount = notifications.filter(n => !n.read).length;
            if (badge) {
                badge.textContent = unreadCount;
                badge.style.display = unreadCount > 0 ? 'flex' : 'none';
            }
        }
        
        function checkForNotifications() {
            // Verificar cursos próximos do vencimento
            const today = new Date();
            const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
            
            cursos.forEach(course => {
                if (course.fim) {
                    const endDate = new Date(course.fim);
                    if (endDate >= today && endDate <= nextWeek && course.status !== 'Concluído') {
                        addNotification(
                            'Curso próximo do fim',
                            `O curso "${course.nome}" termina em breve (${formatDate(course.fim)})`,
                            'warning',
                            true
                        );
                    }
                }
            });
        }
        
        function saveNotifications() {
            localStorage.setItem('notifications', JSON.stringify(notifications));
        }
        
        function loadNotifications() {
            const saved = localStorage.getItem('notifications');
            if (saved) {
                notifications = JSON.parse(saved).map(n => ({
                    ...n,
                    timestamp: new Date(n.timestamp)
                }));
            }
        }
        
        // 3. Busca Avançada e Filtros
        function initializeSearchAndFilters() {
            const searchInput = document.getElementById('searchInput');
            const toggleFiltersBtn = document.getElementById('toggleFiltersBtn');
            const filtersContainer = document.getElementById('filtersContainer');
            const applyFiltersBtn = document.getElementById('applyFiltersBtn');
            const clearFiltersBtn = document.getElementById('clearFiltersBtn');
            
            if (toggleFiltersBtn && filtersContainer) {
                toggleFiltersBtn.addEventListener('click', () => {
                    filtersContainer.style.display = filtersContainer.style.display === 'none' ? 'grid' : 'none';
                });
            }
            
            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        currentFilters.search = e.target.value;
                        applyFilters();
                    }, 300);
                });
            }
            
            if (applyFiltersBtn) {
                applyFiltersBtn.addEventListener('click', applyFilters);
            }
            
            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', () => {
                    currentFilters = {};
                    document.getElementById('searchInput').value = '';
                    document.getElementById('filterStatus').value = '';
                    document.getElementById('filterCity').value = '';
                    document.getElementById('filterInstructor').value = '';
                    document.getElementById('filterStartDate').value = '';
                    document.getElementById('filterEndDate').value = '';
                    applyFilters();
                });
            }
            
            // Popular select de instrutores
            updateInstructorFilter();
        }
        
        function applyFilters() {
            currentPage = 1;
            if (document.getElementById('coursesPage')?.classList.contains('active')) {
                renderCoursesByLote();
            }
        }
        
        function filterCourses(courses) {
            // Se não houver filtros definidos, retornar todos os cursos
            if (!currentFilters || Object.keys(currentFilters).length === 0) {
                return [...courses];
            }
            
            let filtered = [...courses];
            
            // Busca por texto
            if (currentFilters.search && currentFilters.search.trim()) {
                const search = currentFilters.search.toLowerCase().trim();
                filtered = filtered.filter(c => 
                    (c.curso || c.nome || '').toLowerCase().includes(search) ||
                    (c.cidade || '').toLowerCase().includes(search) ||
                    (c.instrutor || '').toLowerCase().includes(search) ||
                    (c.idLote || '').toLowerCase().includes(search) ||
                    (c.lote || c.loteResponsavel || '').toLowerCase().includes(search)
                );
            }
            
            // Filtro por status
            if (currentFilters.status && currentFilters.status !== '') {
                filtered = filtered.filter(c => normalizeStatus(c.status) === currentFilters.status);
            }
            
            // Filtro por cidade
            if (currentFilters.city && currentFilters.city.trim()) {
                filtered = filtered.filter(c => 
                    (c.cidade || '').toLowerCase().includes(currentFilters.city.toLowerCase().trim())
                );
            }
            
            // Filtro por instrutor
            if (currentFilters.instructor && currentFilters.instructor !== '') {
                filtered = filtered.filter(c => c.instrutor === currentFilters.instructor);
            }
            
            // Filtro por período
            if (currentFilters.startDate && currentFilters.startDate.trim()) {
                filtered = filtered.filter(c => {
                    if (!c.inicio) return false;
                    return new Date(c.inicio) >= new Date(currentFilters.startDate);
                });
            }
            
            if (currentFilters.endDate && currentFilters.endDate.trim()) {
                filtered = filtered.filter(c => {
                    if (!c.fim) return false;
                    return new Date(c.fim) <= new Date(currentFilters.endDate);
                });
            }
            
            return filtered;
        }
        
        function updateInstructorFilter() {
            const select = document.getElementById('filterInstructor');
            if (!select) return;
            
            const instructors = [...new Set(cursos.map(c => c.instrutor).filter(Boolean))];
            select.innerHTML = '<option value="">Todos</option>' + 
                instructors.map(i => `<option value="${i}">${i}</option>`).join('');
        }
        
        // 4. Paginação
        function initializePagination() {
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            
            if (prevBtn) prevBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderCoursesByLote();
                }
            });
            
            if (nextBtn) nextBtn.addEventListener('click', () => {
                currentPage++;
                renderCoursesByLote();
            });
        }
        
        function renderPagination(totalItems) {
            const container = document.getElementById('paginationContainer');
            const pageInfo = document.getElementById('pageInfo');
            
            if (!container) return;
            
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            
            // Ocultar paginação se mostrar todos os cursos ou se houver apenas 1 página
            if (totalPages <= 1 || itemsPerPage >= 10000) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'flex';
            if (pageInfo) {
                pageInfo.textContent = `Página ${currentPage} de ${totalPages}`;
            }
            
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            
            if (prevBtn) prevBtn.disabled = currentPage === 1;
            if (nextBtn) nextBtn.disabled = currentPage === totalPages;
        }
        
        // 5. Ordenação
        function initializeSorting() {
            const sortSelect = document.getElementById('sortCourses');
            if (sortSelect) {
                sortSelect.addEventListener('change', (e) => {
                    const value = e.target.value;
                    if (value === 'name') currentSort = { field: 'nome', direction: 'asc' };
                    else if (value === 'date') currentSort = { field: 'inicio', direction: 'desc' };
                    else if (value === 'status') currentSort = { field: 'status', direction: 'asc' };
                    else if (value === 'city') currentSort = { field: 'cidade', direction: 'asc' };
                    
                    currentPage = 1;
                    renderCoursesByLote();
                });
            }
        }
        
        function sortCourses(courses) {
            return [...courses].sort((a, b) => {
                let aVal = a[currentSort.field] || '';
                let bVal = b[currentSort.field] || '';
                
                if (currentSort.field === 'inicio' || currentSort.field === 'fim') {
                    aVal = aVal ? new Date(aVal).getTime() : 0;
                    bVal = bVal ? new Date(bVal).getTime() : 0;
                } else {
                    aVal = String(aVal).toLowerCase();
                    bVal = String(bVal).toLowerCase();
                }
                
                if (currentSort.direction === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });
        }
        
        // 6. Atalhos de Teclado
        function initializeKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Não processar se estiver digitando em input/textarea (exceto Esc e Ctrl+F)
                if ((e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') && 
                    !(e.key === 'Escape' || (e.ctrlKey && (e.key === 'f' || e.key === 'F')))) {
                    return;
                }
                
                // Ctrl+N: Novo curso
                if (e.ctrlKey && (e.key === 'n' || e.key === 'N')) {
                    e.preventDefault();
                    const btn = document.getElementById('newCourseBtn');
                    if (btn && !btn.disabled) {
                        btn.click();
                    }
                }
                
                // Ctrl+F: Focar busca
                if (e.ctrlKey && (e.key === 'f' || e.key === 'F')) {
                    e.preventDefault();
                    const searchToggle = document.getElementById('searchToggleBtn');
                    const searchInput = document.getElementById('searchInput');
                    if (searchToggle && searchInput) {
                        if (searchInput.style.display === 'none') {
                            searchToggle.click();
                        }
                        setTimeout(() => searchInput.focus(), 100);
                    }
                }
                
                // Esc: Fechar modais
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal-overlay.active').forEach(overlay => {
                        overlay.classList.remove('active');
                    });
                    const notificationsPanel = document.getElementById('notificationsPanel');
                    if (notificationsPanel) {
                        notificationsPanel.classList.remove('active');
                    }
                }
            });
        }
        
        // 7. Salvamento automático de alterações
        function initializeAutoSave() {
            // Salvar automaticamente ao detectar mudanças em formulários
            document.querySelectorAll('input, select, textarea').forEach(input => {
                input.addEventListener('change', () => {
                    // Salvar automaticamente após um pequeno delay
                    setTimeout(() => {
                        autoSaveChanges();
                    }, 500);
                });
            });
            
            // Salvar automaticamente ao sair da página
            window.addEventListener('beforeunload', () => {
                saveAllChanges();
            });
        }
        
        function autoSaveChanges() {
            // Salvar dados atuais automaticamente
            if (firebaseAvailable) {
                // Firebase salva automaticamente via onSnapshot
                return;
            }
            
            // Salvar no localStorage
            try {
                if (cursos && cursos.length > 0) {
                    localStorage.setItem('cursos', JSON.stringify(cursos));
                }
                if (instrutores && instrutores.length > 0) {
                    localStorage.setItem('instrutores', JSON.stringify(instrutores));
                }
                if (usuarios && usuarios.length > 0) {
                    localStorage.setItem('usuarios', JSON.stringify(usuarios));
                }
            } catch (error) {
                console.error('Erro ao salvar automaticamente:', error);
            }
        }
        
        function saveAllChanges() {
            // Salvar todas as alterações pendentes
            autoSaveChanges();
            
            // Se houver formulários abertos, salvá-los
            const courseForm = document.getElementById('courseForm');
            if (courseForm && courseForm.checkValidity()) {
                // Os formulários já são salvos ao submeter, então apenas garantimos que está tudo salvo
            }
        }
        
        // 8. Tooltips
        function initializeTooltips() {
            // Tooltips são adicionados via atributo title ou data-tooltip
            document.querySelectorAll('[data-tooltip]').forEach(el => {
                el.classList.add('tooltip');
                const tooltip = document.createElement('div');
                tooltip.className = 'tooltip-content';
                tooltip.textContent = el.dataset.tooltip;
                el.appendChild(tooltip);
            });
        }
        
        // 9. Estatísticas por Período
        
        // 10. Backup Automático
        function initializeBackup() {
            // Backup a cada 5 minutos
            backupInterval = setInterval(() => {
                performBackup();
            }, 5 * 60 * 1000);
            
            // Backup inicial
            performBackup();
        }
        
        function performBackup() {
            try {
                const backup = {
                    timestamp: new Date().toISOString(),
                    cursos: cursos,
                    instrutores: instrutores,
                    usuarios: usuarios,
                    loteNames: loteNames
                };
                
                localStorage.setItem('backup_' + Date.now(), JSON.stringify(backup));
                
                // Manter apenas os 10 backups mais recentes
                const backupKeys = Object.keys(localStorage)
                    .filter(k => k.startsWith('backup_'))
                    .sort()
                    .reverse();
                
                if (backupKeys.length > 10) {
                    backupKeys.slice(10).forEach(k => localStorage.removeItem(k));
                }
                
                console.log('Backup automático realizado');
            } catch (error) {
                console.error('Erro ao realizar backup:', error);
            }
        }
        
        // 11. Preview antes de importar
        function initializeImportPreview() {
            const excelInput = document.getElementById('excelFileInput');
            if (excelInput) {
                excelInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    // Validar tipo de arquivo
                    const validTypes = ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 
                                       'application/vnd.ms-excel',
                                       'application/excel'];
                    const validExtensions = ['.xlsx', '.xls'];
                    const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
                    
                    if (!validTypes.includes(file.type) && !validExtensions.includes(fileExtension)) {
                        showToast('Por favor, selecione um arquivo Excel (.xlsx ou .xls)', 'error');
                        return;
                    }
                    
                    // Validar tamanho (máximo 10MB)
                    if (file.size > 10 * 1024 * 1024) {
                        showToast('Arquivo muito grande. Tamanho máximo: 10MB', 'error');
                        return;
                    }
                    
                    document.getElementById('selectedFileName').textContent = file.name;
                    document.getElementById('fileInfoBox').classList.add('show');
                    
                    try {
                        const data = await readExcelFile(file);
                        previewData = data;
                        showImportPreview(data);
                    } catch (error) {
                        console.error('Erro ao ler arquivo:', error);
                        showToast('Erro ao ler arquivo Excel', 'error');
                    }
                });
            }
            
            // Botão confirmar importação
            const confirmBtn = document.getElementById('confirmImportBtn');
            if (confirmBtn) {
                confirmBtn.addEventListener('click', async () => {
                    if (previewData && previewData.length > 0) {
                        await importPreviewData();
                    } else {
                        showToast('Nenhum dado para importar', 'warning');
                    }
                });
            }
            
            // Botão cancelar
            const cancelBtn = document.getElementById('cancelImportBtn');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', () => {
                    const preview = document.getElementById('importPreview');
                    if (preview) preview.style.display = 'none';
                    previewData = null;
                    const excelInput = document.getElementById('excelFileInput');
                    if (excelInput) excelInput.value = '';
                    const fileInfoBox = document.getElementById('fileInfoBox');
                    if (fileInfoBox) fileInfoBox.classList.remove('show');
                });
            }
        }
        
        async function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet);
                        resolve(json);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
        
        function showImportPreview(data) {
            const preview = document.getElementById('importPreview');
            const container = document.getElementById('previewTableContainer');
            
            if (!preview || !container) return;
            
            if (data.length === 0) {
                container.innerHTML = '<p>Nenhum dado encontrado no arquivo</p>';
                preview.style.display = 'block';
                return;
            }
            
            // Mostrar primeiras 10 linhas
            const previewData = data.slice(0, 10);
            const headers = Object.keys(previewData[0] || {});
            
            let html = `
                <p style="margin-bottom: 1rem; color: var(--text-secondary);">
                    Mostrando ${previewData.length} de ${data.length} registros
                </p>
                <table class="preview-table">
                    <thead>
                        <tr>
                            ${headers.map(h => `<th>${h}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${previewData.map(row => `
                            <tr>
                                ${headers.map(h => `<td>${row[h] || ''}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
            preview.style.display = 'block';
        }
        
        async function importPreviewData() {
            if (!previewData) return;
            
            document.getElementById('importPreview').style.display = 'none';
            await processExcelData(previewData);
            previewData = null;
        }
        
        async function processExcelData(json) {
            setLoadingState(true);
            try {
                let imported = 0;
                let errors = [];
                
                // Reutilizar a lógica de handleExcelUpload
                const batchSize = 10;
                for (let i = 0; i < json.length; i += batchSize) {
                    const batch = json.slice(i, i + batchSize);
                    
                    for (const row of batch) {
                        try {
                            // Reutilizar a mesma lógica de processamento de handleExcelUpload
                            // (copiar a lógica de processamento de linha)
                            const loteValue = row['LOTE'] || row['lote'] || row['Lote'] || '';
                            
                            // Função auxiliar para obter valor da coluna
                            function getColumnValue(row, variations) {
                                for (const variation of variations) {
                                    if (row[variation] !== undefined && row[variation] !== null && row[variation] !== '') {
                                        return String(row[variation]).trim();
                                    }
                                }
                                return '';
                            }
                            
                            const endereco = getColumnValue(row, [
                                'ENDEREÇO', 'ENDERECO', 'endereço', 'endereco',
                                'LOCAL DO CURSO', 'local do curso', 'Local do Curso',
                                'LOCAL', 'local', 'Local'
                            ]) || '';
                            
                            const courseData = {
                                curso: getColumnValue(row, ['CURSO', 'curso', 'Curso', 'NOME', 'nome']) || '',
                                idLote: getColumnValue(row, ['ID', 'id', 'Id', 'ID POR LOTE', 'id por lote']) || '',
                                lote: loteValue,
                                loteResponsavel: loteValue,
                                cidade: getColumnValue(row, ['CIDADE', 'cidade', 'Cidade']) || '',
                                inicio: (() => {
                                    const dateValue = getColumnValue(row, [
                                        'DATA INÍCIO', 'DATA INICIO', 'data início', 'data inicio', 
                                        'INÍCIO', 'inicio', 'INICIO', 'Data Início', 'Data Inicio'
                                    ]);
                                    return formatExcelDate(dateValue);
                                })(),
                                fim: (() => {
                                    const dateValue = getColumnValue(row, [
                                        'DATA FIM', 'data fim', 'FIM', 'fim', 'Data Fim'
                                    ]);
                                    return formatExcelDate(dateValue);
                                })(),
                                local: endereco,
                                status: normalizeStatus(getColumnValue(row, ['STATUS', 'status', 'Status']) || 'Pendente'),
                                alunos: parseInt(getColumnValue(row, ['CONCLUDENTES', 'concludentes', 'Concludentes']) || '0') || 0,
                                cargaHoraria: getColumnValue(row, [
                                    'CARGA HORÁRIA', 'carga horária', 'CARGA HORARIA', 'carga horaria',
                                    'Carga Horária', 'Carga Horaria'
                                ]) || '',
                                instrutor: getColumnValue(row, ['INSTRUTOR', 'instrutor', 'Instrutor']) || '',
                                telefone: getColumnValue(row, ['TELEFONE', 'telefone', 'Telefone']) || '',
                                driveLink: '',
                                nota: ''
                            };
                            
                            if (firebaseAvailable) {
                                await db.collection('cursos').add(courseData);
                            } else {
                                const newId = 'course_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                                courseData.id = newId;
                                const existingCourses = JSON.parse(localStorage.getItem('cursos') || '[]');
                                existingCourses.push(courseData);
                                localStorage.setItem('cursos', JSON.stringify(existingCourses));
                            }
                            
                            imported++;
                        } catch (error) {
                            errors.push(`Linha ${i + 1}: ${error.message}`);
                        }
                    }
                }
                
                if (firebaseAvailable) {
                    await loadData();
                } else {
                    loadFromLocalStorage();
                }
                
                showToast(`${imported} cursos importados com sucesso!${errors.length > 0 ? ' ' + errors.length + ' erros.' : ''}`, 'success');
                
                if (document.getElementById('coursesPage')?.classList.contains('active')) {
                    renderCoursesByLote();
                }
            } catch (error) {
                console.error('Erro ao importar dados:', error);
                showToast('Erro ao importar dados: ' + error.message, 'error');
            } finally {
                setLoadingState(false);
            }
        }
        
        // 12. Toggle de Busca
        function initializeSearchToggle() {
            const searchToggleBtn = document.getElementById('searchToggleBtn');
            const searchInput = document.getElementById('searchInput');
            
            if (searchToggleBtn && searchInput) {
                searchToggleBtn.addEventListener('click', () => {
                    const isVisible = searchInput.style.display !== 'none';
                    searchInput.style.display = isVisible ? 'none' : 'block';
                    if (!isVisible) {
                        searchInput.focus();
                    }
                });
            }
        }
        
        // 13. Histórico de Alterações
        function initializeChangeHistory() {
            loadChangeHistory();
        }
        
        function addToChangeHistory(type, entity, changes) {
            const historyItem = {
                id: Date.now(),
                type, // 'create', 'update', 'delete'
                entity, // 'course', 'instructor', 'user'
                changes,
                user: currentUser?.username || 'Sistema',
                timestamp: new Date()
            };
            
            changeHistory.unshift(historyItem);
            if (changeHistory.length > 100) changeHistory.pop();
            
            saveChangeHistory();
        }
        
        function saveChangeHistory() {
            localStorage.setItem('changeHistory', JSON.stringify(changeHistory));
        }
        
        function loadChangeHistory() {
            const saved = localStorage.getItem('changeHistory');
            if (saved) {
                changeHistory = JSON.parse(saved).map(h => ({
                    ...h,
                    timestamp: new Date(h.timestamp)
                }));
            }
        }
        
        function renderChangeHistory() {
            const container = document.getElementById('changeHistoryContainer');
            if (!container) return;
            
            container.innerHTML = `
                <div class="history-timeline">
                    ${changeHistory.slice(0, 50).map(item => `
                        <div class="history-item">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <strong>${item.user}</strong> - ${getHistoryActionText(item.type)} ${item.entity}
                                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;">
                                        ${formatTimestamp(item.timestamp)}
                                    </div>
                                </div>
                            </div>
                            ${item.changes && Object.keys(item.changes).length > 0 ? `
                                <div class="history-changes">
                                    ${Object.entries(item.changes).map(([key, value]) => `
                                        <div class="history-change-item">
                                            <span>${key}:</span>
                                            ${value.old ? `<span class="history-change-old">${value.old}</span> → ` : ''}
                                            <span class="history-change-new">${value.new || value}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function getHistoryActionText(type) {
            const actions = {
                'create': 'criou',
                'update': 'atualizou',
                'delete': 'excluiu'
            };
            return actions[type] || type;
        }
        
        // Modificar renderCoursesByLote para usar filtros, ordenação e paginação
        const originalRenderCoursesByLote = window.renderCoursesByLote;
        window.renderCoursesByLote = function() {
            let coursesToRender = [...cursos];
            
            // Aplicar filtros
            coursesToRender = filterCourses(coursesToRender);
            
            // Aplicar ordenação
            coursesToRender = sortCourses(coursesToRender);
            
            // Atualizar contador
            
            // Aplicar paginação
            const totalItems = coursesToRender.length;
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            coursesToRender = coursesToRender.slice(startIndex, endIndex);
            
            // Renderizar paginação
            renderPagination(totalItems);
            
            // Chamar função original com cursos filtrados
            // (precisamos modificar a lógica para aceitar cursos pré-filtrados)
            // Por enquanto, vamos manter a lógica original mas aplicar os filtros
            if (originalRenderCoursesByLote) {
                // Salvar cursos filtrados temporariamente
                const originalCursos = cursos;
                cursos = coursesToRender;
                originalRenderCoursesByLote();
                cursos = originalCursos;
            }
        };
        
        // Atualizar filtros quando aplicar
        document.getElementById('applyFiltersBtn')?.addEventListener('click', () => {
            currentFilters = {
                search: document.getElementById('searchInput')?.value || '',
                status: document.getElementById('filterStatus')?.value || '',
                city: document.getElementById('filterCity')?.value || '',
                instructor: document.getElementById('filterInstructor')?.value || '',
                startDate: document.getElementById('filterStartDate')?.value || '',
                endDate: document.getElementById('filterEndDate')?.value || ''
            };
            applyFilters();
        });

        // ========== MELHORIAS SOLICITADAS ==========

        // 1. Animações de loading mais elaboradas
        function showAdvancedLoading(message = 'Carregando...') {
            const overlay = document.createElement('div');
            overlay.className = 'loading-overlay';
            overlay.id = 'advancedLoading';
            overlay.innerHTML = `
                <div>
                    <div class="loading-spinner"></div>
                    <div class="loading-content">${message}</div>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        function hideAdvancedLoading() {
            const overlay = document.getElementById('advancedLoading');
            if (overlay) {
                overlay.style.opacity = '0';
                setTimeout(() => overlay.remove(), 300);
            }
        }

        // 2. Feedback visual em ações
        function showActionFeedback(message, type = 'success') {
            const feedback = document.createElement('div');
            feedback.className = 'action-feedback';
            feedback.style.background = type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--danger)' : 'var(--warning)';
            feedback.innerHTML = `
                <span class="material-icons">${type === 'success' ? 'check_circle' : type === 'error' ? 'error' : 'warning'}</span>
                <span>${message}</span>
            `;
            document.body.appendChild(feedback);
            setTimeout(() => {
                feedback.style.opacity = '0';
                setTimeout(() => feedback.remove(), 300);
            }, 3000);
        }

        // 3. Notificações inteligentes - Alertas de cursos próximos do vencimento
        let upcomingCoursesNotifications = [];

        function getViewedNotifications() {
            const saved = localStorage.getItem('viewedNotifications');
            return saved ? JSON.parse(saved) : [];
        }

        function saveViewedNotifications(viewedIds) {
            localStorage.setItem('viewedNotifications', JSON.stringify(viewedIds));
        }

        function getNotificationHistory() {
            const saved = localStorage.getItem('notificationHistory');
            return saved ? JSON.parse(saved) : [];
        }

        function saveNotificationHistory(history) {
            localStorage.setItem('notificationHistory', JSON.stringify(history));
        }

        function deleteNotificationFromHistory(courseId) {
            const history = getNotificationHistory();
            const updated = history.filter(n => n.courseId !== courseId);
            saveNotificationHistory(updated);
        }

        function deleteAllNotificationsFromHistory() {
            saveNotificationHistory([]);
        }

        function checkUpcomingCourseDeadlines() {
            if (!cursos || cursos.length === 0) return;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);
            
            const viewedIds = getViewedNotifications();
            
            upcomingCoursesNotifications = cursos.filter(course => {
                if (!course.fim) return false;
                try {
                    const endDate = new Date(course.fim);
                    if (isNaN(endDate.getTime())) return false;
                    endDate.setHours(0, 0, 0, 0);
                    const status = normalizeStatus(course.status);
                    // Só incluir se não foi visualizada
                    return endDate >= today && endDate <= nextWeek && status !== 'Concluído' && !viewedIds.includes(course.id);
                } catch (e) {
                    return false;
                }
            });

            if (upcomingCoursesNotifications.length > 0) {
                // Adicionar notificação no sino (apenas não visualizadas)
                updateNotificationBadge(upcomingCoursesNotifications.length);
                // Salvar notificações
                localStorage.setItem('upcomingCoursesNotifications', JSON.stringify(upcomingCoursesNotifications));
                
                // Criar notificação push se permitido
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification(`Cursos Próximos do Vencimento`, {
                        body: `${upcomingCoursesNotifications.length} curso(s) vence(m) nos próximos 7 dias`,
                        icon: '/icon.png',
                        tag: 'course-reminder',
                        requireInteraction: false
                    });
                }
            } else {
                updateNotificationBadge(0);
                localStorage.removeItem('upcomingCoursesNotifications');
            }
        }

        function updateNotificationBadge(count) {
            const btn = document.getElementById('notificationBtn');
            if (!btn) {
                // Tentar novamente após um delay
                setTimeout(() => updateNotificationBadge(count), 500);
                return;
            }

            let badge = document.getElementById('notificationBadge');
            
            if (count > 0) {
                if (!badge) {
                    badge = document.createElement('span');
                    badge.id = 'notificationBadge';
                    badge.className = 'notification-badge';
                    badge.style.cssText = 'position: absolute; top: -6px; right: -6px; background: #ef4444; color: white; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; z-index: 1000; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4); border: 2px solid var(--background);';
                    btn.style.position = 'relative';
                    btn.appendChild(badge);
                }
                badge.textContent = count > 99 ? '99+' : count.toString();
                badge.style.display = 'flex';
            } else {
                if (badge) {
                    badge.style.display = 'none';
                }
            }
        }

        function showNotificationsModal() {
            // Prevenir múltiplos modais
            if (notificationModalOpen) return;
            
            // Carregar notificações salvas
            const saved = localStorage.getItem('upcomingCoursesNotifications');
            const allNotifications = saved ? JSON.parse(saved) : (upcomingCoursesNotifications || []);
            
            // Carregar histórico de notificações
            const history = getNotificationHistory();
            
            // Combinar notificações atuais com histórico
            const allNotifs = [...allNotifications];
            history.forEach(h => {
                if (!allNotifs.find(n => n.id === h.courseId)) {
                    allNotifs.push(h);
                }
            });

            if (allNotifs.length === 0) {
                showToast('Nenhuma notificação no momento', 'info');
                return;
            }

            // Marcar todas as notificações atuais como vistas ao abrir o modal
            const viewedIds = getViewedNotifications();
            allNotifications.forEach(course => {
                if (!viewedIds.includes(course.id)) {
                    viewedIds.push(course.id);
                    // Adicionar ao histórico se ainda não estiver
                    if (!history.find(h => h.courseId === course.id)) {
                        history.push({
                            courseId: course.id,
                            curso: course.curso || course.nome,
                            fim: course.fim,
                            cidade: course.cidade,
                            instrutor: course.instrutor,
                            status: course.status,
                            viewedAt: new Date().toISOString()
                        });
                    }
                }
            });
            saveViewedNotifications(viewedIds);
            saveNotificationHistory(history);
            
            // Atualizar badge (remover notificações vistas)
            const unviewedCount = allNotifications.filter(c => !viewedIds.includes(c.id)).length;
            updateNotificationBadge(unviewedCount);

            notificationModalOpen = true;
            
            // Remover modal existente se houver
            const existingModal = document.querySelector('.notification-modal-overlay');
            if (existingModal) {
                existingModal.remove();
            }

            const modal = document.createElement('div');
            modal.className = 'modal-overlay notification-modal-overlay active';
            modal.innerHTML = `
                <div class="modal notification-modal" style="max-width: 600px; border-radius: 20px; overflow: hidden; box-shadow: 0 25px 50px rgba(0,0,0,0.15); background: var(--surface);">
                    <div class="modal-header" style="padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--surface);">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span class="material-icons" style="font-size: 24px; color: var(--primary);">notifications</span>
                            <h3 style="margin: 0; font-size: 1.1rem; font-weight: 600; color: var(--text-primary);">Notificações</h3>
                            ${allNotifs.length > 0 ? `<span style="font-size: 0.875rem; color: var(--text-muted); margin-left: 0.5rem;">(${allNotifs.length})</span>` : ''}
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            ${allNotifs.length > 0 ? `
                                <button onclick="deleteAllNotificationsFromModal()" style="background: transparent; border: none; color: var(--text-muted); cursor: pointer; padding: 0.5rem; border-radius: 8px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" title="Excluir todas" onmouseover="this.style.background='var(--surface-hover)'; this.style.color='var(--danger)'" onmouseout="this.style.background='transparent'; this.style.color='var(--text-muted)'">
                                    <span class="material-icons" style="font-size: 20px;">delete_sweep</span>
                                </button>
                            ` : ''}
                            <button onclick="closeNotificationModal()" style="background: transparent; border: none; color: var(--text-muted); cursor: pointer; padding: 0.5rem; border-radius: 8px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='var(--surface-hover)'" onmouseout="this.style.background='transparent'">
                                <span class="material-icons" style="font-size: 20px;">close</span>
                            </button>
                        </div>
                    </div>
                    <div class="modal-body" style="padding: 1rem; max-height: 500px; overflow-y: auto;">
                        ${allNotifs.length === 0 ? `
                            <div style="padding: 3rem 2rem; text-align: center; color: var(--text-muted);">
                                <span class="material-icons" style="font-size: 48px; opacity: 0.3; margin-bottom: 1rem; display: block;">notifications_none</span>
                                <p style="margin: 0; font-size: 0.95rem;">Nenhuma notificação</p>
                            </div>
                        ` : `
                            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                ${allNotifs.map((course) => {
                                    try {
                                        const endDate = new Date(course.fim);
                                        const daysLeft = Math.ceil((endDate - new Date()) / (1000 * 60 * 60 * 24));
                                        const isUrgent = daysLeft <= 3;
                                        const isViewed = viewedIds.includes(course.id);
                                        return `
                                            <div class="notification-item-minimal" style="padding: 1rem; background: ${isViewed ? 'var(--background)' : 'var(--surface)'}; border-radius: 12px; border: 1px solid var(--border); transition: all 0.2s; position: relative; ${!isViewed ? 'border-left: 3px solid ' + (isUrgent ? 'var(--danger)' : 'var(--primary)') + ';' : ''}">
                                                <div style="display: flex; gap: 0.75rem; align-items: start;">
                                                    <div style="width: 36px; height: 36px; background: ${isUrgent ? 'var(--danger)' : 'var(--primary)'}; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
                                                        <span class="material-icons" style="font-size: 18px;">${isUrgent ? 'warning' : 'event'}</span>
                                                    </div>
                                                    <div style="flex: 1; min-width: 0;">
                                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                                            <h4 style="margin: 0; font-size: 0.95rem; font-weight: 600; color: var(--text-primary); line-height: 1.3;">${course.curso || course.nome || 'Sem nome'}</h4>
                                                            <button onclick="event.stopPropagation(); deleteNotificationFromModal('${course.id}')" style="background: transparent; border: none; color: var(--text-muted); cursor: pointer; padding: 0.25rem; border-radius: 6px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; opacity: 0.6;" onmouseover="this.style.opacity='1'; this.style.background='var(--surface-hover)'; this.style.color='var(--danger)'" onmouseout="this.style.opacity='0.6'; this.style.background='transparent'; this.style.color='var(--text-muted)'" title="Excluir">
                                                                <span class="material-icons" style="font-size: 18px;">close</span>
                                                            </button>
                                                        </div>
                                                        <div style="display: flex; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 0.5rem;">
                                                            <div style="display: flex; align-items: center; gap: 0.375rem; font-size: 0.8rem; color: var(--text-secondary);">
                                                                <span class="material-icons" style="font-size: 16px;">calendar_today</span>
                                                                <span>${formatDate(course.fim)}</span>
                                                            </div>
                                                            <div style="display: flex; align-items: center; gap: 0.375rem; font-size: 0.8rem; color: ${isUrgent ? 'var(--danger)' : 'var(--text-secondary)'}; font-weight: ${isUrgent ? '600' : '400'};">
                                                                <span class="material-icons" style="font-size: 16px;">schedule</span>
                                                                <span>${daysLeft} dia(s)</span>
                                                            </div>
                                                            ${course.cidade ? `
                                                                <div style="display: flex; align-items: center; gap: 0.375rem; font-size: 0.8rem; color: var(--text-secondary);">
                                                                    <span class="material-icons" style="font-size: 16px;">location_on</span>
                                                                    <span>${course.cidade}</span>
                                                                </div>
                                                            ` : ''}
                                                        </div>
                                                        <button onclick="event.stopPropagation(); openViewCourseModal('${course.id}'); closeNotificationModal();" style="width: 100%; padding: 0.5rem; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.5rem;" onmouseover="this.style.background='var(--primary-hover)'" onmouseout="this.style.background='var(--primary)'">
                                                            <span class="material-icons" style="font-size: 18px;">visibility</span>
                                                            Ver detalhes
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    } catch (e) {
                                        return '';
                                    }
                                }).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Fechar ao clicar fora
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeNotificationModal();
                }
            });
            
            // Fechar com ESC
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    closeNotificationModal();
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
        }

        function deleteNotificationFromModal(courseId) {
            // Remover do histórico
            deleteNotificationFromHistory(courseId);
            
            // Remover das notificações atuais se estiver lá
            const saved = localStorage.getItem('upcomingCoursesNotifications');
            if (saved) {
                const notifications = JSON.parse(saved);
                const updated = notifications.filter(n => n.id !== courseId);
                localStorage.setItem('upcomingCoursesNotifications', JSON.stringify(updated));
            }
            
            // Remover das visualizadas
            const viewedIds = getViewedNotifications();
            const updatedViewed = viewedIds.filter(id => id !== courseId);
            saveViewedNotifications(updatedViewed);
            
            // Recarregar modal
            closeNotificationModal();
            setTimeout(() => {
                showNotificationsModal();
            }, 100);
        }

        function deleteAllNotificationsFromModal() {
            if (confirm('Tem certeza que deseja excluir todas as notificações?')) {
                deleteAllNotificationsFromHistory();
                localStorage.removeItem('upcomingCoursesNotifications');
                saveViewedNotifications([]);
                
                // Atualizar badge
                updateNotificationBadge(0);
                
                // Recarregar modal
                closeNotificationModal();
                setTimeout(() => {
                    showNotificationsModal();
                }, 100);
            }
        }
        
        function closeNotificationModal() {
            const modal = document.querySelector('.notification-modal-overlay');
            if (modal) {
                modal.style.opacity = '0';
                setTimeout(() => {
                    modal.remove();
                    notificationModalOpen = false;
                }, 200);
            } else {
                notificationModalOpen = false;
            }
        }
        
        // Tornar funções acessíveis globalmente
        window.showNotificationsModal = showNotificationsModal;
        window.closeNotificationModal = closeNotificationModal;
        window.deleteNotificationFromModal = deleteNotificationFromModal;
        window.deleteAllNotificationsFromModal = deleteAllNotificationsFromModal;

        // 4. Modo de visualização - Lista, grid e timeline
        let currentViewMode = 'grid'; // 'grid', 'list', 'timeline'

        function initializeViewModes() {
            const viewModeContainer = document.createElement('div');
            viewModeContainer.className = 'view-mode-selector';
            viewModeContainer.style.cssText = 'display: flex; gap: 8px; margin-bottom: 1rem; align-items: center;';
            viewModeContainer.innerHTML = `
                <span style="margin-right: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">Visualização:</span>
                <button class="view-mode-btn ${currentViewMode === 'grid' ? 'active' : ''}" data-mode="grid" title="Grid">
                    <span class="material-icons">grid_view</span>
                </button>
                <button class="view-mode-btn ${currentViewMode === 'list' ? 'active' : ''}" data-mode="list" title="Lista">
                    <span class="material-icons">view_list</span>
                </button>
                <button class="view-mode-btn ${currentViewMode === 'timeline' ? 'active' : ''}" data-mode="timeline" title="Timeline">
                    <span class="material-icons">timeline</span>
                </button>
            `;

            // Adicionar estilos para os botões
            if (!document.getElementById('viewModeStyles')) {
                const style = document.createElement('style');
                style.id = 'viewModeStyles';
                style.textContent = `
                    .view-mode-btn {
                        padding: 8px 12px;
                        background: var(--surface);
                        border: 1px solid var(--border);
                        border-radius: 8px;
                        color: var(--text-secondary);
                        cursor: pointer;
                        transition: all 0.3s ease;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                    .view-mode-btn:hover {
                        background: var(--surface-hover);
                        color: var(--text-primary);
                    }
                    .view-mode-btn.active {
                        background: var(--primary);
                        color: white;
                        border-color: var(--primary);
                    }
                `;
                document.head.appendChild(style);
            }

            const coursesPage = document.getElementById('coursesPage');
            if (coursesPage) {
                const header = coursesPage.querySelector('.page-header');
                if (header && !header.querySelector('.view-mode-selector')) {
                    header.appendChild(viewModeContainer);
                }
            }

            viewModeContainer.querySelectorAll('.view-mode-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentViewMode = btn.dataset.mode;
                    viewModeContainer.querySelectorAll('.view-mode-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    localStorage.setItem('viewMode', currentViewMode);
                    renderCoursesByLote();
                });
            });

            // Carregar modo salvo
            const savedMode = localStorage.getItem('viewMode');
            if (savedMode && ['grid', 'list', 'timeline'].includes(savedMode)) {
                currentViewMode = savedMode;
                viewModeContainer.querySelectorAll('.view-mode-btn').forEach(b => {
                    b.classList.toggle('active', b.dataset.mode === currentViewMode);
                });
            }
        }

        // 5. Integração com WhatsApp
        function sendWhatsAppMessage(phone, message) {
            const cleanPhone = phone.replace(/\D/g, '');
            const url = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }

        function openWhatsAppForCourse(courseId) {
            const course = cursos.find(c => c.id === courseId);
            if (!course || !course.instrutor) {
                showToast('Instrutor não encontrado ou sem telefone', 'error');
                return;
            }
            
            const instructor = instrutores.find(i => i.nome === course.instrutor);
            if (!instructor || !instructor.telefone) {
                showToast('Telefone do instrutor não encontrado', 'error');
                return;
            }

            const message = `Olá ${instructor.nome}! Gostaria de falar sobre o curso: ${course.curso}`;
            sendWhatsAppMessage(instructor.telefone, message);
        }

        // 6. Backup e restauração - Interface para gerenciar backups
        function initializeBackupManager() {
            const backupSection = document.createElement('div');
            backupSection.className = 'settings-card';
            backupSection.innerHTML = `
                <div class="settings-section-header">
                    <div class="settings-icon-large">
                        <span class="material-icons">backup</span>
                    </div>
                    <div class="settings-header-content">
                        <h3>Backup e Restauração</h3>
                        <p>Gerencie seus backups e restaure dados quando necessário</p>
                    </div>
                </div>
                <div style="margin-top: 1.5rem;">
                    <button class="btn btn-primary" onclick="createManualBackup()">
                        <span class="material-icons">save</span>
                        Criar Backup Manual
                    </button>
                    <button class="btn btn-secondary" onclick="showBackupList()" style="margin-left: 1rem;">
                        <span class="material-icons">history</span>
                        Ver Backups
                    </button>
                </div>
            `;

            const settingsPage = document.getElementById('settingsPage');
            if (settingsPage) {
                settingsPage.appendChild(backupSection);
            }
        }

        function createManualBackup() {
            const backup = {
                timestamp: new Date().toISOString(),
                cursos: cursos,
                instrutores: instrutores,
                usuarios: usuarios,
                loteNames: loteNames
            };
            
            const backupKey = 'manual_backup_' + Date.now();
            localStorage.setItem(backupKey, JSON.stringify(backup));
            showActionFeedback('Backup criado com sucesso!', 'success');
        }

        function showBackupList() {
            const backups = Object.keys(localStorage)
                .filter(k => k.startsWith('backup_') || k.startsWith('manual_backup_'))
                .map(k => ({
                    key: k,
                    data: JSON.parse(localStorage.getItem(k))
                }))
                .sort((a, b) => new Date(b.data.timestamp) - new Date(a.data.timestamp));

            // Criar modal para listar backups
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.innerHTML = `
                <div class="modal" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3>Backups Disponíveis</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                            <span class="material-icons">close</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="backup-list">
                            ${backups.map(backup => `
                                <div class="backup-item" style="padding: 1rem; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 1rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>${new Date(backup.data.timestamp).toLocaleString('pt-BR')}</strong>
                                            <p style="margin: 0.5rem 0 0 0; color: var(--text-muted); font-size: 0.875rem;">
                                                ${backup.data.cursos?.length || 0} cursos, ${backup.data.instrutores?.length || 0} instrutores
                                            </p>
                                        </div>
                                        <button class="btn btn-primary" onclick="restoreBackup('${backup.key}')">
                                            <span class="material-icons">restore</span>
                                            Restaurar
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function restoreBackup(backupKey) {
            if (!confirm('Tem certeza que deseja restaurar este backup? Todos os dados atuais serão substituídos.')) return;
            
            const backup = JSON.parse(localStorage.getItem(backupKey));
            if (backup) {
                cursos = backup.cursos || [];
                instrutores = backup.instrutores || [];
                usuarios = backup.usuarios || usuarios;
                loteNames = backup.loteNames || {};
                
                saveAllChanges();
                loadData();
                showActionFeedback('Backup restaurado com sucesso!', 'success');
                document.querySelector('.modal-overlay.active')?.remove();
            }
        }

        // 7. Auditoria - Log detalhado
        function logAuditAction(action, details, type = 'info') {
            const auditLog = {
                timestamp: new Date().toISOString(),
                user: currentUser?.name || 'Sistema',
                action: action,
                details: details,
                type: type
            };
            
            let auditLogs = JSON.parse(localStorage.getItem('auditLogs') || '[]');
            auditLogs.push(auditLog);
            
            // Manter apenas os últimos 1000 logs
            if (auditLogs.length > 1000) {
                auditLogs = auditLogs.slice(-1000);
            }
            
            localStorage.setItem('auditLogs', JSON.stringify(auditLogs));
        }

        function showAuditReport() {
            const auditLogs = JSON.parse(localStorage.getItem('auditLogs') || '[]');
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.innerHTML = `
                <div class="modal" style="max-width: 1000px; max-height: 90vh;">
                    <div class="modal-header">
                        <h3>Relatório de Auditoria</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                            <span class="material-icons">close</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div style="overflow-y: auto; max-height: 70vh;">
                            ${auditLogs.slice().reverse().map(log => `
                                <div class="audit-log-item" style="padding: 1rem; border-bottom: 1px solid var(--border);">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div>
                                            <strong>${log.action}</strong>
                                            <p style="margin: 0.5rem 0 0 0; color: var(--text-muted); font-size: 0.875rem;">
                                                ${log.details}
                                            </p>
                                            <p style="margin: 0.5rem 0 0 0; color: var(--text-muted); font-size: 0.75rem;">
                                                Por: ${log.user} - ${new Date(log.timestamp).toLocaleString('pt-BR')}
                                            </p>
                                        </div>
                                        <span class="status-badge ${log.type}" style="font-size: 0.7rem;">${log.type}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // 8. PWA - Service Worker e Manifest
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(() => {
                    // Service worker não disponível, continuar normalmente
                });
            });
        }

        // 9. Gestos no mobile - Swipe para ações
        let touchStartX = 0;
        let touchStartY = 0;

        function initializeSwipeGestures() {
            document.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            });

            document.addEventListener('touchend', (e) => {
                if (!touchStartX || !touchStartY) return;
                
                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;
                const diffX = touchStartX - touchEndX;
                const diffY = touchStartY - touchEndY;

                // Swipe horizontal (mais de 50px)
                if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                    if (diffX > 0) {
                        // Swipe left - abrir sidebar
                        if (window.innerWidth <= 768) {
                            document.getElementById('sidebar')?.classList.add('active');
                        }
                    } else {
                        // Swipe right - fechar sidebar
                        if (window.innerWidth <= 768) {
                            document.getElementById('sidebar')?.classList.remove('active');
                        }
                    }
                }

                // Pull to refresh
                if (diffY > 100 && window.scrollY === 0) {
                    location.reload();
                }

                touchStartX = 0;
                touchStartY = 0;
            });
        }


        // 11. Integração com calendário - Lembretes automáticos
        function initializeCalendarIntegration() {
            // Configurar lembretes automáticos
            setupAutomaticReminders();
        }

        function setupAutomaticReminders() {
            // Verificar cursos próximos do vencimento diariamente
            setInterval(() => {
                const today = new Date();
                const nextWeek = new Date(today);
                nextWeek.setDate(today.getDate() + 7);

                const upcomingCourses = cursos.filter(course => {
                    if (!course.fim) return false;
                    const endDate = new Date(course.fim);
                    return endDate >= today && endDate <= nextWeek && normalizeStatus(course.status) !== 'Concluído';
                });

                if (upcomingCourses.length > 0) {
                    // Criar notificação
                    if ('Notification' in window && Notification.permission === 'granted') {
                        new Notification(`Cursos Próximos do Vencimento`, {
                            body: `${upcomingCourses.length} curso(s) vence(m) nos próximos 7 dias`,
                            icon: '/icon.png',
                            tag: 'course-reminder'
                        });
                    }
                }
            }, 24 * 60 * 60 * 1000); // Verificar uma vez por dia

            // Solicitar permissão para notificações
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        // Inicializar todas as melhorias
        setTimeout(() => {
            initializeViewModes();
            initializeBackupManager();
            initializeSwipeGestures();
            initializeCalendarIntegration();
            checkUpcomingCourseDeadlines();
            
            // Carregar notificações salvas ao inicializar
            const saved = localStorage.getItem('upcomingCoursesNotifications');
            if (saved) {
                upcomingCoursesNotifications = JSON.parse(saved);
                updateNotificationBadge(upcomingCoursesNotifications.length);
            }
            
            // Verificar cursos próximos do vencimento a cada hora
            setInterval(checkUpcomingCourseDeadlines, 60 * 60 * 1000);
        }, 1000);

        // Interceptar ações para auditoria
        const originalDeleteCourse = window.deleteCourse;
        window.deleteCourse = function(id) {
            const course = cursos.find(c => c.id === id);
            if (course) {
                logAuditAction('Exclusão de Curso', `Curso "${course.curso}" foi excluído`, 'danger');
            }
            return originalDeleteCourse.apply(this, arguments);
        };

        const originalSaveCourse = window.handleCourseSubmit;
        if (originalSaveCourse) {
            // Log será feito dentro da função original
        }
    </script>
</body>
</html>
