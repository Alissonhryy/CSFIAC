<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <link rel="icon" type="image/png" href="icon-180.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#6366f1">
    <meta name="description" content="Sistema de gestão de cursos CSF + Qualificação e Renda">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ceará Sem Fome + Qualificação e Renda">
    <link rel="manifest" href="manifest.json">
    <!-- Apple Touch Icons para iOS -->
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon-180x180.png">
    <link rel="apple-touch-icon" sizes="167x167" href="apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="152x152" href="apple-touch-icon.png">
    <link rel="apple-touch-icon-precomposed" href="apple-touch-icon-precomposed.png">
    <title>CSF + Qualificação e Renda</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Adicionando SheetJS para leitura de Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Adicionando Chart.js para gráfico pizza -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Adicionando html2canvas para captura de tela -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --primary-light: rgba(99, 102, 241, 0.1);
            --background: #0f172a;
            --sidebar: #020617;
            --surface: #1e293b;
            --surface-hover: #334155;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: #334155;
            --overlay: rgba(0, 0, 0, 0.7);
            --card: #1e293b;
            --transition-speed: 0.3s;
        }

        /* Transição suave para temas */
        *, *::before, *::after {
            transition: background-color var(--transition-speed) ease,
                        border-color var(--transition-speed) ease,
                        color var(--transition-speed) ease,
                        box-shadow var(--transition-speed) ease;
        }

        /* Modo Claro */
        :root.light-mode {
            --background: #f8fafc;
            --sidebar: #ffffff;
            --surface: #ffffff;
            --surface-hover: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --card: #ffffff;
            --overlay: rgba(0, 0, 0, 0.5);
        }
        
        /* Temas de Cores */
        :root.theme-blue {
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --primary-light: rgba(59, 130, 246, 0.1);
        }
        
        :root.theme-green {
            --primary: #10b981;
            --primary-hover: #059669;
            --primary-light: rgba(16, 185, 129, 0.1);
        }
        
        :root.theme-purple {
            --primary: #8b5cf6;
            --primary-hover: #7c3aed;
            --primary-light: rgba(139, 92, 246, 0.1);
        }
        
        :root.theme-rose {
            --primary: #f43f5e;
            --primary-hover: #e11d48;
            --primary-light: rgba(244, 63, 94, 0.1);
        }
        
        :root.theme-orange {
            --primary: #f97316;
            --primary-hover: #ea580c;
            --primary-light: rgba(249, 115, 22, 0.1);
        }
        
        :root.theme-cyan {
            --primary: #06b6d4;
            --primary-hover: #0891b2;
            --primary-light: rgba(6, 182, 212, 0.1);
        }
        
        /* ==================== SKELETON LOADING ==================== */
        .skeleton {
            background: linear-gradient(90deg, var(--surface) 25%, var(--surface-hover) 50%, var(--surface) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 8px;
        }
        
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .skeleton-card {
            height: 200px;
            border-radius: 16px;
        }
        
        .skeleton-text {
            height: 16px;
            margin-bottom: 8px;
        }
        
        .skeleton-text.short {
            width: 60%;
        }
        
        .skeleton-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
        }
        
        /* ==================== ANIMAÇÕES DE ENTRADA ==================== */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .animate-in {
            animation: fadeInUp 0.4s ease forwards;
        }
        
        .animate-in-scale {
            animation: fadeInScale 0.3s ease forwards;
        }
        
        .animate-in-left {
            animation: slideInLeft 0.3s ease forwards;
        }
        
        /* Stagger animation para cards */
        .courses-grid .course-card,
        .instructors-grid .instructor-card {
            opacity: 0;
            animation: fadeInUp 0.4s ease forwards;
        }
        
        .courses-grid .course-card:nth-child(1) { animation-delay: 0.05s; }
        .courses-grid .course-card:nth-child(2) { animation-delay: 0.1s; }
        .courses-grid .course-card:nth-child(3) { animation-delay: 0.15s; }
        .courses-grid .course-card:nth-child(4) { animation-delay: 0.2s; }
        .courses-grid .course-card:nth-child(5) { animation-delay: 0.25s; }
        .courses-grid .course-card:nth-child(6) { animation-delay: 0.3s; }
        .courses-grid .course-card:nth-child(n+7) { animation-delay: 0.35s; }
        
        /* ==================== FEEDBACK VISUAL BOTÕES ==================== */
        .btn {
            position: relative;
            overflow: hidden;
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.4s ease, height 0.4s ease;
        }
        
        .btn:active::after {
            width: 200px;
            height: 200px;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        /* ==================== BUSCA GLOBAL ==================== */
        .global-search-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--overlay);
            z-index: 10002;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 15vh;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
        }
        
        .global-search-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .global-search-container {
            background: var(--surface);
            border-radius: 16px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            transform: translateY(-20px);
            transition: transform 0.2s ease;
            overflow: hidden;
        }
        
        .global-search-overlay.active .global-search-container {
            transform: translateY(0);
        }
        
        .global-search-input-wrapper {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
        }
        
        .global-search-input-wrapper .material-icons {
            color: var(--text-muted);
            margin-right: 1rem;
        }
        
        .global-search-input {
            flex: 1;
            background: none;
            border: none;
            font-size: 1.1rem;
            color: var(--text-primary);
            outline: none;
        }
        
        .global-search-input::placeholder {
            color: var(--text-muted);
        }
        
        .global-search-shortcut {
            padding: 4px 8px;
            background: var(--surface-hover);
            border-radius: 6px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .global-search-results {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .search-result-group {
            padding: 0.5rem 0;
        }
        
        .search-result-group-title {
            padding: 0.5rem 1.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .search-result-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            transition: background 0.15s ease;
        }
        
        .search-result-item:hover,
        .search-result-item.selected {
            background: var(--surface-hover);
        }
        
        .search-result-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .search-result-icon .material-icons {
            color: var(--primary);
        }
        
        .search-result-content {
            flex: 1;
            min-width: 0;
        }
        
        .search-result-title {
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .search-result-subtitle {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        
        .search-result-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
        }
        
        .search-no-results {
            padding: 2rem;
            text-align: center;
            color: var(--text-muted);
        }
        
        .search-no-results .material-icons {
            font-size: 48px;
            margin-bottom: 0.5rem;
            opacity: 0.5;
        }
        
        /* ==================== ATALHOS DE TECLADO ==================== */
        .shortcuts-modal {
            max-width: 500px;
        }
        
        .shortcut-group {
            margin-bottom: 1.5rem;
        }
        
        .shortcut-group-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }
        
        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }
        
        .shortcut-item:last-child {
            border-bottom: none;
        }
        
        .shortcut-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .shortcut-keys {
            display: flex;
            gap: 4px;
        }
        
        .shortcut-key {
            padding: 4px 8px;
            background: var(--surface-hover);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            font-family: monospace;
        }
        
        /* ==================== SELETOR DE TEMAS ==================== */
        .theme-selector {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 0.5rem;
        }
        
        .theme-color-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .theme-color-btn:hover {
            transform: scale(1.1);
        }
        
        .theme-color-btn.active {
            border-color: var(--text-primary);
        }
        
        .theme-color-btn.active::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: bold;
        }
        
        .theme-color-btn.default { background: #6366f1; }
        .theme-color-btn.blue { background: #3b82f6; }
        .theme-color-btn.green { background: #10b981; }
        .theme-color-btn.purple { background: #8b5cf6; }
        .theme-color-btn.rose { background: #f43f5e; }
        .theme-color-btn.orange { background: #f97316; }
        .theme-color-btn.cyan { background: #06b6d4; }
        
        /* ==================== DASHBOARD CHARTS ==================== */
        .dashboard-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .chart-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }
        
        .chart-card:hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .chart-header {
            margin-bottom: 1rem;
        }
        
        .chart-header h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }
        
        .chart-subtitle {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        
        .chart-container {
            height: 250px;
            position: relative;
        }
        
        /* ==================== DASHBOARD TIMELINE ==================== */
        .dashboard-timeline {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .timeline-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .timeline-header h3 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }
        
        .timeline-header .material-icons {
            color: var(--primary);
        }
        
        .timeline-content {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .timeline-item {
            display: flex;
            gap: 1rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
            position: relative;
        }
        
        .timeline-item:last-child {
            border-bottom: none;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 40px;
            bottom: -10px;
            width: 2px;
            background: var(--border);
        }
        
        .timeline-item:last-child::before {
            display: none;
        }
        
        .timeline-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            z-index: 1;
        }
        
        .timeline-icon .material-icons {
            font-size: 16px;
            color: white;
        }
        
        .timeline-icon.add { background: var(--success); }
        .timeline-icon.edit { background: var(--info); }
        .timeline-icon.delete { background: var(--danger); }
        .timeline-icon.complete { background: var(--success); }
        .timeline-icon.default { background: var(--text-muted); }
        
        .timeline-details {
            flex: 1;
            min-width: 0;
        }
        
        .timeline-title {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .timeline-description {
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-top: 2px;
        }
        
        .timeline-time {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }
        
        .timeline-empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }
        
        /* Search hint no header */
        .header-search-hint {
            margin-left: auto;
        }
        
        @media (max-width: 768px) {
            .header-search-hint {
                display: none !important;
            }
            
            .dashboard-charts {
                grid-template-columns: 1fr;
            }
        }

        /* ==================== MODO COMPACTO ==================== */
        .compact-mode .course-card {
            padding: 0.75rem !important;
            min-height: auto !important;
        }
        .compact-mode .course-card .course-header {
            margin-bottom: 0.5rem;
        }
        .compact-mode .course-card .course-title {
            font-size: 0.9rem !important;
        }
        .compact-mode .course-card .course-info {
            gap: 0.25rem !important;
        }
        .compact-mode .course-card .course-info-item {
            font-size: 0.75rem !important;
            padding: 0.15rem 0 !important;
        }
        .compact-mode .course-card .course-info-item .material-icons {
            font-size: 14px !important;
        }
        .compact-mode .course-card .status-badge {
            font-size: 0.65rem !important;
            padding: 0.15rem 0.5rem !important;
        }
        .compact-mode .course-card .course-actions button {
            padding: 4px !important;
        }
        .compact-mode .course-card .course-actions .material-icons {
            font-size: 16px !important;
        }
        .compact-mode .courses-grid {
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)) !important;
            gap: 0.75rem !important;
        }
        .compact-mode .course-note {
            display: none;
        }
        .compact-mode .course-alert {
            padding: 0.5rem !important;
            font-size: 0.75rem !important;
        }

        /* Botão toggle modo compacto */
        .view-toggle-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        .view-toggle-btn:hover {
            background: var(--surface-hover);
            color: var(--text-primary);
        }
        .view-toggle-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* ==================== SKELETON LOADING ==================== */
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .skeleton {
            background: linear-gradient(90deg, var(--surface) 25%, var(--surface-hover) 50%, var(--surface) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }
        .skeleton-card {
            height: 200px;
            border-radius: 16px;
        }
        .skeleton-text {
            height: 1rem;
            margin-bottom: 0.5rem;
        }
        .skeleton-text.short { width: 60%; }
        .skeleton-text.medium { width: 80%; }
        .skeleton-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        /* ==================== ANIMAÇÕES SUAVES ==================== */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        .animate-slide-in {
            animation: slideIn 0.3s ease-out forwards;
        }
        .animate-scale-in {
            animation: scaleIn 0.2s ease-out forwards;
        }
        .page-section {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .page-section:not(.active) {
            opacity: 0;
            transform: translateY(10px);
        }
        .page-section.active {
            animation: fadeIn 0.4s ease-out;
        }
        .course-card, .kpi-card, .instructor-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, opacity 0.3s ease;
            opacity: 0;
        }
        .collapsible-content.expanded {
            max-height: 2000px;
            opacity: 1;
        }

        /* ==================== BREADCRUMBS ==================== */
        .breadcrumbs {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: var(--surface);
            border-radius: 10px;
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
            flex-wrap: wrap;
        }
        .breadcrumb-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.2s;
        }
        .breadcrumb-item:hover {
            color: var(--primary);
        }
        .breadcrumb-item.active {
            color: var(--text-primary);
            font-weight: 500;
            cursor: default;
        }
        .breadcrumb-separator {
            color: var(--text-muted);
        }
        .breadcrumb-item .material-icons {
            font-size: 18px;
        }

        /* ==================== NOTIFICAÇÕES PUSH ==================== */
        .notification-banner {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 380px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            animation: slideInRight 0.4s ease-out;
            display: none;
        }
        .notification-banner.show {
            display: block;
        }
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }
        .notification-banner.hiding {
            animation: slideOutRight 0.3s ease-in forwards;
        }
        @keyframes slideOutRight {
            to { opacity: 0; transform: translateX(100%); }
        }
        .notification-banner-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        .notification-banner-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .notification-banner-title .material-icons {
            color: var(--warning);
        }
        .notification-banner-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }
        .notification-banner-close:hover {
            background: var(--surface-hover);
        }
        .notification-banner-body {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.5;
        }
        .notification-banner-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .notification-badge-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        /* ==================== SWIPE GESTURES (MOBILE) ==================== */
        .swipeable-card {
            position: relative;
            overflow: hidden;
            touch-action: pan-y;
        }
        .swipe-actions {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            display: flex;
            align-items: center;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        .swipe-action-btn {
            height: 100%;
            padding: 0 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            border: none;
            cursor: pointer;
        }
        .swipe-action-btn.edit {
            background: var(--primary);
        }
        .swipe-action-btn.delete {
            background: var(--danger);
        }
        .swipe-action-btn .material-icons {
            font-size: 24px;
        }
        .swipeable-card.swiped .swipe-actions {
            transform: translateX(0);
        }
        .swipeable-card .card-content {
            background: var(--card);
            position: relative;
            z-index: 1;
            transition: transform 0.3s ease;
        }
        .swipeable-card.swiping .card-content {
            transition: none;
        }

        /* ==================== PWA INSTALL PROMPT ==================== */
        .pwa-install-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--surface);
            border: 1px solid var(--primary);
            border-radius: 16px;
            padding: 1rem 1.5rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            z-index: 10001;
            display: none;
            align-items: center;
            gap: 1rem;
            max-width: 90%;
            animation: slideUp 0.4s ease-out;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translate(-50%, 100%); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
        .pwa-install-prompt.show {
            display: flex;
        }
        .pwa-install-icon {
            width: 48px;
            height: 48px;
            background: var(--primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .pwa-install-icon .material-icons {
            font-size: 28px;
            color: white;
        }
        .pwa-install-text h4 {
            margin: 0 0 0.25rem;
            color: var(--text-primary);
        }
        .pwa-install-text p {
            margin: 0;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        .pwa-install-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        /* Tema Verde */
        :root.theme-green {
            --primary: #10b981;
            --primary-hover: #059669;
        }
        
        :root.theme-green:not(.light-mode) {
            --background: #0f172a;
            --sidebar: #064e3b;
            --surface: #065f46;
            --surface-hover: #047857;
            --text-primary: #f8fafc;
            --text-secondary: #d1fae5;
            --text-muted: #a7f3d0;
            --border: #10b981;
            --overlay: rgba(15, 23, 42, 0.8);
            --card: #065f46;
        }
        
        :root.theme-green.light-mode {
            --background: #ecfdf5;
            --sidebar: #d1fae5;
            --surface: #a7f3d0;
            --surface-hover: #6ee7b7;
            --text-primary: #064e3b;
            --text-secondary: #065f46;
            --text-muted: #10b981;
            --border: #10b981;
            --overlay: rgba(16, 185, 129, 0.5);
            --card: #d1fae5;
        }
        
        /* Tema Roxo */
        :root.theme-purple {
            --primary: #8b5cf6;
            --primary-hover: #7c3aed;
        }
        
        :root.theme-purple:not(.light-mode) {
            --background: #0f172a;
            --sidebar: #581c87;
            --surface: #6b21a8;
            --surface-hover: #7c3aed;
            --text-primary: #f8fafc;
            --text-secondary: #e9d5ff;
            --text-muted: #ddd6fe;
            --border: #8b5cf6;
            --overlay: rgba(15, 23, 42, 0.8);
            --card: #6b21a8;
        }
        
        :root.theme-purple.light-mode {
            --background: #faf5ff;
            --sidebar: #f3e8ff;
            --surface: #e9d5ff;
            --surface-hover: #ddd6fe;
            --text-primary: #581c87;
            --text-secondary: #6b21a8;
            --text-muted: #8b5cf6;
            --border: #8b5cf6;
            --overlay: rgba(139, 92, 246, 0.5);
            --card: #f3e8ff;
        }

        /* Tema Azul */
        :root.theme-blue {
            --primary: #3b82f6;
            --primary-hover: #2563eb;
        }
        
        :root.theme-blue:not(.light-mode) {
            --background: #0f172a;
            --sidebar: #1e3a8a;
            --surface: #1e40af;
            --surface-hover: #2563eb;
            --text-primary: #f8fafc;
            --text-secondary: #dbeafe;
            --text-muted: #bfdbfe;
            --border: #3b82f6;
            --overlay: rgba(15, 23, 42, 0.8);
            --card: #1e40af;
        }
        
        :root.theme-blue.light-mode {
            --background: #eff6ff;
            --sidebar: #dbeafe;
            --surface: #bfdbfe;
            --surface-hover: #93c5fd;
            --text-primary: #1e3a8a;
            --text-secondary: #1e40af;
            --text-muted: #3b82f6;
            --border: #3b82f6;
            --overlay: rgba(59, 130, 246, 0.5);
            --card: #dbeafe;
        }

        /* Tema Laranja */
        :root.theme-orange {
            --primary: #f97316;
            --primary-hover: #ea580c;
        }
        
        :root.theme-orange:not(.light-mode) {
            --background: #0f172a;
            --sidebar: #7c2d12;
            --surface: #9a3412;
            --surface-hover: #c2410c;
            --text-primary: #f8fafc;
            --text-secondary: #fed7aa;
            --text-muted: #fdba74;
            --border: #f97316;
            --overlay: rgba(15, 23, 42, 0.8);
            --card: #9a3412;
        }
        
        :root.theme-orange.light-mode {
            --background: #fff7ed;
            --sidebar: #ffedd5;
            --surface: #fed7aa;
            --surface-hover: #fdba74;
            --text-primary: #7c2d12;
            --text-secondary: #9a3412;
            --text-muted: #f97316;
            --border: #f97316;
            --overlay: rgba(249, 115, 22, 0.5);
            --card: #ffedd5;
        }

        /* Tema Rosa */
        :root.theme-pink {
            --primary: #ec4899;
            --primary-hover: #db2777;
        }
        
        :root.theme-pink:not(.light-mode) {
            --background: #0f172a;
            --sidebar: #831843;
            --surface: #9f1239;
            --surface-hover: #be185d;
            --text-primary: #f8fafc;
            --text-secondary: #fce7f3;
            --text-muted: #fbcfe8;
            --border: #ec4899;
            --overlay: rgba(15, 23, 42, 0.8);
            --card: #9f1239;
        }
        
        :root.theme-pink.light-mode {
            --background: #fdf2f8;
            --sidebar: #fce7f3;
            --surface: #fbcfe8;
            --surface-hover: #f9a8d4;
            --text-primary: #831843;
            --text-secondary: #9f1239;
            --text-muted: #ec4899;
            --border: #ec4899;
            --overlay: rgba(236, 72, 153, 0.5);
            --card: #fce7f3;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--background);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Login Screen */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(-45deg, #0f172a, #1e293b, #312e81, #1e1b4b);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            overflow: hidden;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Partículas flutuantes */
        .login-particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: rgba(99, 102, 241, 0.3);
            border-radius: 50%;
            animation: float 20s infinite;
        }

        .particle:nth-child(1) { left: 10%; animation-delay: 0s; animation-duration: 25s; }
        .particle:nth-child(2) { left: 20%; animation-delay: 2s; animation-duration: 20s; width: 15px; height: 15px; }
        .particle:nth-child(3) { left: 30%; animation-delay: 4s; animation-duration: 28s; }
        .particle:nth-child(4) { left: 40%; animation-delay: 1s; animation-duration: 22s; width: 8px; height: 8px; }
        .particle:nth-child(5) { left: 50%; animation-delay: 3s; animation-duration: 18s; }
        .particle:nth-child(6) { left: 60%; animation-delay: 5s; animation-duration: 24s; width: 12px; height: 12px; }
        .particle:nth-child(7) { left: 70%; animation-delay: 2s; animation-duration: 26s; }
        .particle:nth-child(8) { left: 80%; animation-delay: 4s; animation-duration: 21s; width: 6px; height: 6px; }
        .particle:nth-child(9) { left: 90%; animation-delay: 1s; animation-duration: 23s; }
        .particle:nth-child(10) { left: 15%; animation-delay: 3s; animation-duration: 19s; width: 14px; height: 14px; }

        @keyframes float {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100vh) rotate(720deg); opacity: 0; }
        }

        .login-overlay.hidden {
            display: none;
        }

        .login-card {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(20px);
            padding: 2.5rem;
            border-radius: 24px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.1);
            animation: slideUp 0.6s ease-out;
            position: relative;
            z-index: 1;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 0.5rem;
            justify-content: center;
            flex-direction: column;
        }

        .login-logo .material-icons {
            font-size: 80px;
            color: var(--primary);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .login-logo h1 {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
        }

        .login-greeting {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 1.5rem;
        }

        .login-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 14px;
            display: none;
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }

        .login-error.show {
            display: block;
        }

        .login-blocked {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
        }

        .login-blocked .material-icons {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        /* Input com ícone */
        .login-input-group {
            position: relative;
            margin-bottom: 1rem;
        }

        .login-input-group .input-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 20px;
            transition: color 0.3s;
        }

        .login-input-group input {
            padding-left: 45px;
            padding-right: 45px;
            height: 50px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .login-input-group input:focus + .input-icon,
        .login-input-group input:valid + .input-icon {
            color: var(--primary);
        }

        .login-input-group .toggle-password {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.3s;
        }

        .login-input-group .toggle-password:hover {
            color: var(--primary);
        }

        /* Validação em tempo real */
        .login-input-group input.valid {
            border-color: var(--success);
        }

        .login-input-group input.invalid {
            border-color: var(--danger);
        }

        .input-feedback {
            font-size: 0.75rem;
            margin-top: 4px;
            display: none;
        }

        .input-feedback.show {
            display: block;
        }

        .input-feedback.error {
            color: var(--danger);
        }

        .input-feedback.success {
            color: var(--success);
        }

        /* Remember me e Esqueci senha */
        .login-options {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
        }

        .remember-me {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .remember-me input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
            cursor: pointer;
        }

        .forgot-password {
            color: var(--primary);
            text-decoration: none;
            transition: opacity 0.3s;
        }

        .forgot-password:hover {
            opacity: 0.8;
            text-decoration: underline;
        }

        /* Botão de login com loading */
        .login-btn {
            width: 100%;
            height: 50px;
            font-size: 1rem;
            font-weight: 600;
            position: relative;
            overflow: hidden;
        }

        .login-btn .btn-text {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: opacity 0.3s;
        }

        .login-btn .btn-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }

        .login-btn.loading .btn-text {
            opacity: 0;
        }

        .login-btn.loading .btn-loading {
            display: block;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Versão do sistema */
        .login-footer {
            text-align: center;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .login-footer .version {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        /* Responsividade mobile para login */
        @media (max-width: 480px) {
            .login-card {
                margin: 1rem;
                padding: 1.5rem;
                border-radius: 16px;
            }

            .login-logo .material-icons {
                font-size: 60px;
            }

            .login-logo h1 {
                font-size: 1.5rem;
            }

            .login-options {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .login-input-group input {
                height: 48px;
            }

            .login-btn {
                height: 48px;
            }
        }

        /* Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar - Colapsável Moderno */
        .sidebar {
            width: 72px;
            background: var(--sidebar);
            border-right: 1px solid var(--border);
            position: fixed;
            height: 100vh;
            display: flex;
            flex-direction: column;
            z-index: 100;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .sidebar:hover {
            width: 280px;
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.15);
        }

        .sidebar-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--border);
            min-height: 72px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 14px;
            flex-direction: row;
            justify-content: flex-start;
            width: 100%;
            padding-left: 2px;
        }

        .sidebar-logo .material-icons {
            font-size: 28px;
            color: var(--primary);
            flex-shrink: 0;
            min-width: 28px;
        }

        .sidebar-logo h1 {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            white-space: nowrap;
            opacity: 0;
            transform: translateX(-10px);
            transition: opacity 0.25s ease, transform 0.25s ease;
            line-height: 1.3;
        }

        .sidebar:hover .sidebar-logo h1 {
            opacity: 1;
            transform: translateX(0);
        }

        .sidebar-nav {
            flex: 1;
            padding: 1.5rem 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 6px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 12px 14px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 12px;
            white-space: nowrap;
            position: relative;
        }

        .nav-item .nav-text {
            opacity: 0;
            transform: translateX(-10px);
            transition: opacity 0.25s ease, transform 0.25s ease;
        }

        .sidebar:hover .nav-item .nav-text {
            opacity: 1;
            transform: translateX(0);
        }

        .nav-item:hover {
            background: var(--surface-hover);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--primary-light);
            color: var(--primary);
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 24px;
            background: var(--primary);
            border-radius: 0 4px 4px 0;
        }

        .nav-item .material-icons {
            font-size: 22px;
            flex-shrink: 0;
            min-width: 22px;
        }

        .nav-item .task-pending-badge {
            margin-left: auto;
            opacity: 0;
            transition: opacity 0.25s ease;
        }

        .sidebar:hover .nav-item .task-pending-badge {
            opacity: 1;
        }

        .sidebar-footer {
            padding: 1rem 0.75rem;
            border-top: 1px solid var(--border);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            border-radius: 12px;
            transition: background 0.2s ease;
        }

        .user-info:hover {
            background: var(--surface-hover);
        }

        .user-avatar {
            width: 38px;
            height: 38px;
            background: linear-gradient(135deg, var(--primary), var(--primary-hover));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
            font-size: 0.9rem;
        }

        .user-details {
            opacity: 0;
            transform: translateX(-10px);
            transition: opacity 0.25s ease, transform 0.25s ease;
            white-space: nowrap;
            flex: 1;
            min-width: 0;
        }

        .sidebar:hover .user-details {
            opacity: 1;
            transform: translateX(0);
        }

        .user-details h4 {
            font-size: 0.85rem;
            font-weight: 600;
            margin: 0;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-details span {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .logout-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s;
            opacity: 0;
            transform: translateX(-10px);
        }

        .sidebar:hover .logout-btn {
            opacity: 1;
            transform: translateX(0);
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 72px;
            padding: 2rem 0;
            min-height: 100vh;
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .main-content > * {
            width: 100%;
            max-width: 1200px;
            padding-left: 2rem;
            padding-right: 2rem;
            box-sizing: border-box;
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px;
        }

        /* Botão fixo para abrir sidebar no mobile */
        .mobile-sidebar-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 56px;
            height: 56px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            z-index: 999;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .mobile-sidebar-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }

        .mobile-sidebar-toggle:active {
            transform: scale(0.95);
        }

        @media (max-width: 768px) {
            .mobile-sidebar-toggle {
                display: flex;
            }
        }

        .search-box {
            flex: 1;
            max-width: 400px;
            position: relative;
        }

        .search-box .material-icons {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        .search-box input {
            width: 100%;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 12px 12px 44px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .search-box input::placeholder {
            color: var(--text-muted);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .header-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #7c3aed);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: var(--surface);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--surface-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-icon {
            padding: 10px;
            aspect-ratio: 1;
        }

        .btn .material-icons {
            transition: transform 0.3s ease;
        }

        .btn:hover .material-icons {
            transform: scale(1.2) rotate(10deg);
        }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.75rem;
            margin-bottom: 2.5rem;
        }

        /* Transformando KPI cards em cards interativos com animações */
        .kpi-card {
            background: var(--surface);
            border-radius: 20px;
            padding: 1.75rem;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .kpi-card:hover::before {
            opacity: 1;
        }

        .kpi-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border-color: var(--primary);
        }

        .kpi-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .kpi-icon {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.4s ease;
        }

        .kpi-card:hover .kpi-icon {
            transform: rotate(10deg) scale(1.1);
        }

        .kpi-icon::after {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 14px;
            padding: 2px;
            background: linear-gradient(135deg, currentColor, transparent);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .kpi-card:hover .kpi-icon::after {
            opacity: 0.6;
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .kpi-icon.purple { 
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(168, 85, 247, 0.3)); 
            color: #c4b5fd;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
        }
        .kpi-icon.green { 
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.3)); 
            color: #6ee7b7;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }
        .kpi-icon.blue { 
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.3)); 
            color: #93c5fd;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }
        .kpi-icon.orange { 
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.3)); 
            color: #fcd34d;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
        }

        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
            transition: all 0.4s ease;
            position: relative;
        }

        .kpi-card:hover .kpi-value {
            transform: scale(1.05);
            color: var(--primary);
        }

        .kpi-label {
            color: var(--text-muted);
            font-size: 0.875rem;
            margin-top: 0.5rem;
            transition: color 0.3s ease;
        }

        .kpi-card:hover .kpi-label {
            color: var(--text-secondary);
        }

        /* Course Cards */
        .courses-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }
        
        /* Telas extra grandes - 4 colunas */
        @media (min-width: 1600px) {
            .courses-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 1.75rem;
            }
        }
        
        /* Tablets grandes - manter 3 colunas */
        @media (max-width: 1400px) and (min-width: 1024px) {
            .courses-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 1.25rem;
            }
        }
        
        /* Tablets - 2 colunas */
        @media (max-width: 1023px) and (min-width: 769px) {
            .courses-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1.25rem;
            }
        }
        
        /* Mobile - 1 coluna */
        @media (max-width: 768px) {
            .courses-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }

        /* Cards de cursos com animações mais interativas */
        .course-card {
            background: var(--surface);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .course-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .course-card:hover::before {
            left: 100%;
        }

        .course-card:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.25);
            border-color: var(--primary);
        }
        
        /* Micro-interações melhoradas */
        .course-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .course-card:active {
            transform: translateY(-2px) scale(0.99);
        }
        
        /* Espaçamento consistente - sistema de 8px */
        .course-card * {
            box-sizing: border-box;
        }

        .course-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 0.875rem;
        }

        .course-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            transition: color 0.3s ease;
            line-height: 1.4;
        }

        .course-card:hover .course-title {
            color: var(--primary);
        }

        .course-id {
            font-size: 0.75rem;
            color: var(--text-muted);
            line-height: 1.3;
        }

        .course-actions {
            display: flex;
            gap: 4px;
        }

        .course-actions button {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
            position: relative;
        }

        .course-actions button::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 8px;
            background: currentColor;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .course-actions button:hover::before {
            opacity: 0.1;
        }

        .course-actions button:hover {
            transform: scale(1.2) rotate(5deg);
        }

        .course-actions button:hover {
            background: var(--surface-hover);
            color: var(--text-primary);
        }

        .course-actions button.delete:hover {
            color: var(--danger);
        }

        .course-actions button.drive:hover {
            color: var(--success);
        }

        .course-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .course-info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .course-info-item .material-icons {
            font-size: 16px;
            color: var(--text-muted);
            flex-shrink: 0;
        }

        /* Estilo para anotação do curso no card */
        .course-note {
            background: rgba(99, 102, 241, 0.1);
            border-left: 3px solid var(--primary);
            padding: 6px 10px;
            margin-top: 8px;
            border-radius: 0 6px 6px 0;
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            align-items: flex-start;
            gap: 6px;
        }

        .course-note .material-icons {
            font-size: 14px;
            color: var(--primary);
            flex-shrink: 0;
            margin-top: 2px;
        }

        .course-note-text {
            word-break: break-word;
            line-height: 1.4;
        }
        
        /* Alertas nos cards */
        .course-alert {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(239, 68, 68, 0.05) 100%);
            border: 2px solid var(--danger);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            position: relative;
            animation: pulseAlert 2s ease-in-out infinite;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
        }
        
        .course-alert.warning {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.15) 0%, rgba(251, 191, 36, 0.05) 100%);
            border-color: var(--warning);
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.2);
        }
        
        .course-alert-icon {
            width: 40px;
            height: 40px;
            background: var(--danger);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
            animation: pulseIcon 1.5s ease-in-out infinite;
        }
        
        .course-alert.warning .course-alert-icon {
            background: var(--warning);
        }
        
        .course-alert-content {
            flex: 1;
            min-width: 0;
        }
        
        .course-alert-title {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .course-alert-message {
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 0.75rem;
        }
        
        .course-alert-action {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }
        
        .course-alert.warning .course-alert-action {
            background: var(--warning);
        }
        
        .course-alert-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            opacity: 0.9;
        }
        
        @keyframes pulseAlert {
            0%, 100% {
                box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
            }
            50% {
                box-shadow: 0 4px 20px rgba(239, 68, 68, 0.4);
            }
        }
        
        @keyframes pulseIcon {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }
        
        .course-card.has-alert {
            border-color: var(--danger);
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
        }
        
        .course-card.has-alert.warning-alert {
            border-color: var(--warning);
            box-shadow: 0 0 0 2px rgba(251, 191, 36, 0.2);
        }

        /* Adicionando animação pulsante aos status badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            position: relative;
            transition: all 0.3s ease;
        }

        .status-badge::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.2);
            }
        }

        .status-badge.concluido { 
            background: rgba(16, 185, 129, 0.15); 
            color: #34d399;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.2);
        }
        .status-badge.andamento { 
            background: rgba(59, 130, 246, 0.15); 
            color: #60a5fa;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
        }
        .status-badge.pendente { 
            background: rgba(245, 158, 11, 0.15); 
            color: #fbbf24;
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.2);
        }
        .status-badge.cancelado { 
            background: rgba(239, 68, 68, 0.15); 
            color: #f87171;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.2);
        }

        /* Badges de status mais visíveis e informativos - MELHORADO */
        .status-badge {
            font-size: 0.8rem;
            padding: 6px 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 1.5px solid currentColor;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            transition: all 0.2s ease;
        }
        
        .status-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }
        
        .status-badge.concluido { 
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(16, 185, 129, 0.1) 100%); 
            color: #34d399;
            border-color: #34d399;
        }
        .status-badge.andamento { 
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(59, 130, 246, 0.1) 100%); 
            color: #60a5fa;
            border-color: #60a5fa;
        }
        .status-badge.pendente { 
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2) 0%, rgba(245, 158, 11, 0.1) 100%); 
            color: #fbbf24;
            border-color: #fbbf24;
        }
        .status-badge.cancelado { 
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(239, 68, 68, 0.1) 100%); 
            color: #f87171;
            border-color: #f87171;
        }

        /* Animações de loading mais elaboradas */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(10px);
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(99, 102, 241, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-content {
            text-align: center;
            color: white;
            margin-top: 20px;
        }

        /* Feedback visual em ações */
        .action-feedback {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            z-index: 10001;
            animation: slideInRight 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Progresso visual nos cards */
        .course-progress {
            width: 100%;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin-top: 12px;
            overflow: hidden;
        }

        .course-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-hover));
            border-radius: 2px;
            transition: width 0.6s ease;
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }

        /* Ações rápidas mais acessíveis */
        .quick-actions {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .course-card:hover .quick-actions {
            opacity: 1;
        }

        .quick-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .quick-action-btn:hover {
            transform: scale(1.1);
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        /* Estilos para modo de visualização */
        .view-mode-selector {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .view-mode-btn {
            padding: 8px 12px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .view-mode-btn:hover {
            background: var(--surface-hover);
            color: var(--text-primary);
        }

        .view-mode-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Estilos para modo lista */
        .courses-list .course-card {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            padding: 1.5rem;
        }

        /* Estilos para modo timeline */
        .courses-timeline {
            position: relative;
            padding-left: 2rem;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 2rem;
            padding-left: 2rem;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--overlay);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--surface);
            border-radius: 24px;
            width: 100%;
            max-width: 650px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.75rem 2rem;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h3 {
            font-size: 1.35rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--surface-hover);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding: 1.5rem;
            border-top: 1px solid var(--border);
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 16px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-input.error, .form-select.error, .form-textarea.error {
            border-color: var(--danger);
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
            animation: shake 0.3s ease;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .form-error {
            color: var(--danger);
            font-size: 0.75rem;
            margin-top: 0.5rem;
            display: none;
        }

        .form-error.show {
            display: block;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* Label opcional para campos não obrigatórios */
        .optional-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-weight: 400;
            margin-left: 4px;
        }

        /* Calendar */
        .calendar-container {
            background: var(--surface);
            border-radius: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
            /* Adicionando efeitos de hover e transições suaves */
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .calendar-container:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            /* Adicionando gradiente sutil no header */
            background: linear-gradient(135deg, var(--surface) 0%, rgba(99, 102, 241, 0.05) 100%);
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .calendar-nav button {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            /* Melhorando animações dos botões de navegação */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .calendar-nav button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(99, 102, 241, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s;
        }

        .calendar-nav button:hover::before {
            width: 100px;
            height: 100px;
        }

        .calendar-nav button:hover {
            background: var(--surface-hover);
            color: var(--primary);
            transform: scale(1.1);
        }

        .calendar-nav button:active {
            transform: scale(0.95);
        }

        .calendar-title {
            font-size: 1.25rem;
            font-weight: 600;
            /* Adicionando gradiente de texto */
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
        }
        
        .calendar-grid.week-view {
            grid-template-columns: repeat(5, 1fr);
        }
        
        .calendar-grid.week-view .calendar-day {
            min-height: 200px;
        }
        
        .calendar-grid.day-view {
            grid-template-columns: 1fr;
            padding: 1rem;
        }
        
        /* Day View Styles */
        .day-view-container {
            background: var(--surface);
            border-radius: 12px;
            padding: 1.5rem;
            min-height: 400px;
        }
        
        .day-view-container.today {
            border: 2px solid var(--primary);
        }
        
        .day-view-container.holiday {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.05) 0%, var(--surface) 100%);
        }
        
        .day-view-holiday {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: rgba(251, 191, 36, 0.15);
            border-radius: 8px;
            color: var(--warning);
            font-weight: 500;
            margin-bottom: 1rem;
        }
        
        .day-view-empty {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }
        
        .day-view-empty .material-icons {
            font-size: 64px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .day-view-empty p {
            margin-bottom: 1.5rem;
        }
        
        .day-view-events {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .day-view-event {
            background: var(--background);
            border: 1px solid var(--border);
            border-left: 4px solid var(--primary);
            border-radius: 10px;
            padding: 1rem 1.25rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .day-view-event:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .day-view-event.status-pendente { border-left-color: #f59e0b; }
        .day-view-event.status-andamento { border-left-color: #3b82f6; }
        .day-view-event.status-concluido { border-left-color: #22c55e; }
        .day-view-event.status-cancelado { border-left-color: #ef4444; opacity: 0.7; }
        
        .day-event-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .day-event-type {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .day-event-type.start {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
        }
        
        .day-event-type.end {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }
        
        .day-event-status {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .day-event-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
        }
        
        .day-event-info {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .day-event-info span {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .day-event-info .material-icons {
            font-size: 16px;
            color: var(--text-muted);
        }
        
        .day-event-description {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }
        
        .add-event-day-btn {
            margin-top: 1.5rem;
        }
        
        .week-view-day {
            min-height: 180px;
        }
        
        /* Toggle de visualização */
        .calendar-view-toggle {
            display: flex;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .view-btn {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .view-btn:hover {
            background: var(--surface-hover);
            color: var(--text-primary);
        }
        
        .view-btn.active {
            background: var(--primary);
            color: white;
        }
        
        .view-btn .material-icons {
            font-size: 20px;
        }
        
        /* Estatísticas do calendário */
        .calendar-stats {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .calendar-stat {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .calendar-stat .material-icons {
            font-size: 20px;
            color: var(--primary);
        }
        
        .calendar-stat span:not(.material-icons) {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* Ações do header do calendário */
        .calendar-header-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }
        
        #calendarDatePicker {
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text-primary);
        }
        
        /* Legenda */
        .calendar-legend {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            flex-wrap: wrap;
        }
        
        .legend-title {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }
        
        /* Preview tooltip do curso */
        .course-preview-tooltip {
            position: fixed;
            z-index: 10000;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            min-width: 280px;
            max-width: 350px;
            overflow: hidden;
            pointer-events: none;
            animation: tooltipFade 0.2s ease;
        }
        
        @keyframes tooltipFade {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .preview-header {
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark, #4f46e5) 100%);
            color: white;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .preview-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
        }
        
        .preview-status.pendente { background: #f59e0b; }
        .preview-status.andamento { background: #3b82f6; }
        .preview-status.concluido { background: #22c55e; }
        .preview-status.cancelado { background: #ef4444; }
        
        .preview-title {
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .preview-body {
            padding: 0.75rem 1rem;
        }
        
        .preview-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.35rem 0;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .preview-info .material-icons {
            font-size: 16px;
            color: var(--text-muted);
        }
        
        /* Feriados no calendário */
        .calendar-day.holiday {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(251, 191, 36, 0.05) 100%);
        }
        
        .calendar-day.holiday .calendar-date {
            color: var(--warning);
        }
        
        .holiday-name {
            font-size: 0.65rem;
            color: var(--warning);
            font-weight: 500;
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Indicador de quantidade de cursos */
        .day-course-count {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--primary);
            color: white;
            font-size: 0.65rem;
            font-weight: 600;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .calendar-day {
            position: relative;
        }
        
        /* Eventos - Design Clean */
        .calendar-event {
            position: relative;
            padding-left: 10px;
        }
        
        .calendar-event::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 80%;
            border-radius: 2px;
        }
        
        /* Cores por status - apenas indicador lateral */
        .calendar-event.status-pendente {
            background: rgba(245, 158, 11, 0.1);
            color: var(--text-primary);
        }
        .calendar-event.status-pendente::before {
            background: #f59e0b;
        }
        
        .calendar-event.status-andamento {
            background: rgba(59, 130, 246, 0.1);
            color: var(--text-primary);
        }
        .calendar-event.status-andamento::before {
            background: #3b82f6;
        }
        
        .calendar-event.status-concluido {
            background: rgba(34, 197, 94, 0.1);
            color: var(--text-primary);
        }
        .calendar-event.status-concluido::before {
            background: #22c55e;
        }
        
        .calendar-event.status-cancelado {
            background: rgba(239, 68, 68, 0.1);
            color: var(--text-muted);
            opacity: 0.6;
            text-decoration: line-through;
        }
        .calendar-event.status-cancelado::before {
            background: #ef4444;
        }
        
        /* Evento de início - destaque verde */
        .calendar-event.start {
            background: linear-gradient(90deg, rgba(34, 197, 94, 0.15) 0%, rgba(34, 197, 94, 0.05) 100%);
            border-left: 3px solid #22c55e;
            padding-left: 6px;
        }
        .calendar-event.start::before {
            display: none;
        }
        .calendar-event.start .event-label {
            color: #22c55e;
            font-weight: 600;
            font-size: 0.6rem;
        }
        
        /* Evento de fim - destaque vermelho */
        .calendar-event.end {
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.15) 0%, rgba(239, 68, 68, 0.05) 100%);
            border-left: 3px solid #ef4444;
            padding-left: 6px;
        }
        .calendar-event.end::before {
            display: none;
        }
        .calendar-event.end .event-label {
            color: #ef4444;
            font-weight: 600;
            font-size: 0.6rem;
        }
        
        .calendar-event.custom-event {
            color: white;
            font-weight: 500;
            padding-left: 8px;
        }
        .calendar-event.custom-event::before {
            display: none;
        }
        
        .calendar-event.more-events {
            background: var(--surface-hover);
            color: var(--text-muted);
            font-size: 0.65rem;
            text-align: center;
            padding-left: 8px;
        }
        .calendar-event.more-events::before {
            display: none;
        }
        
        /* Botão adicionar evento no dia */
        .add-event-btn {
            position: absolute;
            bottom: 4px;
            right: 4px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: none;
            background: var(--primary);
            color: white;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            opacity: 0.8;
        }
        
        .add-event-btn .material-icons {
            font-size: 14px;
        }
        
        .calendar-day:hover .add-event-btn {
            display: flex;
        }
        
        .add-event-btn:hover {
            transform: scale(1.1);
            opacity: 1;
        }
        
        /* Presets de cor */
        .color-preset {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .color-preset:hover {
            transform: scale(1.1);
            border-color: var(--text-primary);
        }
        
        /* Cursor para double click */
        .calendar-day:not(.other-month) {
            cursor: pointer;
        }
        
        /* ==================== SISTEMA DE TAREFAS ==================== */
        
        .task-pending-badge {
            background: var(--warning);
            color: white;
            font-size: 0.65rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: auto;
        }
        
        .tasks-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .task-stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.2s;
        }
        
        .task-stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .task-stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .task-stat-icon .material-icons {
            font-size: 24px;
            color: white;
        }
        
        .task-stat-icon.pending { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .task-stat-icon.today { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .task-stat-icon.overdue { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .task-stat-icon.completed { background: linear-gradient(135deg, #22c55e, #16a34a); }
        
        .task-stat-info {
            display: flex;
            flex-direction: column;
        }
        
        .task-stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
        }
        
        .task-stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 4px;
        }
        
        .tasks-filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .task-filter-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--surface);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }
        
        .task-filter-btn .material-icons {
            font-size: 18px;
        }
        
        .task-filter-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .task-filter-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        .tasks-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        @media (max-width: 900px) {
            .tasks-container {
                grid-template-columns: 1fr;
            }
        }
        
        .task-group {
            margin-bottom: 1.5rem;
        }
        
        .task-group-header {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }
        
        .task-item {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.875rem 1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            transition: all 0.2s;
            position: relative;
        }
        
        .task-item:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .task-item.completed {
            opacity: 0.7;
            background: var(--surface-hover);
        }
        
        .task-item.completed .task-title {
            text-decoration: line-through;
            color: var(--text-muted);
        }
        
        .task-item.overdue {
            border-left: 4px solid var(--danger);
        }
        
        .task-item.today {
            border-left: 4px solid var(--primary);
        }
        
        .task-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
            margin-top: 2px;
        }
        
        .task-checkbox:hover {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.1);
        }
        
        .task-checkbox.checked {
            background: var(--success);
            border-color: var(--success);
        }
        
        .task-checkbox.checked .material-icons {
            color: white;
            font-size: 16px;
        }
        
        .task-content {
            flex: 1;
            min-width: 0;
        }
        
        .task-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .task-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1rem;
            line-height: 1.4;
        }
        
        .task-priority {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            flex-shrink: 0;
        }
        
        .task-priority.high {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }
        
        .task-priority.medium {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
        }
        
        .task-priority.low {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
        }
        
        .task-description {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            line-height: 1.5;
        }
        
        .task-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .task-meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        
        .task-meta-item .material-icons {
            font-size: 16px;
        }
        
        .task-meta-item.overdue {
            color: var(--danger);
            font-weight: 500;
        }
        
        .task-actions {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .task-item:hover .task-actions {
            opacity: 1;
        }
        
        .task-action-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            background: var(--surface-hover);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .task-action-btn .material-icons {
            font-size: 18px;
        }
        
        .task-action-btn:hover {
            background: var(--primary);
            color: white;
        }
        
        .task-action-btn.delete:hover {
            background: var(--danger);
        }
        
        .tasks-empty {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }
        
        .tasks-empty .material-icons {
            font-size: 64px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .tasks-empty h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }
        
        /* Subtarefas */
        .subtasks {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px dashed var(--border);
        }
        
        .subtask-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.35rem 0;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .subtask-item.completed {
            text-decoration: line-through;
            color: var(--text-muted);
        }
        
        .subtask-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .subtask-checkbox.checked {
            background: var(--success);
            border-color: var(--success);
        }
        
        .subtask-checkbox .material-icons {
            font-size: 14px;
            color: white;
        }
        
        /* Modal de tarefa */
        .subtask-input-group {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .subtask-list {
            margin-top: 0.75rem;
        }
        
        .subtask-list-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--surface-hover);
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }
        
        .subtask-list-item span {
            flex: 1;
        }
        
        .subtask-remove-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 2px;
        }
        
        .subtask-remove-btn:hover {
            color: var(--danger);
        }
        
        /* Animação de tarefa concluída */
        .task-completed-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .task-completed-overlay.show {
            opacity: 1;
        }
        
        .task-completed-content {
            background: var(--surface);
            padding: 2.5rem;
            border-radius: 20px;
            text-align: center;
            transform: scale(0.8);
            transition: transform 0.3s ease;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .task-completed-overlay.show .task-completed-content {
            transform: scale(1);
            animation: celebratePop 0.5s ease;
        }
        
        @keyframes celebratePop {
            0% { transform: scale(0.5); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .task-completed-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            animation: celebrateSpin 0.5s ease;
        }
        
        @keyframes celebrateSpin {
            0% { transform: rotate(-10deg); }
            50% { transform: rotate(10deg); }
            100% { transform: rotate(0); }
        }
        
        .task-completed-icon .material-icons {
            font-size: 40px;
            color: white;
        }
        
        .task-completed-content h3 {
            font-size: 1.5rem;
            color: var(--success);
            margin-bottom: 0.5rem;
        }
        
        .task-completed-content p {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .calendar-day-header {
            padding: 1rem;
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            background: var(--background);
            /* Adicionando animação de pulso nos headers */
            animation: headerPulse 3s ease-in-out infinite;
        }

        @keyframes headerPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .calendar-day {
            min-height: 100px;
            padding: 0.5rem;
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            background: var(--surface);
            /* Adicionando transições e efeitos hover interativos */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .calendar-day::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .calendar-day:hover::before {
            opacity: 1;
        }

        .calendar-day:hover {
            transform: scale(1.05);
            z-index: 10;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
            border-color: var(--primary);
        }

        .calendar-day:nth-child(5n) {
            border-right: none;
        }

        .calendar-day.other-month {
            background: var(--background);
            opacity: 0.5;
            transition: opacity 0.3s;
        }

        .calendar-day.other-month:hover {
            opacity: 0.8;
        }

        .calendar-day.today {
            background: rgba(99, 102, 241, 0.1);
            /* Adicionando animação de brilho no dia atual */
            position: relative;
            animation: todayGlow 2s ease-in-out infinite;
        }

        @keyframes todayGlow {
            0%, 100% {
                box-shadow: inset 0 0 20px rgba(99, 102, 241, 0.2);
            }
            50% {
                box-shadow: inset 0 0 30px rgba(99, 102, 241, 0.4);
            }
        }

        .calendar-date {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            position: relative;
            z-index: 1;
            transition: all 0.3s;
        }

        .calendar-day:hover .calendar-date {
            color: var(--primary);
            transform: scale(1.1);
        }

        .calendar-day.today .calendar-date {
            background: var(--primary);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            /* Adicionando animação de pulso no dia atual */
            animation: datePulse 1.5s ease-in-out infinite;
        }

        @keyframes datePulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        .calendar-event {
            font-size: 0.7rem;
            padding: 3px 6px;
            border-radius: 4px;
            margin-bottom: 3px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
            z-index: 1;
            transition: all 0.2s ease;
            transform-origin: left center;
        }

        .calendar-event:hover {
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 20;
            opacity: 1 !important;
        }

        .calendar-event.start { 
            background: var(--success); 
            color: white;
            /* Adicionando animação de entrada */
            animation: eventSlideIn 0.5s ease-out;
        }
        
        .calendar-event.end { 
            background: var(--danger); 
            color: white;
            animation: eventSlideIn 0.5s ease-out;
        }
        
        .calendar-event.ongoing { 
            background: var(--info); 
            color: white;
            animation: eventSlideIn 0.5s ease-out;
        }

        @keyframes eventSlideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Adicionando estilo para o botão "Hoje" */
        #todayBtn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        #todayBtn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s;
        }

        #todayBtn:hover::before {
            width: 200px;
            height: 200px;
        }

        #todayBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        #todayBtn:active {
            transform: translateY(0);
        }

        /* Pages */
        .page-section {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1), transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .page-section.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
            animation: pageFadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes pageFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2.5rem;
            flex-wrap: wrap;
            gap: 1.25rem;
        }

        .page-title {
            font-size: 1.75rem;
            font-weight: 700;
        }

        /* Instructors */
        .instructor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .instructor-card {
            background: var(--surface);
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid var(--border);
            text-align: center;
        }

        .instructor-avatar {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--primary), #a855f7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-size: 2rem;
            font-weight: 600;
            margin: 0 auto 1rem;
        }

        .instructor-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .instructor-specialty {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .instructor-stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            padding: 1rem 0;
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            margin-bottom: 1rem;
        }

        .instructor-stat {
            text-align: center;
        }

        .instructor-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .instructor-stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .instructor-actions {
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        .instructor-actions .btn-whatsapp {
            background: #25D366;
            color: white;
        }

        .instructor-actions .btn-whatsapp:hover {
            background: #128C7E;
        }

        .btn-whatsapp-mini {
            background: #25D366;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 4px 6px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
            transition: all 0.2s;
            vertical-align: middle;
        }

        .btn-whatsapp-mini:hover {
            background: #128C7E;
            transform: scale(1.1);
        }

        .btn-whatsapp-mini .material-icons {
            font-size: 14px;
        }

        /* Settings */
        .settings-card {
            background: var(--surface);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid var(--border);
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
        }

        .settings-card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }

        .settings-card h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text);
        }

        .settings-card h3 .material-icons {
            color: var(--primary);
            font-size: 28px;
        }

        .settings-card .description {
            color: var(--text-muted);
            margin-bottom: 1.5rem;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .file-upload-area {
            border: 2px dashed var(--border);
            border-radius: 16px;
            padding: 3.5rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.02) 0%, rgba(99, 102, 241, 0.05) 100%);
            margin: 1rem 0;
            position: relative;
            overflow: hidden;
        }

        .file-upload-area::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .file-upload-area:hover::before {
            opacity: 1;
        }

        .file-upload-area:hover {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.08) 0%, rgba(99, 102, 241, 0.12) 100%);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.15);
        }

        .file-upload-area .material-icons {
            font-size: 64px;
            color: var(--primary);
            margin-bottom: 1.25rem;
            display: block;
            transition: transform 0.3s ease;
        }

        .file-upload-area:hover .material-icons {
            transform: scale(1.1);
        }

        .file-upload-area .upload-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text);
            margin: 0 0 0.75rem 0;
            line-height: 1.4;
        }

        .file-upload-area .upload-subtitle {
            font-size: 0.95rem;
            color: var(--text-muted);
            margin: 0.5rem 0;
            line-height: 1.5;
        }

        .file-upload-area .upload-formats {
            font-size: 0.875rem;
            color: var(--primary);
            margin: 0.75rem 0 0.5rem 0;
            font-weight: 500;
        }

        .file-upload-area .upload-columns {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin: 0.5rem auto 0 auto;
            max-width: 90%;
            line-height: 1.4;
        }

        .file-info {
            margin-top: 1.5rem;
            padding: 1.25rem;
            background: var(--background);
            border-radius: 12px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .file-info .material-icons {
            color: var(--primary);
            font-size: 24px;
        }

        .file-info p {
            margin: 0;
            font-size: 0.95rem;
            color: var(--text);
            font-weight: 500;
        }

        .export-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .export-actions .btn {
            justify-content: center;
        }

        .danger-zone {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.05) 0%, rgba(239, 68, 68, 0.02) 100%);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .danger-zone-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #ef4444;
            font-weight: 600;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
        }

        .danger-zone-title .material-icons {
            font-size: 20px;
        }

        .danger-zone-description {
            color: var(--text-muted);
            margin-bottom: 1rem;
            font-size: 0.9rem;
            line-height: 1.5;
        }


        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-state .material-icons {
            font-size: 64px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.25rem 1.5rem;
            margin-bottom: 0;
            display: flex;
            align-items: center;
            gap: 14px;
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.05) inset;
            opacity: 0;
            transform: translateX(120%);
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            min-width: 320px;
            max-width: 500px;
            position: relative;
            overflow: hidden;
        }
        
        .toast::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: currentColor;
        }
        
        .toast .material-icons {
            font-size: 24px;
            flex-shrink: 0;
        }
        
        .toast span:last-child {
            flex: 1;
            word-wrap: break-word;
            line-height: 1.5;
            font-size: 0.95rem;
        }
        
        .toast .toast-close {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.6;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .toast .toast-close:hover {
            opacity: 1;
            background: var(--surface-hover);
            color: var(--text-primary);
        }

        .toast.success { 
            border-left: 4px solid var(--success);
            color: var(--success);
        }
        .toast.error { 
            border-left: 4px solid var(--danger);
            color: var(--danger);
        }
        .toast.warning { 
            border-left: 4px solid var(--warning);
            color: var(--warning);
        }
        .toast.info { 
            border-left: 4px solid var(--info);
            color: var(--info);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Users Section */
        .users-table {
            width: 100%;
            border-collapse: collapse;
        }

        .users-table th,
        .users-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .users-table th {
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.875rem;
            text-transform: uppercase;
        }

        .users-table tr:hover td {
            background: var(--surface-hover);
        }

        .role-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .role-badge.admin { background: rgba(239, 68, 68, 0.15); color: #f87171; }
        .role-badge.editor { background: rgba(59, 130, 246, 0.15); color: #60a5fa; }
        .role-badge.viewer { background: rgba(16, 185, 129, 0.15); color: #34d399; }

        /* Novo layout do Activity Log - estilo timeline moderno */
        .activity-log {
            max-height: 500px;
            overflow-y: auto;
            padding: 1rem;
        }

        .activity-log-grid {
            display: grid;
            gap: 0;
        }

        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 1rem 0;
            position: relative;
        }

        .activity-item:not(:last-child)::before {
            content: '';
            position: absolute;
            left: 18px;
            top: 48px;
            bottom: -8px;
            width: 2px;
            background: var(--border);
        }

        .activity-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            position: relative;
            z-index: 1;
        }

        .activity-icon.add { background: var(--success); color: white; }
        .activity-icon.edit { background: var(--info); color: white; }
        .activity-icon.delete { background: var(--danger); color: white; }

        .activity-content {
            flex: 1;
            background: var(--background);
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid var(--border);
        }

        .activity-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .activity-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .activity-time {
            font-size: 0.75rem;
            color: var(--text-muted);
            background: var(--surface);
            padding: 4px 8px;
            border-radius: 6px;
        }

        .activity-description {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .activity-user {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 0.75rem;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .activity-user .material-icons {
            font-size: 14px;
        }

        /* Novo layout do Relatório Geral */
        .report-preview {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 16px;
            padding: 2rem;
            color: #ffffff;
        }

        .report-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid rgba(255,255,255,0.1);
        }

        .report-header h2 {
            color: #ffffff;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .report-header p {
            color: rgba(255,255,255,0.7);
            font-size: 0.9rem;
        }

        .report-kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .report-kpi-card {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .report-kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: #ffffff;
        }

        .report-kpi-label {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.7);
            text-transform: uppercase;
            margin-top: 0.25rem;
        }

        .report-kpi-card.green .report-kpi-value { color: #34d399; }
        .report-kpi-card.blue .report-kpi-value { color: #60a5fa; }
        .report-kpi-card.yellow .report-kpi-value { color: #fbbf24; }
        .report-kpi-card.red .report-kpi-value { color: #f87171; }
        .report-kpi-card.purple .report-kpi-value { color: #a78bfa; }

        .report-section {
            margin-bottom: 1.5rem;
        }

        .report-section h3 {
            color: #ffffff;
            font-size: 1rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .report-section h3 .material-icons {
            font-size: 20px;
            color: var(--primary);
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .report-table th,
        .report-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .report-table th {
            background: rgba(255,255,255,0.05);
            font-weight: 600;
            color: rgba(255,255,255,0.9);
        }

        .report-table td {
            color: rgba(255,255,255,0.8);
        }

        .report-table tr:hover td {
            background: rgba(255,255,255,0.05);
        }

        .report-chart {
            display: flex;
            justify-content: center;
            margin: 1.5rem 0;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .report-city-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 0.75rem;
        }

        .report-city-item {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .report-city-name {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.9);
        }

        .report-city-count {
            background: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Course Details */
        .course-detail-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .course-detail-item:last-child {
            border-bottom: none;
        }

        .course-detail-item .material-icons {
            color: var(--primary);
            font-size: 24px;
        }

        .course-detail-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .course-detail-value {
            font-size: 1rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .course-detail-value a {
            color: var(--info);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .course-detail-value a:hover {
            text-decoration: underline;
        }

        /* Seção de mudar senha */
        .password-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 280px;
                transform: translateX(-100%);
            }

            .sidebar:hover {
                width: 280px;
                box-shadow: none;
            }

            .sidebar.active {
                transform: translateX(0);
                box-shadow: 4px 0 24px rgba(0, 0, 0, 0.3);
            }

            .sidebar .sidebar-logo h1,
            .sidebar .nav-item .nav-text,
            .sidebar .user-details,
            .sidebar .logout-btn,
            .sidebar .nav-item .task-pending-badge {
                opacity: 1;
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 1.5rem 1.5rem;
            }

            .mobile-menu-btn {
                display: block;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .courses-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .course-card {
                padding: 1rem;
            }

            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .calendar-day {
                min-height: 60px;
            }

            .calendar-event {
                font-size: 0.6rem;
                padding: 2px 4px;
            }

            .report-kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* ==================== NOVO LAYOUT DE CONFIGURAÇÕES ==================== */
        
        /* Settings - Layout Vertical Moderno */
        .settings-layout {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .settings-nav {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            background: var(--card);
            border-radius: 16px;
            padding: 1rem;
            border: 1px solid var(--border);
            justify-content: center;
        }

        .settings-nav-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            background: transparent;
            border: none;
            border-radius: 10px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .settings-nav-item:hover {
            background: var(--surface-hover);
            color: var(--text);
        }

        .settings-nav-item.active {
            background: var(--primary);
            color: white;
        }

        .settings-nav-item .material-icons {
            font-size: 18px;
        }

        .settings-content {
            min-width: 0;
        }

        .settings-section {
            display: none;
        }

        .settings-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .settings-section-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border);
        }

        .settings-section-title .material-icons {
            color: var(--primary);
            font-size: 22px;
        }

        .settings-option-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .settings-option-card:hover {
            border-color: var(--primary);
        }

        .settings-option-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .settings-option-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary), #a855f7);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }

        .settings-option-icon .material-icons {
            font-size: 20px;
        }

        .settings-option-info {
            flex: 1;
            min-width: 150px;
        }

        .settings-option-info h4 {
            font-weight: 600;
            color: var(--text);
            margin: 0 0 0.25rem 0;
            font-size: 0.9rem;
        }

        .settings-option-info p {
            color: var(--text-muted);
            font-size: 0.75rem;
            margin: 0;
        }

        /* Theme colors grid */
        .theme-colors-grid {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .theme-color-option {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--color);
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .theme-color-option:hover {
            transform: scale(1.1);
        }

        .theme-color-option.active {
            border-color: var(--text);
            box-shadow: 0 0 0 2px var(--background);
        }

        .theme-color-option.active::after {
            content: '✓';
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        /* Custom colors panel */
        .custom-colors-panel {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px dashed var(--border);
        }

        .color-inputs-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .color-input-item {
            flex: 1 1 auto;
            min-width: 80px;
        }

        .color-input-item {
            text-align: center;
        }

        .color-input-item label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .color-input-item input[type="color"] {
            width: 100%;
            height: 40px;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            padding: 2px;
        }

        .custom-colors-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        /* Project name input */
        .project-name-input {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .project-name-input .form-input {
            flex: 1;
        }

        /* Settings tabs */
        .settings-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--border);
            padding-bottom: 0;
        }

        .settings-tab {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }

        .settings-tab:hover {
            color: var(--primary);
        }

        .settings-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Manager compact layout */
        .manager-compact-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 800px) {
            .manager-compact-layout {
                grid-template-columns: 1fr;
            }
        }

        .manager-list-section {
            min-width: 0;
        }

        .manager-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            font-weight: 600;
            color: var(--text);
        }

        .manager-preview-compact {
            background: var(--surface);
            border-radius: 12px;
            padding: 1rem;
            border: 1px dashed var(--border);
        }

        .preview-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 1rem;
        }

        .form-preview-mini {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 350px;
            overflow-y: auto;
        }

        /* Upload zone compact */
        .upload-zone-compact {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.25rem;
            border: 2px dashed var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 1rem;
        }

        .upload-zone-compact:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .upload-zone-compact .material-icons {
            font-size: 28px;
            color: var(--primary);
        }

        .upload-zone-compact span {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .upload-zone-compact small {
            color: var(--text-muted);
            font-size: 0.75rem;
            margin-left: auto;
        }

        /* Export buttons compact */
        .export-buttons-compact {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .export-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.8rem;
            font-weight: 500;
            flex: 0 0 auto;
        }

        .export-btn:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
        }

        .export-btn .material-icons {
            font-size: 18px;
        }

        /* Security buttons */
        .security-buttons-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .security-action-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.8rem;
            flex: 0 0 auto;
        }

        .security-action-btn:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .security-action-btn .material-icons {
            font-size: 18px;
            color: var(--primary);
        }

        /* Danger zone */
        .danger-zone {
            border-color: rgba(239, 68, 68, 0.3) !important;
        }

        .danger-zone:hover {
            border-color: #ef4444 !important;
        }

        .danger-content {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px dashed rgba(239, 68, 68, 0.3);
        }

        .danger-warning-text {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #ef4444;
            font-size: 0.85rem;
            margin-bottom: 1rem;
        }

        .danger-warning-text .material-icons {
            font-size: 18px;
        }

        /* About section */
        .about-content {
            text-align: center;
            padding: 2rem;
        }

        .about-logo {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            background: linear-gradient(135deg, var(--primary), #a855f7);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
        }

        .about-logo .material-icons {
            font-size: 40px;
            color: white;
        }

        .about-content h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .about-version {
            color: var(--primary);
            font-weight: 500;
            margin-bottom: 1rem;
        }

        .about-description {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }

        .about-links {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* ==================== ESTILOS LEGADOS (compatibilidade) ==================== */

        /* Novo design interativo para a aba de configurações */
        .settings-card {
            background: var(--card);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .settings-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), #a855f7, var(--primary));
            transform: scaleX(0);
            transition: transform 0.4s ease;
        }

        .settings-card:hover::before {
            transform: scaleX(1);
        }

        .settings-card:hover {
            box-shadow: 0 20px 40px rgba(99, 102, 241, 0.12);
            transform: translateY(-4px);
            border-color: var(--primary);
        }

        .settings-section-header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--border);
        }

        .settings-icon-large {
            width: 72px;
            height: 72px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary), #a855f7);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
            animation: pulse-glow 3s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3); }
            50% { box-shadow: 0 12px 32px rgba(99, 102, 241, 0.5); }
        }

        .settings-icon-large .material-icons {
            font-size: 40px;
            color: white;
        }

        .settings-header-content h3 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text);
            margin: 0 0 0.5rem 0;
        }

        .settings-header-content p {
            color: var(--text-muted);
            font-size: 0.95rem;
            margin: 0;
        }

        .interactive-upload-zone {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            /* Fixed padding to prevent content cutoff */
            padding: 4rem 2.5rem;
            min-height: 350px;
            border: 3px dashed rgba(99, 102, 241, 0.3);
            border-radius: 24px;
            cursor: pointer;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.03), rgba(168, 85, 247, 0.03));
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: visible;
            margin: 2rem 0;
        }

        .interactive-upload-zone::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.2), transparent);
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.5s ease;
            pointer-events: none;
        }

        .interactive-upload-zone:hover::after {
            transform: translate(-50%, -50%) scale(1);
        }

        .interactive-upload-zone:hover {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.08), rgba(168, 85, 247, 0.08));
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 60px rgba(99, 102, 241, 0.25);
            border-width: 3px;
        }

        .interactive-upload-zone.drag-over {
            border-color: #a855f7;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(99, 102, 241, 0.15));
            transform: scale(1.05);
        }

        .upload-icon-container {
            position: relative;
            display: inline-block;
            margin-bottom: 1.5rem;
        }

        .upload-icon-bg {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), #a855f7);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 12px 40px rgba(99, 102, 241, 0.3);
            transition: all 0.4s ease;
            /* Removed z-index that was causing overlap issues */
        }

        .upload-icon-bg .material-icons {
            font-size: 64px;
            color: white;
            animation: bounce-icon 2s ease-in-out infinite;
        }

        @keyframes bounce-icon {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .interactive-upload-zone:hover .upload-icon-bg {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 16px 48px rgba(99, 102, 241, 0.4);
        }

        .interactive-upload-zone:hover .upload-icon-bg .material-icons {
            color: white;
        }

        .upload-text-main {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.75rem;
            /* Added margin-top for proper spacing */
            margin-top: 1.5rem;
        }

        .upload-text-sub {
            font-size: 1.1rem;
            color: var(--text-muted);
            margin-bottom: 1.5rem;
            text-align: center;
            max-width: 90%;
        }

        .upload-format-tags {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .format-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1));
            border: 2px solid rgba(99, 102, 241, 0.3);
            border-radius: 50px;
            font-weight: 600;
            color: var(--primary);
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .format-tag .material-icons {
            font-size: 20px;
        }

        .interactive-upload-zone:hover .format-tag {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(168, 85, 247, 0.2));
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .file-selected-display {
            display: none;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.1));
            border: 2px solid rgba(34, 197, 94, 0.5);
            border-radius: 16px;
            margin-top: 1.5rem;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.4s ease;
        }
        
        .file-selected-display.show {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Loading States */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(99, 102, 241, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Melhorias de acessibilidade */
        button:focus-visible,
        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }
        
        /* Melhorias de performance - will-change */
        .kpi-card,
        .course-card,
        .instructor-card {
            will-change: transform;
        }
        
        /* Melhorias de responsividade */
        @media (max-width: 480px) {
            .modal {
                max-width: 95%;
                margin: 1rem;
            }
            
            .kpi-grid {
                grid-template-columns: 1fr;
            }
            
            .report-kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .toast {
                min-width: auto;
                max-width: calc(100vw - 2rem);
            }
        }

        /* ==================== MELHORIAS MOBILE COMPLETAS ==================== */
        
        /* Mobile Navigation Bar - Bottom */
        .mobile-bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface);
            border-top: 1px solid var(--border);
            padding: 0.5rem 0;
            padding-bottom: calc(0.5rem + env(safe-area-inset-bottom));
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
        }

        .mobile-bottom-nav-items {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 0.5rem 1rem;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.65rem;
            font-weight: 500;
            transition: all 0.2s;
            border-radius: 12px;
            cursor: pointer;
        }

        .mobile-nav-item .material-icons {
            font-size: 24px;
            transition: transform 0.2s;
        }

        .mobile-nav-item.active {
            color: var(--primary);
        }

        .mobile-nav-item.active .material-icons {
            transform: scale(1.1);
        }

        .mobile-nav-item:active {
            background: var(--surface-hover);
            transform: scale(0.95);
        }

        /* Pull to Refresh Indicator */
        .pull-to-refresh {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            transform: translateY(-100%);
            transition: transform 0.3s;
            z-index: 999;
        }

        .pull-to-refresh.visible {
            transform: translateY(0);
        }

        .pull-to-refresh .material-icons {
            color: white;
            font-size: 28px;
            animation: spin 1s linear infinite;
        }

        /* Mobile Header Improvements */
        @media (max-width: 768px) {
            /* Header mobile */
            .header {
                padding: 0.75rem 1rem;
                gap: 0.5rem;
            }

            .header-title {
                font-size: 1.1rem;
            }

            .header-search {
                display: none;
            }

            /* Botão de busca mobile */
            .mobile-search-btn {
                display: flex !important;
                padding: 0.5rem;
                background: var(--surface);
                border: 1px solid var(--border);
                border-radius: 8px;
                color: var(--text-secondary);
            }

            /* Modal de busca mobile */
            .mobile-search-modal {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: var(--surface);
                padding: 1rem;
                z-index: 10001;
                transform: translateY(-100%);
                transition: transform 0.3s ease;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            }

            .mobile-search-modal.active {
                transform: translateY(0);
            }

            .mobile-search-modal input {
                width: 100%;
                padding: 1rem;
                font-size: 1rem;
                border-radius: 12px;
            }

            /* Page titles mobile */
            .page-title {
                font-size: 1.3rem;
            }

            .page-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .header-actions {
                display: flex;
                gap: 0.5rem;
                flex-wrap: wrap;
            }

            .header-actions .btn {
                flex: 1;
                min-width: 120px;
                justify-content: center;
                padding: 0.75rem;
                font-size: 0.85rem;
            }

            /* KPI Cards mobile */
            .kpi-card {
                padding: 1rem;
            }

            .kpi-value {
                font-size: 1.75rem;
            }

            .kpi-label {
                font-size: 0.75rem;
            }

            .kpi-icon {
                width: 40px;
                height: 40px;
            }

            .kpi-icon .material-icons {
                font-size: 20px;
            }

            /* Course cards mobile */
            .course-card {
                padding: 1rem;
            }

            .course-title {
                font-size: 1rem;
            }

            .course-actions {
                flex-wrap: wrap;
                gap: 0.25rem;
            }

            .course-actions button {
                padding: 0.4rem;
            }

            /* Instructor cards mobile */
            .instructor-card {
                padding: 1rem;
            }

            .instructor-grid {
                grid-template-columns: 1fr;
            }

            /* Calendar mobile */
            .calendar-grid {
                font-size: 0.75rem;
            }

            .calendar-day {
                min-height: 50px;
                padding: 4px;
            }

            .calendar-day-number {
                font-size: 0.8rem;
            }

            .calendar-event {
                font-size: 0.55rem;
                padding: 2px 3px;
            }

            .calendar-header {
                flex-direction: column;
                gap: 0.75rem;
                align-items: stretch;
            }

            .calendar-nav {
                justify-content: space-between;
            }

            .month-year {
                font-size: 1.1rem;
            }

            /* Settings cards mobile */
            .settings-card {
                padding: 1.25rem;
                border-radius: 16px;
            }

            .settings-section-header {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }

            .settings-icon-large {
                width: 56px;
                height: 56px;
            }

            .settings-icon-large .material-icons {
                font-size: 28px;
            }

            .settings-header-content h3 {
                font-size: 1.25rem;
            }

            .settings-header-content p {
                font-size: 0.85rem;
            }

            /* Upload zone mobile */
            .interactive-upload-zone {
                padding: 2rem 1rem;
                min-height: 250px;
            }

            .upload-icon-bg {
                width: 80px;
                height: 80px;
            }

            .upload-icon-bg .material-icons {
                font-size: 36px;
            }

            .upload-text-main {
                font-size: 1.1rem;
            }

            .upload-text-sub {
                font-size: 0.9rem;
            }

            .format-tag {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
            }

            /* Export buttons mobile */
            .export-buttons-grid {
                grid-template-columns: 1fr;
            }

            .export-button-card {
                padding: 1.25rem;
            }

            /* Themes grid mobile */
            .themes-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 0.75rem !important;
            }

            .theme-option {
                padding: 0.75rem !important;
            }

            .theme-preview {
                height: 80px !important;
            }

            /* Modal mobile */
            .modal {
                max-height: 90vh;
                margin: 0.5rem;
                border-radius: 16px;
            }

            .modal-header {
                padding: 1rem;
            }

            .modal-header h3 {
                font-size: 1.1rem;
            }

            .modal-body {
                padding: 1rem;
            }

            .modal-footer {
                padding: 1rem;
                flex-direction: column;
            }

            .modal-footer .btn {
                width: 100%;
            }

            /* Form inputs mobile */
            .form-input, .form-select, .form-textarea {
                padding: 0.875rem;
                font-size: 16px; /* Previne zoom no iOS */
            }

            .form-label {
                font-size: 0.85rem;
            }

            /* Table mobile - scroll horizontal */
            .users-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            /* Bottom nav visible */
            .mobile-bottom-nav {
                display: block;
            }

            /* Adjust main content for bottom nav */
            .main-content {
                padding-bottom: calc(70px + env(safe-area-inset-bottom));
            }

            /* Sidebar overlay */
            .sidebar {
                position: fixed;
                z-index: 1001;
            }

            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1000;
            }

            .sidebar-overlay.active {
                display: block;
            }

            /* Floating action button mobile */
            .mobile-fab {
                display: flex !important;
                position: fixed;
                bottom: calc(80px + env(safe-area-inset-bottom));
                right: 1rem;
                width: 56px;
                height: 56px;
                border-radius: 50%;
                background: var(--primary);
                color: white;
                align-items: center;
                justify-content: center;
                box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
                z-index: 999;
                border: none;
                cursor: pointer;
                transition: transform 0.2s, box-shadow 0.2s;
            }

            .mobile-fab:active {
                transform: scale(0.95);
            }

            .mobile-fab .material-icons {
                font-size: 28px;
            }

            /* Toast mobile */
            .toast {
                bottom: calc(80px + env(safe-area-inset-bottom));
                left: 1rem;
                right: 1rem;
                transform: translateX(0);
            }

            /* User dropdown mobile */
            .user-dropdown {
                right: 0;
                min-width: 200px;
            }

            /* Lote group mobile */
            .lote-group-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .lote-group-header h3 {
                font-size: 1rem;
            }

            /* Filter controls mobile */
            .filter-group {
                flex-direction: column;
            }

            .filter-group .form-select {
                width: 100%;
            }

            /* Course view modal mobile */
            .course-view-modal .modal {
                max-width: 100%;
                margin: 0;
                border-radius: 16px 16px 0 0;
                max-height: 85vh;
            }

            /* Stats mobile */
            .quick-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }

            .stat-item {
                padding: 0.75rem;
            }

            /* Notification bell mobile */
            .notification-bell {
                padding: 0.4rem;
            }

            /* Dark mode toggle mobile */
            #themeToggle {
                padding: 0.4rem;
            }
        }

        /* Extra small devices */
        @media (max-width: 360px) {
            .kpi-grid {
                grid-template-columns: 1fr;
            }

            .themes-grid {
                grid-template-columns: 1fr !important;
            }

            .mobile-nav-item {
                padding: 0.4rem 0.5rem;
                font-size: 0.6rem;
            }

            .mobile-nav-item .material-icons {
                font-size: 20px;
            }

            .header-actions .btn {
                font-size: 0.75rem;
                padding: 0.6rem;
            }

            .btn .material-icons {
                font-size: 18px;
            }
        }

        /* Landscape mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .mobile-bottom-nav {
                padding: 0.25rem 0;
            }

            .mobile-nav-item {
                flex-direction: row;
                gap: 0.5rem;
            }

            .modal {
                max-height: 95vh;
            }

            .login-card {
                max-height: 90vh;
                overflow-y: auto;
            }
        }

        /* Touch improvements */
        @media (hover: none) and (pointer: coarse) {
            .btn, .nav-item, .mobile-nav-item, .course-card, .kpi-card {
                -webkit-tap-highlight-color: transparent;
            }

            .btn:active, .nav-item:active {
                transform: scale(0.98);
            }

            /* Larger touch targets */
            .course-actions button {
                min-width: 44px;
                min-height: 44px;
            }

            .modal-close {
                min-width: 44px;
                min-height: 44px;
            }

            /* Swipe hints */
            .swipe-hint {
                display: block;
                text-align: center;
                color: var(--text-muted);
                font-size: 0.75rem;
                padding: 0.5rem;
            }
        }

        /* Hide desktop-only elements on mobile */
        @media (max-width: 768px) {
            .desktop-only {
                display: none !important;
            }
        }

        /* Hide mobile-only elements on desktop */
        @media (min-width: 769px) {
            .mobile-only {
                display: none !important;
            }

            .mobile-bottom-nav {
                display: none !important;
            }

            .mobile-fab {
                display: none !important;
            }

            .mobile-search-btn {
                display: none !important;
            }
        }

        /* Safe area padding for notched devices */
        @supports (padding: env(safe-area-inset-bottom)) {
            .mobile-bottom-nav {
                padding-bottom: calc(0.5rem + env(safe-area-inset-bottom));
            }

            .main-content {
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
            }
        }

        /* ==================== 2FA AUTHENTICATION ==================== */
        .twofa-modal .code-inputs {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin: 1.5rem 0;
        }

        .twofa-modal .code-input {
            width: 50px;
            height: 60px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--surface);
            color: var(--text);
            transition: all 0.2s;
        }

        .twofa-modal .code-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .twofa-setup-qr {
            text-align: center;
            padding: 1.5rem;
            background: white;
            border-radius: 12px;
            margin: 1rem 0;
        }

        .twofa-secret {
            font-family: monospace;
            font-size: 1.1rem;
            background: var(--surface);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            word-break: break-all;
            text-align: center;
        }

        /* ==================== GERENCIADOR DE CURSOS ==================== */
        
        /* Tabs de navegação */
        .manager-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--border);
            padding-bottom: 0;
        }

        .manager-tab {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }

        .manager-tab:hover {
            color: var(--primary);
        }

        .manager-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .manager-tab .material-icons {
            font-size: 20px;
        }

        /* Conteúdo do manager */
        .manager-content {
            display: none;
        }

        .manager-content.active {
            display: block;
        }

        .manager-description {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }

        .manager-description .material-icons {
            color: var(--primary);
            font-size: 20px;
        }

        /* Layout lado a lado */
        .manager-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 1024px) {
            .manager-layout {
                grid-template-columns: 1fr;
            }
        }

        .manager-fields-section {
            display: flex;
            flex-direction: column;
        }

        .manager-fields-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .manager-fields-header h4 {
            font-weight: 600;
            color: var(--text);
            margin: 0;
        }

        .manager-fields-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .manager-preview-section {
            position: sticky;
            top: 1rem;
        }

        .manager-preview-section h4 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: var(--text);
            margin: 0 0 1rem 0;
        }

        .manager-preview-section h4 .material-icons {
            color: var(--primary);
            font-size: 20px;
        }

        /* Preview do formulário */
        .form-preview-container {
            background: var(--surface);
            border-radius: 16px;
            overflow: hidden;
            border: 2px solid var(--border);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .form-preview-modal {
            max-height: 450px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .form-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            background: var(--primary);
            color: white;
            font-weight: 600;
        }

        .form-preview-header .material-icons {
            opacity: 0.7;
            font-size: 20px;
        }

        .form-preview-body {
            padding: 1rem;
            overflow-y: auto;
            max-height: 340px;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .form-preview-field {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .form-preview-field label {
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-muted);
        }

        .form-preview-field .preview-input {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--background);
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .form-preview-field-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .form-preview-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border-top: 1px solid var(--border);
            background: var(--surface);
        }

        /* Preview do card */
        .card-preview-wrapper {
            display: flex;
            justify-content: center;
            padding: 1.5rem;
            background: var(--background);
            border-radius: 16px;
            border: 2px dashed var(--border);
        }

        /* Item de campo no gerenciador */
        .manager-field-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            transition: all 0.2s ease;
            cursor: grab;
        }

        .manager-field-item:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.1);
        }

        .manager-field-item.dragging {
            opacity: 0.5;
            border-style: dashed;
        }

        .manager-field-item.drag-over {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .manager-field-item.system-field {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(168, 85, 247, 0.05));
        }

        .manager-field-drag {
            color: var(--text-muted);
            cursor: grab;
        }

        .manager-field-drag:active {
            cursor: grabbing;
        }

        .manager-field-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary), #a855f7);
            color: white;
            flex-shrink: 0;
        }

        .manager-field-icon .material-icons {
            font-size: 18px;
        }

        .manager-field-info {
            flex: 1;
            min-width: 0;
        }

        .manager-field-name {
            font-weight: 500;
            color: var(--text);
            font-size: 0.9rem;
        }

        .manager-field-type {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .manager-field-actions {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .manager-field-toggle {
            position: relative;
            width: 40px;
            height: 22px;
        }

        .manager-field-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .manager-field-toggle .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--border);
            transition: 0.3s;
            border-radius: 22px;
        }

        .manager-field-toggle .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .manager-field-toggle input:checked + .slider {
            background: var(--primary);
        }

        .manager-field-toggle input:checked + .slider:before {
            transform: translateX(18px);
        }

        .manager-field-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .manager-field-btn:hover {
            background: var(--surface-hover);
            color: var(--primary);
        }

        .manager-field-btn.delete:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .manager-field-btn .material-icons {
            font-size: 18px;
        }

        /* Indicador de campo do sistema */
        .system-badge {
            font-size: 0.65rem;
            padding: 0.15rem 0.4rem;
            background: var(--primary);
            color: white;
            border-radius: 4px;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        /* ==================== CARD FIELDS CUSTOMIZER (legado) ==================== */
        .card-fields-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .card-fields-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-fields-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .card-field-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.25rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            transition: all 0.2s ease;
            cursor: grab;
        }

        .card-field-item:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1);
        }

        .card-field-item.dragging {
            opacity: 0.5;
            border-style: dashed;
        }

        .card-field-item.drag-over {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .card-field-drag-handle {
            color: var(--text-muted);
            cursor: grab;
            display: flex;
            align-items: center;
        }

        .card-field-drag-handle:active {
            cursor: grabbing;
        }

        .card-field-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary), #a855f7);
            color: white;
            flex-shrink: 0;
        }

        .card-field-icon .material-icons {
            font-size: 20px;
        }

        .card-field-info {
            flex: 1;
            min-width: 0;
        }

        .card-field-name {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        .card-field-key {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-family: monospace;
            background: var(--surface-hover);
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            display: inline-block;
        }

        .card-field-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-field-toggle {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .card-field-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .card-field-toggle .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--border);
            transition: 0.3s;
            border-radius: 24px;
        }

        .card-field-toggle .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .card-field-toggle input:checked + .slider {
            background: var(--primary);
        }

        .card-field-toggle input:checked + .slider:before {
            transform: translateX(20px);
        }

        .card-field-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: var(--surface-hover);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .card-field-btn:hover {
            background: var(--primary);
            color: white;
        }

        .card-field-btn.delete:hover {
            background: var(--danger);
        }

        .card-field-btn .material-icons {
            font-size: 18px;
        }

        /* Add Field Button */
        .add-field-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem;
            background: transparent;
            border: 2px dashed var(--border);
            border-radius: 12px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
            font-weight: 500;
        }

        .add-field-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        /* Card Preview */
        .card-preview-container {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid var(--border);
        }

        .card-preview-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 1rem;
        }

        .card-preview-title .material-icons {
            color: var(--primary);
        }

        .card-preview {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.25rem;
            max-width: 400px;
        }

        .card-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .card-preview-course-name {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text);
        }

        .card-preview-course-id {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .card-preview-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
        }

        .card-preview-fields {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .card-preview-field {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .card-preview-field .material-icons {
            font-size: 16px;
            color: var(--text-muted);
        }

        /* Form Card Preview (no modal de curso) */
        .form-preview-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px dashed var(--border);
        }

        .form-preview-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .form-preview-header .material-icons {
            font-size: 18px;
        }

        .form-card-preview {
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 1.25rem;
            transition: all 0.3s ease;
        }

        .form-card-preview:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.1);
        }

        .form-card-preview .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .form-card-preview .preview-title {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text);
            flex: 1;
        }

        .form-card-preview .preview-id {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .form-card-preview .preview-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .form-card-preview .preview-fields {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-card-preview .preview-field {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .form-card-preview .preview-field .material-icons {
            font-size: 16px;
            color: var(--text-muted);
        }

        .form-card-preview .preview-field-empty {
            color: var(--text-muted);
            font-style: italic;
        }

        /* Field Editor Modal */
        .field-editor-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .icon-selector {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            padding: 0.5rem;
            background: var(--surface);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .icon-option {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 2px solid transparent;
            background: var(--surface-hover);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .icon-option:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .icon-option.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .icon-option .material-icons {
            font-size: 20px;
        }

        @media (max-width: 768px) {
            .field-editor-grid {
                grid-template-columns: 1fr;
            }

            .icon-selector {
                grid-template-columns: repeat(5, 1fr);
            }

            .card-field-item {
                flex-wrap: wrap;
            }

            .card-field-actions {
                width: 100%;
                justify-content: flex-end;
                margin-top: 0.5rem;
                padding-top: 0.5rem;
                border-top: 1px solid var(--border);
            }
        }

        /* ==================== AUDIT LOGS ==================== */
        .audit-log-table {
            width: 100%;
            border-collapse: collapse;
        }

        .audit-log-table th,
        .audit-log-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .audit-log-table th {
            background: var(--surface);
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .audit-log-table tr:hover {
            background: var(--surface-hover);
        }

        .audit-action {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .audit-action.create { background: rgba(34, 197, 94, 0.1); color: var(--success); }
        .audit-action.update { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
        .audit-action.delete { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .audit-action.login { background: rgba(168, 85, 247, 0.1); color: #a855f7; }
        .audit-action.logout { background: rgba(107, 114, 128, 0.1); color: #6b7280; }

        /* ==================== PERMISSIONS MANAGER ==================== */
        .permissions-grid {
            display: grid;
            gap: 1rem;
        }

        .permission-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: var(--surface);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .permission-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .permission-info .material-icons {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--surface-hover);
            border-radius: 10px;
            color: var(--primary);
        }

        .permission-name {
            font-weight: 600;
        }

        .permission-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .permission-toggle {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .permission-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .permission-toggle .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--border);
            transition: 0.3s;
            border-radius: 26px;
        }

        .permission-toggle .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .permission-toggle input:checked + .slider {
            background: var(--primary);
        }

        .permission-toggle input:checked + .slider:before {
            transform: translateX(24px);
        }

        /* ==================== ONBOARDING ==================== */
        .onboarding-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10003;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .onboarding-overlay.active {
            display: flex;
        }

        .onboarding-card {
            background: var(--surface);
            border-radius: 24px;
            max-width: 500px;
            width: 90%;
            overflow: hidden;
            animation: slideUp 0.5s ease;
        }

        .onboarding-header {
            padding: 2rem;
            text-align: center;
            background: linear-gradient(135deg, var(--primary), #a855f7);
        }

        .onboarding-header .material-icons {
            font-size: 64px;
            color: white;
            margin-bottom: 1rem;
        }

        .onboarding-header h2 {
            color: white;
            margin: 0;
            font-size: 1.5rem;
        }

        .onboarding-body {
            padding: 2rem;
        }

        .onboarding-step {
            display: none;
        }

        .onboarding-step.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .onboarding-feature {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            background: var(--surface-hover);
            border-radius: 12px;
            margin-bottom: 1rem;
        }

        .onboarding-feature .material-icons {
            color: var(--primary);
            font-size: 28px;
        }

        .onboarding-feature h4 {
            margin: 0 0 0.25rem 0;
        }

        .onboarding-feature p {
            margin: 0;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .onboarding-dots {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin: 1.5rem 0;
        }

        .onboarding-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--border);
            transition: all 0.3s;
        }

        .onboarding-dot.active {
            background: var(--primary);
            width: 30px;
            border-radius: 5px;
        }

        .onboarding-footer {
            display: flex;
            justify-content: space-between;
            padding: 1rem 2rem 2rem;
        }

        /* ==================== UNDO/REDO ==================== */
        .undo-toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--card);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 1rem;
            z-index: 9999;
            transition: transform 0.3s ease;
            border: 1px solid var(--border);
        }

        .undo-toast.active {
            transform: translateX(-50%) translateY(0);
        }

        .undo-toast .undo-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: opacity 0.2s;
        }

        .undo-toast .undo-btn:hover {
            opacity: 0.9;
        }

        /* ==================== KEYBOARD SHORTCUTS INDICATOR ==================== */
        .shortcut-indicator {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--surface);
            padding: 0.75rem 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            z-index: 998;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
            border: 1px solid var(--border);
        }

        .shortcut-indicator.active {
            opacity: 1;
            transform: translateY(0);
        }

        .shortcut-indicator kbd {
            background: var(--surface-hover);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: monospace;
            font-weight: 600;
        }

        .file-selected-display .material-icons {
            font-size: 32px;
            color: #22c55e;
        }

        .file-info-text {
            flex: 1;
        }

        .file-info-text strong {
            display: block;
            color: var(--text);
            margin-bottom: 0.25rem;
            font-size: 1rem;
        }

        .file-info-text span {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .columns-info-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(99, 102, 241, 0.08));
            border: 2px solid rgba(99, 102, 241, 0.2);
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }

        .columns-info-card .material-icons {
            font-size: 28px;
            color: var(--primary);
            flex-shrink: 0;
        }

        .columns-info-card strong {
            display: block;
            color: var(--text);
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .columns-info-card p {
            color: var(--text-muted);
            margin: 0;
            line-height: 1.6;
            font-size: 0.9rem;
        }

        .export-buttons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .export-button-card {
            background: linear-gradient(135deg, var(--card), rgba(99, 102, 241, 0.02));
            border: 2px solid var(--border);
            border-radius: 20px;
            padding: 2rem;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .export-button-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.1), transparent);
            transition: left 0.6s ease;
        }

        .export-button-card:hover::before {
            left: 100%;
        }

        .export-button-card:hover {
            border-color: var(--primary);
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 16px 48px rgba(99, 102, 241, 0.2);
        }

        .export-icon-wrapper {
            width: 80px;
            height: 80px;
            margin: 0 auto 1.5rem;
            border-radius: 20px;
            background: linear-gradient(135deg, var(--primary), #a855f7);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.4s ease;
        }

        .export-button-card:hover .export-icon-wrapper {
            transform: rotate(360deg) scale(1.1);
        }

        .export-icon-wrapper .material-icons {
            font-size: 40px;
            color: white;
        }

        .export-button-card h4 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text);
            margin: 0 0 0.5rem 0;
        }

        .export-button-card p {
            color: var(--text-muted);
            margin: 0;
            font-size: 0.9rem;
        }

        .danger-zone-card {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.05), rgba(220, 38, 38, 0.05));
            border: 2px solid rgba(239, 68, 68, 0.3);
        }

        .danger-zone-card:hover {
            border-color: #ef4444;
            box-shadow: 0 20px 40px rgba(239, 68, 68, 0.15);
        }

        .danger-zone-card .settings-icon-large {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            animation: pulse-danger 3s ease-in-out infinite;
        }

        @keyframes pulse-danger {
            0%, 100% { box-shadow: 0 8px 24px rgba(239, 68, 68, 0.3); }
            50% { box-shadow: 0 12px 32px rgba(239, 68, 68, 0.5); }
        }

        .danger-warning-box {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid rgba(239, 68, 68, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            display: flex;
            align-items: start;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .danger-warning-box .material-icons {
            font-size: 28px;
            color: #ef4444;
        }

        .danger-warning-box p {
            color: var(--text);
            margin: 0;
            line-height: 1.6;
        }

        .danger-warning-box strong {
            color: #ef4444;
        }

        /* Estilos para organização por LOTE */
        .lote-section {
            background: var(--surface);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border);
        }

        .lote-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .lote-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .lote-count {
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .lote-edit-input {
            background: var(--background);
            border: 2px solid var(--primary);
            border-radius: 8px;
            padding: 8px 12px;
            color: var(--text-primary);
            font-size: 1.25rem;
            font-weight: 700;
            width: 300px;
        }

        .lote-edit-actions {
            display: flex;
            gap: 8px;
            margin-left: 12px;
        }

        .lote-edit-actions button {
            padding: 8px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .lote-edit-actions button:hover {
            transform: scale(1.1);
        }
        
        /* Busca Avançada e Filtros */
        .advanced-search-panel {
            background: var(--surface);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border);
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .filter-group label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .filter-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        /* Notificações e Alertas */
        .notification-bell {
            position: relative;
            overflow: visible !important;
        }
        
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            z-index: 1000;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            min-width: 20px;
            height: 20px;
            padding: 0 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            animation: pulse 2s infinite;
            box-shadow: 0 2px 6px rgba(239, 68, 68, 0.4);
            pointer-events: none;
        }
        
        .notifications-panel {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 380px;
            max-height: 500px;
            background: var(--surface);
            border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
            overflow: hidden;
        }
        
        .notifications-panel.active {
            display: flex;
            flex-direction: column;
        }
        
        .notifications-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .notifications-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        .notification-item {
            padding: 1.25rem;
            border-radius: 14px;
            margin-bottom: 0.75rem;
            background: var(--background);
            border-left: 4px solid var(--primary);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .notification-item:hover {
            background: var(--surface-hover);
            transform: translateX(6px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .notification-item.urgent {
            border-left-color: var(--danger);
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.05) 0%, var(--background) 10%);
        }
        
        .notification-item.warning {
            border-left-color: var(--warning);
            background: linear-gradient(90deg, rgba(251, 191, 36, 0.05) 0%, var(--background) 10%);
        }
        
        .notification-item.read {
            opacity: 0.7;
        }
        
        .notification-item.unread {
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.08) 0%, var(--background) 20%);
        }
        
        .notification-item.success {
            border-left-color: var(--success);
        }
        
        .notification-item.error {
            border-left-color: var(--danger);
        }
        
        .notification-item.info {
            border-left-color: var(--info);
        }
        
        .notification-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--surface-hover);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .notification-item.success .notification-icon { color: var(--success); }
        .notification-item.error .notification-icon { color: var(--danger); }
        .notification-item.warning .notification-icon { color: var(--warning); }
        .notification-item.info .notification-icon { color: var(--info); }
        
        .notification-content {
            flex: 1;
            min-width: 0;
        }
        
        .notification-title {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 2px;
        }
        
        .notification-message {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.4;
            margin-bottom: 4px;
        }
        
        .notification-time {
            font-size: 0.7rem;
            color: var(--text-muted);
        }
        
        .notification-unread-dot {
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .notification-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .notification-item.has-course {
            cursor: pointer;
        }
        
        .notification-link {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
            color: var(--primary);
            margin-top: 4px;
            font-weight: 500;
        }
        
        .notification-item.has-course:hover .notification-link {
            text-decoration: underline;
        }
        
        .notification-actions {
            display: flex;
            gap: 6px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        
        .notif-action-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 5px 10px;
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--surface-hover);
            color: var(--text-primary);
        }
        
        .notif-action-btn .material-icons {
            font-size: 14px;
        }
        
        .notif-action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .notif-action-btn.primary {
            background: var(--primary);
            color: white;
        }
        
        .notif-action-btn.success {
            background: var(--success);
            color: white;
        }
        
        .notif-action-btn.danger {
            background: transparent;
            color: var(--text-muted);
            padding: 5px;
        }
        
        .notif-action-btn.danger:hover {
            background: var(--danger);
            color: white;
        }
        
        .notification-item .notification-delete {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 6px;
            opacity: 0;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .notification-item:hover .notification-delete {
            opacity: 1;
        }
        
        .notification-item .notification-delete:hover {
            background: var(--surface-hover);
            color: var(--danger);
        }

        .notif-delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            border-radius: 6px;
            opacity: 0;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
        }

        .notif-delete-btn .material-icons {
            font-size: 18px;
        }

        .notification-item:hover .notif-delete-btn {
            opacity: 1;
        }

        .notif-delete-btn:hover {
            background: var(--danger);
            color: white;
        }
        
        .notification-item-minimal {
            transition: all 0.2s ease;
        }
        
        .notification-item-minimal:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .notification-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }
        
        .notification-message {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        
        .notification-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        /* Histórico de Alterações */
        .history-timeline {
            position: relative;
            padding-left: 2rem;
        }
        
        .history-item {
            position: relative;
            padding-bottom: 1.5rem;
            border-left: 2px solid var(--border);
            padding-left: 1.5rem;
        }
        
        .history-item::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 0;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--primary);
        }
        
        .history-item:last-child {
            border-left: none;
        }
        
        .history-changes {
            background: var(--background);
            border-radius: 8px;
            padding: 0.75rem;
            margin-top: 0.5rem;
            font-size: 0.85rem;
        }
        
        .history-change-item {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
        }
        
        .history-change-old {
            color: var(--danger);
            text-decoration: line-through;
        }
        
        .history-change-new {
            color: var(--success);
        }
        
        /* Histórico de Alterações Completo - Timeline */
        .course-history-timeline {
            position: relative;
            padding: 1rem 0;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .history-entry {
            position: relative;
            padding: 0.75rem 1rem;
            margin-bottom: 0.75rem;
            background: var(--surface);
            border-radius: 8px;
            border-left: 3px solid var(--primary);
            transition: all 0.2s ease;
        }
        
        .history-entry:hover {
            background: var(--surface-hover);
            transform: translateX(4px);
        }
        
        .history-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .history-entry-user {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
        }
        
        .history-entry-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .history-entry-action {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        
        .history-entry-changes {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
            font-size: 0.8rem;
        }
        
        .history-change {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.5rem;
            background: var(--background);
            border-radius: 6px;
        }
        
        .history-change-field {
            font-weight: 500;
            color: var(--text-secondary);
            min-width: 100px;
        }
        
        .history-change-old-value {
            color: var(--danger);
            text-decoration: line-through;
            opacity: 0.7;
        }
        
        .history-change-arrow {
            color: var(--text-muted);
        }
        
        .history-change-new-value {
            color: var(--success);
            font-weight: 500;
        }
        
        /* Arquivamento */
        /* Modo Claro/Escuro Toggle */
        .theme-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary);
            border: none;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: all 0.3s;
        }
        
        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.5);
        }
        
        /* Paginação */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 2rem;
            padding: 1rem;
        }
        
        .pagination button {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .pagination button:hover:not(:disabled) {
            background: var(--surface-hover);
            border-color: var(--primary);
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination button.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* Ordenação */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .sortable-header:hover {
            color: var(--primary);
        }
        
        .sort-icon {
            font-size: 16px;
            opacity: 0.5;
            transition: all 0.2s;
        }
        
        .sort-icon.active {
            opacity: 1;
            color: var(--primary);
        }
        
        /* Tooltips */
        .tooltip {
            position: relative;
        }
        
        .tooltip-content {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--surface);
            color: var(--text-primary);
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            pointer-events: none;
            z-index: 1000;
            border: 1px solid var(--border);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            margin-bottom: 8px;
        }
        
        .tooltip-content::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--surface);
        }
        
        .tooltip:hover .tooltip-content {
            opacity: 1;
            visibility: visible;
        }
        
        /* Preview de Importação */
        .import-preview {
            background: var(--surface);
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            border: 1px solid var(--border);
            max-height: 400px;
            overflow-y: auto;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        
        .preview-table th,
        .preview-table td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        .preview-table th {
            background: var(--background);
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .preview-table tr:hover td {
            background: var(--surface-hover);
        }
        
        .preview-error {
            color: var(--danger);
            font-size: 0.75rem;
        }
        
        .preview-success {
            color: var(--success);
        }
        
        /* Estatísticas por Período */
        /* Opções de Tema */
        .theme-option {
            position: relative;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .theme-option:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }
        
        .theme-option.active {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        
        .theme-option.active .theme-check {
            display: flex !important;
        }
        
        .themes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }
        
        /* Atalhos de teclado - Indicador */
        .keyboard-shortcut {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-left: auto;
        }
        
        .keyboard-key {
            background: var(--background);
            border: 1px solid var(--border);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.7rem;
        }
        
        /* Backup automático */
        .backup-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-muted);
            padding: 0.5rem;
        }
        
        .backup-status.active {
            color: var(--success);
        }
        

    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-overlay" id="loginOverlay">
        <!-- Partículas animadas -->
        <div class="login-particles">
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
        </div>
        
        <div class="login-card">
            <div class="login-logo">
                <span class="material-icons" id="loginDefaultIcon">school</span>
                <h1 id="loginProjectName">Ceará Sem Fome + Qualificação e Renda</h1>
            </div>
            
            <p class="login-greeting" id="loginGreeting">Bom dia! Faça login para continuar.</p>
            
            <div class="login-error" id="loginError">
                Credenciais inválidas. Tente novamente.
            </div>
            
            <div class="login-blocked" id="loginBlocked" style="display: none;">
                <span class="material-icons">lock</span>
                <p>Conta temporariamente bloqueada.</p>
                <p id="blockTimer">Aguarde <span id="blockCountdown">30</span> segundos.</p>
            </div>
            
            <form id="loginForm">
                <div class="login-input-group">
                    <input type="text" class="form-input" id="loginUsername" placeholder="Digite seu usuário" required>
                    <span class="material-icons input-icon">person</span>
                    <div class="input-feedback" id="usernameFeedback"></div>
                </div>
                
                <div class="login-input-group">
                    <input type="password" class="form-input" id="loginPassword" placeholder="Digite sua senha" required>
                    <span class="material-icons input-icon">lock</span>
                    <button type="button" class="toggle-password" id="togglePassword" tabindex="-1">
                        <span class="material-icons">visibility</span>
                    </button>
                    <div class="input-feedback" id="passwordFeedback"></div>
                </div>
                
                <div class="login-options">
                    <label class="remember-me">
                        <input type="checkbox" id="rememberMe">
                        <span>Lembrar de mim</span>
                    </label>
                    <a href="#" class="forgot-password" id="forgotPasswordLink">Esqueci minha senha</a>
                </div>
                
                <button type="submit" class="btn btn-primary login-btn" id="loginBtn">
                    <span class="btn-text">
                        <span class="material-icons">login</span>
                        Entrar
                    </span>
                    <div class="btn-loading">
                        <div class="spinner"></div>
                    </div>
                </button>
            </form>
            
            <div class="login-footer">
                <div class="version">
                    <span class="material-icons" style="font-size: 14px;">info</span>
                    <span>Versão 2.0.0</span>
                </div>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <span class="material-icons" id="sidebarDefaultIcon">school</span>
                    <h1 id="sidebarProjectName">CSF + Qualificação</h1>
                </div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-item active" data-page="dashboard">
                    <span class="material-icons">dashboard</span>
                    <span class="nav-text">Dashboard</span>
                </div>
                <div class="nav-item" data-page="courses">
                    <span class="material-icons">book</span>
                    <span class="nav-text">Cursos</span>
                </div>
                <div class="nav-item" data-page="calendar">
                    <span class="material-icons">calendar_month</span>
                    <span class="nav-text">Calendário</span>
                </div>
                <div class="nav-item" data-page="tasks">
                    <span class="material-icons">checklist</span>
                    <span class="nav-text">Tarefas</span>
                    <span class="task-pending-badge" id="taskPendingBadge" style="display: none;">0</span>
                </div>
                <div class="nav-item" data-page="instructors">
                    <span class="material-icons">people</span>
                    <span class="nav-text">Instrutores</span>
                </div>
                <div class="nav-item" data-page="users" id="usersNavItem" style="display: none;">
                    <span class="material-icons">admin_panel_settings</span>
                    <span class="nav-text">Usuários</span>
                </div>
                <div class="nav-item" data-page="settings">
                    <span class="material-icons">settings</span>
                    <span class="nav-text">Configurações</span>
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <div class="user-details">
                        <h4 id="userName">Admin</h4>
                        <span id="userRole">Administrador</span>
                    </div>
                    <button class="logout-btn" id="logoutBtn" title="Sair">
                        <span class="material-icons">logout</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Botão fixo para abrir sidebar no mobile -->
        <button id="mobileSidebarToggle" class="mobile-sidebar-toggle" title="Abrir menu">
            <span class="material-icons">menu</span>
        </button>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Breadcrumbs -->
            <div class="breadcrumbs" id="breadcrumbs">
                <div class="breadcrumb-item" data-page="dashboard">
                    <span class="material-icons">home</span>
                    Início
                </div>
                <span class="breadcrumb-separator">›</span>
                <div class="breadcrumb-item active" id="currentPageBreadcrumb">
                    Dashboard
                </div>
            </div>

            <!-- Push Notification Banner -->
            <div class="notification-banner" id="pushNotificationBanner">
                <div class="notification-banner-header">
                    <div class="notification-banner-title">
                        <span class="material-icons">notifications_active</span>
                        <span id="pushNotificationTitle">Alerta</span>
                    </div>
                    <button class="notification-banner-close" onclick="closePushNotification()">
                        <span class="material-icons">close</span>
                    </button>
                </div>
                <div class="notification-banner-body" id="pushNotificationBody">
                    Mensagem da notificação
                </div>
                <div class="notification-banner-actions" id="pushNotificationActions">
                </div>
            </div>

            <!-- PWA Install Prompt -->
            <div class="pwa-install-prompt" id="pwaInstallPrompt">
                <div class="pwa-install-icon">
                    <span class="material-icons">install_mobile</span>
                </div>
                <div class="pwa-install-text">
                    <h4>Instalar App</h4>
                    <p>Instale o app para acesso rápido</p>
                </div>
                <div class="pwa-install-actions">
                    <button class="btn btn-primary" id="pwaInstallBtn" onclick="installPWA()">Instalar</button>
                    <button class="btn btn-secondary" onclick="dismissPWAPrompt()">Depois</button>
                </div>
            </div>

            <!-- Notificações Panel -->
            <div class="notifications-panel" id="notificationsPanel">
                <div class="notifications-header">
                    <h3>Notificações</h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary" id="refreshNotificationsBtn" title="Atualizar notificações" style="padding: 0.25rem 0.5rem;" onclick="refreshNotifications()">
                            <span class="material-icons" style="font-size: 18px;">refresh</span>
                        </button>
                        <button class="btn btn-secondary" id="markAllReadBtn" title="Marcar todas como lidas" style="padding: 0.25rem 0.5rem;">
                            <span class="material-icons" style="font-size: 18px;">done_all</span>
                        </button>
                        <button class="btn btn-secondary" id="clearNotificationsBtn" title="Limpar histórico" style="padding: 0.25rem 0.5rem;">
                            <span class="material-icons" style="font-size: 18px;">delete_sweep</span>
                        </button>
                        <button class="btn btn-secondary" id="closeNotificationsBtn" style="padding: 0.25rem 0.5rem;">
                            <span class="material-icons" style="font-size: 18px;">close</span>
                        </button>
                    </div>
                </div>
                <div class="notifications-list" id="notificationsList">
                    <!-- Notificações serão renderizadas aqui -->
                </div>
            </div>
            
            <!-- Aviso de dados não salvos -->
            <!-- Toggle de Tema -->
            <button class="theme-toggle" id="themeToggle" title="Alternar tema">
                <span class="material-icons" id="themeIcon">dark_mode</span>
            </button>
            
            <!-- Dashboard Page -->
            <section class="page-section active" id="dashboardPage">
                <div class="header">
                    <button class="mobile-menu-btn" id="mobileMenuBtn">
                        <span class="material-icons">menu</span>
                    </button>
                    <div class="header-search-hint desktop-only" onclick="openGlobalSearch()" style="cursor: pointer; display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; color: var(--text-muted); font-size: 0.9rem;">
                        <span class="material-icons" style="font-size: 18px;">search</span>
                        Buscar...
                        <span style="margin-left: auto; padding: 2px 6px; background: var(--surface-hover); border-radius: 4px; font-size: 0.7rem;">Ctrl+K</span>
                    </div>
                    <button class="mobile-search-btn mobile-only" onclick="openGlobalSearch()">
                        <span class="material-icons">search</span>
                    </button>
                </div>

                <!-- KPI Cards -->
                <div class="kpi-grid">
                    <div class="kpi-card animate-in" style="animation-delay: 0.1s;">
                        <div class="kpi-header">
                            <div class="kpi-icon purple">
                                <span class="material-icons">school</span>
                            </div>
                        </div>
                        <div class="kpi-value" id="totalCourses">0</div>
                        <div class="kpi-label">Total de Cursos</div>
                    </div>
                    <div class="kpi-card animate-in" style="animation-delay: 0.15s;">
                        <div class="kpi-header">
                            <div class="kpi-icon green">
                                <span class="material-icons">check_circle</span>
                            </div>
                        </div>
                        <div class="kpi-value" id="completedCourses">0</div>
                        <div class="kpi-label">Concluídos</div>
                    </div>
                    <div class="kpi-card animate-in" style="animation-delay: 0.2s;">
                        <div class="kpi-header">
                            <div class="kpi-icon blue">
                                <span class="material-icons">pending</span>
                            </div>
                        </div>
                        <div class="kpi-value" id="ongoingCourses">0</div>
                        <div class="kpi-label">Em Andamento</div>
                    </div>
                    <div class="kpi-card animate-in" style="animation-delay: 0.25s;">
                        <div class="kpi-header">
                            <div class="kpi-icon orange">
                                <span class="material-icons">groups</span>
                            </div>
                        </div>
                        <div class="kpi-value" id="totalStudents">0</div>
                        <div class="kpi-label">Total Concludentes</div>
                    </div>
                </div>
                
                <!-- Dashboard Charts -->
                <div class="dashboard-charts">
                    <div class="chart-card animate-in" style="animation-delay: 0.3s;">
                        <div class="chart-header">
                            <h3>Cursos por Mês</h3>
                            <span class="chart-subtitle">Últimos 6 meses</span>
                        </div>
                        <div class="chart-container">
                            <canvas id="coursesTimelineChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card animate-in" style="animation-delay: 0.35s;">
                        <div class="chart-header">
                            <h3>Status dos Cursos</h3>
                            <span class="chart-subtitle">Distribuição atual</span>
                        </div>
                        <div class="chart-container">
                            <canvas id="coursesStatusChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Timeline de Atividades -->
                <div class="dashboard-timeline animate-in" style="animation-delay: 0.4s;">
                    <div class="timeline-header">
                        <h3><span class="material-icons">timeline</span> Atividade Recente</h3>
                    </div>
                    <div class="timeline-content" id="dashboardTimeline">
                        <!-- Timeline será renderizada aqui -->
                    </div>
                </div>

                <!-- Relatório de Cursos no Dashboard -->
                <div class="report-section" style="margin-top: 2rem;">
                    <div class="page-header">
                        <h2 class="page-title">Relatório de Cursos</h2>
                        <div class="header-actions">
                            <button class="btn btn-primary" id="downloadReportBtn">
                                <span class="material-icons">download</span>
                                Baixar Relatório
                            </button>
                        </div>
                    </div>
                    <div id="dashboardReport">
                        <!-- Relatório será renderizado aqui -->
                    </div>
                </div>
            </section>

            <!-- Courses Page -->
            <section class="page-section" id="coursesPage">
                <div class="page-header">
                    <h2 class="page-title">Cursos</h2>
                    <div class="header-actions">
                        <button class="view-toggle-btn" id="compactModeBtn" title="Modo Compacto">
                            <span class="material-icons">view_comfy</span>
                            <span class="btn-text">Compacto</span>
                        </button>
                        <button class="btn btn-secondary notification-bell" id="notificationBellBtn" title="Notificações">
                            <span class="material-icons">notifications</span>
                            <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                        </button>
                        <button class="btn btn-primary" id="newCourseBtn">
                            <span class="material-icons">add</span>
                            Novo Curso
                        </button>
                    </div>
                </div>
                
                <!-- Busca Avançada e Filtros -->
                <div class="advanced-search-panel">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                        <h3 style="font-size: 1.1rem; font-weight: 600;">Filtros</h3>
                        <button class="btn btn-secondary" id="toggleFiltersBtn" style="padding: 0.5rem 1rem;">
                            <span class="material-icons">filter_list</span>
                            Filtros
                        </button>
                    </div>
                    <div id="filtersContainer" class="filters-grid" style="display: none;">
                        <div class="filter-group">
                            <label>Status</label>
                            <select id="filterStatus" class="form-select">
                                <option value="">Todos</option>
                                <option value="Concluído">Concluído</option>
                                <option value="Em Andamento">Em Andamento</option>
                                <option value="Pendente">Pendente</option>
                                <option value="Cancelado">Cancelado</option>
                    </select>
                        </div>
                        <div class="filter-group">
                            <label>LOTE</label>
                            <select id="filterLote" class="form-select">
                                <option value="">Todos</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Curso</label>
                            <select id="filterCurso" class="form-select">
                                <option value="">Todos</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>ID</label>
                            <input type="text" id="filterId" class="form-input" placeholder="Digite o ID do curso" inputmode="numeric">
                        </div>
                        <div class="filter-actions">
                            <button class="btn btn-primary" id="applyFiltersBtn">Aplicar Filtros</button>
                            <button class="btn btn-secondary" id="clearFiltersBtn">Limpar</button>
                        </div>
                    </div>
                </div>
                
                
                <div id="coursesByLoteContainer">
                    <!-- Cursos organizados por LOTE serão renderizados aqui -->
                </div>
                
                <!-- Paginação -->
                <div class="pagination" id="paginationContainer" style="display: none;">
                    <button id="prevPageBtn" class="btn btn-secondary">
                        <span class="material-icons">chevron_left</span>
                    </button>
                    <span id="pageInfo" style="padding: 0 1rem;"></span>
                    <button id="nextPageBtn" class="btn btn-secondary">
                        <span class="material-icons">chevron_right</span>
                    </button>
                </div>
            </section>

            <!-- Calendar Page -->
            <section class="page-section" id="calendarPage">
                <div class="page-header">
                    <h2 class="page-title">Calendário</h2>
                    <div class="header-actions">
                        <div class="calendar-view-toggle">
                            <button class="view-btn active" data-view="month" title="Mensal">
                                <span class="material-icons">calendar_view_month</span>
                            </button>
                            <button class="view-btn" data-view="week" title="Semanal">
                                <span class="material-icons">view_week</span>
                            </button>
                            <button class="view-btn" data-view="day" title="Diário">
                                <span class="material-icons">view_day</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Estatísticas do mês -->
                <div class="calendar-stats" id="calendarStats">
                    <div class="calendar-stat">
                        <span class="material-icons">event</span>
                        <span id="totalCoursesMonth">0</span> cursos no mês
                    </div>
                    <div class="calendar-stat">
                        <span class="material-icons">play_circle</span>
                        <span id="coursesStartingMonth">0</span> iniciando
                    </div>
                    <div class="calendar-stat">
                        <span class="material-icons">stop_circle</span>
                        <span id="coursesEndingMonth">0</span> finalizando
                    </div>
                </div>
                
                <div class="calendar-container">
                    <div class="calendar-header">
                        <div class="calendar-nav">
                            <button id="prevMonth" title="Mês anterior (←)">
                                <span class="material-icons">chevron_left</span>
                            </button>
                            <h3 class="calendar-title" id="calendarTitle">Dezembro 2024</h3>
                            <button id="nextMonth" title="Próximo mês (→)">
                                <span class="material-icons">chevron_right</span>
                            </button>
                        </div>
                        <div class="calendar-header-actions">
                            <input type="date" id="calendarDatePicker" class="form-input" style="width: auto; padding: 0.5rem;" title="Ir para data">
                            <button class="btn btn-primary" id="todayBtn">
                                <span class="material-icons">today</span>
                                Hoje
                            </button>
                        </div>
                    </div>
                    <div class="calendar-grid" id="calendarGrid">
                        <!-- Calendar will be rendered here -->
                    </div>
                    
                    <!-- Legenda -->
                    <div class="calendar-legend">
                        <div class="legend-title">Legenda:</div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: var(--success);"></span>
                            <span>Início do curso</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: var(--danger);"></span>
                            <span>Fim do curso</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: var(--primary);"></span>
                            <span>Em andamento</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: var(--warning);"></span>
                            <span>Feriado</span>
                        </div>
                    </div>
                </div>
                
                <!-- Preview do curso (tooltip) -->
                <div class="course-preview-tooltip" id="coursePreviewTooltip" style="display: none;">
                    <div class="preview-header">
                        <span class="preview-status"></span>
                        <span class="preview-title"></span>
                    </div>
                    <div class="preview-body">
                        <div class="preview-info"><span class="material-icons">person</span> <span class="preview-instructor"></span></div>
                        <div class="preview-info"><span class="material-icons">location_on</span> <span class="preview-location"></span></div>
                        <div class="preview-info"><span class="material-icons">schedule</span> <span class="preview-dates"></span></div>
                        <div class="preview-info"><span class="material-icons">groups</span> <span class="preview-students"></span></div>
                    </div>
                </div>
            </section>

            <!-- Tasks Page -->
            <section class="page-section" id="tasksPage">
                <div class="page-header">
                    <h2 class="page-title">Agenda de Tarefas</h2>
                    <div class="header-actions">
                        <button class="btn btn-primary" id="newTaskBtn">
                            <span class="material-icons">add_task</span>
                            Nova Tarefa
                        </button>
                    </div>
                </div>
                
                <!-- Estatísticas de tarefas -->
                <div class="tasks-stats">
                    <div class="task-stat-card">
                        <div class="task-stat-icon pending">
                            <span class="material-icons">pending_actions</span>
                        </div>
                        <div class="task-stat-info">
                            <span class="task-stat-value" id="tasksPendingCount">0</span>
                            <span class="task-stat-label">Pendentes</span>
                        </div>
                    </div>
                    <div class="task-stat-card">
                        <div class="task-stat-icon today">
                            <span class="material-icons">today</span>
                        </div>
                        <div class="task-stat-info">
                            <span class="task-stat-value" id="tasksTodayCount">0</span>
                            <span class="task-stat-label">Para Hoje</span>
                        </div>
                    </div>
                    <div class="task-stat-card">
                        <div class="task-stat-icon overdue">
                            <span class="material-icons">warning</span>
                        </div>
                        <div class="task-stat-info">
                            <span class="task-stat-value" id="tasksOverdueCount">0</span>
                            <span class="task-stat-label">Atrasadas</span>
                        </div>
                    </div>
                    <div class="task-stat-card">
                        <div class="task-stat-icon completed">
                            <span class="material-icons">task_alt</span>
                        </div>
                        <div class="task-stat-info">
                            <span class="task-stat-value" id="tasksCompletedCount">0</span>
                            <span class="task-stat-label">Concluídas</span>
                        </div>
                    </div>
                </div>
                
                <!-- Filtros de tarefas -->
                <div class="tasks-filters">
                    <button class="task-filter-btn active" data-filter="all">
                        <span class="material-icons">list</span> Todas
                    </button>
                    <button class="task-filter-btn" data-filter="today">
                        <span class="material-icons">today</span> Hoje
                    </button>
                    <button class="task-filter-btn" data-filter="week">
                        <span class="material-icons">date_range</span> Esta Semana
                    </button>
                    <button class="task-filter-btn" data-filter="overdue">
                        <span class="material-icons">warning</span> Atrasadas
                    </button>
                    <button class="task-filter-btn" data-filter="completed">
                        <span class="material-icons">check_circle</span> Concluídas
                    </button>
                </div>
                
                <!-- Lista de tarefas -->
                <div class="tasks-container" id="tasksContainer">
                    <!-- Tarefas serão renderizadas aqui -->
                </div>
            </section>

            <!-- Instructors Page -->
            <section class="page-section" id="instructorsPage">
                <div class="page-header">
                    <h2 class="page-title">Instrutores</h2>
                    <div class="header-actions">
                        <button class="btn btn-secondary" id="importInstructorsBtn">
                            <span class="material-icons">upload_file</span>
                            Importar Dados
                        </button>
                    <button class="btn btn-primary" id="newInstructorBtn">
                        <span class="material-icons">person_add</span>
                        Novo Instrutor
                    </button>
                    </div>
                </div>
                <div class="instructor-grid" id="instructorGrid">
                    <!-- Instructors will be rendered here -->
                </div>
            </section>

            <!-- Users Page (Admin Only) -->
            <section class="page-section" id="usersPage">
                <div class="page-header">
                    <h2 class="page-title">Gerenciar Usuários</h2>
                    <button class="btn btn-primary" id="newUserBtn">
                        <span class="material-icons">person_add</span>
                        Novo Usuário
                    </button>
                </div>
                
                <!-- Adicionando seção para alterar nome do administrador -->
                <div class="settings-card">
                    <h3>
                        <span class="material-icons">badge</span>
                        Alterar Meu Nome
                    </h3>
                    <form id="changeNameForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Nome Atual</label>
                                <input type="text" class="form-input" id="currentNameDisplay" disabled>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Novo Nome</label>
                                <input type="text" class="form-input" id="newAdminName" placeholder="Digite o novo nome">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <span class="material-icons">save</span>
                            Alterar Nome
                        </button>
                    </form>
                </div>

                <!-- Seção de mudar senha do admin -->
                <div class="settings-card">
                    <h3>
                        <span class="material-icons">lock</span>
                        Alterar Minha Senha
                    </h3>
                    <form id="changePasswordForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Senha Atual</label>
                                <input type="password" class="form-input" id="currentPassword" placeholder="Digite sua senha atual">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Nova Senha</label>
                                <input type="password" class="form-input" id="newPassword" placeholder="Digite a nova senha">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Confirmar Nova Senha</label>
                            <input type="password" class="form-input" id="confirmPassword" placeholder="Confirme a nova senha">
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <span class="material-icons">save</span>
                            Alterar Senha
                        </button>
                    </form>
                </div>

                <div class="settings-card">
                    <h3>
                        <span class="material-icons">group</span>
                        Lista de Usuários
                    </h3>
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Função</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- Users will be rendered here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Novo layout do log de atividades -->
                <div class="settings-card">
                    <h3>
                        <span class="material-icons">history</span>
                        Log de Atividades
                    </h3>
                    <div class="activity-log" id="activityLog">
                        <!-- Activity log will be rendered here -->
                    </div>
                </div>
                
                <!-- Histórico de Alterações Detalhado -->
                <div class="settings-card">
                    <h3>
                        <span class="material-icons">timeline</span>
                        Histórico de Alterações
                    </h3>
                    <div id="changeHistoryContainer">
                        <!-- Histórico será renderizado aqui -->
                    </div>
                </div>
            </section>

            <!-- Settings Page -->
            <section class="page-section" id="settingsPage">
                <div class="page-header">
                    <h2 class="page-title">Configurações</h2>
                </div>

                <!-- Menu lateral de navegação das configurações -->
                <div class="settings-layout">
                    <nav class="settings-nav">
                        <button class="settings-nav-item active" data-section="appearance">
                            <span class="material-icons">palette</span>
                            <span>Aparência</span>
                        </button>
                        <button class="settings-nav-item" data-section="courses">
                            <span class="material-icons">tune</span>
                            <span>Cursos</span>
                        </button>
                        <button class="settings-nav-item" data-section="data" id="navDataSection">
                            <span class="material-icons">sync_alt</span>
                            <span>Dados</span>
                        </button>
                        <button class="settings-nav-item" data-section="security" id="navSecuritySection">
                            <span class="material-icons">security</span>
                            <span>Segurança</span>
                        </button>
                        <button class="settings-nav-item" data-section="about">
                            <span class="material-icons">info</span>
                            <span>Sobre</span>
                        </button>
                    </nav>

                    <div class="settings-content">
                        <!-- SEÇÃO: APARÊNCIA -->
                        <div class="settings-section active" id="section-appearance">
                            <div class="settings-section-title">
                                <span class="material-icons">palette</span>
                                Aparência
                            </div>

                            <!-- Modo claro/escuro -->
                            <div class="settings-option-card">
                                <div class="settings-option-header">
                                    <div class="settings-option-icon">
                                        <span class="material-icons">dark_mode</span>
                                    </div>
                                    <div class="settings-option-info">
                                        <h4>Modo do Tema</h4>
                                        <p>Alterne entre modo claro e escuro</p>
                                    </div>
                                    <button class="btn btn-secondary" id="themeModeToggle" onclick="document.getElementById('themeToggle').click()">
                                        <span class="material-icons" id="themeModeIcon">dark_mode</span>
                                        <span id="themeModeText">Escuro</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Cor do tema -->
                            <div class="settings-option-card">
                                <div class="settings-option-header">
                                    <div class="settings-option-icon" style="background: linear-gradient(135deg, var(--primary), #a855f7);">
                                        <span class="material-icons">color_lens</span>
                                    </div>
                                    <div class="settings-option-info">
                                        <h4>Cor Principal</h4>
                                        <p>Escolha a cor de destaque do sistema</p>
                                    </div>
                                </div>
                                <div class="theme-colors-grid">
                                    <button class="theme-color-option active" data-theme="default" style="--color: #6366f1;" title="Índigo"></button>
                                    <button class="theme-color-option" data-theme="blue" style="--color: #3b82f6;" title="Azul"></button>
                                    <button class="theme-color-option" data-theme="green" style="--color: #10b981;" title="Verde"></button>
                                    <button class="theme-color-option" data-theme="purple" style="--color: #8b5cf6;" title="Roxo"></button>
                                    <button class="theme-color-option" data-theme="rose" style="--color: #f43f5e;" title="Rosa"></button>
                                    <button class="theme-color-option" data-theme="orange" style="--color: #f97316;" title="Laranja"></button>
                                    <button class="theme-color-option" data-theme="cyan" style="--color: #06b6d4;" title="Ciano"></button>
                                </div>
                            </div>

                            <!-- Cores personalizadas -->
                            <div class="settings-option-card">
                                <div class="settings-option-header">
                                    <div class="settings-option-icon" style="background: linear-gradient(135deg, #f59e0b, #ef4444);">
                                        <span class="material-icons">tune</span>
                                    </div>
                                    <div class="settings-option-info">
                                        <h4>Cores Personalizadas</h4>
                                        <p>Defina suas próprias cores</p>
                                    </div>
                                    <button class="btn btn-secondary btn-sm" onclick="toggleCustomColors()">
                                        <span class="material-icons">expand_more</span>
                                    </button>
                                </div>
                                <div class="custom-colors-panel" id="customColorsPanel" style="display: none;">
                                    <div class="color-inputs-grid">
                                        <div class="color-input-item">
                                            <label>Principal</label>
                                            <input type="color" id="customPrimaryColor" value="#6366f1">
                                        </div>
                                        <div class="color-input-item">
                                            <label>Fundo</label>
                                            <input type="color" id="customBackgroundColor" value="#0f172a">
                                        </div>
                                        <div class="color-input-item">
                                            <label>Sidebar</label>
                                            <input type="color" id="customSidebarColor" value="#020617">
                                        </div>
                                        <div class="color-input-item">
                                            <label>Superfície</label>
                                            <input type="color" id="customSurfaceColor" value="#1e293b">
                                        </div>
                                    </div>
                                    <div class="custom-colors-actions">
                                        <button class="btn btn-primary btn-sm" id="applyCustomThemeBtn">Aplicar</button>
                                        <button class="btn btn-secondary btn-sm" id="resetCustomThemeBtn">Restaurar</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Nome do projeto -->
                            <div class="settings-option-card">
                                <div class="settings-option-header">
                                    <div class="settings-option-icon" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);">
                                        <span class="material-icons">badge</span>
                                    </div>
                                    <div class="settings-option-info">
                                        <h4>Nome do Projeto</h4>
                                        <p>Aparece na tela de login e sidebar</p>
                                    </div>
                                </div>
                                <div class="project-name-input">
                                    <input type="text" id="projectNameInput" class="form-input" placeholder="Nome do projeto" maxlength="50">
                                    <button class="btn btn-primary btn-sm" id="saveProjectNameBtn">
                                        <span class="material-icons">save</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- SEÇÃO: CURSOS -->
                        <div class="settings-section" id="section-courses">
                            <div class="settings-section-title">
                                <span class="material-icons">tune</span>
                                Gerenciador de Cursos
                            </div>

                            <!-- Tabs -->
                            <div class="settings-tabs">
                                <button class="settings-tab active" data-tab="form-manager" onclick="switchManagerTab('form-manager')">
                                    <span class="material-icons">edit_note</span>
                                    Formulário
                                </button>
                                <button class="settings-tab" data-tab="card-manager" onclick="switchManagerTab('card-manager')">
                                    <span class="material-icons">view_agenda</span>
                                    Cards
                                </button>
                            </div>

                            <!-- Gerenciador de Formulário -->
                            <div class="manager-content active" id="form-manager">
                                <div class="manager-compact-layout">
                                    <div class="manager-list-section">
                                        <div class="manager-list-header">
                                            <span>Campos do Formulário</span>
                                            <button class="btn btn-primary btn-sm" onclick="openAddFormFieldModal()">
                                                <span class="material-icons">add</span>
                                                Novo
                                            </button>
                                        </div>
                                        <div class="manager-fields-list" id="formFieldsList"></div>
                                    </div>
                                    <div class="manager-preview-compact">
                                        <div class="preview-label">Pré-visualização</div>
                                        <div class="form-preview-mini" id="formPreviewBody"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Gerenciador de Cards -->
                            <div class="manager-content" id="card-manager">
                                <div class="manager-compact-layout">
                                    <div class="manager-list-section">
                                        <div class="manager-list-header">
                                            <span>Campos do Card</span>
                                        </div>
                                        <div class="manager-fields-list" id="cardFieldsList"></div>
                                    </div>
                                    <div class="manager-preview-compact">
                                        <div class="preview-label">Pré-visualização</div>
                                        <div class="card-preview" id="cardPreview"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SEÇÃO: DADOS -->
                        <div class="settings-section" id="section-data">
                            <div class="settings-section-title">
                                <span class="material-icons">sync_alt</span>
                                Importar e Exportar Dados
                            </div>

                            <!-- Importar -->
                            <div class="settings-option-card" id="importDataCard">
                                <div class="settings-option-header">
                                    <div class="settings-option-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
                                        <span class="material-icons">upload_file</span>
                                    </div>
                                    <div class="settings-option-info">
                                        <h4>Importar Cursos</h4>
                                        <p>Importe dados de planilhas Excel</p>
                                    </div>
                                </div>
                                <label class="upload-zone-compact" for="excelFileInput" id="uploadZone">
                                    <span class="material-icons">cloud_upload</span>
                                    <span>Arraste ou clique para selecionar arquivo</span>
                                    <small>.xlsx, .xls</small>
                                </label>
                                <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display: none;">
                                <input type="file" id="instructorsFileInput" accept=".xlsx,.xls" style="display: none;">
                                <div class="import-preview" id="importPreview" style="display: none;">
                                    <div id="previewTableContainer"></div>
                                    <div class="import-actions">
                                        <button class="btn btn-primary btn-sm" id="confirmImportBtn">Confirmar</button>
                                        <button class="btn btn-secondary btn-sm" id="cancelImportBtn">Cancelar</button>
                                    </div>
                                </div>
                                <div class="file-selected-display" id="fileInfoBox">
                                    <span class="material-icons">check_circle</span>
                                    <span id="selectedFileName"></span>
                                </div>
                            </div>

                            <!-- Exportar -->
                            <div class="settings-option-card" id="exportDataCard">
                                <div class="settings-option-header">
                                    <div class="settings-option-icon" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);">
                                        <span class="material-icons">download</span>
                                    </div>
                                    <div class="settings-option-info">
                                        <h4>Exportar Dados</h4>
                                        <p>Baixe seus dados em diferentes formatos</p>
                                    </div>
                                </div>
                                <div class="export-buttons-compact">
                                    <button class="export-btn" id="exportCoursesBtn">
                                        <span class="material-icons">description</span>
                                        CSV
                                    </button>
                                    <button class="export-btn" id="exportCoursesExcelBtn">
                                        <span class="material-icons">table_chart</span>
                                        Excel
                                    </button>
                                    <button class="export-btn" id="exportCoursesPDFBtn">
                                        <span class="material-icons">picture_as_pdf</span>
                                        PDF
                                    </button>
                                    <button class="export-btn" id="exportInstructorsBtn">
                                        <span class="material-icons">people</span>
                                        Instrutores
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- SEÇÃO: SEGURANÇA -->
                        <!-- SEÇÃO: SEGURANÇA -->
                        <div class="settings-section" id="section-security">
                            <div class="settings-section-title">
                                <span class="material-icons">security</span>
                                Segurança e Auditoria
                            </div>

                            <div class="settings-option-card" id="securityCard">
                                <div class="settings-option-header">
                                    <div class="settings-option-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
                                        <span class="material-icons">shield</span>
                                    </div>
                                    <div class="settings-option-info">
                                        <h4>Gerenciamento de Segurança</h4>
                                        <p>Logs, permissões e configurações de acesso</p>
                                    </div>
                                </div>
                                <div class="security-buttons-grid">
                                    <button class="security-action-btn" onclick="showAuditLogs()">
                                        <span class="material-icons">history</span>
                                        <span>Logs de Auditoria</span>
                                    </button>
                                    <button class="security-action-btn" onclick="showPermissionsModal()">
                                        <span class="material-icons">admin_panel_settings</span>
                                        <span>Permissões</span>
                                    </button>
                                    <button class="security-action-btn" onclick="showOnboarding()">
                                        <span class="material-icons">help_outline</span>
                                        <span>Tutorial</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Zona de perigo -->
                            <div class="settings-option-card danger-zone" id="dangerZoneCard">
                                <div class="settings-option-header">
                                    <div class="settings-option-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                                        <span class="material-icons">warning</span>
                                    </div>
                                    <div class="settings-option-info">
                                        <h4>Zona de Perigo</h4>
                                        <p>Ações irreversíveis - use com cuidado</p>
                                    </div>
                                </div>
                                <div class="danger-content">
                                    <p class="danger-warning-text">
                                        <span class="material-icons">error</span>
                                        Esta ação irá excluir permanentemente todos os dados.
                                    </p>
                                    <button class="btn btn-danger btn-sm" id="clearDataBtn">
                                        <span class="material-icons">delete_forever</span>
                                        Limpar Dados
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- SEÇÃO: SOBRE -->
                        <div class="settings-section" id="section-about">
                            <div class="settings-section-title">
                                <span class="material-icons">info</span>
                                Sobre o Sistema
                            </div>

                            <div class="settings-option-card">
                                <div class="about-content">
                                    <div class="about-logo">
                                        <span class="material-icons">school</span>
                                    </div>
                                    <h3>Ceará Sem Fome + Qualificação e Renda</h3>
                                    <p class="about-version">Versão 2.0</p>
                                    <p class="about-description">Sistema de gerenciamento de cursos e capacitações profissionais.</p>
                                    <div class="about-links">
                                        <button class="btn btn-secondary btn-sm" onclick="showOnboarding()">
                                            <span class="material-icons">help</span>
                                            Ver Tutorial
                                        </button>
                                        <button class="btn btn-secondary btn-sm" onclick="document.getElementById('shortcutsModal').classList.add('active')">
                                            <span class="material-icons">keyboard</span>
                                            Atalhos
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-bottom-nav" id="mobileBottomNav">
        <div class="mobile-bottom-nav-items">
            <div class="mobile-nav-item active" data-page="dashboard">
                <span class="material-icons">dashboard</span>
                <span>Início</span>
            </div>
            <div class="mobile-nav-item" data-page="courses">
                <span class="material-icons">book</span>
                <span>Cursos</span>
            </div>
            <div class="mobile-nav-item" data-page="calendar">
                <span class="material-icons">calendar_month</span>
                <span>Agenda</span>
            </div>
            <div class="mobile-nav-item" data-page="tasks">
                <span class="material-icons">task_alt</span>
                <span>Tarefas</span>
            </div>
            <div class="mobile-nav-item" data-page="settings">
                <span class="material-icons">settings</span>
                <span>Config</span>
            </div>
        </div>
    </nav>

    <!-- Mobile FAB (Floating Action Button) -->
    <button class="mobile-fab mobile-only" id="mobileFab" title="Novo">
        <span class="material-icons">add</span>
    </button>

    <!-- Sidebar Overlay Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Onboarding Overlay -->
    <div class="onboarding-overlay" id="onboardingOverlay">
        <div class="onboarding-card">
            <div class="onboarding-header">
                <span class="material-icons">rocket_launch</span>
                <h2>Bem-vindo ao Ceará Sem Fome + Qualificação e Renda!</h2>
            </div>
            <div class="onboarding-body">
                <div class="onboarding-step active" data-step="1">
                    <div class="onboarding-feature">
                        <span class="material-icons">dashboard</span>
                        <div>
                            <h4>Dashboard Completo</h4>
                            <p>Visualize todos os seus cursos, métricas e relatórios em um só lugar.</p>
                        </div>
                    </div>
                    <div class="onboarding-feature">
                        <span class="material-icons">calendar_month</span>
                        <div>
                            <h4>Calendário Interativo</h4>
                            <p>Acompanhe datas de início e fim dos cursos de forma visual.</p>
                        </div>
                    </div>
                </div>
                <div class="onboarding-step" data-step="2">
                    <div class="onboarding-feature">
                        <span class="material-icons">keyboard</span>
                        <div>
                            <h4>Atalhos de Teclado</h4>
                            <p>Use <kbd>Ctrl+K</kbd> para busca rápida, <kbd>Ctrl+Z</kbd> para desfazer e muito mais!</p>
                        </div>
                    </div>
                    <div class="onboarding-feature">
                        <span class="material-icons">select_all</span>
                        <div>
                            <h4>Ações em Massa</h4>
                            <p>Selecione múltiplos cursos e execute ações de uma vez.</p>
                        </div>
                    </div>
                </div>
                <div class="onboarding-step" data-step="3">
                    <div class="onboarding-feature">
                        <span class="material-icons">security</span>
                        <div>
                            <h4>Segurança Avançada</h4>
                            <p>Autenticação 2FA, logs de auditoria e controle de permissões.</p>
                        </div>
                    </div>
                    <div class="onboarding-feature">
                        <span class="material-icons">sync</span>
                        <div>
                            <h4>Sincronização em Tempo Real</h4>
                            <p>Todas as alterações são salvas automaticamente.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="onboarding-dots">
                <div class="onboarding-dot active" data-step="1"></div>
                <div class="onboarding-dot" data-step="2"></div>
                <div class="onboarding-dot" data-step="3"></div>
            </div>
            <div class="onboarding-footer">
                <button class="btn btn-secondary" id="skipOnboarding">Pular</button>
                <button class="btn btn-primary" id="nextOnboarding">
                    Próximo
                    <span class="material-icons">arrow_forward</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Undo Toast -->
    <div class="undo-toast" id="undoToast">
        <span class="material-icons">undo</span>
        <span id="undoMessage">Ação realizada</span>
        <button class="undo-btn" onclick="performUndo()">Desfazer</button>
    </div>

    <!-- Shortcut Indicator -->
    <div class="shortcut-indicator" id="shortcutIndicator">
        <kbd id="shortcutKey"></kbd>
        <span id="shortcutAction"></span>
    </div>

    <!-- 2FA Modal -->
    <div class="modal-overlay" id="twofaModal">
        <div class="modal twofa-modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Verificação em Duas Etapas</h3>
                <button class="modal-close" onclick="closeModal('twofaModal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <span class="material-icons" style="font-size: 64px; color: var(--primary); margin-bottom: 1rem;">security</span>
                <p>Digite o código de 6 dígitos do seu aplicativo autenticador.</p>
                <div class="code-inputs">
                    <input type="text" maxlength="1" class="code-input" data-index="0">
                    <input type="text" maxlength="1" class="code-input" data-index="1">
                    <input type="text" maxlength="1" class="code-input" data-index="2">
                    <input type="text" maxlength="1" class="code-input" data-index="3">
                    <input type="text" maxlength="1" class="code-input" data-index="4">
                    <input type="text" maxlength="1" class="code-input" data-index="5">
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="verify2FACode()">
                    Verificar
                </button>
            </div>
        </div>
    </div>

    <!-- Audit Logs Modal -->
    <div class="modal-overlay" id="auditLogsModal">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <h3>
                    <span class="material-icons">history</span>
                    Logs de Auditoria
                </h3>
                <button class="modal-close" onclick="closeModal('auditLogsModal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                    <select class="form-select" id="auditFilterAction" style="width: auto;">
                        <option value="">Todas as ações</option>
                        <option value="create">Criação</option>
                        <option value="update">Atualização</option>
                        <option value="delete">Exclusão</option>
                        <option value="login">Login</option>
                        <option value="logout">Logout</option>
                    </select>
                    <select class="form-select" id="auditFilterUser" style="width: auto;">
                        <option value="">Todos os usuários</option>
                    </select>
                    <input type="date" class="form-input" id="auditFilterDate" style="width: auto;">
                </div>
                <div style="max-height: 400px; overflow-y: auto;">
                    <table class="audit-log-table">
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th>Usuário</th>
                                <th>Ação</th>
                                <th>Entidade</th>
                                <th>Detalhes</th>
                            </tr>
                        </thead>
                        <tbody id="auditLogsBody">
                            <!-- Logs renderizados aqui -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Form Field Editor Modal -->
    <div class="modal-overlay" id="formFieldEditorModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="formFieldEditorTitle">
                    <span class="material-icons">add_circle</span>
                    Novo Campo
                </h3>
                <button class="modal-close" onclick="closeModal('formFieldEditorModal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="formFieldEditorForm">
                    <div class="field-editor-grid">
                        <div class="form-group">
                            <label class="form-label">Nome do Campo</label>
                            <input type="text" class="form-input" id="formFieldName" placeholder="Ex: Quantidade de Inscritos" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Chave (identificador)</label>
                            <input type="text" class="form-input" id="formFieldKey" placeholder="Ex: qtdInscritos" required>
                            <small style="color: var(--text-muted);">Sem espaços ou acentos</small>
                        </div>
                    </div>
                    
                    <div class="field-editor-grid" style="margin-top: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Tipo do Campo</label>
                            <select class="form-select" id="formFieldType">
                                <option value="text">Texto</option>
                                <option value="number">Número</option>
                                <option value="date">Data</option>
                                <option value="select">Seleção</option>
                                <option value="textarea">Área de Texto</option>
                                <option value="url">URL/Link</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Placeholder</label>
                            <input type="text" class="form-input" id="formFieldPlaceholder" placeholder="Ex: Digite a quantidade...">
                        </div>
                    </div>

                    <div class="form-group" id="selectOptionsGroup" style="margin-top: 1rem; display: none;">
                        <label class="form-label">Opções (uma por linha)</label>
                        <textarea class="form-input" id="formFieldOptions" rows="3" placeholder="Opção 1&#10;Opção 2&#10;Opção 3"></textarea>
                    </div>
                    
                    <div class="form-group" style="margin-top: 1rem;">
                        <label class="form-label">Ícone</label>
                        <div class="icon-selector" id="formIconSelector">
                            <!-- Ícones renderizados via JavaScript -->
                        </div>
                        <input type="hidden" id="formFieldIcon" value="info">
                    </div>

                    <div class="form-group" style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                        <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem;">
                            <span class="material-icons" style="font-size: 18px; color: var(--warning);">warning</span>
                            Aplicar em:
                        </label>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="applyTo" value="all" checked style="accent-color: var(--primary);">
                                <span>Todos os cursos (padrão)</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="applyTo" value="new" style="accent-color: var(--primary);">
                                <span>Apenas novos cursos</span>
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('formFieldEditorModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="saveFormField()">
                    <span class="material-icons">save</span>
                    Salvar Campo
                </button>
            </div>
        </div>
    </div>

    <!-- Card Field Editor Modal (legado) -->
    <div class="modal-overlay" id="fieldEditorModal">
        <div class="modal" style="max-width: 550px;">
            <div class="modal-header">
                <h3 id="fieldEditorTitle">
                    <span class="material-icons">edit</span>
                    Editar Campo
                </h3>
                <button class="modal-close" onclick="closeModal('fieldEditorModal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="fieldEditorForm">
                    <div class="field-editor-grid">
                        <div class="form-group">
                            <label class="form-label">Nome de Exibição</label>
                            <input type="text" class="form-input" id="fieldDisplayName" placeholder="Ex: Instrutor" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Chave do Campo</label>
                            <input type="text" class="form-input" id="fieldKey" placeholder="Ex: instrutor" required>
                            <small style="color: var(--text-muted);">Deve corresponder ao campo no banco de dados</small>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 1rem;">
                        <label class="form-label">Ícone</label>
                        <div class="icon-selector" id="iconSelector">
                            <!-- Ícones renderizados via JavaScript -->
                        </div>
                        <input type="hidden" id="fieldIcon" value="info">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('fieldEditorModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="saveField()">
                    <span class="material-icons">save</span>
                    Salvar Campo
                </button>
            </div>
        </div>
    </div>

    <!-- Permissions Modal -->
    <div class="modal-overlay" id="permissionsModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3>
                    <span class="material-icons">admin_panel_settings</span>
                    Gerenciar Permissões
                </h3>
                <button class="modal-close" onclick="closeModal('permissionsModal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label class="form-label">Selecione o usuário</label>
                    <select class="form-select" id="permissionUserSelect">
                        <!-- Usuários renderizados aqui -->
                    </select>
                </div>
                <h4 style="margin-bottom: 1rem;">Permissões</h4>
                <div class="permissions-grid" id="permissionsGrid">
                    <!-- Permissões renderizadas aqui -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('permissionsModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="savePermissions()">Salvar Permissões</button>
            </div>
        </div>
    </div>

    <!-- Course Modal - Campos opcionais -->
    <div class="modal-overlay" id="courseModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="courseModalTitle">Novo Curso</h3>
                <button class="modal-close" onclick="closeModal('courseModal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="courseForm">
                <div class="modal-body" id="courseFormBody">
                    <!-- Campos renderizados dinamicamente via JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('courseModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="material-icons">save</span>
                        Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Course Modal -->
    <div class="modal-overlay" id="viewCourseModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="viewCourseTitle">Detalhes do Curso</h3>
                <button class="modal-close" onclick="closeModal('viewCourseModal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="modal-body" id="viewCourseBody">
                <!-- Course details will be rendered here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('viewCourseModal')"> Fechar</button>
                <button type="button" class="btn btn-primary" id="editCourseFromViewBtn">
                    <span class="material-icons">edit</span>
                    Editar
                </button>
            </div>
        </div>
    </div>

    <!-- Instructor Modal - Campos opcionais -->
    <div class="modal-overlay" id="instructorModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="instructorModalTitle">Novo Instrutor</h3>
                <button class="modal-close" onclick="closeModal('instructorModal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="instructorForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Nome <span class="optional-label">(opcional)</span></label>
                        <input type="text" class="form-input" id="instructorName" placeholder="Nome completo">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Especialidade <span class="optional-label">(opcional)</span></label>
                        <input type="text" class="form-input" id="instructorSpecialty" placeholder="Ex: Segurança do Trabalho">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Telefone <span class="optional-label">(opcional)</span></label>
                        <input type="tel" class="form-input" id="instructorPhone" placeholder="(00) 00000-0000">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email <span class="optional-label">(opcional)</span></label>
                        <input type="email" class="form-input" id="instructorEmail" placeholder="email@exemplo.com">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('instructorModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="material-icons">save</span>
                        Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Quick Instructor Modal -->
    <div class="modal-overlay" id="quickInstructorModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Adicionar Instrutor Rápido</h3>
                <button class="modal-close" onclick="closeModal('quickInstructorModal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="quickInstructorForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Nome do Instrutor <span class="optional-label">(opcional)</span></label>
                        <input type="text" class="form-input" id="quickInstructorName">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('quickInstructorModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="material-icons">add</span>
                        Adicionar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Modal - Campos opcionais -->
    <div class="modal-overlay" id="userModal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h3 id="userModalTitle">Novo Usuário</h3>
                <button class="modal-close" onclick="closeModal('userModal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="userForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Nome <span class="optional-label">(opcional)</span></label>
                        <input type="text" class="form-input" id="newUserName" placeholder="Nome do usuário">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Usuário (login) <span class="optional-label">(opcional)</span></label>
                        <input type="text" class="form-input" id="newUserUsername" placeholder="Nome de usuário para login">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email <span class="optional-label">(opcional)</span></label>
                        <input type="email" class="form-input" id="newUserEmail" placeholder="email@exemplo.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Senha <span class="optional-label">(opcional)</span></label>
                        <input type="password" class="form-input" id="newUserPassword" placeholder="Senha do usuário">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Função</label>
                        <select class="form-select" id="newUserRole">
                            <option value="viewer">Visualizador</option>
                            <option value="editor">Editor</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('userModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="material-icons">save</span>
                        Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Report Modal -->
    <div class="modal-overlay" id="reportModal">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <h3>Relatório de Cursos</h3>
                <button class="modal-close" onclick="closeModal('reportModal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="report-preview" id="reportContent">
                    <!-- Report content will be rendered here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('reportModal')"> Fechar</button>
                <button type="button" class="btn btn-primary" onclick="downloadReportAsImage()">
                    <span class="material-icons">image</span>
                    Baixar como Imagem
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Busca Global -->
    <div class="global-search-overlay" id="globalSearchOverlay" onclick="if(event.target === this) closeGlobalSearch()">
        <div class="global-search-container">
            <div class="global-search-input-wrapper">
                <span class="material-icons">search</span>
                <input type="text" class="global-search-input" id="globalSearchInput" placeholder="Buscar cursos, instrutores, tarefas..." autocomplete="off">
                <span class="global-search-shortcut">ESC</span>
            </div>
            <div class="global-search-results" id="globalSearchResults">
                <div class="search-no-results" id="searchInitialState">
                    <span class="material-icons">search</span>
                    <p>Digite para buscar...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Atalhos -->
    <div class="modal-overlay" id="shortcutsModal">
        <div class="modal shortcuts-modal">
            <div class="modal-header">
                <h3>Atalhos de Teclado</h3>
                <button class="modal-close" onclick="closeModal('shortcutsModal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="shortcut-group">
                    <div class="shortcut-group-title">Navegação</div>
                    <div class="shortcut-item">
                        <span class="shortcut-description">Abrir busca global</span>
                        <div class="shortcut-keys">
                            <span class="shortcut-key">Ctrl</span>
                            <span class="shortcut-key">K</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-description">Ir para Dashboard</span>
                        <div class="shortcut-keys">
                            <span class="shortcut-key">G</span>
                            <span class="shortcut-key">D</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-description">Ir para Cursos</span>
                        <div class="shortcut-keys">
                            <span class="shortcut-key">G</span>
                            <span class="shortcut-key">C</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-description">Ir para Calendário</span>
                        <div class="shortcut-keys">
                            <span class="shortcut-key">G</span>
                            <span class="shortcut-key">A</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-description">Ir para Tarefas</span>
                        <div class="shortcut-keys">
                            <span class="shortcut-key">G</span>
                            <span class="shortcut-key">T</span>
                        </div>
                    </div>
                </div>
                <div class="shortcut-group">
                    <div class="shortcut-group-title">Ações</div>
                    <div class="shortcut-item">
                        <span class="shortcut-description">Novo curso</span>
                        <div class="shortcut-keys">
                            <span class="shortcut-key">N</span>
                            <span class="shortcut-key">C</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-description">Nova tarefa</span>
                        <div class="shortcut-keys">
                            <span class="shortcut-key">N</span>
                            <span class="shortcut-key">T</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-description">Alternar tema</span>
                        <div class="shortcut-keys">
                            <span class="shortcut-key">Ctrl</span>
                            <span class="shortcut-key">Shift</span>
                            <span class="shortcut-key">L</span>
                        </div>
                    </div>
                </div>
                <div class="shortcut-group">
                    <div class="shortcut-group-title">Geral</div>
                    <div class="shortcut-item">
                        <span class="shortcut-description">Mostrar atalhos</span>
                        <div class="shortcut-keys">
                            <span class="shortcut-key">?</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-description">Fechar modal/busca</span>
                        <div class="shortcut-keys">
                            <span class="shortcut-key">ESC</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBq5qmLy6HAzZAeC4KCVjLfdCM77ttOU3A",
            authDomain: "csf-iac.firebaseapp.com",
            projectId: "csf-iac",
            storageBucket: "csf-iac.firebasestorage.app",
            messagingSenderId: "484645494526",
            appId: "1:484645494526:web:f5ecc23c7c0edbca320faf",
            measurementId: "G-XL3WY01E73"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        let firebaseAvailable = false;

        // State
        let cursos = [];
        let instrutores = [];
        let usuarios = [];
        let activityLogs = [];
        let currentUser = null;
        let editingCourseId = null;
        let editingInstructorId = null;
        let editingUserId = null;
        let currentMonth = new Date();
        let currentCalendarView = 'month'; // 'month', 'week', 'day'
        
        // Segurança e UX
        let undoStack = [];
        let redoStack = [];
        let hasSeenOnboarding = localStorage.getItem('hasSeenOnboarding') === 'true';
        let auditLogs = JSON.parse(localStorage.getItem('auditLogs') || '[]');
        let viewingCourseId = null;
        let loteNames = {}; // Inicializar variável loteNames
        let isLoading = false; // Estado de loading
        let debounceTimer = null; // Timer para debounce

        const defaultUsers = [
            { id: 'admin1', name: 'Administrador', username: 'Csfiac', password: '032147', role: 'admin' },
            { id: 'editor1', name: 'Editor', username: 'Iac', password: 'Iac@123', role: 'editor' },
            { id: 'viewer1', name: 'Visualizador', username: 'viewer', password: 'viewer123', role: 'viewer' }
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Inicializar funcionalidades do login
            updateLoginGreeting();
            initializePasswordToggle();
            initializeLoginValidation();
            initializeForgotPassword();
            checkRememberedUser();
            
            await initializeApp();
            checkAuth();
            setupEventListeners();
            setupDragAndDrop(); // Chamada para configurar o drag and drop
            setupModalCloseOnOutsideClick(); // Configurar fechamento de modais ao clicar fora
            initNotificationSystem(); // Inicializar sistema de notificações
            setupCalendarKeyboardNav(); // Navegação por teclado no calendário
            setupCalendarDatePicker(); // Date picker do calendário
            initTaskSystem(); // Inicializar sistema de tarefas
            setupKeyboardShortcuts(); // Atalhos de teclado
            initThemeSelector(); // Seletor de cores
            // Carregar nome do projeto ao inicializar
            loadProjectName();
        });

        async function initializeApp() {
            try {
                await db.collection('_test_connection').doc('test').get();
                firebaseAvailable = true;
                console.log('Firebase conectado com sucesso!');
                await initializeUsers();
            } catch (error) {
                console.warn('Firebase não disponível, usando localStorage:', error.message);
                firebaseAvailable = false;
                initializeLocalStorage();
            }
        }

        function initializeLocalStorage() {
            if (!localStorage.getItem('usuarios')) {
                localStorage.setItem('usuarios', JSON.stringify(defaultUsers));
            }
            if (!localStorage.getItem('cursos')) {
                localStorage.setItem('cursos', JSON.stringify([]));
            }
            if (!localStorage.getItem('instrutores')) {
                localStorage.setItem('instrutores', JSON.stringify([]));
            }
            if (!localStorage.getItem('activityLogs')) {
                localStorage.setItem('activityLogs', JSON.stringify([]));
            }
            if (!localStorage.getItem('loteNames')) {
                localStorage.setItem('loteNames', JSON.stringify({}));
            }
            loteNames = JSON.parse(localStorage.getItem('loteNames') || '{}');
            
            // Sincronizar loteNames do Firebase se disponível
            if (firebaseAvailable) {
                syncLoteNamesFromFirebase();
            }
        }
        
        async function syncLoteNamesFromFirebase() {
            try {
                const snapshot = await db.collection('loteNames').get();
                if (!snapshot.empty) {
                    const firebaseLoteNames = {};
                    snapshot.docs.forEach(doc => {
                        firebaseLoteNames[doc.id] = doc.data().name;
                    });
                    // Mesclar com localStorage
                    loteNames = { ...loteNames, ...firebaseLoteNames };
                    localStorage.setItem('loteNames', JSON.stringify(loteNames));
                }
            } catch (error) {
                console.warn('Erro ao sincronizar loteNames do Firebase:', error);
            }
        }

        async function initializeUsers() {
            try {
                const snapshot = await db.collection('usuarios').get();
                if (snapshot.empty) {
                    for (const user of defaultUsers) {
                        await db.collection('usuarios').doc(user.id).set(user);
                    }
                }
            } catch (error) {
                console.error('Error initializing users:', error);
            }
        }

        function checkAuth() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showApp();
            }
        }

        // Auth Functions
        let loginAttempts = 0;
        let isLoginBlocked = false;
        let blockTimer = null;

        // Inicializar saudação baseada na hora
        function updateLoginGreeting() {
            const hour = new Date().getHours();
            let greeting = '';
            
            if (hour >= 5 && hour < 12) {
                greeting = 'Bom dia! ☀️';
            } else if (hour >= 12 && hour < 18) {
                greeting = 'Boa tarde! 🌤️';
            } else {
                greeting = 'Boa noite! 🌙';
            }
            
            const greetingEl = document.getElementById('loginGreeting');
            if (greetingEl) {
                greetingEl.textContent = `${greeting} Faça login para continuar.`;
            }
        }

        // Toggle mostrar/ocultar senha
        function initializePasswordToggle() {
            const toggleBtn = document.getElementById('togglePassword');
            const passwordInput = document.getElementById('loginPassword');
            
            if (toggleBtn && passwordInput) {
                toggleBtn.addEventListener('click', () => {
                    const type = passwordInput.type === 'password' ? 'text' : 'password';
                    passwordInput.type = type;
                    toggleBtn.querySelector('.material-icons').textContent = 
                        type === 'password' ? 'visibility' : 'visibility_off';
                });
            }
        }

        // Validação em tempo real
        function initializeLoginValidation() {
            const usernameInput = document.getElementById('loginUsername');
            const passwordInput = document.getElementById('loginPassword');
            const usernameFeedback = document.getElementById('usernameFeedback');
            const passwordFeedback = document.getElementById('passwordFeedback');

            if (usernameInput) {
                usernameInput.addEventListener('input', () => {
                    const value = usernameInput.value.trim();
                    if (value.length === 0) {
                        usernameInput.classList.remove('valid', 'invalid');
                        usernameFeedback.classList.remove('show');
                    } else if (value.length < 3) {
                        usernameInput.classList.remove('valid');
                        usernameInput.classList.add('invalid');
                        usernameFeedback.textContent = 'Mínimo 3 caracteres';
                        usernameFeedback.className = 'input-feedback show error';
                    } else {
                        usernameInput.classList.remove('invalid');
                        usernameInput.classList.add('valid');
                        usernameFeedback.classList.remove('show');
                    }
                });
            }

            if (passwordInput) {
                passwordInput.addEventListener('input', () => {
                    const value = passwordInput.value;
                    if (value.length === 0) {
                        passwordInput.classList.remove('valid', 'invalid');
                        passwordFeedback.classList.remove('show');
                    } else if (value.length < 3) {
                        passwordInput.classList.remove('valid');
                        passwordInput.classList.add('invalid');
                        passwordFeedback.textContent = 'Mínimo 3 caracteres';
                        passwordFeedback.className = 'input-feedback show error';
                    } else {
                        passwordInput.classList.remove('invalid');
                        passwordInput.classList.add('valid');
                        passwordFeedback.classList.remove('show');
                    }
                });
            }
        }

        // Bloqueio após tentativas
        function blockLogin(seconds = 30) {
            isLoginBlocked = true;
            const loginForm = document.getElementById('loginForm');
            const loginBlocked = document.getElementById('loginBlocked');
            const countdownEl = document.getElementById('blockCountdown');
            
            loginForm.style.display = 'none';
            loginBlocked.style.display = 'block';
            
            let remaining = seconds;
            countdownEl.textContent = remaining;
            
            blockTimer = setInterval(() => {
                remaining--;
                countdownEl.textContent = remaining;
                
                if (remaining <= 0) {
                    clearInterval(blockTimer);
                    isLoginBlocked = false;
                    loginAttempts = 0;
                    loginBlocked.style.display = 'none';
                    loginForm.style.display = 'block';
                }
            }, 1000);
        }

        // Esqueci minha senha
        function initializeForgotPassword() {
            const forgotLink = document.getElementById('forgotPasswordLink');
            if (forgotLink) {
                forgotLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    showToast('Entre em contato com o administrador para redefinir sua senha.', 'info');
                });
            }
        }

        // Lembrar de mim
        function checkRememberedUser() {
            const remembered = localStorage.getItem('rememberedUser');
            if (remembered) {
                const { username } = JSON.parse(remembered);
                const usernameInput = document.getElementById('loginUsername');
                const rememberCheckbox = document.getElementById('rememberMe');
                if (usernameInput) usernameInput.value = username;
                if (rememberCheckbox) rememberCheckbox.checked = true;
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            
            if (isLoginBlocked) return;
            
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe')?.checked;
            const loginBtn = document.getElementById('loginBtn');
            
            // Mostrar loading
            loginBtn.classList.add('loading');
            loginBtn.disabled = true;
            
            // Simular pequeno delay para UX
            await new Promise(resolve => setTimeout(resolve, 800));
            
            const defaultUser = defaultUsers.find(u => u.username === username && u.password === password);
            
            if (defaultUser) {
                currentUser = { ...defaultUser };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                if (rememberMe) {
                    localStorage.setItem('rememberedUser', JSON.stringify({ username }));
                } else {
                    localStorage.removeItem('rememberedUser');
                }
                document.getElementById('loginError').classList.remove('show');
                loginAttempts = 0;
                loginBtn.classList.remove('loading');
                loginBtn.disabled = false;
                showApp();
                logActivity('Login', `${currentUser.name} fez login`, 'add');
                addAuditLog('login', 'session', currentUser.id, `${currentUser.name} fez login`);
                return;
            }
            
            if (!firebaseAvailable) {
                const localUsers = JSON.parse(localStorage.getItem('usuarios') || '[]');
                const localUser = localUsers.find(u => u.username === username && u.password === password);
                
                if (localUser) {
                    currentUser = { ...localUser };
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    if (rememberMe) {
                        localStorage.setItem('rememberedUser', JSON.stringify({ username }));
                    } else {
                        localStorage.removeItem('rememberedUser');
                    }
                    document.getElementById('loginError').classList.remove('show');
                    loginAttempts = 0;
                    loginBtn.classList.remove('loading');
                    loginBtn.disabled = false;
                    showApp();
                    logActivity('Login', `${currentUser.name} fez login`, 'add');
                    addAuditLog('login', 'session', currentUser.id, `${currentUser.name} fez login`);
                    return;
                }
                
                loginAttempts++;
                loginBtn.classList.remove('loading');
                loginBtn.disabled = false;
                
                if (loginAttempts >= 5) {
                    blockLogin(30);
                } else {
                    document.getElementById('loginError').textContent = 
                        `Credenciais inválidas. Tentativa ${loginAttempts}/5.`;
                    document.getElementById('loginError').classList.add('show');
                }
                return;
            }

            try {
                const snapshot = await db.collection('usuarios').where('username', '==', username).get();
                
                if (!snapshot.empty) {
                    const userDoc = snapshot.docs[0];
                    const userData = userDoc.data();
                    
                    if (userData.password === password) {
                        currentUser = { id: userDoc.id, ...userData };
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        if (rememberMe) {
                            localStorage.setItem('rememberedUser', JSON.stringify({ username }));
                        } else {
                            localStorage.removeItem('rememberedUser');
                        }
                        document.getElementById('loginError').classList.remove('show');
                        loginAttempts = 0;
                        loginBtn.classList.remove('loading');
                        loginBtn.disabled = false;
                        showApp();
                        logActivity('Login', `${currentUser.name} fez login`, 'add');
                        addAuditLog('login', 'session', currentUser.id, `${currentUser.name} fez login`);
                        return;
                    }
                }
                
                loginAttempts++;
                loginBtn.classList.remove('loading');
                loginBtn.disabled = false;
                
                if (loginAttempts >= 5) {
                    blockLogin(30);
                } else {
                    document.getElementById('loginError').textContent = 
                        `Credenciais inválidas. Tentativa ${loginAttempts}/5.`;
                    document.getElementById('loginError').classList.add('show');
                }
            } catch (error) {
                console.error('Erro no login Firebase:', error);
                loginBtn.classList.remove('loading');
                loginBtn.disabled = false;
                document.getElementById('loginError').classList.add('show');
            }
        }

        function showApp() {
            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
            
            const roleLabels = { admin: 'Administrador', editor: 'Editor', viewer: 'Visualizador' };
            document.getElementById('userRole').textContent = roleLabels[currentUser.role];
            
            if (document.getElementById('currentNameDisplay')) {
                document.getElementById('currentNameDisplay').value = currentUser.name;
            }
            
            if (currentUser.role === 'admin') {
                document.getElementById('usersNavItem').style.display = 'flex';
                // Mostrar funções administrativas
                if (document.getElementById('importDataCard')) document.getElementById('importDataCard').style.display = 'block';
                if (document.getElementById('exportDataCard')) document.getElementById('exportDataCard').style.display = 'block';
                if (document.getElementById('dangerZoneCard')) document.getElementById('dangerZoneCard').style.display = 'block';
                if (document.getElementById('securityCard')) document.getElementById('securityCard').style.display = 'block';
                if (document.getElementById('importInstructorsBtn')) document.getElementById('importInstructorsBtn').style.display = 'flex';
            } else {
                document.getElementById('usersNavItem').style.display = 'none';
                // Esconder funções administrativas para não-admins
                if (document.getElementById('importDataCard')) document.getElementById('importDataCard').style.display = 'none';
                if (document.getElementById('exportDataCard')) document.getElementById('exportDataCard').style.display = 'none';
                if (document.getElementById('dangerZoneCard')) document.getElementById('dangerZoneCard').style.display = 'none';
                if (document.getElementById('securityCard')) document.getElementById('securityCard').style.display = 'none';
                if (document.getElementById('importInstructorsBtn')) document.getElementById('importInstructorsBtn').style.display = 'none';
            }

            if (currentUser.role === 'viewer') {
                document.getElementById('newCourseBtn').style.display = 'none';
                document.getElementById('newInstructorBtn').style.display = 'none';
                // Esconder configurações para visualizadores
                const settingsNavItem = document.querySelector('.nav-item[data-page="settings"]');
                if (settingsNavItem) settingsNavItem.style.display = 'none';
                // Esconder tarefas para visualizadores
                const tasksNavItem = document.querySelector('.nav-item[data-page="tasks"]');
                if (tasksNavItem) tasksNavItem.style.display = 'none';
                // Esconder FAB para visualizadores
                const mobileFab = document.getElementById('mobileFab');
                if (mobileFab) mobileFab.style.display = 'none';
                // Esconder settings na nav mobile
                const mobileSettingsNav = document.querySelector('.mobile-nav-item[data-page="settings"]');
                if (mobileSettingsNav) mobileSettingsNav.style.display = 'none';
            } else {
                document.getElementById('newCourseBtn').style.display = 'flex';
                document.getElementById('newInstructorBtn').style.display = 'flex';
                const settingsNavItem = document.querySelector('.nav-item[data-page="settings"]');
                if (settingsNavItem) settingsNavItem.style.display = 'flex';
                // Mostrar tarefas para não-visualizadores
                const tasksNavItem = document.querySelector('.nav-item[data-page="tasks"]');
                if (tasksNavItem) tasksNavItem.style.display = 'flex';
                // Mostrar settings na nav mobile
                const mobileSettingsNav = document.querySelector('.mobile-nav-item[data-page="settings"]');
                if (mobileSettingsNav) mobileSettingsNav.style.display = 'flex';
            }

            loadData();
            
            // Garantir renderização inicial após carregar dados
            setTimeout(() => {
                renderCalendar();
                if (document.getElementById('coursesPage')?.classList.contains('active')) {
                    renderCoursesByLote();
                }
            }, 500);
        }

        // Data Loading - Otimizado com debounce
        let dataUpdateTimer = null;
        function loadData() {
            if (firebaseAvailable) {
                db.collection('cursos').onSnapshot(snapshot => {
                    cursos = snapshot.docs.map(doc => {
                        const courseData = { id: doc.id, ...doc.data() };
                        // Normalizar status ao carregar
                        if (courseData.status) {
                            courseData.status = normalizeStatus(courseData.status);
                        }
                        return courseData;
                    });
                    
                    // Debounce para evitar múltiplas renderizações
                    if (dataUpdateTimer) clearTimeout(dataUpdateTimer);
                    dataUpdateTimer = setTimeout(() => {
                    updateKPIs();
                    renderCalendar();
                    renderDashboardReport();
                    // Atualizar filtros com os dados carregados
                    updateLoteFilter();
                    updateCursoFilter();
                    if (document.getElementById('coursesPage')?.classList.contains('active')) {
                        renderCoursesByLote();
                    }
                    // Verificar alertas após carregar dados
                    if (typeof checkAutomaticAlerts === 'function') {
                        checkAutomaticAlerts();
                    }
                    }, 100);
                }, error => {
                    console.error('Erro ao carregar cursos:', error);
                    loadFromLocalStorage();
                });

                db.collection('instrutores').onSnapshot(snapshot => {
                    instrutores = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderInstructors();
                    updateInstructorSelect();
                }, error => {
                    console.error('Erro ao carregar instrutores:', error);
                    loadFromLocalStorage();
                });

                db.collection('usuarios').onSnapshot(snapshot => {
                    usuarios = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderUsers();
                    // Update current user name if it changed
                    if (currentUser && currentUser.id) {
                        const updatedUser = usuarios.find(u => u.id === currentUser.id);
                        if (updatedUser && updatedUser.name !== currentUser.name) {
                            currentUser = { ...currentUser, name: updatedUser.name };
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                            document.getElementById('userName').textContent = currentUser.name;
                            document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
                        }
                        if (updatedUser && updatedUser.role !== currentUser.role) {
                             currentUser = { ...currentUser, role: updatedUser.role };
                             localStorage.setItem('currentUser', JSON.stringify(currentUser));
                             const roleLabels = { admin: 'Administrador', editor: 'Editor', viewer: 'Visualizador' };
                             document.getElementById('userRole').textContent = roleLabels[currentUser.role];
                            if (currentUser.role === 'admin') {
                                document.getElementById('usersNavItem').style.display = 'flex';
                                // Mostrar funções administrativas
                                if (document.getElementById('importDataCard')) document.getElementById('importDataCard').style.display = 'block';
                                if (document.getElementById('exportDataCard')) document.getElementById('exportDataCard').style.display = 'block';
                                if (document.getElementById('dangerZoneCard')) document.getElementById('dangerZoneCard').style.display = 'block';
                                if (document.getElementById('importInstructorsBtn')) document.getElementById('importInstructorsBtn').style.display = 'flex';
                            } else {
                                document.getElementById('usersNavItem').style.display = 'none';
                                // Esconder funções administrativas para não-admins
                                if (document.getElementById('importDataCard')) document.getElementById('importDataCard').style.display = 'none';
                                if (document.getElementById('exportDataCard')) document.getElementById('exportDataCard').style.display = 'none';
                                if (document.getElementById('dangerZoneCard')) document.getElementById('dangerZoneCard').style.display = 'none';
                                if (document.getElementById('importInstructorsBtn')) document.getElementById('importInstructorsBtn').style.display = 'none';
                            }
                             if (currentUser.role === 'viewer') {
                                document.getElementById('newCourseBtn').style.display = 'none';
                                document.getElementById('newInstructorBtn').style.display = 'none';
                                const tasksNavItem = document.querySelector('.nav-item[data-page="tasks"]');
                                if (tasksNavItem) tasksNavItem.style.display = 'none';
                            } else {
                                document.getElementById('newCourseBtn').style.display = 'flex';
                                document.getElementById('newInstructorBtn').style.display = 'flex';
                                const tasksNavItem = document.querySelector('.nav-item[data-page="tasks"]');
                                if (tasksNavItem) tasksNavItem.style.display = 'flex';
                            }
                            // Recarregar tarefas do usuário ao mudar role
                            setupTasksListener();
                        }
                    }
                }, error => {
                    console.error('Erro ao carregar usuários:', error);
                    loadFromLocalStorage();
                });

                db.collection('activities').orderBy('timestamp', 'desc').limit(100).onSnapshot(snapshot => {
                    activityLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderActivityLogs();
                }, error => {
                    console.error('Erro ao carregar logs:', error);
                    loadFromLocalStorage();
                });
                
                // Carregar eventos do calendário em tempo real
                setupCalendarEventsListener();
                
                // Carregar tarefas do usuário em tempo real
                setupTasksListener();
            } else {
                loadFromLocalStorage();
            }
        }

        function loadFromLocalStorage() {
            cursos = JSON.parse(localStorage.getItem('cursos') || '[]');
            // Normalizar status de todos os cursos ao carregar
            cursos = cursos.map(course => {
                if (course.status) {
                    course.status = normalizeStatus(course.status);
                }
                return course;
            });
            instrutores = JSON.parse(localStorage.getItem('instrutores') || '[]');
            usuarios = JSON.parse(localStorage.getItem('usuarios') || '[]');
            activityLogs = JSON.parse(localStorage.getItem('activityLogs') || '[]');
            loteNames = JSON.parse(localStorage.getItem('loteNames') || '{}');
            
            // Carregar eventos do calendário
            calendarEvents = JSON.parse(localStorage.getItem('calendarEvents') || '[]');
            
            // Carregar tarefas do usuário
            if (currentUser?.id) {
                tasks = JSON.parse(localStorage.getItem(`tasks_${currentUser.id}`) || '[]');
            }
            
            // Salvar cursos normalizados de volta
            localStorage.setItem('cursos', JSON.stringify(cursos));
            
            // Usar requestAnimationFrame para otimizar renderizações
            requestAnimationFrame(() => {
            updateKPIs();
            renderCalendar();
            renderInstructors();
            updateInstructorSelect();
            renderUsers();
            renderActivityLogs();
            renderDashboardReport();
            renderTasks();
            updateTaskBadge();
            updateTaskStats();
            // Atualizar filtros com os dados carregados
            updateLoteFilter();
            updateCursoFilter();
            if (document.getElementById('coursesPage')?.classList.contains('active')) {
                renderCoursesByLote();
            }
            // Verificar alertas após carregar dados
            if (typeof checkAutomaticAlerts === 'function') {
                setTimeout(checkAutomaticAlerts, 500);
            }
            });
        }

        // Navigation
        function navigateTo(page) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.page === page);
            });

            // Sync mobile bottom nav
            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.page === page);
            });

            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
            });

            document.getElementById(`${page}Page`).classList.add('active');
            document.getElementById('sidebar').classList.remove('active');
            
            // Close sidebar overlay on mobile
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            if (sidebarOverlay) sidebarOverlay.classList.remove('active');
            
            // Atualizar breadcrumbs
            if (typeof updateBreadcrumbs === 'function') {
                updateBreadcrumbs(page);
            }
            
            // Renderizar conteúdo específico da página
            if (page === 'settings') {
                renderChangeHistory();
                // Atualizar tema ativo na interface
                const savedColorTheme = localStorage.getItem('colorTheme') || 'default';
                document.querySelectorAll('.theme-option').forEach(option => {
                    option.classList.toggle('active', option.dataset.theme === savedColorTheme);
                });
                // Inicializar personalizador de cards
                initializeCardFieldsCustomizer();
                // Reinicializar customização de tema quando entrar na página
                setTimeout(() => initializeCustomTheme(), 100);
            }
            
            if (page === 'courses') {
                renderCoursesByLote();
            } else if (page === 'dashboard') {
                renderDashboardReport();
            } else if (page === 'calendar') {
                renderCalendar();
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('active');
            if (overlay) {
                overlay.classList.toggle('active');
            }
        }

        // Render Functions
        function renderCourses(searchTerm = '') {
            const grid = document.getElementById('coursesGrid');
            if (!grid) return;
            
            let filtered = cursos;

            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filtered = cursos.filter(c => 
                    c.curso?.toLowerCase().includes(term) ||
                    c.cidade?.toLowerCase().includes(term) ||
                    c.instrutor?.toLowerCase().includes(term) ||
                    c.loteResponsavel?.toLowerCase().includes(term)
                );
            }
            
            // Aplicar ordenação (prioriza cursos com alertas)
            filtered = sortCourses(filtered);

            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <span class="material-icons">school</span>
                        <h3>Nenhum curso encontrado</h3>
                        <p>${searchTerm ? 'Tente uma busca diferente' : 'Adicione seu primeiro curso'}</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filtered.map(course => {
                const statusClass = getStatusClass(course.status);
                const canEdit = currentUser?.role !== 'viewer';
                const alerts = getCourseAlerts(course);
                const hasAlert = alerts.length > 0;
                const alertClass = hasAlert ? (alerts[0].severity === 'warning' ? 'warning-alert' : '') : '';
                
                return `
                    <div class="course-card ${hasAlert ? 'has-alert ' + alertClass : ''}" data-id="${course.id}" onclick="openViewCourseModal('${course.id}')">
                        <div class="course-header">
                            <div>
                                <div class="course-title">${course.curso || 'Sem nome'}</div>
                                <div class="course-id">ID da Turma: ${course.idLote || 'N/A'}${course.loteResponsavel ? ' | ' + course.loteResponsavel : ''}</div>
                            </div>
                            ${canEdit ? `
                                <div class="course-actions" onclick="event.stopPropagation()">
                                    ${course.driveLink ? `
                                        <button class="drive" onclick="openDriveLink('${course.driveLink}')" title="Abrir Google Drive">
                                            <span class="material-icons">folder</span>
                                        </button>
                                    ` : ''}
                                    <button onclick="openCourseModal('${course.id}')" title="Editar">
                                        <span class="material-icons">edit</span>
                                    </button>
                                    <button class="delete" onclick="deleteCourse('${course.id}')" title="Excluir">
                                        <span class="material-icons">delete</span>
                                    </button>
                                </div>
                            ` : `
                                <div class="course-actions" onclick="event.stopPropagation()">
                                    ${course.driveLink ? `
                                        <button class="drive" onclick="openDriveLink('${course.driveLink}')" title="Abrir Google Drive">
                                            <span class="material-icons">folder</span>
                                        </button>
                                    ` : ''}
                                </div>
                            `}
                        </div>
                        <div class="course-info">
                            <div class="course-info-item">
                                <span class="material-icons">location_on</span>
                                ${course.cidade || 'Local não definido'}${course.local ? ' - ' + course.local : ''}
                            </div>
                            <div class="course-info-item">
                                <span class="material-icons">event</span>
                                <span>Período: ${course.inicio && course.fim ? formatDate(course.inicio) + ' - ' + formatDate(course.fim) : course.inicio ? formatDate(course.inicio) : course.fim ? formatDate(course.fim) : 'Não informado'}</span>
                            </div>
                            <div class="course-info-item">
                                <span class="material-icons">person</span>
                                ${course.instrutor || 'Instrutor não definido'}
                                ${(() => {
                                    const inst = instrutores.find(i => i.nome === course.instrutor);
                                    if (inst && inst.telefone) {
                                        const phone = inst.telefone.replace(/\D/g, '');
                                        return `<button class="btn-whatsapp-mini" onclick="event.stopPropagation(); openWhatsApp('${phone}')" title="WhatsApp"><span class="material-icons">chat</span></button>`;
                                    }
                                    return '';
                                })()}
                            </div>
                            <div class="course-info-item">
                                <span class="material-icons">groups</span>
                                ${course.alunos || 0} concludentes
                            </div>
                            ${course.telefone ? `
                            <div class="course-info-item">
                                <span class="material-icons">phone</span>
                                ${course.telefone}
                                <button class="btn-whatsapp-mini" onclick="event.stopPropagation(); openWhatsApp('${course.telefone.replace(/\D/g, '')}')" title="WhatsApp"><span class="material-icons">chat</span></button>
                            </div>
                            ` : ''}
                            <div>
                                <span class="status-badge ${statusClass}">${normalizeStatus(course.status)}</span>
                            </div>
                        </div>
                        <!-- Exibição da anotação no card -->
                        ${course.nota ? `
                            <div class="course-note">
                                <span class="material-icons">sticky_note_2</span>
                                <span class="course-note-text">${course.nota}</span>
                            </div>
                        ` : ''}
                        ${renderCourseAlerts(alerts, course.id)}
                    </div>
                `;
            }).join('');
        }

        function openDriveLink(link) {
            if (link) {
                window.open(link, '_blank');
            }
        }

        function openViewCourseModal(courseId) {
            viewingCourseId = courseId;
            const course = cursos.find(c => c.id === courseId);
            if (!course) return;

            document.getElementById('viewCourseTitle').textContent = course.curso || 'Detalhes do Curso';
            
            const statusClass = getStatusClass(course.status);
            const body = document.getElementById('viewCourseBody');
            
            // Obter campos do formulário ordenados
            const fields = (typeof formFields !== 'undefined' ? formFields : [])
                .filter(f => f.enabled)
                .sort((a, b) => a.order - b.order);
            
            let html = '';
            
            fields.forEach(field => {
                let value = course[field.key];
                let displayValue = '';
                let extraContent = '';
                
                // Tratamento especial por tipo/key
                if (field.key === 'inicio' || field.key === 'fim') {
                    return; // Tratados juntos como período
                }
                
                if (field.key === 'status') {
                    displayValue = `<span class="status-badge ${statusClass}">${value || 'Pendente'}</span>`;
                } else if (field.key === 'instrutor') {
                    displayValue = value || 'Não definido';
                    const inst = instrutores.find(i => i.nome === value);
                    if (inst && inst.telefone) {
                        const phone = inst.telefone.replace(/\D/g, '');
                        extraContent = '<button class="btn-whatsapp-mini" onclick="openWhatsApp(\'' + phone + '\')" title="WhatsApp do Instrutor"><span class="material-icons">chat</span></button>';
                    }
                } else if (field.key === 'driveLink') {
                    if (value) {
                        displayValue = '<a href="' + value + '" target="_blank"><span class="material-icons" style="font-size: 18px;">open_in_new</span> Abrir pasta</a>';
                    } else {
                        return;
                    }
                } else if (field.type === 'tel' || field.key === 'telefone' || field.name.toLowerCase().includes('telefone') || field.name.toLowerCase().includes('whatsapp')) {
                    if (value) {
                        const phone = value.replace(/\D/g, '');
                        displayValue = value;
                        extraContent = '<button class="btn-whatsapp-mini" onclick="openWhatsApp(\'' + phone + '\')" title="WhatsApp"><span class="material-icons">chat</span></button>';
                    } else {
                        return;
                    }
                } else if (field.type === 'url' && value) {
                    displayValue = '<a href="' + value + '" target="_blank"><span class="material-icons" style="font-size: 18px;">open_in_new</span> Abrir link</a>';
                } else if (field.key === 'alunos') {
                    displayValue = (value || 0) + ' concludentes';
                } else {
                    displayValue = value || 'Não informado';
                }
                
                html += `
                    <div class="course-detail-item">
                        <span class="material-icons">${field.icon || 'info'}</span>
                        <div>
                            <div class="course-detail-label">${field.name}</div>
                            <div class="course-detail-value">${displayValue} ${extraContent}</div>
                        </div>
                    </div>
                `;
            });
            
            // Adicionar período (início e fim juntos)
            const periodoValue = course.inicio && course.fim 
                ? formatDate(course.inicio) + ' - ' + formatDate(course.fim) 
                : course.inicio ? formatDate(course.inicio) 
                : course.fim ? formatDate(course.fim) 
                : 'Não informado';
            
            html += `
                <div class="course-detail-item">
                    <span class="material-icons">event</span>
                    <div>
                        <div class="course-detail-label">Período</div>
                        <div class="course-detail-value">${periodoValue}</div>
                    </div>
                </div>
            `;
            
            // Adicionar campos extras que não estão no formFields mas existem no curso
            const knownKeys = fields.map(f => f.key).concat(['inicio', 'fim', 'id', 'loteResponsavel']);
            Object.keys(course).forEach(key => {
                if (!knownKeys.includes(key) && course[key] && course[key] !== '' && key !== 'id') {
                    let displayValue = course[key];
                    let extraContent = '';
                    
                    // Detectar se é telefone pelo nome da chave
                    if (key.toLowerCase().includes('telefone') || key.toLowerCase().includes('phone') || key.toLowerCase().includes('whatsapp')) {
                        const phone = String(course[key]).replace(/\D/g, '');
                        if (phone.length >= 10) {
                            extraContent = '<button class="btn-whatsapp-mini" onclick="openWhatsApp(\'' + phone + '\')" title="WhatsApp"><span class="material-icons">chat</span></button>';
                        }
                    }
                    
                    html += `
                        <div class="course-detail-item">
                            <span class="material-icons">info</span>
                            <div>
                                <div class="course-detail-label">${key.charAt(0).toUpperCase() + key.slice(1)}</div>
                                <div class="course-detail-value">${displayValue} ${extraContent}</div>
                            </div>
                        </div>
                    `;
                }
            });
            
            // Nota/Observação (se não foi exibido nos campos)
            if (course.nota && !fields.find(f => f.key === 'nota')) {
                html += `
                    <div class="course-detail-item">
                        <span class="material-icons">chat_bubble_outline</span>
                        <div>
                            <div class="course-detail-label">Observação</div>
                            <div class="course-detail-value">${course.nota}</div>
                        </div>
                    </div>
                `;
            }
            
            // Histórico de Alterações
            html += `
                <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid var(--border);">
                    <h4 style="margin: 0 0 1rem 0; font-size: 0.95rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                        <span class="material-icons" style="font-size: 20px;">history</span>
                        Histórico de Alterações
                    </h4>
                    ${renderCourseHistory(courseId)}
                </div>
            `;
            
            body.innerHTML = html;

            const editBtn = document.getElementById('editCourseFromViewBtn');
            if (currentUser?.role !== 'viewer') {
                editBtn.style.display = 'flex';
                editBtn.onclick = () => {
                    closeModal('viewCourseModal');
                    openCourseModal(courseId);
                };
            } else {
                editBtn.style.display = 'none';
            }

            document.getElementById('viewCourseModal').classList.add('active');
        }
        
        // Funções auxiliares

        function renderInstructors() {
            const grid = document.getElementById('instructorGrid');

            if (instrutores.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <span class="material-icons">people</span>
                        <h3>Nenhum instrutor cadastrado</h3>
                        <p>Adicione seu primeiro instrutor</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = instrutores.map(instructor => {
                const coursesCount = cursos.filter(c => c.instrutor === instructor.nome).length;
                const canEdit = currentUser?.role !== 'viewer';
                const phone = instructor.telefone ? instructor.telefone.replace(/\D/g, '') : '';

                return `
                    <div class="instructor-card">
                        <div class="instructor-avatar">${instructor.nome?.charAt(0) || '?'}</div>
                        <div class="instructor-name">${instructor.nome || 'Sem nome'}</div>
                        <div class="instructor-specialty">${instructor.especialidade || 'Sem especialidade'}</div>
                        <div class="instructor-stats">
                            <div class="instructor-stat">
                                <div class="instructor-stat-value">${coursesCount}</div>
                                <div class="instructor-stat-label">Cursos</div>
                            </div>
                        </div>
                        <div class="instructor-actions">
                            ${phone ? `
                                <button class="btn btn-whatsapp btn-icon" onclick="openWhatsApp('${phone}')" title="Enviar mensagem no WhatsApp">
                                    <span class="material-icons">chat</span>
                                </button>
                            ` : ''}
                            ${canEdit ? `
                                <button class="btn btn-secondary btn-icon" onclick="openInstructorModal('${instructor.id}')" title="Editar">
                                    <span class="material-icons">edit</span>
                                </button>
                                <button class="btn btn-danger btn-icon" onclick="deleteInstructor('${instructor.id}')" title="Excluir">
                                    <span class="material-icons">delete</span>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openWhatsApp(phone) {
            const formattedPhone = phone.startsWith('55') ? phone : '55' + phone;
            window.open(`https://wa.me/${formattedPhone}`, '_blank');
        }

        function renderUsers() {
            const tbody = document.getElementById('usersTableBody');
            
            tbody.innerHTML = usuarios.map(user => {
                const roleClass = user.role;
                const roleLabel = { admin: 'Admin', editor: 'Editor', viewer: 'Viewer' }[user.role];
                const isCurrentUser = user.id === currentUser?.id;

                return `
                    <tr>
                        <td>${user.name}</td>
                        <td>${user.email || user.username || '-'}</td>
                        <td><span class="role-badge ${roleClass}">${roleLabel}</span></td>
                        <td>
                            ${!isCurrentUser ? `
                                <button class="btn btn-secondary btn-icon" onclick="openUserModal('${user.id}')" title="Editar">
                                    <span class="material-icons">edit</span>
                                </button>
                                <button class="btn btn-danger btn-icon" onclick="deleteUser('${user.id}')" title="Excluir">
                                    <span class="material-icons">delete</span>
                                </button>
                            ` : '<span style="color: var(--text-muted)">Usuário atual</span>'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderActivityLogs() {
            const container = document.getElementById('activityLog');
            
            if (activityLogs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <span class="material-icons">history</span>
                        <h3>Nenhuma atividade registrada</h3>
                        <p>As atividades aparecerão aqui</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="activity-log-grid">
                    ${activityLogs.map(log => {
                        const iconClass = log.type || 'add';
                        const iconName = iconClass === 'add' ? 'add' : iconClass === 'edit' ? 'edit' : 'delete';
                        return `
                            <div class="activity-item">
                                <div class="activity-icon ${iconClass}">
                                    <span class="material-icons">${iconName}</span>
                                </div>
                                <div class="activity-content">
                                    <div class="activity-header">
                                        <div class="activity-title">${log.action}</div>
                                        <div class="activity-time">${formatTimestamp(log.timestamp)}</div>
                                    </div>
                                    <div class="activity-description">${log.description}</div>
                                    <div class="activity-user">
                                        <span class="material-icons">person</span>
                                        ${log.user || 'Sistema'}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function updateKPIs() {
            document.getElementById('totalCourses').textContent = cursos.length;
            document.getElementById('completedCourses').textContent = cursos.filter(c => normalizeStatus(c.status) === 'Concluído').length;
            document.getElementById('ongoingCourses').textContent = cursos.filter(c => normalizeStatus(c.status) === 'Em Andamento').length;
            document.getElementById('totalStudents').textContent = cursos.reduce((sum, c) => sum + (parseInt(c.alunos) || 0), 0);
            
            // Atualizar gráficos do dashboard
            renderDashboardCharts();
        }

        function updateInstructorSelect() {
            const select = document.getElementById('courseInstructor');
            if (!select) return;
            
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">Selecione um instrutor</option>' +
                instrutores.map(i => `<option value="${i.nome}">${i.nome}</option>`).join('');
            
            select.value = currentValue;
        }

        // Calendar Functions
        
        // Feriados brasileiros (fixos e móveis calculados)
        function getHolidays(year) {
            const holidays = {
                // Feriados fixos
                [`${year}-01-01`]: 'Ano Novo',
                [`${year}-04-21`]: 'Tiradentes',
                [`${year}-05-01`]: 'Dia do Trabalho',
                [`${year}-09-07`]: 'Independência',
                [`${year}-10-12`]: 'N. Sra. Aparecida',
                [`${year}-11-02`]: 'Finados',
                [`${year}-11-15`]: 'Proclamação da República',
                [`${year}-12-25`]: 'Natal'
            };
            
            // Calcular Páscoa (algoritmo de Meeus/Jones/Butcher)
            const a = year % 19;
            const b = Math.floor(year / 100);
            const c = year % 100;
            const d = Math.floor(b / 4);
            const e = b % 4;
            const f = Math.floor((b + 8) / 25);
            const g = Math.floor((b - f + 1) / 3);
            const h = (19 * a + b - d - g + 15) % 30;
            const i = Math.floor(c / 4);
            const k = c % 4;
            const l = (32 + 2 * e + 2 * i - h - k) % 7;
            const m = Math.floor((a + 11 * h + 22 * l) / 451);
            const month = Math.floor((h + l - 7 * m + 114) / 31);
            const day = ((h + l - 7 * m + 114) % 31) + 1;
            
            const easter = new Date(year, month - 1, day);
            
            // Feriados móveis baseados na Páscoa
            const carnival = new Date(easter);
            carnival.setDate(easter.getDate() - 47);
            holidays[carnival.toISOString().split('T')[0]] = 'Carnaval';
            
            const carnival2 = new Date(easter);
            carnival2.setDate(easter.getDate() - 46);
            holidays[carnival2.toISOString().split('T')[0]] = 'Carnaval';
            
            const goodFriday = new Date(easter);
            goodFriday.setDate(easter.getDate() - 2);
            holidays[goodFriday.toISOString().split('T')[0]] = 'Sexta-feira Santa';
            
            holidays[easter.toISOString().split('T')[0]] = 'Páscoa';
            
            const corpusChristi = new Date(easter);
            corpusChristi.setDate(easter.getDate() + 60);
            holidays[corpusChristi.toISOString().split('T')[0]] = 'Corpus Christi';
            
            return holidays;
        }
        
        // Eventos personalizados do calendário
        let calendarEvents = [];
        let calendarEventsListener = null;
        
        // Tarefas do usuário
        let tasks = [];
        let tasksListener = null;
        
        // Listener para eventos do calendário
        function setupCalendarEventsListener() {
            if (calendarEventsListener) {
                calendarEventsListener(); // Cancelar listener anterior
            }
            
            if (!firebaseAvailable) {
                calendarEvents = JSON.parse(localStorage.getItem('calendarEvents') || '[]');
                renderCalendar();
                return;
            }
            
            calendarEventsListener = db.collection('calendarEvents').onSnapshot(snapshot => {
                calendarEvents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log('📅 Eventos do calendário atualizados:', calendarEvents.length);
                renderCalendar();
            }, error => {
                console.error('Erro ao carregar eventos do calendário:', error);
                calendarEvents = JSON.parse(localStorage.getItem('calendarEvents') || '[]');
                renderCalendar();
            });
        }
        
        // Listener para tarefas do usuário
        function setupTasksListener() {
            if (tasksListener) {
                tasksListener(); // Cancelar listener anterior
            }
            
            const userId = currentUser?.id;
            if (!userId) {
                // Silencioso - é esperado antes do login
                return;
            }
            
            if (!firebaseAvailable) {
                tasks = JSON.parse(localStorage.getItem(`tasks_${userId}`) || '[]');
                renderTasks();
                updateTaskBadge();
                updateTaskStats();
                return;
            }
            
            console.log('🔄 Configurando listener de tarefas para usuário:', userId);
            tasksListener = db.collection('tasks').where('userId', '==', userId).onSnapshot(snapshot => {
                tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log('✅ Tarefas atualizadas:', tasks.length);
                renderTasks();
                updateTaskBadge();
                updateTaskStats();
            }, error => {
                console.error('Erro ao carregar tarefas:', error);
                tasks = JSON.parse(localStorage.getItem(`tasks_${userId}`) || '[]');
                renderTasks();
                updateTaskBadge();
                updateTaskStats();
            });
        }
        
        function saveCalendarEvents() {
            localStorage.setItem('calendarEvents', JSON.stringify(calendarEvents));
        }
        
        function addCalendarEvent(date, title, description = '', color = '#6366f1', time = '', category = 'geral') {
            const event = {
                id: 'evt-' + Date.now(),
                date,
                time,
                title,
                description,
                color,
                category,
                createdAt: new Date().toISOString(),
                createdBy: currentUser?.id || 'anonymous',
                createdByName: currentUser?.name || 'Anônimo'
            };
            
            if (firebaseAvailable) {
                db.collection('calendarEvents').doc(event.id).set(event)
                    .then(() => saveCalendarEvents())
                    .catch(error => {
                        console.error('Erro ao salvar evento:', error);
                        calendarEvents.push(event);
                        saveCalendarEvents();
                        renderCalendar();
                    });
            } else {
                calendarEvents.push(event);
                saveCalendarEvents();
                renderCalendar();
            }
            return event;
        }
        
        function updateCalendarEvent(eventId, updates) {
            const event = calendarEvents.find(e => e.id === eventId);
            if (!event) return;
            
            // Verificar se é o dono
            if (event.createdBy !== currentUser?.id) {
                showToast('Você não tem permissão para editar este evento', 'error');
                return;
            }
            
            const updatedEvent = { ...event, ...updates, updatedAt: new Date().toISOString() };
            
            if (firebaseAvailable) {
                db.collection('calendarEvents').doc(eventId).set(updatedEvent)
                    .then(() => {
                        const index = calendarEvents.findIndex(e => e.id === eventId);
                        if (index !== -1) calendarEvents[index] = updatedEvent;
                        saveCalendarEvents();
                        renderCalendar();
                        console.log('Evento atualizado com sucesso');
                    })
                    .catch(error => {
                        console.error('Erro ao atualizar evento:', error);
                        showToast('Erro ao atualizar evento', 'error');
                    });
            } else {
                const index = calendarEvents.findIndex(e => e.id === eventId);
                if (index !== -1) calendarEvents[index] = updatedEvent;
                saveCalendarEvents();
                renderCalendar();
            }
        }
        
        function deleteCalendarEvent(eventId) {
            if (firebaseAvailable) {
                db.collection('calendarEvents').doc(eventId).delete()
                    .then(() => {
                        calendarEvents = calendarEvents.filter(e => e.id !== eventId);
                        saveCalendarEvents();
                    })
                    .catch(error => {
                        console.error('Erro ao excluir evento:', error);
                        calendarEvents = calendarEvents.filter(e => e.id !== eventId);
                        saveCalendarEvents();
                        renderCalendar();
                    });
            } else {
                calendarEvents = calendarEvents.filter(e => e.id !== eventId);
                saveCalendarEvents();
                renderCalendar();
            }
        }
        
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            if (!grid) return;
            
            // Renderizar baseado na visualização atual
            if (currentCalendarView === 'week') {
                renderWeekView();
                return;
            } else if (currentCalendarView === 'day') {
                renderDayView();
                return;
            }
            
            // Visualização mensal (padrão)
            grid.className = 'calendar-grid';
            
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            const holidays = getHolidays(year);

            const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
                           'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const calendarTitle = document.getElementById('calendarTitle');
            if (calendarTitle) {
                calendarTitle.textContent = `${months[month]} ${year}`;
            }

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDay = firstDay.getDay();
            const daysInMonth = lastDay.getDate();

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Estatísticas do mês
            let coursesInMonth = 0;
            let coursesStarting = 0;
            let coursesEnding = 0;

            // Cabeçalhos apenas de segunda a sexta
            let html = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex']
                .map(day => `<div class="calendar-day-header">${day}</div>`)
                .join('');

            const prevMonth = new Date(year, month, 0);
            const prevMonthDays = prevMonth.getDate();
            let daysFromPrevMonth = 0;
            
            if (startDay === 0) {
                daysFromPrevMonth = 5;
            } else if (startDay === 6) {
                daysFromPrevMonth = 1;
            } else if (startDay > 1) {
                daysFromPrevMonth = startDay - 1;
            }

            for (let i = daysFromPrevMonth - 1; i >= 0; i--) {
                const day = prevMonthDays - i;
                html += `<div class="calendar-day other-month"><div class="calendar-date">${day}</div></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dayOfWeek = date.getDay();
                
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    continue;
                }

                const isToday = date.getTime() === today.getTime();
                const dateStr = date.toISOString().split('T')[0];
                
                // Verificar feriado
                const holiday = holidays[dateStr];
                const isHoliday = !!holiday;

                // Cursos do dia - apenas início e fim (não mostrar em andamento)
                const events = cursos.filter(c => {
                    if (!c.inicio && !c.fim) return false;
                    return c.inicio === dateStr || c.fim === dateStr;
                });
                
                // Eventos personalizados do dia
                const customEvents = calendarEvents.filter(e => e.date === dateStr);
                
                // Contagem para estatísticas
                events.forEach(c => {
                    if (c.inicio === dateStr) {
                        coursesStarting++;
                        coursesInMonth++;
                    }
                    if (c.fim === dateStr) coursesEnding++;
                });

                // HTML dos eventos de curso com preview
                let eventsHtml = events.slice(0, 3).map(c => {
                    const statusClass = 'status-' + getStatusClass(c.status);
                    const isStart = c.inicio === dateStr;
                    const isEnd = c.fim === dateStr;
                    const eventClass = isStart ? 'start' : 'end';
                    const label = isStart ? '▶ Início' : '■ Fim';
                    return `<div class="calendar-event ${eventClass} ${statusClass}" 
                                data-course-id="${c.id}"
                                onmouseenter="showCoursePreview(event, '${c.id}')"
                                onmouseleave="hideCoursePreview()"
                                onclick="openCourseModal('${c.id}')"
                                title="${label}: ${c.curso}">
                                <span class="event-label">${label}</span> ${c.curso || c.lote}
                            </div>`;
                }).join('');
                
                // Eventos personalizados - ordenar por horário
                const sortedCustomEvents = [...customEvents].sort((a, b) => (a.time || '').localeCompare(b.time || ''));
                eventsHtml += sortedCustomEvents.slice(0, 1).map(e => {
                    const isOwner = currentUser?.id === e.createdBy;
                    const ownerLabel = isOwner ? '' : ` • ${e.createdByName || 'Anônimo'}`;
                    const timeLabel = e.time ? `${e.time} - ` : '';
                    return `<div class="calendar-event custom-event" style="background: ${e.color};" 
                                onclick="showEventDetails('${e.id}')"
                                title="${timeLabel}${e.title}${ownerLabel}">${e.time ? e.time + ' ' : ''}${e.title}</div>`;
                }).join('');

                const totalEvents = events.length + customEvents.length;
                if (totalEvents > 3) {
                    eventsHtml += `<div class="calendar-event more-events">+${totalEvents - 3} mais</div>`;
                }
                
                // Indicador de quantidade
                const countBadge = totalEvents > 0 ? `<div class="day-course-count">${totalEvents}</div>` : '';
                
                // Nome do feriado
                const holidayHtml = isHoliday ? `<div class="holiday-name" title="${holiday}">${holiday}</div>` : '';

                html += `
                    <div class="calendar-day${isToday ? ' today' : ''}${isHoliday ? ' holiday' : ''}" 
                         data-date="${dateStr}"
                         ondblclick="openAddEventModal('${dateStr}')">
                        <div class="calendar-date">${day}</div>
                        ${holidayHtml}
                        ${countBadge}
                        ${eventsHtml}
                        <button class="add-event-btn" onclick="openAddEventModal('${dateStr}')" title="Adicionar evento">
                            <span class="material-icons">add</span>
                        </button>
                    </div>
                `;
            }

            const lastDayOfMonth = new Date(year, month, daysInMonth);
            const lastDayOfWeek = lastDayOfMonth.getDay();
            
            let daysFromNextMonth = 0;
            if (lastDayOfWeek === 0 || lastDayOfWeek === 6) {
                daysFromNextMonth = 0;
            } else if (lastDayOfWeek < 5) {
                daysFromNextMonth = 5 - lastDayOfWeek;
            }

            for (let i = 1; i <= daysFromNextMonth; i++) {
                html += `<div class="calendar-day other-month"><div class="calendar-date">${i}</div></div>`;
            }

            grid.innerHTML = html;
            
            // Atualizar estatísticas
            const totalCoursesEl = document.getElementById('totalCoursesMonth');
            const startingEl = document.getElementById('coursesStartingMonth');
            const endingEl = document.getElementById('coursesEndingMonth');
            
            if (totalCoursesEl) totalCoursesEl.textContent = coursesInMonth;
            if (startingEl) startingEl.textContent = coursesStarting;
            if (endingEl) endingEl.textContent = coursesEnding;
        }
        
        // Preview do curso ao passar o mouse
        function showCoursePreview(event, courseId) {
            const course = cursos.find(c => c.id === courseId);
            if (!course) return;
            
            const tooltip = document.getElementById('coursePreviewTooltip');
            if (!tooltip) return;
            
            const statusClass = getStatusClass(course.status);
            
            tooltip.querySelector('.preview-status').className = 'preview-status ' + statusClass;
            tooltip.querySelector('.preview-title').textContent = course.curso || course.lote || 'Sem nome';
            tooltip.querySelector('.preview-instructor').textContent = course.instrutor || 'Não definido';
            tooltip.querySelector('.preview-location').textContent = course.local || course.cidade || 'Não definido';
            tooltip.querySelector('.preview-dates').textContent = `${formatDateBR(course.inicio)} - ${formatDateBR(course.fim)}`;
            tooltip.querySelector('.preview-students').textContent = `${course.alunos || 0} alunos`;
            
            // Posicionar tooltip
            const rect = event.target.getBoundingClientRect();
            tooltip.style.left = rect.right + 10 + 'px';
            tooltip.style.top = rect.top + 'px';
            tooltip.style.display = 'block';
            
            // Ajustar se sair da tela
            const tooltipRect = tooltip.getBoundingClientRect();
            if (tooltipRect.right > window.innerWidth) {
                tooltip.style.left = rect.left - tooltipRect.width - 10 + 'px';
            }
            if (tooltipRect.bottom > window.innerHeight) {
                tooltip.style.top = window.innerHeight - tooltipRect.height - 10 + 'px';
            }
        }
        
        function hideCoursePreview() {
            const tooltip = document.getElementById('coursePreviewTooltip');
            if (tooltip) tooltip.style.display = 'none';
        }
        
        function formatDateBR(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('pt-BR');
        }
        
        // Modal para adicionar evento
        function openAddEventModal(dateStr) {
            const modal = document.getElementById('addEventModal');
            if (!modal) {
                createAddEventModal();
            }
            
            // Resetar formulário para novo evento
            document.getElementById('eventModalTitle').textContent = 'Adicionar Evento';
            document.getElementById('editingEventId').value = '';
            document.getElementById('eventDate').value = dateStr;
            document.getElementById('eventTime').value = '';
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventDescription').value = '';
            document.getElementById('eventColor').value = '#6366f1';
            document.getElementById('eventCategory').value = 'geral';
            document.getElementById('eventSubmitBtn').innerHTML = '<span class="material-icons">add</span> Adicionar';
            
            document.getElementById('addEventModal').classList.add('active');
        }
        
        function createAddEventModal() {
            const modalHtml = `
                <div class="modal-overlay" id="addEventModal">
                    <div class="modal" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3 id="eventModalTitle">Adicionar Evento</h3>
                            <button class="modal-close" onclick="closeModal('addEventModal')">
                                <span class="material-icons">close</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="addEventForm" onsubmit="handleAddEvent(event)">
                                <input type="hidden" id="editingEventId" value="">
                                
                                <div class="form-group">
                                    <label class="form-label">Título do Evento *</label>
                                    <input type="text" id="eventTitle" class="form-input" required placeholder="Ex: Reunião, Prazo, Lembrete...">
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Data *</label>
                                        <input type="date" id="eventDate" class="form-input" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Horário</label>
                                        <input type="time" id="eventTime" class="form-input">
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Categoria</label>
                                        <select id="eventCategory" class="form-select">
                                            <option value="geral">📌 Geral</option>
                                            <option value="reuniao">👥 Reunião</option>
                                            <option value="prazo">⏰ Prazo</option>
                                            <option value="lembrete">🔔 Lembrete</option>
                                            <option value="feriado">🎉 Feriado/Folga</option>
                                            <option value="importante">⚠️ Importante</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Cor</label>
                                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                                            <input type="color" id="eventColor" value="#6366f1" style="width: 40px; height: 36px; border: none; cursor: pointer; border-radius: 6px;">
                                            <button type="button" class="color-preset" style="background: #6366f1;" onclick="document.getElementById('eventColor').value='#6366f1'"></button>
                                            <button type="button" class="color-preset" style="background: #22c55e;" onclick="document.getElementById('eventColor').value='#22c55e'"></button>
                                            <button type="button" class="color-preset" style="background: #f59e0b;" onclick="document.getElementById('eventColor').value='#f59e0b'"></button>
                                            <button type="button" class="color-preset" style="background: #ef4444;" onclick="document.getElementById('eventColor').value='#ef4444'"></button>
                                            <button type="button" class="color-preset" style="background: #8b5cf6;" onclick="document.getElementById('eventColor').value='#8b5cf6'"></button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Descrição</label>
                                    <textarea id="eventDescription" class="form-input" rows="2" placeholder="Detalhes do evento..."></textarea>
                                </div>
                                
                                <div class="form-actions">
                                    <button type="button" class="btn btn-secondary" onclick="closeModal('addEventModal')">Cancelar</button>
                                    <button type="submit" class="btn btn-primary" id="eventSubmitBtn">
                                        <span class="material-icons">add</span>
                                        Adicionar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        function handleAddEvent(e) {
            e.preventDefault();
            const editingId = document.getElementById('editingEventId').value;
            const date = document.getElementById('eventDate').value;
            const time = document.getElementById('eventTime').value;
            const title = document.getElementById('eventTitle').value.trim();
            const description = document.getElementById('eventDescription').value.trim();
            const color = document.getElementById('eventColor').value;
            const category = document.getElementById('eventCategory').value;
            
            if (!title) {
                showToast('Informe o título do evento', 'error');
                return;
            }
            
            if (editingId) {
                // Editar evento existente
                updateCalendarEvent(editingId, { date, time, title, description, color, category });
                showToast('Evento atualizado!', 'success');
            } else {
                // Criar novo evento
                addCalendarEvent(date, title, description, color, time, category);
                showToast('Evento adicionado!', 'success');
            }
            closeModal('addEventModal');
        }
        
        function showEventDetails(eventId) {
            const event = calendarEvents.find(e => e.id === eventId);
            if (!event) return;
            
            const isOwner = currentUser?.id === event.createdBy;
            const createdByName = event.createdByName || 'Desconhecido';
            
            const categoryLabels = {
                geral: '📌 Geral',
                reuniao: '👥 Reunião',
                prazo: '⏰ Prazo',
                lembrete: '🔔 Lembrete',
                feriado: '🎉 Feriado/Folga',
                importante: '⚠️ Importante'
            };
            
            // Criar modal de detalhes do evento
            let modal = document.getElementById('eventDetailsModal');
            if (modal) modal.remove();
            
            const modalHtml = `
                <div class="modal-overlay" id="eventDetailsModal">
                    <div class="modal" style="max-width: 450px;">
                        <div class="modal-header">
                            <h3>Detalhes do Evento</h3>
                            <button class="modal-close" onclick="closeModal('eventDetailsModal')">
                                <span class="material-icons">close</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 1rem;">
                                <div style="width: 20px; height: 20px; border-radius: 6px; background: ${event.color}; flex-shrink: 0;"></div>
                                <h4 style="margin: 0; color: var(--text-primary); font-size: 1.2rem;">${event.title}</h4>
                            </div>
                            
                            ${event.description ? `
                                <div style="margin-bottom: 1rem; padding: 1rem; background: var(--surface-hover); border-radius: 8px;">
                                    <p style="margin: 0; color: var(--text-secondary); white-space: pre-wrap;">${event.description}</p>
                                </div>
                            ` : ''}
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div style="padding: 0.75rem; background: var(--surface-hover); border-radius: 8px;">
                                    <div style="display: flex; align-items: center; gap: 8px; color: var(--text-muted); font-size: 0.8rem; margin-bottom: 4px;">
                                        <span class="material-icons" style="font-size: 16px;">event</span>
                                        Data
                                    </div>
                                    <div style="color: var(--text-primary); font-weight: 500;">${formatDateBR(event.date)}</div>
                                </div>
                                
                                <div style="padding: 0.75rem; background: var(--surface-hover); border-radius: 8px;">
                                    <div style="display: flex; align-items: center; gap: 8px; color: var(--text-muted); font-size: 0.8rem; margin-bottom: 4px;">
                                        <span class="material-icons" style="font-size: 16px;">schedule</span>
                                        Horário
                                    </div>
                                    <div style="color: var(--text-primary); font-weight: 500;">${event.time || 'Dia todo'}</div>
                                </div>
                                
                                <div style="padding: 0.75rem; background: var(--surface-hover); border-radius: 8px;">
                                    <div style="display: flex; align-items: center; gap: 8px; color: var(--text-muted); font-size: 0.8rem; margin-bottom: 4px;">
                                        <span class="material-icons" style="font-size: 16px;">label</span>
                                        Categoria
                                    </div>
                                    <div style="color: var(--text-primary); font-weight: 500;">${categoryLabels[event.category] || '📌 Geral'}</div>
                                </div>
                                
                                <div style="padding: 0.75rem; background: var(--surface-hover); border-radius: 8px;">
                                    <div style="display: flex; align-items: center; gap: 8px; color: var(--text-muted); font-size: 0.8rem; margin-bottom: 4px;">
                                        <span class="material-icons" style="font-size: 16px;">person</span>
                                        Criado por
                                    </div>
                                    <div style="color: var(--text-primary); font-weight: 500;">${createdByName}</div>
                                </div>
                            </div>
                            
                            ${isOwner ? `
                                <div class="form-actions" style="margin-top: 1.5rem; justify-content: space-between;">
                                    <button type="button" class="btn btn-danger" onclick="confirmDeleteEvent('${eventId}')">
                                        <span class="material-icons">delete</span>
                                        Excluir
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="editCalendarEvent('${eventId}')">
                                        <span class="material-icons">edit</span>
                                        Editar
                                    </button>
                                </div>
                            ` : `
                                <div style="margin-top: 1rem; padding: 0.75rem; background: var(--primary-light); border-radius: 8px; text-align: center;">
                                    <span style="color: var(--text-muted); font-size: 0.85rem;">
                                        <span class="material-icons" style="font-size: 16px; vertical-align: middle;">info</span>
                                        Apenas ${createdByName} pode editar ou excluir este evento
                                    </span>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            document.getElementById('eventDetailsModal').classList.add('active');
        }
        
        function editCalendarEvent(eventId) {
            const event = calendarEvents.find(e => e.id === eventId);
            if (!event) return;
            
            closeModal('eventDetailsModal');
            
            // Abrir modal de edição
            const modal = document.getElementById('addEventModal');
            if (!modal) {
                createAddEventModal();
            }
            
            document.getElementById('eventModalTitle').textContent = 'Editar Evento';
            document.getElementById('editingEventId').value = eventId;
            document.getElementById('eventDate').value = event.date;
            document.getElementById('eventTime').value = event.time || '';
            document.getElementById('eventTitle').value = event.title;
            document.getElementById('eventDescription').value = event.description || '';
            document.getElementById('eventColor').value = event.color;
            document.getElementById('eventCategory').value = event.category || 'geral';
            document.getElementById('eventSubmitBtn').innerHTML = '<span class="material-icons">save</span> Salvar';
            
            document.getElementById('addEventModal').classList.add('active');
        }
        
        function confirmDeleteEvent(eventId) {
            if (confirm('Deseja realmente excluir este evento?')) {
                deleteCalendarEvent(eventId);
                closeModal('eventDetailsModal');
                showToast('Evento removido', 'info');
            }
        }

        function changeMonth(delta) {
            switch (currentCalendarView) {
                case 'week':
                    currentMonth.setDate(currentMonth.getDate() + (delta * 7));
                    break;
                case 'day':
                    currentMonth.setDate(currentMonth.getDate() + delta);
                    break;
                default:
                    currentMonth.setMonth(currentMonth.getMonth() + delta);
            }
            renderCalendar();
        }

        function goToToday() {
            currentMonth = new Date();
            renderCalendar();
        }
        
        // Navegação por teclado
        function setupCalendarKeyboardNav() {
            document.addEventListener('keydown', (e) => {
                const calendarPage = document.getElementById('calendarPage');
                if (!calendarPage?.classList.contains('active')) return;
                
                if (e.key === 'ArrowLeft') {
                    changeMonth(-1);
                } else if (e.key === 'ArrowRight') {
                    changeMonth(1);
                }
            });
        }
        
        // Date picker para ir para data específica
        function setupCalendarDatePicker() {
            const picker = document.getElementById('calendarDatePicker');
            if (picker) {
                picker.addEventListener('change', (e) => {
                    if (e.target.value) {
                        const date = new Date(e.target.value + 'T00:00:00');
                        currentMonth = date;
                        renderCalendar();
                    }
                });
            }
            
            // Botões de visualização
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentCalendarView = btn.dataset.view;
                    renderCalendar();
                });
            });
        }
        
        // Renderizar visualização semanal
        function renderWeekView() {
            const grid = document.getElementById('calendarGrid');
            if (!grid) return;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Início da semana (segunda-feira)
            const startOfWeek = new Date(currentMonth);
            const dayOfWeek = startOfWeek.getDay();
            const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            startOfWeek.setDate(startOfWeek.getDate() + diff);
            
            const holidays = getHolidays(currentMonth.getFullYear());
            
            // Atualizar título
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(endOfWeek.getDate() + 4);
            const calendarTitle = document.getElementById('calendarTitle');
            if (calendarTitle) {
                calendarTitle.textContent = `${startOfWeek.getDate()}/${startOfWeek.getMonth() + 1} - ${endOfWeek.getDate()}/${endOfWeek.getMonth() + 1}/${endOfWeek.getFullYear()}`;
            }
            
            // Cabeçalhos
            let html = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex']
                .map(day => `<div class="calendar-day-header">${day}</div>`)
                .join('');
            
            // Dias da semana (segunda a sexta)
            for (let i = 0; i < 5; i++) {
                const date = new Date(startOfWeek);
                date.setDate(date.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                const isToday = date.getTime() === today.getTime();
                const holiday = holidays[dateStr];
                
                // Eventos do dia
                const events = cursos.filter(c => c.inicio === dateStr || c.fim === dateStr);
                const customEvents = calendarEvents.filter(e => e.date === dateStr);
                
                let eventsHtml = events.map(c => {
                    const isStart = c.inicio === dateStr;
                    const eventClass = isStart ? 'start' : 'end';
                    const label = isStart ? '▶ Início' : '■ Fim';
                    return `<div class="calendar-event ${eventClass}" 
                                onclick="openCourseModal('${c.id}')"
                                onmouseenter="showCoursePreview(event, '${c.id}')"
                                onmouseleave="hideCoursePreview()">
                                <span class="event-label">${label}</span> ${c.curso || c.lote}
                            </div>`;
                }).join('');
                
                const sortedEvents = [...customEvents].sort((a, b) => (a.time || '').localeCompare(b.time || ''));
                eventsHtml += sortedEvents.map(e => {
                    const isOwner = currentUser?.id === e.createdBy;
                    const ownerLabel = isOwner ? '' : ` • ${e.createdByName || 'Anônimo'}`;
                    const timeLabel = e.time ? `${e.time} - ` : '';
                    return `<div class="calendar-event custom-event" style="background: ${e.color};" onclick="showEventDetails('${e.id}')" title="${timeLabel}${e.title}${ownerLabel}">${e.time ? e.time + ' ' : ''}${e.title}</div>`;
                }).join('');
                
                const totalEvents = events.length + customEvents.length;
                const countBadge = totalEvents > 0 ? `<div class="day-course-count">${totalEvents}</div>` : '';
                const holidayHtml = holiday ? `<div class="holiday-name">${holiday}</div>` : '';
                
                html += `
                    <div class="calendar-day week-view-day${isToday ? ' today' : ''}${holiday ? ' holiday' : ''}" 
                         data-date="${dateStr}" ondblclick="openAddEventModal('${dateStr}')">
                        <div class="calendar-date">${date.getDate()}</div>
                        ${holidayHtml}
                        ${countBadge}
                        ${eventsHtml}
                        <button class="add-event-btn" onclick="openAddEventModal('${dateStr}')">
                            <span class="material-icons">add</span>
                        </button>
                    </div>
                `;
            }
            
            grid.innerHTML = html;
            grid.className = 'calendar-grid week-view';
            updateCalendarStats();
        }
        
        // Renderizar visualização diária
        function renderDayView() {
            const grid = document.getElementById('calendarGrid');
            if (!grid) return;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dateStr = currentMonth.toISOString().split('T')[0];
            const isToday = currentMonth.toDateString() === today.toDateString();
            const holidays = getHolidays(currentMonth.getFullYear());
            const holiday = holidays[dateStr];
            
            const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
                           'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const weekDays = ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado'];
            
            const calendarTitle = document.getElementById('calendarTitle');
            if (calendarTitle) {
                calendarTitle.textContent = `${weekDays[currentMonth.getDay()]}, ${currentMonth.getDate()} de ${months[currentMonth.getMonth()]}`;
            }
            
            // Eventos do dia
            const events = cursos.filter(c => c.inicio === dateStr || c.fim === dateStr);
            const customEvents = calendarEvents.filter(e => e.date === dateStr);
            
            let eventsHtml = '';
            
            if (events.length === 0 && customEvents.length === 0) {
                eventsHtml = `
                    <div class="day-view-empty">
                        <span class="material-icons">event_available</span>
                        <p>Nenhum evento para este dia</p>
                        <button class="btn btn-primary" onclick="openAddEventModal('${dateStr}')">
                            <span class="material-icons">add</span> Adicionar Evento
                        </button>
                    </div>
                `;
            } else {
                eventsHtml = `<div class="day-view-events">`;
                
                events.forEach(c => {
                    const isStart = c.inicio === dateStr;
                    const label = isStart ? '▶ Início do Curso' : '■ Fim do Curso';
                    const statusClass = 'status-' + getStatusClass(c.status);
                    eventsHtml += `
                        <div class="day-view-event ${statusClass}" onclick="openCourseModal('${c.id}')">
                            <div class="day-event-header">
                                <span class="day-event-type ${isStart ? 'start' : 'end'}">${label}</span>
                                <span class="day-event-status">${normalizeStatus(c.status)}</span>
                            </div>
                            <div class="day-event-title">${c.curso || c.lote}</div>
                            <div class="day-event-info">
                                <span><span class="material-icons">person</span> ${c.instrutor || 'Sem instrutor'}</span>
                                <span><span class="material-icons">location_on</span> ${c.local || c.cidade || 'Sem local'}</span>
                                <span><span class="material-icons">groups</span> ${c.alunos || 0} alunos</span>
                            </div>
                        </div>
                    `;
                });
                
                customEvents.forEach(e => {
                    eventsHtml += `
                        <div class="day-view-event custom" style="border-left-color: ${e.color};" onclick="showEventDetails('${e.id}')">
                            <div class="day-event-header">
                                <span class="day-event-type" style="background: ${e.color};">📌 Evento</span>
                            </div>
                            <div class="day-event-title">${e.title}</div>
                            ${e.description ? `<div class="day-event-description">${e.description}</div>` : ''}
                        </div>
                    `;
                });
                
                eventsHtml += `</div>`;
            }
            
            grid.innerHTML = `
                <div class="day-view-container${isToday ? ' today' : ''}${holiday ? ' holiday' : ''}">
                    ${holiday ? `<div class="day-view-holiday"><span class="material-icons">celebration</span> ${holiday}</div>` : ''}
                    ${eventsHtml}
                    <button class="btn btn-secondary add-event-day-btn" onclick="openAddEventModal('${dateStr}')">
                        <span class="material-icons">add</span> Adicionar Evento
                    </button>
                </div>
            `;
            
            grid.className = 'calendar-grid day-view';
            updateCalendarStats();
        }
        
        // Atualizar estatísticas do calendário
        function updateCalendarStats() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            
            let coursesStarting = 0;
            let coursesEnding = 0;
            let coursesInMonth = 0;
            
            cursos.forEach(c => {
                if (c.inicio) {
                    const startDate = new Date(c.inicio + 'T00:00:00');
                    if (startDate.getFullYear() === year && startDate.getMonth() === month) {
                        coursesStarting++;
                        coursesInMonth++;
                    }
                }
                if (c.fim) {
                    const endDate = new Date(c.fim + 'T00:00:00');
                    if (endDate.getFullYear() === year && endDate.getMonth() === month) {
                        coursesEnding++;
                    }
                }
            });
            
            const totalCoursesEl = document.getElementById('totalCoursesMonth');
            const startingEl = document.getElementById('coursesStartingMonth');
            const endingEl = document.getElementById('coursesEndingMonth');
            
            if (totalCoursesEl) totalCoursesEl.textContent = coursesInMonth;
            if (startingEl) startingEl.textContent = coursesStarting;
            if (endingEl) endingEl.textContent = coursesEnding;
        }
        
        // Modificar changeMonth para suportar diferentes views
        function changeCalendarPeriod(delta) {
            switch (currentCalendarView) {
                case 'week':
                    currentMonth.setDate(currentMonth.getDate() + (delta * 7));
                    break;
                case 'day':
                    currentMonth.setDate(currentMonth.getDate() + delta);
                    break;
                default:
                    currentMonth.setMonth(currentMonth.getMonth() + delta);
            }
            renderCalendar();
        }

        // Modal Functions
        function openCourseModal(courseId = null) {
            editingCourseId = courseId;
            const modal = document.getElementById('courseModal');
            const title = document.getElementById('courseModalTitle');

            // Renderizar formulário dinamicamente com a ordem configurada
            renderCourseFormFields();

            if (courseId) {
                const course = cursos.find(c => c.id === courseId);
                if (course) {
                    title.textContent = 'Editar Curso';
                    
                    // Preencher campos do sistema
                    const setVal = (id, val) => {
                        const el = document.getElementById(id);
                        if (el) el.value = val || '';
                    };
                    
                    setVal('courseName', course.curso);
                    setVal('courseIdLote', course.idLote);
                    setVal('courseLote', course.lote || course.loteResponsavel);
                    setVal('courseCargaHoraria', course.cargaHoraria);
                    setVal('courseCity', course.cidade);
                    setVal('courseLocation', course.local);
                    setVal('courseStart', course.inicio);
                    setVal('courseEnd', course.fim);
                    setVal('courseStatus', course.status || 'Pendente');
                    setVal('courseStudents', course.alunos || 0);
                    setVal('courseInstructor', course.instrutor);
                    setVal('courseDriveLink', course.driveLink);
                    setVal('courseNote', course.nota);
                    
                    // Preencher campos personalizados
                    fillCustomFieldValues(course);
                }
            } else {
                title.textContent = 'Novo Curso';
            }

            modal.classList.add('active');
        }

        function openInstructorModal(instructorId = null) {
            editingInstructorId = instructorId;
            const modal = document.getElementById('instructorModal');
            if (!modal) {
                console.error('Modal de instrutor não encontrado!');
                return;
            }
            const title = document.getElementById('instructorModalTitle');
            const form = document.getElementById('instructorForm');
            if (!form) {
                console.error('Formulário de instrutor não encontrado!');
                return;
            }

            form.reset();
            document.querySelectorAll('.form-error').forEach(el => el.classList.remove('show'));

            if (instructorId) {
                const instructor = instrutores.find(i => i.id === instructorId);
                if (instructor) {
                    title.textContent = 'Editar Instrutor';
                    document.getElementById('instructorName').value = instructor.nome || '';
                    document.getElementById('instructorSpecialty').value = instructor.especialidade || '';
                    document.getElementById('instructorPhone').value = instructor.telefone || '';
                    document.getElementById('instructorEmail').value = instructor.email || '';
                }
            } else {
                title.textContent = 'Novo Instrutor';
            }

            modal.classList.add('active');
        }

        function openQuickInstructorModal() {
            document.getElementById('quickInstructorForm').reset();
            document.querySelectorAll('.form-error').forEach(el => el.classList.remove('show'));
            document.getElementById('quickInstructorModal').classList.add('active');
        }

        function openUserModal(userId = null) {
            editingUserId = userId;
            const modal = document.getElementById('userModal');
            const title = document.getElementById('userModalTitle');
            const form = document.getElementById('userForm');

            form.reset();
            document.querySelectorAll('.form-error').forEach(el => el.classList.remove('show'));

            if (userId) {
                const user = usuarios.find(u => u.id === userId);
                if (user) {
                    title.textContent = 'Editar Usuário';
                    document.getElementById('newUserName').value = user.name || '';
                    document.getElementById('newUserUsername').value = user.username || '';
                    document.getElementById('newUserEmail').value = user.email || '';
                    document.getElementById('newUserPassword').value = '';
                    document.getElementById('newUserRole').value = user.role || 'viewer';
                }
            } else {
                title.textContent = 'Novo Usuário';
            }

            modal.classList.add('active');
        }

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            const form = document.getElementById(`${modalId.replace('Modal', 'Form')}`);
            if (form) {
                form.reset();
            }
            document.querySelectorAll(`#${modalId} .form-error`).forEach(el => el.classList.remove('show'));
        }
        
        // Fechar modal ao clicar fora dele
        function setupModalCloseOnOutsideClick() {
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', function(e) {
                    // Fechar apenas se clicou diretamente no overlay (não no modal interno)
                    if (e.target === overlay) {
                        const modalId = overlay.id;
                        closeModal(modalId);
                    }
                });
            });
        }

        async function handleCourseSubmit(e) {
            e.preventDefault();
            
            // Validações
            const idLote = document.getElementById('courseIdLote').value.trim();
            const lote = document.getElementById('courseLote').value.trim();
            const inicio = document.getElementById('courseStart').value;
            const fim = document.getElementById('courseEnd').value;
            
            // Limpar erros anteriores
            document.querySelectorAll('.form-error').forEach(el => el.classList.remove('show'));
            
            let hasError = false;
            
            // Validar ID do LOTE (opcional, mas se preenchido deve ser válido)
            if (idLote && (isNaN(parseInt(idLote)) || parseInt(idLote) <= 0)) {
                document.getElementById('courseIdLote').classList.add('error');
                showToast('ID do LOTE deve ser um número positivo', 'error');
                hasError = true;
            }
            
            // Validar LOTE (opcional, mas se preenchido deve ter pelo menos 2 caracteres)
            if (lote && lote.length < 2) {
                document.getElementById('courseLote').classList.add('error');
                showToast('LOTE deve ter pelo menos 2 caracteres', 'error');
                hasError = true;
            }
            
            // Validar datas
            if (inicio && fim) {
                const startDate = new Date(inicio);
                const endDate = new Date(fim);
                if (endDate < startDate) {
                    document.getElementById('courseEnd').classList.add('error');
                    showToast('Data de fim não pode ser anterior à data de início', 'error');
                    hasError = true;
                }
            }
            
            // Validar URL do Drive se fornecida
            const driveLink = document.getElementById('courseDriveLink').value.trim();
            if (driveLink && !isValidUrl(driveLink)) {
                document.getElementById('courseDriveLink').classList.add('error');
                showToast('URL do Google Drive inválida', 'error');
                hasError = true;
            }
            
            if (hasError) return;
            
            // Remover classes de erro dos campos válidos
            document.querySelectorAll('.form-input, .form-select').forEach(el => {
                if (!el.classList.contains('error')) {
                    el.classList.remove('error');
                }
            });
            
            const courseData = {
                curso: document.getElementById('courseName').value.trim(),
                idLote: idLote ? parseInt(idLote) : 0,
                lote: lote || '',
                loteResponsavel: lote || '',
                cargaHoraria: document.getElementById('courseCargaHoraria').value,
                cidade: document.getElementById('courseCity').value.trim(),
                inicio: inicio,
                fim: fim,
                status: normalizeStatus(document.getElementById('courseStatus').value || 'Pendente'),
                alunos: parseInt(document.getElementById('courseStudents').value) || 0,
                local: document.getElementById('courseLocation').value.trim(),
                instrutor: document.getElementById('courseInstructor').value,
                driveLink: driveLink,
                nota: document.getElementById('courseNote').value.trim(),
                // Adicionar campos personalizados
                ...getCustomFieldValues()
            };
            
            // Validar número de alunos
            if (courseData.alunos < 0) {
                showToast('Número de concludentes não pode ser negativo', 'error');
                return;
            }

            // Mostrar loading
            setLoadingState(true);

            try {
                let changes = {};
                let oldCourse = null;
                
                if (editingCourseId) {
                    oldCourse = cursos.find(c => c.id === editingCourseId);
                    if (oldCourse) {
                        Object.keys(courseData).forEach(key => {
                            const oldValue = oldCourse[key];
                            const newValue = courseData[key];
                            // Comparar valores normalizados
                            if (key === 'status') {
                                if (normalizeStatus(oldValue) !== normalizeStatus(newValue)) {
                                    changes[key] = { old: oldValue, new: newValue };
                                }
                            } else if (oldValue !== newValue) {
                                changes[key] = { old: oldValue !== null && oldValue !== undefined ? oldValue : '', new: newValue !== null && newValue !== undefined ? newValue : '' };
                            }
                        });
                    }
                }
                
                if (firebaseAvailable) {
                    if (editingCourseId) {
                        courseData.id = editingCourseId;
                        const docRef = await db.collection('cursos').doc(editingCourseId);
                        await docRef.set(courseData); // Usar set ao invés de update para substituir completamente
                        
                        // Atualizar array local
                        const index = cursos.findIndex(c => c.id === editingCourseId);
                        if (index !== -1) {
                            cursos[index] = courseData;
                        }
                        
                        if (Object.keys(changes).length > 0) {
                            addCourseHistoryEntry(editingCourseId, 'updated', changes, oldCourse);
                        }
                    } else {
                        const docRef = await db.collection('cursos').doc();
                        courseData.id = docRef.id;
                        await docRef.set(courseData);
                        cursos.push(courseData);
                        addCourseHistoryEntry(courseData.id, 'created', { curso: { old: '', new: courseData.curso } });
                    }
                } else {
                    const existingCourses = JSON.parse(localStorage.getItem('cursos') || '[]');
                    if (editingCourseId) {
                        const index = existingCourses.findIndex(c => c.id === editingCourseId);
                        if (index !== -1) {
                            // Substituir completamente, mantendo apenas o id
                            courseData.id = editingCourseId;
                            existingCourses[index] = courseData;
                            if (Object.keys(changes).length > 0) {
                                addCourseHistoryEntry(editingCourseId, 'updated', changes, oldCourse);
                            }
                        }
                        // Atualizar array local também
                        const localIndex = cursos.findIndex(c => c.id === editingCourseId);
                        if (localIndex !== -1) {
                            cursos[localIndex] = courseData;
                        }
                    } else {
                        courseData.id = 'course_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        existingCourses.push(courseData);
                        cursos.push(courseData);
                        addCourseHistoryEntry(courseData.id, 'created', { curso: { old: '', new: courseData.curso } });
                    }
                    localStorage.setItem('cursos', JSON.stringify(existingCourses));
                }
                
                if (editingCourseId) {
                    showToast('Curso atualizado com sucesso!', 'success');
                    logActivity('Edição de Curso', `Editou o curso "${courseData.curso || 'Sem nome'}"`, 'edit');
                } else {
                    showToast('Curso criado com sucesso!', 'success');
                    logActivity('Novo Curso', `Adicionou o curso "${courseData.curso || 'Sem nome'}"`, 'add');
                }
                closeModal('courseModal');
                
                // Atualizar renderização apenas das páginas ativas/necessárias
                if (document.getElementById('coursesGrid')) {
                    renderCourses();
                }
                if (document.getElementById('coursesPage')?.classList.contains('active')) {
                    renderCoursesByLote();
                }
                if (document.getElementById('calendarPage')?.classList.contains('active')) {
                    renderCalendar();
                }
                if (document.getElementById('dashboardPage')?.classList.contains('active')) {
                    renderDashboard();
                    renderDashboardReport();
                }
            } catch (error) {
                console.error('Error saving course:', error);
                showToast('Erro ao salvar curso: ' + (error.message || 'Erro desconhecido'), 'error');
            } finally {
                setLoadingState(false);
            }
        }
        
        function isValidUrl(string) {
            try {
                const url = new URL(string);
                return url.protocol === 'http:' || url.protocol === 'https:';
            } catch (_) {
                return false;
            }
        }
        
        function setLoadingState(loading) {
            isLoading = loading;
            const overlay = document.getElementById('loadingOverlay');
            const buttons = document.querySelectorAll('button[type="submit"]');
            
            if (overlay) {
                if (loading) {
                    overlay.classList.add('active');
                } else {
                    overlay.classList.remove('active');
                }
            }
            
            buttons.forEach(btn => {
                if (loading) {
                    btn.disabled = true;
                    btn.style.opacity = '0.6';
                    btn.style.cursor = 'not-allowed';
                } else {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                }
            });
        }

        async function handleInstructorSubmit(e) {
            e.preventDefault();
            
            // Validações
            document.querySelectorAll('.form-error').forEach(el => el.classList.remove('show'));
            
            const nome = document.getElementById('instructorName').value.trim();
            const email = document.getElementById('instructorEmail').value.trim();
            const telefone = document.getElementById('instructorPhone').value.trim();
            
            let hasError = false;
            
            // Validar email se fornecido
            if (email && !isValidEmail(email)) {
                document.getElementById('instructorEmail').classList.add('error');
                showToast('Email inválido', 'error');
                hasError = true;
            }
            
            // Validar telefone se fornecido
            if (telefone && !isValidPhone(telefone)) {
                document.getElementById('instructorPhone').classList.add('error');
                showToast('Telefone inválido. Use o formato (00) 00000-0000', 'error');
                hasError = true;
            }
            
            if (hasError) return;
            
            const instructorData = {
                nome: nome || 'Instrutor sem nome',
                especialidade: document.getElementById('instructorSpecialty').value.trim(),
                telefone: telefone,
                email: email
            };
            
            // Remover classes de erro
            document.querySelectorAll('.form-input').forEach(el => el.classList.remove('error'));

            setLoadingState(true);

            try {
                if (firebaseAvailable) {
                    if (editingInstructorId) {
                        await db.collection('instrutores').doc(editingInstructorId).update(instructorData);
                    } else {
                        await db.collection('instrutores').add(instructorData);
                    }
                } else {
                    const existingInstructors = JSON.parse(localStorage.getItem('instrutores') || '[]');
                    if (editingInstructorId) {
                        const index = existingInstructors.findIndex(i => i.id === editingInstructorId);
                        if (index !== -1) {
                            existingInstructors[index] = { ...existingInstructors[index], ...instructorData };
                        }
                    } else {
                        instructorData.id = 'instructor_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        existingInstructors.push(instructorData);
                    }
                    localStorage.setItem('instrutores', JSON.stringify(existingInstructors));
                    loadFromLocalStorage();
                }
                
                if (editingInstructorId) {
                    showToast('Instrutor atualizado com sucesso!', 'success');
                    logActivity('Edição de Instrutor', `Editou o instrutor "${instructorData.nome || 'Sem nome'}"`, 'edit');
                } else {
                    showToast('Instrutor criado com sucesso!', 'success');
                    logActivity('Novo Instrutor', `Adicionou o instrutor "${instructorData.nome || 'Sem nome'}"`, 'add');
                }
                closeModal('instructorModal');
            } catch (error) {
                console.error('Error saving instructor:', error);
                showToast('Erro ao salvar instrutor: ' + (error.message || 'Erro desconhecido'), 'error');
            } finally {
                setLoadingState(false);
            }
        }
        
        function isValidEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }
        
        function isValidPhone(phone) {
            // Aceita formatos: (00) 00000-0000, (00) 0000-0000, 00000000000, etc.
            const cleaned = phone.replace(/\D/g, '');
            return cleaned.length >= 10 && cleaned.length <= 11;
        }

        async function handleQuickInstructorSubmit(e) {
            e.preventDefault();
            
            const nome = document.getElementById('quickInstructorName').value.trim();

            try {
                if (firebaseAvailable) {
                    await db.collection('instrutores').add({ nome: nome || 'Novo Instrutor' });
                } else {
                    const existingInstructors = JSON.parse(localStorage.getItem('instrutores') || '[]');
                    existingInstructors.push({
                        id: 'instructor_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        nome: nome || 'Novo Instrutor'
                    });
                    localStorage.setItem('instrutores', JSON.stringify(existingInstructors));
                    loadFromLocalStorage();
                }
                showToast('Instrutor adicionado!', 'success');
                logActivity('Novo Instrutor', `Adicionou o instrutor "${nome || 'Novo Instrutor'}" (rápido)`, 'add');
                closeModal('quickInstructorModal');
            } catch (error) {
                console.error('Error adding instructor:', error);
                showToast('Erro ao adicionar instrutor', 'error');
            }
        }

        async function handleUserSubmit(e) {
            e.preventDefault();
            
            // Validações
            document.querySelectorAll('.form-error').forEach(el => el.classList.remove('show'));
            
            const name = document.getElementById('newUserName').value.trim();
            const username = document.getElementById('newUserUsername').value.trim();
            const email = document.getElementById('newUserEmail').value.trim();
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value || 'viewer';
            
            let hasError = false;
            
            // Validar username (obrigatório e único)
            if (!username || username.length < 3) {
                document.getElementById('newUserUsername').classList.add('error');
                showToast('Username é obrigatório e deve ter pelo menos 3 caracteres', 'error');
                hasError = true;
            } else {
                // Verificar se username já existe
                const existingUser = usuarios.find(u => u.username === username && u.id !== editingUserId);
                if (existingUser) {
                    document.getElementById('newUserUsername').classList.add('error');
                    showToast('Username já está em uso', 'error');
                    hasError = true;
                }
            }
            
            // Validar email se fornecido
            if (email && !isValidEmail(email)) {
                document.getElementById('newUserEmail').classList.add('error');
                showToast('Email inválido', 'error');
                hasError = true;
            }
            
            // Validar senha (obrigatória para novos usuários)
            if (!editingUserId && (!password || password.length < 4)) {
                document.getElementById('newUserPassword').classList.add('error');
                showToast('Senha é obrigatória e deve ter pelo menos 4 caracteres', 'error');
                hasError = true;
            }
            
            // Validar senha se fornecida na edição
            if (editingUserId && password && password.length < 4) {
                document.getElementById('newUserPassword').classList.add('error');
                showToast('Senha deve ter pelo menos 4 caracteres', 'error');
                hasError = true;
            }
            
            if (hasError) return;
            
            const userData = {
                name: name || 'Novo Usuário',
                username: username,
                email: email,
                password: password || (editingUserId ? usuarios.find(u => u.id === editingUserId)?.password : '123456'),
                role: role
            };
            
            // Remover classes de erro
            document.querySelectorAll('.form-input').forEach(el => el.classList.remove('error'));

            setLoadingState(true);

            try {
                if (firebaseAvailable) {
                    if (editingUserId) {
                        await db.collection('usuarios').doc(editingUserId).update(userData);
                    } else {
                        await db.collection('usuarios').add(userData);
                    }
                } else {
                    const existingUsers = JSON.parse(localStorage.getItem('usuarios') || '[]');
                    if (editingUserId) {
                        const index = existingUsers.findIndex(u => u.id === editingUserId);
                        if (index !== -1) {
                            existingUsers[index] = { ...existingUsers[index], ...userData };
                        }
                    } else {
                        userData.id = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        existingUsers.push(userData);
                    }
                    localStorage.setItem('usuarios', JSON.stringify(existingUsers));
                    loadFromLocalStorage();
                }
                
                if (editingUserId) {
                    showToast('Usuário atualizado com sucesso!', 'success');
                    logActivity('Edição de Usuário', `Editou o usuário "${userData.name}"`, 'edit');
                } else {
                    showToast('Usuário criado com sucesso!', 'success');
                    logActivity('Novo Usuário', `Adicionou o usuário "${userData.name}"`, 'add');
                }
                closeModal('userModal');
            } catch (error) {
                console.error('Error saving user:', error);
                showToast('Erro ao salvar usuário: ' + (error.message || 'Erro desconhecido'), 'error');
            } finally {
                setLoadingState(false);
            }
        }

        async function handleChangePassword(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!currentPassword || !newPassword || !confirmPassword) {
                showToast('Preencha todos os campos', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showToast('As senhas não coincidem', 'error');
                return;
            }

            if (newPassword.length < 4) {
                showToast('A nova senha deve ter pelo menos 4 caracteres', 'error');
                return;
            }

            // Verificar senha atual
            if (currentUser.password !== currentPassword) {
                showToast('Senha atual incorreta', 'error');
                return;
            }

            try {
                if (firebaseAvailable) {
                    await db.collection('usuarios').doc(currentUser.id).update({ password: newPassword });
                } else {
                    const existingUsers = JSON.parse(localStorage.getItem('usuarios') || '[]');
                    const index = existingUsers.findIndex(u => u.id === currentUser.id);
                    if (index !== -1) {
                        existingUsers[index].password = newPassword;
                        localStorage.setItem('usuarios', JSON.stringify(existingUsers));
                    }
                }

                // Atualizar o usuário atual
                currentUser.password = newPassword;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));

                showToast('Senha alterada com sucesso!', 'success');
                logActivity('Alteração de Senha', `${currentUser.name} alterou sua senha`, 'edit');
                
                // Limpar formulário
                document.getElementById('changePasswordForm').reset();
            } catch (error) {
                console.error('Error changing password:', error);
                showToast('Erro ao alterar senha', 'error');
            }
        }

        async function handleChangeName(e) {
            e.preventDefault();
            
            const newName = document.getElementById('newAdminName').value.trim();
            const currentNameDisplay = document.getElementById('currentNameDisplay');

            if (!newName) {
                showToast('Digite um novo nome', 'error');
                return;
            }

            if (newName.length < 2) {
                showToast('O nome deve ter pelo menos 2 caracteres', 'error');
                return;
            }

            const oldName = currentUser.name;

            try {
                if (firebaseAvailable) {
                    await db.collection('usuarios').doc(currentUser.id).update({ name: newName });
                } else {
                    const existingUsers = JSON.parse(localStorage.getItem('usuarios') || '[]');
                    const index = existingUsers.findIndex(u => u.id === currentUser.id);
                    if (index !== -1) {
                        existingUsers[index].name = newName;
                        localStorage.setItem('usuarios', JSON.stringify(existingUsers));
                    }
                }

                // Atualizar o usuário atual
                currentUser.name = newName;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));

                // Atualizar a sidebar
                document.getElementById('userName').textContent = newName;
                document.getElementById('userAvatar').textContent = newName.charAt(0).toUpperCase();
                
                // Atualizar o campo de nome atual
                currentNameDisplay.value = newName;

                showToast('Nome alterado com sucesso!', 'success');
                logActivity('Alteração de Nome', `${oldName} alterou seu nome para "${newName}"`, 'edit');
                
                // Limpar formulário
                document.getElementById('newAdminName').value = '';
            } catch (error) {
                console.error('Error changing name:', error);
                showToast('Erro ao alterar nome', 'error');
            }
        }


        async function deleteCourse(id) {
            if (!confirm('Tem certeza que deseja excluir este curso?\n\nVocê pode desfazer esta ação com Ctrl+Z.')) return;

            try {
                const course = cursos.find(c => c.id === id);
                
                // Registrar no histórico antes de deletar
                if (course) {
                    addCourseHistoryEntry(id, 'deleted', { curso: { old: course.curso || 'Sem nome', new: '' } }, course);
                    
                    // Adicionar ao undo stack
                    pushToUndoStack({
                        type: 'delete_course',
                        data: { ...course },
                        message: `Curso "${course.curso}" excluído`
                    });
                    
                    // Adicionar ao audit log
                    addAuditLog('delete', 'course', id, `Curso "${course.curso}" excluído`);
                }
                
                if (firebaseAvailable) {
                    await db.collection('cursos').doc(id).delete();
                } else {
                    const existingCourses = JSON.parse(localStorage.getItem('cursos') || '[]');
                    const filteredCourses = existingCourses.filter(c => c.id !== id);
                    localStorage.setItem('cursos', JSON.stringify(filteredCourses));
                    cursos = filteredCourses;
                }
                
                logActivity('Exclusão de Curso', `Excluiu o curso "${course?.curso}"`, 'delete');
                
                    // Atualizar renderização
                    renderCalendar();
                    renderDashboardReport();
                    if (document.getElementById('coursesPage')?.classList.contains('active')) {
                        renderCoursesByLote();
                    }
            } catch (error) {
                console.error('Error deleting course:', error);
                showToast('Erro ao excluir curso', 'error');
            }
        }

        async function deleteInstructor(id) {
            if (!confirm('Tem certeza que deseja excluir este instrutor?')) return;

            try {
                const instructor = instrutores.find(i => i.id === id);
                
                if (firebaseAvailable) {
                    await db.collection('instrutores').doc(id).delete();
                } else {
                    const existingInstructors = JSON.parse(localStorage.getItem('instrutores') || '[]');
                    const filteredInstructors = existingInstructors.filter(i => i.id !== id);
                    localStorage.setItem('instrutores', JSON.stringify(filteredInstructors));
                    loadFromLocalStorage();
                }
                
                showToast('Instrutor excluído!', 'success');
                logActivity('Exclusão de Instrutor', `Excluiu o instrutor "${instructor?.nome}"`, 'delete');
            } catch (error) {
                console.error('Error deleting instructor:', error);
                showToast('Erro ao excluir instrutor', 'error');
            }
        }

        async function deleteUser(id) {
            if (!confirm('Tem certeza que deseja excluir este usuário?')) return;

            try {
                const user = usuarios.find(u => u.id === id);
                
                if (firebaseAvailable) {
                    await db.collection('usuarios').doc(id).delete();
                } else {
                    const existingUsers = JSON.parse(localStorage.getItem('usuarios') || '[]');
                    const filteredUsers = existingUsers.filter(u => u.id !== id);
                    localStorage.setItem('usuarios', JSON.stringify(filteredUsers));
                    loadFromLocalStorage();
                }
                
                showToast('Usuário excluído!', 'success');
                logActivity('Exclusão de Usuário', `Excluiu o usuário "${user?.name}"`, 'delete');
            } catch (error) {
                console.error('Error deleting user:', error);
                showToast('Erro ao excluir usuário', 'error');
            }
        }

        // Import/Export Functions
        async function handleExcelUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Validar tipo de arquivo
            const validTypes = ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 
                               'application/vnd.ms-excel',
                               'application/excel'];
            const validExtensions = ['.xlsx', '.xls'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            
            if (!validTypes.includes(file.type) && !validExtensions.includes(fileExtension)) {
                showToast('Por favor, selecione um arquivo Excel (.xlsx ou .xls)', 'error');
                return;
            }
            
            // Validar tamanho (máximo 10MB)
            if (file.size > 10 * 1024 * 1024) {
                showToast('Arquivo muito grande. Tamanho máximo: 10MB', 'error');
                return;
            }

            document.getElementById('selectedFileName').textContent = file.name;
            document.getElementById('fileInfoBox').classList.add('show');
            
            // Mostrar loading
            setLoadingState(true);
            showToast('Processando arquivo...', 'info');

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    // Usar cellDates: true para converter datas automaticamente
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    // raw: false converte valores, mas mantém datas como objetos Date quando possível
                    const json = XLSX.utils.sheet_to_json(worksheet, { raw: false, defval: '' });

                    let imported = 0;
                    let errors = [];
                    
                    // Processar em lotes para melhor performance
                    const batchSize = 10;
                    for (let i = 0; i < json.length; i += batchSize) {
                        const batch = json.slice(i, i + batchSize);
                        
                        for (const row of batch) {
                            try {
                        const loteValue = row['LOTE'] || row['lote'] || row['Lote'] || '';
                        
                        // Função auxiliar para buscar valor de coluna com múltiplas variações (case-insensitive e flexível)
                        function getColumnValue(row, variations) {
                            // Normalizar string para comparação (remover acentos, espaços extras, etc)
                            function normalizeForComparison(str) {
                                return str.toLowerCase()
                                    .trim()
                                    .replace(/\s+/g, ' ')
                                    .replace(/[çÇ]/g, 'c')
                                    .replace(/[áàâãä]/g, 'a')
                                    .replace(/[éèêë]/g, 'e')
                                    .replace(/[íìîï]/g, 'i')
                                    .replace(/[óòôõö]/g, 'o')
                                    .replace(/[úùûü]/g, 'u')
                                    .replace(/[ñ]/g, 'n');
                            }
                            
                            // Primeiro, tentar variações exatas
                            for (const variation of variations) {
                                if (row[variation] !== undefined && row[variation] !== null && row[variation] !== '') {
                                    const value = row[variation];
                                    // Se for Date, retornar diretamente
                                    if (value instanceof Date) return value;
                                    // Caso contrário, converter para string
                                    const strValue = String(value).trim();
                                    if (strValue) return strValue;
                                }
                            }
                            
                            // Se não encontrou, tentar busca case-insensitive e flexível
                            const rowKeys = Object.keys(row);
                            for (const variation of variations) {
                                const variationNormalized = normalizeForComparison(variation);
                                for (const key of rowKeys) {
                                    const keyNormalized = normalizeForComparison(key);
                                    if (keyNormalized === variationNormalized) {
                                        const value = row[key];
                                        // Se for Date, retornar diretamente
                                        if (value instanceof Date) {
                                            if (i === 0 && imported === 0) {
                                                console.log(`✓ Encontrado "${variation}" como "${key}" com valor Date:`, value);
                                            }
                                            return value;
                                        }
                                        // Caso contrário, converter para string
                                        const strValue = String(value).trim();
                                        if (strValue) {
                                            if (i === 0 && imported === 0) {
                                                console.log(`✓ Encontrado "${variation}" como "${key}" com valor:`, strValue);
                                            }
                                            return strValue;
                                        }
                                    }
                                }
                            }
                            
                            // Última tentativa: busca parcial (contém)
                            for (const variation of variations) {
                                const variationNormalized = normalizeForComparison(variation);
                                // Buscar palavras-chave importantes
                                const keywords = variationNormalized.split(' ').filter(w => w.length > 3);
                                for (const key of rowKeys) {
                                    const keyNormalized = normalizeForComparison(key);
                                    // Verificar se todas as palavras-chave estão presentes
                                    if (keywords.length > 0 && keywords.every(kw => keyNormalized.includes(kw))) {
                                        const value = row[key];
                                        // Se for Date, retornar diretamente
                                        if (value instanceof Date) {
                                            if (i === 0 && imported === 0) {
                                                console.log(`✓ Encontrado "${variation}" parcialmente como "${key}" com valor Date:`, value);
                                            }
                                            return value;
                                        }
                                        // Caso contrário, converter para string
                                        const strValue = String(value).trim();
                                        if (strValue) {
                                            if (i === 0 && imported === 0) {
                                                console.log(`✓ Encontrado "${variation}" parcialmente como "${key}" com valor:`, strValue);
                                            }
                                            return strValue;
                                        }
                                    }
                                }
                            }
                            
                            return '';
                        }
                        
                        // Buscar endereço com todas as variações possíveis
                        const endereco = getColumnValue(row, [
                            'ENDEREÇO', 'endereço', 'Endereço', 'ENDERECO', 'endereco', 'Endereco',
                            'LOCAL DO CURSO', 'local do curso', 'Local do Curso', 'Local Do Curso',
                            'LOCAL', 'local', 'Local',
                            'LOCAL_DO_CURSO', 'local_do_curso', 'Local_Do_Curso'
                        ]);
                        
                        // Debug do endereço encontrado (apenas primeira linha)
                        if (i === 0 && imported === 0 && !endereco) {
                            console.warn('⚠ Endereço NÃO encontrado. Colunas disponíveis:', Object.keys(row));
                        }
                        
                        const courseData = {
                            curso: getColumnValue(row, ['CURSO', 'curso', 'Curso']) || '',
                            idLote: parseInt(getColumnValue(row, ['ID', 'id', 'Id']) || '0') || 0,
                            lote: loteValue,
                            loteResponsavel: loteValue,
                            cidade: getColumnValue(row, ['CIDADE', 'cidade', 'Cidade', 'CIDADE ', 'cidade ']) || '',
                            inicio: (() => {
                                const dateValue = getColumnValue(row, [
                                    'DATA INÍCIO', 'DATA INICIO', 'data início', 'data inicio', 
                                    'INÍCIO', 'inicio', 'INICIO', 'Data Início', 'Data Inicio',
                                    'DATA INICIO', 'Data Inicio', 'Data inicio'
                                ]);
                                // Se for um objeto Date, converter diretamente
                                if (dateValue instanceof Date) {
                                    const year = dateValue.getFullYear();
                                    const month = String(dateValue.getMonth() + 1).padStart(2, '0');
                                    const day = String(dateValue.getDate()).padStart(2, '0');
                                    const formatted = `${year}-${month}-${day}`;
                                    if (i === 0 && imported === 0) {
                                        console.log('Data início (Date object):', dateValue, '→ Formatada:', formatted);
                                    }
                                    return formatted;
                                }
                                
                                const formatted = formatExcelDate(dateValue);
                                if (i === 0 && imported === 0 && dateValue) {
                                    console.log('Data início original:', dateValue, typeof dateValue, '→ Formatada:', formatted);
                                }
                                return formatted;
                            })(),
                            fim: (() => {
                                const dateValue = getColumnValue(row, [
                                    'DATA FIM', 'data fim', 'FIM', 'fim', 'Data Fim',
                                    'DATA FIM ', 'Data Fim', 'Data fim'
                                ]);
                                
                                // Se for um objeto Date, converter diretamente
                                if (dateValue instanceof Date) {
                                    const year = dateValue.getFullYear();
                                    const month = String(dateValue.getMonth() + 1).padStart(2, '0');
                                    const day = String(dateValue.getDate()).padStart(2, '0');
                                    const formatted = `${year}-${month}-${day}`;
                                    if (i === 0 && imported === 0) {
                                        console.log('Data fim (Date object):', dateValue, '→ Formatada:', formatted);
                                    }
                                    return formatted;
                                }
                                
                                const formatted = formatExcelDate(dateValue);
                                if (i === 0 && imported === 0 && dateValue) {
                                    console.log('Data fim original:', dateValue, typeof dateValue, '→ Formatada:', formatted);
                                }
                                return formatted;
                            })(),
                            local: endereco,
                            status: normalizeStatus(getColumnValue(row, ['STATUS', 'status', 'Status']) || 'Pendente'),
                            alunos: parseInt(getColumnValue(row, ['CONCLUDENTES', 'concludentes', 'Concludentes']) || '0') || 0,
                            cargaHoraria: getColumnValue(row, [
                                'CARGA HORÁRIA', 'carga horária', 'CARGA HORARIA', 'carga horaria',
                                'Carga Horária', 'Carga Horaria', 'CARGA_HORÁRIA', 'carga_horária'
                            ]) || '',
                            instrutor: getColumnValue(row, ['INSTRUTOR', 'instrutor', 'Instrutor']) || '',
                            telefone: getColumnValue(row, ['TELEFONE', 'telefone', 'Telefone']) || '',
                            driveLink: '',
                            nota: ''
                        };

                        const newId = 'course_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9) + '_' + imported;
                        const courseWithId = {...courseData, id: newId};
                        
                        if (firebaseAvailable) {
                            try {
                                const docRef = await db.collection('cursos').add(courseData);
                                const courseWithFirebaseId = {...courseData, id: docRef.id};
                                cursos.push(courseWithFirebaseId);
                                        imported++;
                            } catch (err) {
                                console.error('Erro ao adicionar curso no Firebase:', err);
                                        errors.push(`Linha ${i + 1}: ${err.message || 'Erro desconhecido'}`);
                            }
                        } else {
                            const existingCourses = JSON.parse(localStorage.getItem('cursos') || '[]');
                            existingCourses.push(courseWithId);
                            cursos.push(courseWithId);
                            localStorage.setItem('cursos', JSON.stringify(existingCourses));
                        imported++;
                                }
                            } catch (err) {
                                console.error('Erro ao processar linha:', err);
                                errors.push(`Linha ${i + 1}: ${err.message || 'Erro ao processar'}`);
                            }
                        }
                        
                        // Pequeno delay entre lotes para não sobrecarregar
                        if (i + batchSize < json.length) {
                            await new Promise(resolve => setTimeout(resolve, 50));
                        }
                    }

                    // Sempre remover loading primeiro
                    setLoadingState(false);

                    if (imported > 0) {
                        let message = `${imported} curso${imported !== 1 ? 's' : ''} importado${imported !== 1 ? 's' : ''} com sucesso!`;
                        if (errors.length > 0) {
                            message += ` (${errors.length} erro${errors.length !== 1 ? 's' : ''})`;
                        }
                        showToast(message, errors.length > 0 ? 'warning' : 'success');
                        logActivity('Importação', `Importou ${imported} curso${imported !== 1 ? 's' : ''} de planilha`, 'add');
                        
                        // Atualizar KPIs e renderizações de forma otimizada
                        requestAnimationFrame(() => {
                        updateKPIs();
                        renderCalendar();
                        renderDashboardReport();
                        if (document.getElementById('coursesPage')?.classList.contains('active')) {
                            renderCoursesByLote();
                        }
                        });
                        
                        // Se Firebase, aguardar atualização completa do banco
                        if (firebaseAvailable) {
                            setTimeout(() => {
                                loadData();
                            }, 1000);
                    } else {
                            // Atualizar dados locais
                            loadFromLocalStorage();
                    }
                    } else {
                        if (json.length === 0) {
                            showToast('Planilha vazia ou formato inválido. Verifique o arquivo.', 'error');
                    } else {
                        showToast('Nenhum curso foi importado. Verifique o formato da planilha.', 'warning');
                        }
                    }
                    
                    // Limpar o input de arquivo
                    const excelFileInput = document.getElementById('excelFileInput');
                    if (excelFileInput) {
                        excelFileInput.value = '';
                    }
                    const fileInfoBox = document.getElementById('fileInfoBox');
                    if (fileInfoBox) {
                        fileInfoBox.classList.remove('show');
                    }
                } catch (error) {
                    console.error('Error importing:', error);
                    setLoadingState(false); // Garantir que o loading seja removido mesmo em caso de erro
                    showToast('Erro ao importar arquivo: ' + (error.message || 'Erro desconhecido'), 'error');
                    
                    // Limpar o input de arquivo mesmo em caso de erro
                    const excelFileInput = document.getElementById('excelFileInput');
                    if (excelFileInput) {
                        excelFileInput.value = '';
                    }
                    const fileInfoBox = document.getElementById('fileInfoBox');
                    if (fileInfoBox) {
                        fileInfoBox.classList.remove('show');
                    }
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function formatExcelDate(value) {
            if (!value && value !== 0) return '';
            
            // Se for número (serial date do Excel)
            if (typeof value === 'number') {
                try {
                    // Excel serial date: número de dias desde 1/1/1900
                    // Excel usa 1/1/1900 como dia 1, mas JavaScript usa 1/1/1970 como epoch
                    // Ajuste: Excel epoch é 25569 dias antes do Unix epoch
                    const excelEpoch = new Date(1899, 11, 30); // 30/12/1899 (dia 0 do Excel)
                    const millisecondsPerDay = 86400 * 1000;
                    
                    // Validar se o número é razoável (entre 1 e 100000, que cobre de 1900 a ~2173)
                    if (value < 1 || value > 100000) {
                        console.warn('Valor de data Excel fora do range esperado:', value);
                        return '';
                    }
                    
                    const date = new Date(excelEpoch.getTime() + (value - 1) * millisecondsPerDay);
                    
                    // Verificar se a data é válida
                    if (!isNaN(date.getTime()) && date.getFullYear() >= 1900 && date.getFullYear() <= 2100) {
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        return `${year}-${month}-${day}`;
                    } else {
                        console.warn('Data inválida gerada:', date, 'do valor:', value);
                    }
                } catch (e) {
                    console.warn('Erro ao converter data numérica:', value, e);
                }
            }
            
            // Se for string, tentar vários formatos
            if (typeof value === 'string') {
                const trimmed = value.trim();
                if (!trimmed) return '';
                
                // Remover caracteres estranhos que podem aparecer
                const cleaned = trimmed.replace(/[^\d\/\-\.]/g, '');
                
                // Formato brasileiro: DD/MM/YYYY ou DD-MM-YYYY
                const brFormat = cleaned.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
                if (brFormat) {
                    let day = brFormat[1].padStart(2, '0');
                    let month = brFormat[2].padStart(2, '0');
                    let year = brFormat[3];
                    if (year.length === 2) {
                        year = '20' + year; // Assume século 21
                    }
                    // Validar valores
                    const dayNum = parseInt(day);
                    const monthNum = parseInt(month);
                    const yearNum = parseInt(year);
                    if (dayNum >= 1 && dayNum <= 31 && monthNum >= 1 && monthNum <= 12 && yearNum >= 1900 && yearNum <= 2100) {
                        const date = new Date(`${year}-${month}-${day}`);
                        if (!isNaN(date.getTime())) {
                    return date.toISOString().split('T')[0];
                }
                    }
                }
                
                // Formato ISO: YYYY-MM-DD
                const isoFormat = cleaned.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
                if (isoFormat) {
                    const year = isoFormat[1];
                    const month = isoFormat[2].padStart(2, '0');
                    const day = isoFormat[3].padStart(2, '0');
                    const date = new Date(`${year}-${month}-${day}`);
                    if (!isNaN(date.getTime())) {
                        return date.toISOString().split('T')[0];
                    }
                }
                
                // Tentar parse direto (pode ser uma data já formatada)
                try {
                    const date = new Date(trimmed);
                    if (!isNaN(date.getTime()) && date.getFullYear() >= 1900 && date.getFullYear() <= 2100) {
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        return `${year}-${month}-${day}`;
                    }
                } catch (e) {
                    console.warn('Erro ao fazer parse da data:', trimmed, e);
                }
            }
            
            // Se chegou aqui, não conseguiu converter
            console.warn('Não foi possível converter a data:', value, typeof value);
            return '';
        }
        
        // Função para importar instrutores
        async function handleInstructorsUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Validar tipo de arquivo
            const validTypes = ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 
                               'application/vnd.ms-excel',
                               'application/excel'];
            const validExtensions = ['.xlsx', '.xls'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            
            if (!validTypes.includes(file.type) && !validExtensions.includes(fileExtension)) {
                showToast('Por favor, selecione um arquivo Excel (.xlsx ou .xls)', 'error');
                return;
            }
            
            // Validar tamanho (máximo 10MB)
            if (file.size > 10 * 1024 * 1024) {
                showToast('Arquivo muito grande. Tamanho máximo: 10MB', 'error');
                return;
            }
            
            // Mostrar loading
            setLoadingState(true);
            showToast('Processando arquivo de instrutores...', 'info');
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    // Usar cellDates: true para converter datas automaticamente
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    // raw: false converte valores, mas mantém datas como objetos Date quando possível
                    const json = XLSX.utils.sheet_to_json(worksheet, { raw: false, defval: '' });
                    
                    let imported = 0;
                    let errors = [];
                    
                    for (let i = 0; i < json.length; i++) {
                        const row = json[i];
                        try {
                            const nome = (row['NOME'] || row['nome'] || '').trim();
                            const telefone = (row['TELEFONE'] || row['telefone'] || '').trim();
                            
                            // Validar que pelo menos o nome foi fornecido
                            if (!nome) {
                                errors.push(`Linha ${i + 2}: Nome não fornecido`);
                                continue;
                            }
                            
                            const instructorData = {
                                nome: nome,
                                telefone: telefone,
                                especialidade: '',
                                email: ''
                            };
                            
                            if (firebaseAvailable) {
                                try {
                                    await db.collection('instrutores').add(instructorData);
                                    imported++;
                                } catch (err) {
                                    console.error('Erro ao adicionar instrutor no Firebase:', err);
                                    errors.push(`Linha ${i + 2}: ${err.message || 'Erro desconhecido'}`);
                                }
                            } else {
                                const existingInstructors = JSON.parse(localStorage.getItem('instrutores') || '[]');
                                instructorData.id = 'instructor_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9) + '_' + imported;
                                existingInstructors.push(instructorData);
                                instrutores.push(instructorData);
                                localStorage.setItem('instrutores', JSON.stringify(existingInstructors));
                                imported++;
                            }
                        } catch (err) {
                            console.error('Erro ao processar linha:', err);
                            errors.push(`Linha ${i + 2}: ${err.message || 'Erro ao processar'}`);
                        }
                    }
                    
                    // Sempre remover loading primeiro
                    setLoadingState(false);
                    
                    if (imported > 0) {
                        let message = `${imported} instrutor${imported !== 1 ? 'es' : ''} importado${imported !== 1 ? 's' : ''} com sucesso!`;
                        if (errors.length > 0) {
                            message += ` (${errors.length} erro${errors.length !== 1 ? 's' : ''})`;
                        }
                        showToast(message, errors.length > 0 ? 'warning' : 'success');
                        logActivity('Importação de Instrutores', `Importou ${imported} instrutor${imported !== 1 ? 'es' : ''} de planilha`, 'add');
                        
                        // Atualizar renderização
                        requestAnimationFrame(() => {
                            renderInstructors();
                            updateInstructorSelect();
                        });
                        
                        // Se Firebase, aguardar atualização completa do banco
                        if (firebaseAvailable) {
                            setTimeout(() => {
                                loadData();
                            }, 1000);
                        } else {
                            loadFromLocalStorage();
                        }
                    } else {
                        if (json.length === 0) {
                            showToast('Planilha vazia ou formato inválido. Verifique o arquivo.', 'error');
                        } else {
                            showToast('Nenhum instrutor foi importado. Verifique o formato da planilha (colunas: NOME, TELEFONE).', 'warning');
                        }
                    }
                    
                    // Limpar o input de arquivo
                    const instructorsFileInput = document.getElementById('instructorsFileInput');
                    if (instructorsFileInput) {
                        instructorsFileInput.value = '';
                    }
                } catch (error) {
                    console.error('Error importing instructors:', error);
                    setLoadingState(false);
                    showToast('Erro ao importar arquivo: ' + (error.message || 'Erro desconhecido'), 'error');
                    
                    // Limpar o input de arquivo mesmo em caso de erro
                    const instructorsFileInput = document.getElementById('instructorsFileInput');
                    if (instructorsFileInput) {
                        instructorsFileInput.value = '';
                    }
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function exportCoursesToCsv() {
            const activeCourses = cursos;
            
            const headers = ['CURSO', 'ID', 'LOTE-RESPONSÁVEL', 'CARGA HORÁRIA', 'CIDADE/MUNICÍPIO', 'INÍCIO', 'FIM', 'CONCLUDENTES', 'LOCAL DO CURSO', 'INSTRUTOR', 'STATUS', 'GOOGLE DRIVE', 'OBSERVAÇÃO'];
            const rows = activeCourses.map(c => [
                c.curso || '',
                c.idLote || '',
                c.loteResponsavel || '',
                c.cargaHoraria || '',
                c.cidade || '',
                c.inicio || '',
                c.fim || '',
                c.alunos || 0,
                c.local || '',
                c.instrutor || '',
                c.status || '',
                c.driveLink || '',
                c.nota || ''
            ]);

            downloadCsv([headers, ...rows], 'cursos.csv');
            showToast(`${activeCourses.length} curso(s) exportado(s)!`, 'success');
        }
        
        // Exportação avançada para Excel
        function exportCoursesToExcel() {
            const activeCourses = cursos;
            
            const data = activeCourses.map(c => ({
                'CURSO': c.curso || '',
                'ID': c.idLote || '',
                'LOTE-RESPONSÁVEL': c.loteResponsavel || '',
                'CARGA HORÁRIA': c.cargaHoraria || '',
                'CIDADE/MUNICÍPIO': c.cidade || '',
                'INÍCIO': c.inicio || '',
                'FIM': c.fim || '',
                'CONCLUDENTES': c.alunos || 0,
                'LOCAL DO CURSO': c.local || '',
                'INSTRUTOR': c.instrutor || '',
                'STATUS': c.status || '',
                'GOOGLE DRIVE': c.driveLink || '',
                'OBSERVAÇÃO': c.nota || ''
            }));
            
            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Cursos');
            
            // Ajustar largura das colunas
            const colWidths = [
                { wch: 30 }, // CURSO
                { wch: 10 }, // ID
                { wch: 20 }, // LOTE
                { wch: 12 }, // CARGA HORÁRIA
                { wch: 20 }, // CIDADE
                { wch: 12 }, // INÍCIO
                { wch: 12 }, // FIM
                { wch: 12 }, // CONCLUDENTES
                { wch: 30 }, // LOCAL
                { wch: 25 }, // INSTRUTOR
                { wch: 15 }, // STATUS
                { wch: 40 }, // GOOGLE DRIVE
                { wch: 40 }  // OBSERVAÇÃO
            ];
            worksheet['!cols'] = colWidths;
            
            XLSX.writeFile(workbook, `cursos_${new Date().toISOString().split('T')[0]}.xlsx`);
            showToast(`${activeCourses.length} curso(s) exportado(s) para Excel!`, 'success');
        }
        
        // Exportação para PDF
        async function exportCoursesToPDF() {
            const activeCourses = cursos;
            
            if (!window.html2canvas) {
                showToast('Biblioteca html2canvas não carregada. Recarregue a página.', 'error');
                return;
            }
            
            showToast('Gerando PDF...', 'info');
            
            try {
                // Criar elemento temporário com os dados
                const tempDiv = document.createElement('div');
                tempDiv.style.cssText = 'position: absolute; left: -9999px; width: 210mm; padding: 20mm; background: white; color: black; font-family: Arial, sans-serif;';
                
                tempDiv.innerHTML = `
                    <h1 style="text-align: center; margin-bottom: 2rem;">Relatório de Cursos</h1>
                    <p style="margin-bottom: 1rem;"><strong>Data:</strong> ${new Date().toLocaleDateString('pt-BR')}</p>
                    <p style="margin-bottom: 2rem;"><strong>Total de Cursos:</strong> ${activeCourses.length}</p>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                        <thead>
                            <tr style="background: #f0f0f0;">
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Curso</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">ID</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Cidade</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Status</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Concludentes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${activeCourses.map(c => `
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${c.curso || ''}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${c.idLote || ''}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${c.cidade || ''}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${c.status || ''}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${c.alunos || 0}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                document.body.appendChild(tempDiv);
                
                const canvas = await html2canvas(tempDiv, {
                    scale: 2,
                    useCORS: true,
                    logging: false
                });
                
                document.body.removeChild(tempDiv);
                
                const imgData = canvas.toDataURL('image/png');
                const pdf = window.jsPDF || null;
                
                if (!pdf) {
                    // Se jsPDF não estiver disponível, baixar como PNG
                    const link = document.createElement('a');
                    link.href = imgData;
                    link.download = `cursos_${new Date().toISOString().split('T')[0]}.png`;
                    link.click();
                    showToast('Imagem gerada! (Instale jsPDF para gerar PDF)', 'info');
                } else {
                    const pdfDoc = new pdf('p', 'mm', 'a4');
                    const imgWidth = 210;
                    const pageHeight = 297;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;
                    
                    pdfDoc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                    
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdfDoc.addPage();
                        pdfDoc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    
                    pdfDoc.save(`cursos_${new Date().toISOString().split('T')[0]}.pdf`);
                    showToast('PDF gerado com sucesso!', 'success');
                }
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                showToast('Erro ao gerar PDF: ' + (error.message || 'Erro desconhecido'), 'error');
            }
        }

        function exportInstructorsToCsv() {
            const headers = ['NOME', 'ESPECIALIDADE', 'TELEFONE', 'EMAIL'];
            const rows = instrutores.map(i => [
                i.nome || '',
                i.especialidade || '',
                i.telefone || '',
                i.email || ''
            ]);

            downloadCsv([headers, ...rows], 'instrutores.csv');
            showToast('Instrutores exportados!', 'success');
        }

        function downloadCsv(data, filename) {
            const csv = data.map(row => 
                row.map(cell => {
                    const escapedCell = String(cell).replace(/"/g, '""');
                    return `"${escapedCell}"`;
                }).join(',')
            ).join('\n');
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        async function clearAllData() {
            if (!confirm('ATENÇÃO: Esta ação irá excluir TODOS os cursos e instrutores. Deseja continuar?')) return;
            if (!confirm('Tem certeza absoluta? Esta ação não pode ser desfeita!')) return;

            try {
                if (firebaseAvailable) {
                    const coursesSnapshot = await db.collection('cursos').get();
                    const instructorsSnapshot = await db.collection('instrutores').get();

                    const batch = db.batch();
                    coursesSnapshot.docs.forEach(doc => batch.delete(doc.ref));
                    instructorsSnapshot.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                } else {
                    localStorage.setItem('cursos', JSON.stringify([]));
                    localStorage.setItem('instrutores', JSON.stringify([]));
                }

                showToast('Todos os dados foram excluídos!', 'success');
                logActivity('Limpeza de Dados', 'Excluiu todos os cursos e instrutores', 'delete');
                loadData();
            } catch (error) {
                console.error('Error clearing data:', error);
                showToast('Erro ao limpar dados', 'error');
            }
        }

        function openReportModal() {
            generateReport();
            document.getElementById('reportModal').classList.add('active');
        }

        function generateReport() {
            // Mostrar todos os cursos (sem filtro de período)
            let coursesToReport = [...cursos];
            
            const total = coursesToReport.length;
            const concluidos = coursesToReport.filter(c => normalizeStatus(c.status) === 'Concluído').length;
            const andamento = coursesToReport.filter(c => normalizeStatus(c.status) === 'Em Andamento').length;
            const pendentes = coursesToReport.filter(c => normalizeStatus(c.status) === 'Pendente').length;
            const cancelados = coursesToReport.filter(c => normalizeStatus(c.status) === 'Cancelado').length;
            const totalAlunos = coursesToReport.reduce((sum, c) => sum + (parseInt(c.alunos) || 0), 0);

            const today = new Date();
            const reportDate = today.toLocaleDateString('pt-BR', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            // Cursos por cidade
            const cursosporCidade = {};
            coursesToReport.forEach(c => {
                const cidade = c.cidade || 'Não definido';
                cursosporCidade[cidade] = (cursosporCidade[cidade] || 0) + 1;
            });

            document.getElementById('reportContent').innerHTML = `
                <div class="report-header">
                    <h2>
                        <span class="material-icons" style="color: var(--primary);">assessment</span>
                        Ceará Sem Fome + Qualificação e Renda - Relatório de Cursos
                    </h2>
                    <p>${reportDate}</p>
                </div>

                <div class="report-kpi-grid">
                    <div class="report-kpi-card purple">
                        <div class="report-kpi-value">${total}</div>
                        <div class="report-kpi-label">Total de Cursos</div>
                    </div>
                    <div class="report-kpi-card green">
                        <div class="report-kpi-value">${concluidos}</div>
                        <div class="report-kpi-label">Concluídos</div>
                    </div>
                    <div class="report-kpi-card blue">
                        <div class="report-kpi-value">${andamento}</div>
                        <div class="report-kpi-label">Em Andamento</div>
                    </div>
                    <div class="report-kpi-card yellow">
                        <div class="report-kpi-value">${pendentes}</div>
                        <div class="report-kpi-label">Pendentes</div>
                    </div>
                    <div class="report-kpi-card red">
                        <div class="report-kpi-value">${cancelados}</div>
                        <div class="report-kpi-label">Cancelados</div>
                    </div>
                    <div class="report-kpi-card">
                        <div class="report-kpi-value">${totalAlunos}</div>
                        <div class="report-kpi-label">Concludentes</div>
                    </div>
                </div>

                <div class="report-section">
                    <h3>
                        <span class="material-icons">pie_chart</span>
                        Distribuição por Status
                    </h3>
                    <div class="report-chart">
                        <canvas id="statusChart" width="280" height="280"></canvas>
                    </div>
                </div>

                <div class="report-section">
                    <h3>
                        <span class="material-icons">location_city</span>
                        Cursos por Cidade
                    </h3>
                    <div class="report-city-grid">
                        ${Object.entries(cursosporCidade).map(([cidade, qtd]) => `
                            <div class="report-city-item">
                                <span class="report-city-name">${cidade}</span>
                                <span class="report-city-count">${qtd}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="report-section">
                    <h3>
                        <span class="material-icons">list</span>
                        Lista de Cursos ${coursesToReport.length > 15 ? '(Primeiros 15)' : ''}
                    </h3>
                    <table class="report-table">
                        <tr>
                            <th>Curso</th>
                            <th>Cidade</th>
                            <th>Período</th>
                            <th>Status</th>
                        </tr>
                        ${coursesToReport.slice(0, 15).map(c => `
                            <tr>
                                <td>${c.curso || 'N/A'}</td>
                                <td>${c.cidade || 'N/A'}</td>
                                <td>${formatDate(c.inicio)} - ${formatDate(c.fim)}</td>
                                <td>${c.status || 'Pendente'}</td>
                            </tr>
                        `).join('')}
                        ${cursos.length > 15 ? `<tr><td colspan="4" style="text-align: center; opacity: 0.7;">... e mais ${cursos.length - 15} cursos</td></tr>` : ''}
                    </table>
                </div>
            `;

            setTimeout(() => {
                const ctx = document.getElementById('statusChart')?.getContext('2d');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Concluídos', 'Em Andamento', 'Pendentes', 'Cancelados'],
                            datasets: [{
                                data: [concluidos, andamento, pendentes, cancelados],
                                backgroundColor: ['#34d399', '#60a5fa', '#fbbf24', '#f87171'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: false,
                            maintainAspectRatio: false,
                            cutout: '60%',
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        color: '#ffffff',
                                        padding: 15,
                                        font: {
                                            size: 12
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }, 100);
        }

        async function downloadReportAsImage() {
            // Tentar encontrar o relatório no dashboard primeiro
            let element = document.getElementById('dashboardReport');
            
            // Se não encontrar ou estiver vazio, tentar no modal
            if (!element || !element.innerHTML.trim()) {
                element = document.getElementById('reportContent');
            }
            
            if (!element || !element.innerHTML.trim()) {
                showToast('Relatório não encontrado. Gere o relatório primeiro.', 'warning');
                return;
            }
            
            try {
                setLoadingState(true);
                showToast('Gerando relatório...', 'info');
                
                // Aguardar um pouco para garantir que o conteúdo está renderizado
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Verificar se html2canvas está disponível
                if (typeof html2canvas === 'undefined') {
                    showToast('Biblioteca html2canvas não carregada. Recarregue a página.', 'error');
                    setLoadingState(false);
                    return;
                }
                
                const isLightMode = document.documentElement.classList.contains('light-mode');
                const canvas = await html2canvas(element, {
                    backgroundColor: isLightMode ? '#f8fafc' : '#0f172a',
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    allowTaint: true,
                    windowWidth: element.scrollWidth,
                    windowHeight: element.scrollHeight
                });
                
                const link = document.createElement('a');
                const date = new Date().toISOString().split('T')[0];
                link.download = `relatorio-cursos-${date}.png`;
                link.href = canvas.toDataURL('image/png');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast('Relatório baixado com sucesso!', 'success');
            } catch (error) {
                console.error('Error generating image:', error);
                showToast('Erro ao gerar imagem: ' + (error.message || 'Erro desconhecido'), 'error');
            } finally {
                setLoadingState(false);
            }
        }

        // Utility Functions
        function formatDate(dateStr) {
            if (!dateStr) return 'Não informado';
            
            // Se já estiver no formato brasileiro, retornar como está
            if (typeof dateStr === 'string' && /^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) {
                return dateStr;
            }
            
            try {
                // Tentar formato ISO (YYYY-MM-DD)
                if (typeof dateStr === 'string' && dateStr.includes('-')) {
                    const parts = dateStr.split('-');
                    if (parts.length === 3) {
                        const [year, month, day] = parts;
                        // Validar se são números válidos
                        const yearNum = parseInt(year);
                        const monthNum = parseInt(month);
                        const dayNum = parseInt(day);
                        
                        if (!isNaN(yearNum) && !isNaN(monthNum) && !isNaN(dayNum) &&
                            yearNum >= 1900 && yearNum <= 2100 &&
                            monthNum >= 1 && monthNum <= 12 &&
                            dayNum >= 1 && dayNum <= 31) {
                return `${day.padStart(2, '0')}/${month.padStart(2, '0')}/${year}`;
                        }
                    }
                }
                
                // Tentar parse como Date
                const date = new Date(dateStr);
                if (!isNaN(date.getTime()) && date.getFullYear() >= 1900 && date.getFullYear() <= 2100) {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${day}/${month}/${year}`;
                }
            } catch (e) {
                console.warn('Erro ao formatar data:', dateStr, e);
            }
            
            // Se não conseguiu formatar, retornar "Não informado" em vez do valor original
            return 'Não informado';
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleString('pt-BR');
        }

        function normalizeStatus(status) {
            if (!status) return 'Pendente';
            // Normalizar: remover espaços extras, converter para primeira letra maiúscula
            const normalized = status.toString().trim();
            
            // Mapear variações comuns
            const statusMap = {
                'concluido': 'Concluído',
                'concluído': 'Concluído',
                'concluida': 'Concluído',
                'concluída': 'Concluído',
                'concluidos': 'Concluído',
                'concluídos': 'Concluído',
                'concluido ': 'Concluído',
                'concluído ': 'Concluído',
                'em andamento': 'Em Andamento',
                'em andamento ': 'Em Andamento',
                'andamento': 'Em Andamento',
                'pendente': 'Pendente',
                'pendente ': 'Pendente',
                'cancelado': 'Cancelado',
                'cancelada': 'Cancelado',
                'cancelados': 'Cancelado',
                'canceladas': 'Cancelado',
                'cancelado ': 'Cancelado'
            };
            
            const lower = normalized.toLowerCase();
            if (statusMap[lower]) {
                return statusMap[lower];
            }
            
            // Se já está no formato correto, retornar como está
            if (['Concluído', 'Em Andamento', 'Pendente', 'Cancelado'].includes(normalized)) {
                return normalized;
            }
            
            // Tentar capitalizar primeira letra de cada palavra
            return normalized.split(' ').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
            ).join(' ');
        }

        function getStatusClass(status) {
            const normalized = normalizeStatus(status);
            const classes = {
                'Concluído': 'concluido',
                'Em Andamento': 'andamento',
                'Pendente': 'pendente',
                'Cancelado': 'cancelado'
            };
            return classes[normalized] || 'pendente';
        }

        /**
         * Sistema de Notificações Avançado
         * @param {string} message - Mensagem principal
         * @param {string} type - Tipo: 'success', 'error', 'warning', 'info'
         * @param {Object} options - Opções adicionais
         * @param {string} options.title - Título da notificação
         * @param {number} options.duration - Duração em ms (0 = persistente)
         * @param {boolean} options.showProgress - Mostrar barra de progresso
         * @param {boolean} options.playSound - Tocar som
         * @param {Array} options.actions - Botões de ação [{label, onClick, style}]
         * @param {Function} options.onClose - Callback ao fechar
         * @param {boolean} options.dismissible - Pode ser fechado (default: true)
         */
        function showToast(message, type = 'success', options = {}) {
            const container = document.getElementById('toastContainer');
            if (!container) return null;
            
            const {
                title = '',
                duration = 5000,
                showProgress = true,
                playSound = false,
                actions = [],
                onClose = null,
                dismissible = true
            } = options;
            
            // Limitar número de toasts visíveis (máximo 5)
            const existingToasts = container.querySelectorAll('.toast');
            if (existingToasts.length >= 5) {
                existingToasts[0].remove();
            }
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'check_circle',
                error: 'error',
                warning: 'warning',
                info: 'info'
            };
            
            const titles = {
                success: 'Sucesso',
                error: 'Erro',
                warning: 'Atenção',
                info: 'Informação'
            };
            
            const toastId = 'toast-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);
            toast.id = toastId;
            
            // Construir HTML do toast
            let actionsHTML = '';
            if (actions.length > 0) {
                actionsHTML = `<div class="toast-actions" style="display: flex; gap: 8px; margin-top: 10px;">
                    ${actions.map((action, i) => `
                        <button class="toast-action-btn" data-action-index="${i}" style="
                            padding: 6px 12px;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 0.8rem;
                            font-weight: 500;
                            background: ${action.style === 'primary' ? 'var(--primary)' : 'var(--surface-hover)'};
                            color: ${action.style === 'primary' ? 'white' : 'var(--text-primary)'};
                            transition: all 0.2s;
                        ">${action.label}</button>
                    `).join('')}
                </div>`;
            }
            
            const displayTitle = title || titles[type] || '';
            
            toast.innerHTML = `
                <span class="material-icons">${icons[type] || icons.success}</span>
                <div class="toast-content" style="flex: 1; min-width: 0;">
                    ${displayTitle ? `<div class="toast-title" style="font-weight: 600; margin-bottom: 4px; color: var(--text-primary);">${displayTitle}</div>` : ''}
                    <div class="toast-message" style="word-wrap: break-word; line-height: 1.4;">${message}</div>
                    ${actionsHTML}
                </div>
                ${dismissible ? `
                    <button class="toast-close" title="Fechar">
                        <span class="material-icons" style="font-size: 18px;">close</span>
                    </button>
                ` : ''}
                ${showProgress && duration > 0 ? `
                    <div class="toast-progress" style="
                        position: absolute;
                        bottom: 0;
                        left: 0;
                        height: 3px;
                        background: currentColor;
                        opacity: 0.5;
                        width: 100%;
                        transform-origin: left;
                        animation: toastProgress ${duration}ms linear forwards;
                    "></div>
                ` : ''}
            `;
            
            container.appendChild(toast);
            
            // Adicionar keyframe para barra de progresso (se não existir)
            if (!document.getElementById('toast-progress-style')) {
                const style = document.createElement('style');
                style.id = 'toast-progress-style';
                style.textContent = `
                    @keyframes toastProgress {
                        from { transform: scaleX(1); }
                        to { transform: scaleX(0); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Som de notificação
            if (playSound) {
                try {
                    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioCtx.createOscillator();
                    const gainNode = audioCtx.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(audioCtx.destination);
                    oscillator.frequency.value = type === 'error' ? 300 : type === 'warning' ? 400 : 600;
                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.3);
                } catch (e) { /* Ignorar erros de áudio */ }
            }
            
            // Animar entrada
            requestAnimationFrame(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(0)';
            });
            
            // Função para fechar o toast
            const closeToast = () => {
                if (toast.parentNode) {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(120%)';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.remove();
                            if (onClose) onClose();
                        }
                    }, 400);
                }
            };
            
            // Configurar timeout (se duration > 0)
            let timeoutId = null;
            if (duration > 0) {
                timeoutId = setTimeout(closeToast, duration);
            }
            
            // Pausar ao passar o mouse
            toast.addEventListener('mouseenter', () => {
                if (timeoutId) clearTimeout(timeoutId);
                const progress = toast.querySelector('.toast-progress');
                if (progress) progress.style.animationPlayState = 'paused';
            });
            
            toast.addEventListener('mouseleave', () => {
                if (duration > 0) {
                    timeoutId = setTimeout(closeToast, 2000);
                    const progress = toast.querySelector('.toast-progress');
                    if (progress) {
                        progress.style.animation = `toastProgress 2000ms linear forwards`;
                        progress.style.animationPlayState = 'running';
                    }
                }
            });
            
            // Botão fechar
            if (dismissible) {
                toast.querySelector('.toast-close').addEventListener('click', () => {
                    if (timeoutId) clearTimeout(timeoutId);
                    closeToast();
                });
            }
            
            // Event listeners para botões de ação
            actions.forEach((action, index) => {
                const btn = toast.querySelector(`[data-action-index="${index}"]`);
                if (btn && action.onClick) {
                    btn.addEventListener('click', () => {
                        action.onClick();
                        if (action.closeOnClick !== false) {
                            if (timeoutId) clearTimeout(timeoutId);
                            closeToast();
                        }
                    });
                }
            });
            
            // Retornar objeto com métodos de controle
            return {
                id: toastId,
                close: closeToast,
                element: toast
            };
        }
        
        // Atalhos úteis para notificações
        const notify = {
            success: (msg, opts) => showToast(msg, 'success', opts),
            error: (msg, opts) => showToast(msg, 'error', opts),
            warning: (msg, opts) => showToast(msg, 'warning', opts),
            info: (msg, opts) => showToast(msg, 'info', opts),
            
            // Notificação de confirmação com ações
            confirm: (message, onConfirm, onCancel) => showToast(message, 'warning', {
                title: 'Confirmação',
                duration: 0,
                dismissible: false,
                actions: [
                    { label: 'Confirmar', onClick: onConfirm, style: 'primary' },
                    { label: 'Cancelar', onClick: onCancel || (() => {}) }
                ]
            }),
            
            // Notificação de loading (persistente)
            loading: (message) => showToast(message, 'info', {
                title: 'Processando...',
                duration: 0,
                showProgress: false,
                dismissible: false
            })
        };
        
        // ========== SISTEMA DE HISTÓRICO DE NOTIFICAÇÕES ==========
        let notificationHistory = [];
        const MAX_NOTIFICATIONS = 50;
        
        // Salvar notificação no histórico
        function saveNotificationToHistory(message, type, title = '', courseId = null) {
            const notification = {
                id: 'notif-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5),
                message,
                type,
                title: title || { success: 'Sucesso', error: 'Erro', warning: 'Atenção', info: 'Informação' }[type] || 'Notificação',
                timestamp: new Date(),
                read: false,
                courseId: courseId
            };
            
            notificationHistory.unshift(notification);
            
            // Limitar histórico
            if (notificationHistory.length > MAX_NOTIFICATIONS) {
                notificationHistory = notificationHistory.slice(0, MAX_NOTIFICATIONS);
            }
            
            // Salvar no localStorage
            localStorage.setItem('notificationHistory', JSON.stringify(notificationHistory));
            
            updateNotificationBadge();
            return notification;
        }
        
        // Carregar histórico do localStorage
        function loadNotificationHistory() {
            try {
                const saved = localStorage.getItem('notificationHistory');
                if (saved) {
                    notificationHistory = JSON.parse(saved);
                    // Converter timestamps de string para Date
                    notificationHistory = notificationHistory.map(n => ({
                        ...n,
                        timestamp: new Date(n.timestamp)
                    }));
                }
            } catch (e) {
                notificationHistory = [];
            }
            updateNotificationBadge();
        }
        
        // Atualizar badge de notificações
        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            if (!badge) return;
            
            const unreadCount = notificationHistory.filter(n => !n.read).length;
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // Excluir notificação
        function deleteNotification(id) {
            notificationHistory = notificationHistory.filter(n => n.id !== id);
            localStorage.setItem('notificationHistory', JSON.stringify(notificationHistory));
            updateNotificationBadge();
            renderNotificationsPanel();
        }
        
        // Ação rápida: excluir notificação (botão X)
        function quickDeleteNotification(notifId) {
            deleteNotification(notifId);
            showToast('Notificação removida', 'info', { duration: 2000 });
        }
        
        // Ação rápida: marcar curso como concluído
        async function quickMarkAsCompleted(notifId, courseId) {
            try {
                const curso = cursos.find(c => c.id === courseId);
                if (!curso) {
                    showToast('Curso não encontrado', 'error');
                    return;
                }
                
                // Atualizar status para Concluído
                if (firebaseAvailable) {
                    await db.collection('cursos').doc(courseId).update({ status: 'Concluído' });
                } else {
                    const existingCourses = JSON.parse(localStorage.getItem('cursos') || '[]');
                    const index = existingCourses.findIndex(c => c.id === courseId);
                    if (index !== -1) {
                        existingCourses[index].status = 'Concluído';
                        localStorage.setItem('cursos', JSON.stringify(existingCourses));
                        loadFromLocalStorage();
                    }
                }
                
                // Excluir notificação
                deleteNotification(notifId);
                
                showToast(`Curso "${curso.curso || curso.lote}" marcado como concluído!`, 'success');
                logActivity('Curso Concluído', `Marcou "${curso.curso || curso.lote}" como concluído via notificação`, 'complete');
                
                // Atualizar visualização
                renderCoursesByLote();
                renderDashboardReport();
                
            } catch (error) {
                console.error('Erro ao marcar curso como concluído:', error);
                showToast('Erro ao atualizar curso', 'error');
            }
        }
        
        // Clique na notificação - exclui e abre curso se houver
        function handleNotificationClick(notifId, courseId) {
            // Excluir a notificação
            deleteNotification(notifId);
            
            if (courseId) {
                // Fechar painel de notificações
                document.getElementById('notificationsPanel')?.classList.remove('active');
                
                // Navegar para página de cursos
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                document.querySelector('[data-page="courses"]')?.classList.add('active');
                document.querySelectorAll('.page-section').forEach(page => page.classList.remove('active'));
                document.getElementById('coursesPage')?.classList.add('active');
                
                // Aguardar renderização e abrir modal do curso
                setTimeout(() => {
                    openCourseModal(courseId);
                }, 300);
            }
        }
        
        // Marcar todas como lidas
        function markAllNotificationsAsRead() {
            notificationHistory.forEach(n => n.read = true);
            localStorage.setItem('notificationHistory', JSON.stringify(notificationHistory));
            updateNotificationBadge();
            renderNotificationsPanel();
        }
        
        // Limpar histórico
        function clearNotificationHistory() {
            notificationHistory = [];
            localStorage.setItem('notificationHistory', JSON.stringify(notificationHistory));
            updateNotificationBadge();
            renderNotificationsPanel();
        }
        
        // Renderizar painel de notificações
        function renderNotificationsPanel() {
            const list = document.getElementById('notificationsList');
            if (!list) return;
            
            if (notificationHistory.length === 0) {
                list.innerHTML = `
                    <div class="empty-notifications" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                        <span class="material-icons" style="font-size: 48px; margin-bottom: 1rem; opacity: 0.5;">notifications_off</span>
                        <p>Nenhuma notificação</p>
                    </div>
                `;
                return;
            }
            
            const icons = {
                success: 'check_circle',
                error: 'error',
                warning: 'warning',
                info: 'info'
            };
            
            list.innerHTML = notificationHistory.map(n => {
                const timeAgo = getTimeAgo(n.timestamp);
                const hasCourse = n.courseId ? 'has-course' : '';
                const courseAttr = n.courseId ? `data-course-id="${n.courseId}"` : '';
                
                // Ações rápidas baseadas no tipo de notificação
                let quickActions = '';
                if (n.courseId) {
                    quickActions = `
                        <div class="notification-actions" onclick="event.stopPropagation()">
                            <button class="notif-action-btn primary" onclick="handleNotificationClick('${n.id}', '${n.courseId}')" title="Abrir curso">
                                <span class="material-icons">edit</span> Editar
                            </button>
                            <button class="notif-action-btn success" onclick="quickMarkAsCompleted('${n.id}', '${n.courseId}')" title="Marcar como concluído">
                                <span class="material-icons">check_circle</span> Concluir
                            </button>
                        </div>
                    `;
                }
                
                return `
                    <div class="notification-item ${n.type} ${n.read ? '' : 'unread'} ${hasCourse}" data-id="${n.id}" ${courseAttr}>
                        <button class="notif-delete-btn" onclick="event.stopPropagation(); quickDeleteNotification('${n.id}')" title="Excluir notificação">
                            <span class="material-icons">close</span>
                        </button>
                        <div class="notification-icon">
                            <span class="material-icons">${icons[n.type] || 'notifications'}</span>
                        </div>
                        <div class="notification-content">
                            <div class="notification-title">${n.title}</div>
                            <div class="notification-message">${n.message}</div>
                            <div class="notification-time">${timeAgo}</div>
                            ${quickActions}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Formatar tempo relativo
        function getTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Agora mesmo';
            if (minutes < 60) return `${minutes} min atrás`;
            if (hours < 24) return `${hours}h atrás`;
            if (days < 7) return `${days} dias atrás`;
            return date.toLocaleDateString('pt-BR');
        }
        
        // Toggle painel de notificações
        function toggleNotificationsPanel() {
            const panel = document.getElementById('notificationsPanel');
            if (panel) {
                panel.classList.toggle('active');
                if (panel.classList.contains('active')) {
                    renderNotificationsPanel();
                }
            }
        }
        
        // Inicializar sistema de notificações
        function initNotificationSystem() {
            loadNotificationHistory();
            
            // Botão de notificações na sidebar
            const bellBtn = document.getElementById('notificationBellBtn');
            if (bellBtn) {
                bellBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleNotificationsPanel();
                });
            }
            
            // Fechar painel de notificações
            const closeBtn = document.getElementById('closeNotificationsBtn');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    document.getElementById('notificationsPanel')?.classList.remove('active');
                });
            }
            
            // Fechar ao clicar fora
            document.addEventListener('click', (e) => {
                const panel = document.getElementById('notificationsPanel');
                const bellBtn = document.getElementById('notificationBellBtn');
                if (panel?.classList.contains('active') && !panel.contains(e.target) && !bellBtn?.contains(e.target)) {
                    panel.classList.remove('active');
                }
            });
            
            // Botão marcar todas como lidas
            const markAllBtn = document.getElementById('markAllReadBtn');
            if (markAllBtn) {
                markAllBtn.addEventListener('click', markAllNotificationsAsRead);
            }
            
            // Botão limpar histórico
            const clearBtn = document.getElementById('clearNotificationsBtn');
            if (clearBtn) {
                clearBtn.addEventListener('click', clearNotificationHistory);
            }
            
            // Verificar alertas automáticos ao iniciar (com delay maior para garantir que dados carregaram)
            setTimeout(() => {
                console.log('Verificando alertas automáticos... Cursos:', cursos.length);
                checkAutomaticAlerts();
            }, 5000);
            
            // Verificar alertas a cada 30 minutos
            setInterval(checkAutomaticAlerts, 30 * 60 * 1000);
        }
        
        // ========== ALERTAS AUTOMÁTICOS ==========
        let lastAlertCheck = null;
        
        function checkAutomaticAlerts(forceCheck = false) {
            if (!cursos || cursos.length === 0) return;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Evitar notificações duplicadas na mesma sessão (exceto se forçado)
            const sessionKey = 'alertsCheckedSession_' + today.toDateString();
            if (sessionStorage.getItem(sessionKey) && !forceCheck) return;
            
            sessionStorage.setItem(sessionKey, 'true');
            
            let alertas = {
                iniciandoHoje: [],
                iniciando3Dias: [],
                iniciando7Dias: [],
                vencendoHoje: [],
                vencendo3Dias: [],
                vencendo7Dias: [],
                atrasados: [],
                dadosIncompletos: [],
                emAndamentoSemFim: []
            };
            
            cursos.forEach(curso => {
                const status = normalizeStatus(curso.status);
                
                // Ignorar cursos já concluídos ou cancelados
                if (status === 'Concluído' || status === 'Cancelado') return;
                
                const inicioDate = curso.inicio ? new Date(curso.inicio) : null;
                const fimDate = curso.fim ? new Date(curso.fim) : null;
                
                // Verificar datas de início (apenas para cursos Pendentes)
                if (inicioDate && status === 'Pendente') {
                    inicioDate.setHours(0, 0, 0, 0);
                    const diffDaysInicio = Math.ceil((inicioDate - today) / (1000 * 60 * 60 * 24));
                    
                    if (diffDaysInicio === 0) {
                        alertas.iniciandoHoje.push(curso);
                    } else if (diffDaysInicio > 0 && diffDaysInicio <= 3) {
                        alertas.iniciando3Dias.push(curso);
                    } else if (diffDaysInicio > 3 && diffDaysInicio <= 7) {
                        alertas.iniciando7Dias.push(curso);
                    }
                }
                
                // Verificar datas de fim
                if (fimDate) {
                    fimDate.setHours(0, 0, 0, 0);
                    const diffDays = Math.ceil((fimDate - today) / (1000 * 60 * 60 * 24));
                    
                    if (diffDays < 0) {
                        alertas.atrasados.push(curso);
                    } else if (diffDays === 0) {
                        alertas.vencendoHoje.push(curso);
                    } else if (diffDays <= 3) {
                        alertas.vencendo3Dias.push(curso);
                    } else if (diffDays <= 7) {
                        alertas.vencendo7Dias.push(curso);
                    }
                }
                
                // Verificar dados incompletos em cursos Em Andamento ou Concluídos
                if (status === 'Em Andamento' || status === 'Concluído') {
                    const camposFaltando = [];
                    
                    if (!curso.instrutor || curso.instrutor.trim() === '' || curso.instrutor === 'Sem instrutor') {
                        camposFaltando.push('Instrutor');
                    }
                    if (!curso.local || curso.local.trim() === '') {
                        camposFaltando.push('Endereço');
                    }
                    if (!curso.cargaHoraria || curso.cargaHoraria.trim() === '') {
                        camposFaltando.push('Carga Horária');
                    }
                    
                    if (camposFaltando.length > 0) {
                        alertas.dadosIncompletos.push({
                            ...curso,
                            camposFaltando
                        });
                    }
                }
                
                // Cursos em andamento sem data de fim
                if (status === 'Em Andamento' && !curso.fim) {
                    alertas.emAndamentoSemFim.push(curso);
                }
            });
            
            // Função auxiliar para formatar data
            const formatDate = (date) => {
                if (!date) return '';
                const d = new Date(date);
                return d.toLocaleDateString('pt-BR');
            };
            
            // Gerar notificações individuais com link para o curso
            
            // Cursos iniciando
            alertas.iniciandoHoje.forEach(curso => {
                saveNotificationToHistory(
                    `Curso "${curso.curso || curso.lote}" inicia HOJE (${formatDate(curso.inicio)})`,
                    'info',
                    '🟢 Inicia Hoje',
                    curso.id
                );
            });
            
            alertas.iniciando3Dias.forEach(curso => {
                saveNotificationToHistory(
                    `Curso "${curso.curso || curso.lote}" inicia em ${formatDate(curso.inicio)}`,
                    'info',
                    '📅 Início Próximo',
                    curso.id
                );
            });
            
            alertas.iniciando7Dias.forEach(curso => {
                saveNotificationToHistory(
                    `Curso "${curso.curso || curso.lote}" inicia em ${formatDate(curso.inicio)}`,
                    'info',
                    '📅 Início em Breve',
                    curso.id
                );
            });
            
            // Cursos terminando
            alertas.atrasados.forEach(curso => {
                saveNotificationToHistory(
                    `Curso "${curso.curso || curso.lote}" está com prazo vencido! (${formatDate(curso.fim)})`,
                    'error',
                    '⚠️ Curso Atrasado',
                    curso.id
                );
            });
            
            alertas.vencendoHoje.forEach(curso => {
                saveNotificationToHistory(
                    `Curso "${curso.curso || curso.lote}" termina HOJE (${formatDate(curso.fim)})`,
                    'warning',
                    '🔴 Termina Hoje',
                    curso.id
                );
            });
            
            alertas.vencendo3Dias.forEach(curso => {
                saveNotificationToHistory(
                    `Curso "${curso.curso || curso.lote}" termina em ${formatDate(curso.fim)}`,
                    'warning',
                    '🟠 Término Próximo',
                    curso.id
                );
            });
            
            alertas.vencendo7Dias.forEach(curso => {
                saveNotificationToHistory(
                    `Curso "${curso.curso || curso.lote}" termina em ${formatDate(curso.fim)}`,
                    'info',
                    '📅 Término em Breve',
                    curso.id
                );
            });
            
            // Dados incompletos
            alertas.dadosIncompletos.forEach(curso => {
                saveNotificationToHistory(
                    `Curso "${curso.curso || curso.lote}" está faltando: ${curso.camposFaltando.join(', ')}`,
                    'warning',
                    '📋 Dados Incompletos',
                    curso.id
                );
            });
            
            alertas.emAndamentoSemFim.forEach(curso => {
                saveNotificationToHistory(
                    `Curso "${curso.curso || curso.lote}" em andamento sem data de término`,
                    'warning',
                    '📅 Sem Data de Término',
                    curso.id
                );
            });
            
            // Verificar eventos do calendário
            checkCalendarEventAlerts(today);
            
            // Verificar tarefas
            checkTaskAlerts(today);
            
            // Toast resumido
            const totalAlertas = alertas.atrasados.length + alertas.vencendoHoje.length + 
                                 alertas.vencendo3Dias.length + alertas.dadosIncompletos.length +
                                 alertas.iniciandoHoje.length + alertas.iniciando3Dias.length;
            
            if (totalAlertas > 0) {
                showToast(
                    `${totalAlertas} alerta(s) encontrado(s). Clique no sino para ver detalhes.`,
                    alertas.atrasados.length > 0 ? 'error' : 'warning',
                    { title: '🔔 Novos Alertas', duration: 8000, playSound: alertas.atrasados.length > 0 }
                );
            }
            
            console.log('Verificação de alertas automáticos concluída:', alertas);
        }
        
        // Função para forçar verificação manual
        function forceCheckAlerts() {
            // Limpar verificação da sessão atual
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const sessionKey = 'alertsCheckedSession_' + today.toDateString();
            sessionStorage.removeItem(sessionKey);
            
            // Forçar verificação
            checkAutomaticAlerts(true);
        }
        
        // Adicionar botão de atualizar notificações no painel
        function refreshNotifications() {
            forceCheckAlerts();
            showToast('Notificações atualizadas!', 'info', { duration: 2000 });
        }
        
        // Verificar alertas de eventos do calendário
        function checkCalendarEventAlerts(today) {
            if (!calendarEvents || calendarEvents.length === 0) return;
            
            const todayStr = today.toISOString().split('T')[0];
            
            calendarEvents.forEach(evento => {
                const eventDate = new Date(evento.date + 'T00:00:00');
                eventDate.setHours(0, 0, 0, 0);
                
                const diffDays = Math.ceil((eventDate - today) / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) {
                    // Evento é hoje
                    saveNotificationToHistory(
                        `Evento "${evento.title}" é HOJE!${evento.description ? ' - ' + evento.description : ''}`,
                        'warning',
                        '📌 Evento Hoje',
                        null
                    );
                } else if (diffDays === 1) {
                    // Evento é amanhã
                    saveNotificationToHistory(
                        `Evento "${evento.title}" é amanhã (${formatDateBR(evento.date)})`,
                        'info',
                        '📅 Evento Amanhã',
                        null
                    );
                } else if (diffDays > 1 && diffDays <= 3) {
                    // Evento nos próximos 3 dias
                    saveNotificationToHistory(
                        `Evento "${evento.title}" em ${formatDateBR(evento.date)}`,
                        'info',
                        '📅 Evento Próximo',
                        null
                    );
                }
            });
        }
        
        // ==================== SISTEMA DE TAREFAS ====================
        let currentTaskFilter = 'all';
        let editingTaskId = null;
        
        // Obter ID do usuário atual para tarefas
        function getTasksUserId() {
            return currentUser?.id || 'anonymous';
        }
        
        function saveTasks() {
            const userId = getTasksUserId();
            // Salvar também no localStorage como backup
            localStorage.setItem(`tasks_${userId}`, JSON.stringify(tasks));
            updateTaskBadge();
            updateTaskStats();
        }
        
        function generateTaskId() {
            return 'task-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }
        
        // Criar nova tarefa
        function createTask(taskData) {
            const userId = getTasksUserId();
            const task = {
                id: generateTaskId(),
                userId: userId,
                title: taskData.title,
                description: taskData.description || '',
                dueDate: taskData.dueDate,
                dueTime: taskData.dueTime || '',
                priority: taskData.priority || 'medium',
                category: taskData.category || 'geral',
                subtasks: taskData.subtasks || [],
                completed: false,
                completedAt: null,
                createdAt: new Date().toISOString(),
                reminders: taskData.reminders || []
            };
            
            if (firebaseAvailable) {
                db.collection('tasks').doc(task.id).set(task)
                    .then(() => {
                        saveTasks();
                    })
                    .catch(error => {
                        console.error('Erro ao salvar tarefa:', error);
                        tasks.push(task);
                        saveTasks();
                        renderTasks();
                    });
            } else {
                tasks.push(task);
                saveTasks();
                renderTasks();
            }
            return task;
        }
        
        // Atualizar tarefa
        function updateTask(taskId, updates) {
            const index = tasks.findIndex(t => t.id === taskId);
            if (index !== -1) {
                const updatedTask = { ...tasks[index], ...updates, updatedAt: new Date().toISOString() };
                tasks[index] = updatedTask;
                
                if (firebaseAvailable) {
                    db.collection('tasks').doc(taskId).set(updatedTask)
                        .then(() => {
                            console.log('✅ Tarefa atualizada no Firebase');
                            saveTasks();
                        })
                        .catch(error => {
                            console.error('Erro ao atualizar tarefa:', error);
                            saveTasks();
                            renderTasks();
                        });
                } else {
                    saveTasks();
                    renderTasks();
                }
            }
        }
        
        // Excluir tarefa
        function deleteTask(taskId) {
            if (!confirm('Deseja excluir esta tarefa?')) return;
            
            if (firebaseAvailable) {
                db.collection('tasks').doc(taskId).delete()
                    .then(() => {
                        tasks = tasks.filter(t => t.id !== taskId);
                        saveTasks();
                        showToast('Tarefa excluída', 'info');
                    })
                    .catch(error => {
                        console.error('Erro ao excluir tarefa:', error);
                        tasks = tasks.filter(t => t.id !== taskId);
                        saveTasks();
                        renderTasks();
                        showToast('Tarefa excluída', 'info');
                    });
            } else {
                tasks = tasks.filter(t => t.id !== taskId);
                saveTasks();
                renderTasks();
                showToast('Tarefa excluída', 'info');
            }
        }
        
        // Marcar tarefa como concluída
        function toggleTaskComplete(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            task.completed = !task.completed;
            task.completedAt = task.completed ? new Date().toISOString() : null;
            task.updatedAt = new Date().toISOString();
            
            if (task.completed) {
                // Animação de confete/celebração
                showTaskCompletedAnimation(task);
                showToast(`✓ Tarefa "${task.title}" concluída!`, 'success');
                logActivity('Tarefa Concluída', `Concluiu a tarefa "${task.title}"`, 'complete');
            }
            
            if (firebaseAvailable) {
                db.collection('tasks').doc(taskId).set(task)
                    .then(() => {
                        console.log('✅ Status da tarefa atualizado');
                        saveTasks();
                    })
                    .catch(error => {
                        console.error('Erro ao atualizar tarefa:', error);
                        saveTasks();
                        renderTasks();
                    });
            } else {
                saveTasks();
                renderTasks();
            }
        }
        
        // Toggle subtarefa
        function toggleSubtask(taskId, subtaskIndex) {
            const task = tasks.find(t => t.id === taskId);
            if (!task || !task.subtasks[subtaskIndex]) return;
            
            task.subtasks[subtaskIndex].completed = !task.subtasks[subtaskIndex].completed;
            
            // Verificar se todas subtarefas estão concluídas
            const allCompleted = task.subtasks.every(st => st.completed);
            if (allCompleted && task.subtasks.length > 0 && !task.completed) {
                if (confirm('Todas as subtarefas foram concluídas! Marcar a tarefa principal como concluída?')) {
                    task.completed = true;
                    task.completedAt = new Date().toISOString();
                    showTaskCompletedAnimation(task);
                    showToast(`✓ Tarefa "${task.title}" concluída!`, 'success');
                }
            }
            
            task.updatedAt = new Date().toISOString();
            
            if (firebaseAvailable) {
                db.collection('tasks').doc(taskId).set(task)
                    .then(() => {
                        console.log('✅ Subtarefa atualizada');
                        saveTasks();
                    })
                    .catch(error => {
                        console.error('Erro ao atualizar subtarefa:', error);
                        saveTasks();
                        renderTasks();
                    });
            } else {
                saveTasks();
                renderTasks();
            }
        }
        
        // Animação de tarefa concluída
        function showTaskCompletedAnimation(task) {
            const overlay = document.createElement('div');
            overlay.className = 'task-completed-overlay';
            overlay.innerHTML = `
                <div class="task-completed-content">
                    <div class="task-completed-icon">
                        <span class="material-icons">celebration</span>
                    </div>
                    <h3>Tarefa Concluída!</h3>
                    <p>${task.title}</p>
                </div>
            `;
            document.body.appendChild(overlay);
            
            setTimeout(() => {
                overlay.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                overlay.classList.remove('show');
                setTimeout(() => overlay.remove(), 300);
            }, 1500);
        }
        
        // Atualizar badge de tarefas pendentes
        function updateTaskBadge() {
            const badge = document.getElementById('taskPendingBadge');
            if (!badge) return;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const pendingToday = tasks.filter(t => {
                if (t.completed) return false;
                const dueDate = new Date(t.dueDate + 'T00:00:00');
                return dueDate <= today;
            }).length;
            
            if (pendingToday > 0) {
                badge.textContent = pendingToday > 99 ? '99+' : pendingToday;
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // Atualizar estatísticas
        function updateTaskStats() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];
            
            const weekEnd = new Date(today);
            weekEnd.setDate(weekEnd.getDate() + 7);
            
            const stats = {
                pending: tasks.filter(t => !t.completed).length,
                today: tasks.filter(t => !t.completed && t.dueDate === todayStr).length,
                overdue: tasks.filter(t => !t.completed && t.dueDate < todayStr).length,
                completed: tasks.filter(t => t.completed).length
            };
            
            document.getElementById('tasksPendingCount')?.textContent && (document.getElementById('tasksPendingCount').textContent = stats.pending);
            document.getElementById('tasksTodayCount')?.textContent && (document.getElementById('tasksTodayCount').textContent = stats.today);
            document.getElementById('tasksOverdueCount')?.textContent && (document.getElementById('tasksOverdueCount').textContent = stats.overdue);
            document.getElementById('tasksCompletedCount')?.textContent && (document.getElementById('tasksCompletedCount').textContent = stats.completed);
        }
        
        // Renderizar tarefas
        function renderTasks() {
            const container = document.getElementById('tasksContainer');
            if (!container) return;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];
            
            const weekEnd = new Date(today);
            weekEnd.setDate(weekEnd.getDate() + 7);
            const weekEndStr = weekEnd.toISOString().split('T')[0];
            
            // Filtrar tarefas
            let filteredTasks = [...tasks];
            
            switch (currentTaskFilter) {
                case 'today':
                    filteredTasks = tasks.filter(t => t.dueDate === todayStr && !t.completed);
                    break;
                case 'week':
                    filteredTasks = tasks.filter(t => t.dueDate >= todayStr && t.dueDate <= weekEndStr && !t.completed);
                    break;
                case 'overdue':
                    filteredTasks = tasks.filter(t => t.dueDate < todayStr && !t.completed);
                    break;
                case 'completed':
                    filteredTasks = tasks.filter(t => t.completed);
                    break;
                default:
                    filteredTasks = tasks.filter(t => !t.completed);
            }
            
            // Ordenar por data e prioridade
            filteredTasks.sort((a, b) => {
                if (a.completed !== b.completed) return a.completed ? 1 : -1;
                if (a.dueDate !== b.dueDate) return a.dueDate.localeCompare(b.dueDate);
                const priorityOrder = { high: 0, medium: 1, low: 2 };
                return priorityOrder[a.priority] - priorityOrder[b.priority];
            });
            
            if (filteredTasks.length === 0) {
                container.innerHTML = `
                    <div class="tasks-empty">
                        <span class="material-icons">task_alt</span>
                        <h3>${currentTaskFilter === 'completed' ? 'Nenhuma tarefa concluída' : 'Nenhuma tarefa encontrada'}</h3>
                        <p>${currentTaskFilter === 'all' ? 'Clique em "Nova Tarefa" para começar' : 'Tente outro filtro'}</p>
                    </div>
                `;
                updateTaskStats();
                return;
            }
            
            container.innerHTML = filteredTasks.map(task => {
                const isOverdue = !task.completed && task.dueDate < todayStr;
                const isToday = task.dueDate === todayStr;
                const priorityLabels = { high: 'Alta', medium: 'Média', low: 'Baixa' };
                
                let statusClass = '';
                if (task.completed) statusClass = 'completed';
                else if (isOverdue) statusClass = 'overdue';
                else if (isToday) statusClass = 'today';
                
                const subtasksHtml = task.subtasks && task.subtasks.length > 0 ? `
                    <div class="subtasks">
                        ${task.subtasks.map((st, i) => `
                            <div class="subtask-item ${st.completed ? 'completed' : ''}">
                                <div class="subtask-checkbox ${st.completed ? 'checked' : ''}" onclick="toggleSubtask('${task.id}', ${i})">
                                    ${st.completed ? '<span class="material-icons">check</span>' : ''}
                                </div>
                                <span>${st.title}</span>
                            </div>
                        `).join('')}
                    </div>
                ` : '';
                
                const completedSubtasks = task.subtasks ? task.subtasks.filter(st => st.completed).length : 0;
                const totalSubtasks = task.subtasks ? task.subtasks.length : 0;
                
                return `
                    <div class="task-item ${statusClass}" data-task-id="${task.id}">
                        <div class="task-checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTaskComplete('${task.id}')">
                            ${task.completed ? '<span class="material-icons">check</span>' : ''}
                        </div>
                        <div class="task-content">
                            <div class="task-header">
                                <span class="task-title">${task.title}</span>
                                <span class="task-priority ${task.priority}">${priorityLabels[task.priority]}</span>
                            </div>
                            ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                            <div class="task-meta">
                                <div class="task-meta-item ${isOverdue ? 'overdue' : ''}">
                                    <span class="material-icons">${isOverdue ? 'warning' : 'event'}</span>
                                    ${formatDateBR(task.dueDate)}${task.dueTime ? ' às ' + task.dueTime : ''}
                                </div>
                                ${totalSubtasks > 0 ? `
                                    <div class="task-meta-item">
                                        <span class="material-icons">checklist</span>
                                        ${completedSubtasks}/${totalSubtasks}
                                    </div>
                                ` : ''}
                                ${task.category !== 'geral' ? `
                                    <div class="task-meta-item">
                                        <span class="material-icons">label</span>
                                        ${task.category}
                                    </div>
                                ` : ''}
                            </div>
                            ${subtasksHtml}
                        </div>
                        <div class="task-actions">
                            <button class="task-action-btn" onclick="openTaskModal('${task.id}')" title="Editar">
                                <span class="material-icons">edit</span>
                            </button>
                            <button class="task-action-btn delete" onclick="deleteTask('${task.id}')" title="Excluir">
                                <span class="material-icons">delete</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            updateTaskStats();
        }
        
        // Modal de tarefa
        function openTaskModal(taskId = null) {
            editingTaskId = taskId;
            
            let modal = document.getElementById('taskModal');
            if (!modal) {
                createTaskModal();
                modal = document.getElementById('taskModal');
            }
            
            const form = document.getElementById('taskForm');
            form.reset();
            document.getElementById('subtasksList').innerHTML = '';
            
            if (taskId) {
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    document.getElementById('taskModalTitle').textContent = 'Editar Tarefa';
                    document.getElementById('taskTitle').value = task.title;
                    document.getElementById('taskDescription').value = task.description || '';
                    document.getElementById('taskDueDate').value = task.dueDate;
                    document.getElementById('taskDueTime').value = task.dueTime || '';
                    document.getElementById('taskPriority').value = task.priority;
                    document.getElementById('taskCategory').value = task.category || 'geral';
                    
                    // Carregar subtarefas
                    if (task.subtasks) {
                        task.subtasks.forEach(st => addSubtaskToList(st.title));
                    }
                }
            } else {
                document.getElementById('taskModalTitle').textContent = 'Nova Tarefa';
                document.getElementById('taskDueDate').value = new Date().toISOString().split('T')[0];
            }
            
            modal.classList.add('active');
        }
        
        function createTaskModal() {
            const modalHtml = `
                <div class="modal-overlay" id="taskModal">
                    <div class="modal" style="max-width: 550px;">
                        <div class="modal-header">
                            <h3 id="taskModalTitle">Nova Tarefa</h3>
                            <button class="modal-close" onclick="closeModal('taskModal')">
                                <span class="material-icons">close</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="taskForm" onsubmit="handleTaskSubmit(event)">
                                <div class="form-group">
                                    <label class="form-label">Título *</label>
                                    <input type="text" id="taskTitle" class="form-input" required placeholder="Ex: Revisar documentação do curso">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Descrição</label>
                                    <textarea id="taskDescription" class="form-input" rows="3" placeholder="Detalhes da tarefa..."></textarea>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Data *</label>
                                        <input type="date" id="taskDueDate" class="form-input" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Horário</label>
                                        <input type="time" id="taskDueTime" class="form-input">
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Prioridade</label>
                                        <select id="taskPriority" class="form-select">
                                            <option value="low">Baixa</option>
                                            <option value="medium" selected>Média</option>
                                            <option value="high">Alta</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Categoria</label>
                                        <select id="taskCategory" class="form-select">
                                            <option value="geral">Geral</option>
                                            <option value="curso">Curso</option>
                                            <option value="reuniao">Reunião</option>
                                            <option value="documento">Documento</option>
                                            <option value="prazo">Prazo</option>
                                            <option value="outro">Outro</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Subtarefas</label>
                                    <div class="subtask-input-group">
                                        <input type="text" id="subtaskInput" class="form-input" placeholder="Adicionar subtarefa...">
                                        <button type="button" class="btn btn-secondary" onclick="addSubtaskFromInput()">
                                            <span class="material-icons">add</span>
                                        </button>
                                    </div>
                                    <div class="subtask-list" id="subtasksList"></div>
                                </div>
                                
                                <div class="form-actions">
                                    <button type="button" class="btn btn-secondary" onclick="closeModal('taskModal')">Cancelar</button>
                                    <button type="submit" class="btn btn-primary">
                                        <span class="material-icons">save</span>
                                        Salvar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Enter para adicionar subtarefa
            document.getElementById('subtaskInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addSubtaskFromInput();
                }
            });
        }
        
        function addSubtaskFromInput() {
            const input = document.getElementById('subtaskInput');
            const value = input.value.trim();
            if (value) {
                addSubtaskToList(value);
                input.value = '';
                input.focus();
            }
        }
        
        function addSubtaskToList(title) {
            const list = document.getElementById('subtasksList');
            const item = document.createElement('div');
            item.className = 'subtask-list-item';
            item.innerHTML = `
                <span class="material-icons" style="color: var(--text-muted); font-size: 18px;">subdirectory_arrow_right</span>
                <span>${title}</span>
                <button type="button" class="subtask-remove-btn" onclick="this.parentElement.remove()">
                    <span class="material-icons" style="font-size: 18px;">close</span>
                </button>
            `;
            list.appendChild(item);
        }
        
        function handleTaskSubmit(e) {
            e.preventDefault();
            
            const subtaskElements = document.querySelectorAll('#subtasksList .subtask-list-item span:nth-child(2)');
            const subtasks = Array.from(subtaskElements).map(el => ({
                title: el.textContent,
                completed: false
            }));
            
            const taskData = {
                title: document.getElementById('taskTitle').value.trim(),
                description: document.getElementById('taskDescription').value.trim(),
                dueDate: document.getElementById('taskDueDate').value,
                dueTime: document.getElementById('taskDueTime').value,
                priority: document.getElementById('taskPriority').value,
                category: document.getElementById('taskCategory').value,
                subtasks: subtasks
            };
            
            if (editingTaskId) {
                updateTask(editingTaskId, taskData);
                showToast('Tarefa atualizada!', 'success');
            } else {
                createTask(taskData);
                showToast('Tarefa criada!', 'success');
                logActivity('Nova Tarefa', `Criou a tarefa "${taskData.title}"`, 'add');
            }
            
            closeModal('taskModal');
        }
        
        // Verificar alertas de tarefas
        function checkTaskAlerts(today) {
            if (!tasks || tasks.length === 0) return;
            
            const todayStr = today.toISOString().split('T')[0];
            
            tasks.forEach(task => {
                if (task.completed) return;
                
                const dueDate = new Date(task.dueDate + 'T00:00:00');
                dueDate.setHours(0, 0, 0, 0);
                
                const diffDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                
                if (diffDays < 0) {
                    // Tarefa atrasada
                    saveNotificationToHistory(
                        `Tarefa "${task.title}" está ATRASADA! (${formatDateBR(task.dueDate)})`,
                        'error',
                        '⚠️ Tarefa Atrasada',
                        null
                    );
                } else if (diffDays === 0) {
                    // Tarefa para hoje
                    saveNotificationToHistory(
                        `Tarefa "${task.title}" é para HOJE!${task.dueTime ? ' às ' + task.dueTime : ''}`,
                        'warning',
                        '📌 Tarefa Hoje',
                        null
                    );
                } else if (diffDays === 1) {
                    // Tarefa para amanhã
                    saveNotificationToHistory(
                        `Tarefa "${task.title}" é para amanhã`,
                        'info',
                        '📅 Tarefa Amanhã',
                        null
                    );
                }
            });
        }
        
        // Inicializar sistema de tarefas
        function initTaskSystem() {
            // Botão nova tarefa
            document.getElementById('newTaskBtn')?.addEventListener('click', () => openTaskModal());
            
            // Filtros
            document.querySelectorAll('.task-filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.task-filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentTaskFilter = btn.dataset.filter;
                    renderTasks();
                });
            });
            
            // Configurar listener de tarefas
            setupTasksListener();
        }
        
        // ==================== BUSCA GLOBAL ====================
        let globalSearchSelectedIndex = 0;
        let globalSearchResults = [];
        
        function openGlobalSearch() {
            const overlay = document.getElementById('globalSearchOverlay');
            const input = document.getElementById('globalSearchInput');
            overlay.classList.add('active');
            input.value = '';
            input.focus();
            document.getElementById('globalSearchResults').innerHTML = `
                <div class="search-no-results" id="searchInitialState">
                    <span class="material-icons">search</span>
                    <p>Digite para buscar...</p>
                </div>
            `;
            globalSearchSelectedIndex = 0;
            globalSearchResults = [];
        }
        
        function closeGlobalSearch() {
            document.getElementById('globalSearchOverlay').classList.remove('active');
        }
        
        function performGlobalSearch(query) {
            if (!query.trim()) {
                document.getElementById('globalSearchResults').innerHTML = `
                    <div class="search-no-results">
                        <span class="material-icons">search</span>
                        <p>Digite para buscar...</p>
                    </div>
                `;
                globalSearchResults = [];
                return;
            }
            
            const q = query.toLowerCase();
            globalSearchResults = [];
            
            // Buscar em cursos
            const cursoResults = cursos.filter(c => 
                (c.curso && c.curso.toLowerCase().includes(q)) ||
                (c.lote && c.lote.toLowerCase().includes(q)) ||
                (c.cidade && c.cidade.toLowerCase().includes(q)) ||
                (c.instrutor && c.instrutor.toLowerCase().includes(q))
            ).slice(0, 5).map(c => ({
                type: 'curso',
                id: c.id,
                title: c.curso || c.lote,
                subtitle: `${c.cidade || ''} • ${c.instrutor || 'Sem instrutor'}`,
                status: normalizeStatus(c.status),
                icon: 'school'
            }));
            
            // Buscar em instrutores
            const instrutorResults = instrutores.filter(i =>
                (i.nome && i.nome.toLowerCase().includes(q)) ||
                (i.especialidade && i.especialidade.toLowerCase().includes(q))
            ).slice(0, 3).map(i => ({
                type: 'instrutor',
                id: i.id,
                title: i.nome,
                subtitle: i.especialidade || 'Sem especialidade',
                icon: 'person'
            }));
            
            // Buscar em tarefas
            const tarefaResults = tasks.filter(t =>
                (t.title && t.title.toLowerCase().includes(q)) ||
                (t.description && t.description.toLowerCase().includes(q))
            ).slice(0, 3).map(t => ({
                type: 'tarefa',
                id: t.id,
                title: t.title,
                subtitle: `${formatDateBR(t.dueDate)} • ${t.completed ? 'Concluída' : 'Pendente'}`,
                status: t.completed ? 'concluida' : 'pendente',
                icon: 'task_alt'
            }));
            
            globalSearchResults = [...cursoResults, ...instrutorResults, ...tarefaResults];
            globalSearchSelectedIndex = 0;
            
            renderSearchResults();
        }
        
        function renderSearchResults() {
            const container = document.getElementById('globalSearchResults');
            
            if (globalSearchResults.length === 0) {
                container.innerHTML = `
                    <div class="search-no-results">
                        <span class="material-icons">search_off</span>
                        <p>Nenhum resultado encontrado</p>
                    </div>
                `;
                return;
            }
            
            const cursos = globalSearchResults.filter(r => r.type === 'curso');
            const instrutores = globalSearchResults.filter(r => r.type === 'instrutor');
            const tarefas = globalSearchResults.filter(r => r.type === 'tarefa');
            
            let html = '';
            let index = 0;
            
            if (cursos.length > 0) {
                html += `<div class="search-result-group">
                    <div class="search-result-group-title">Cursos</div>
                    ${cursos.map(r => {
                        const selected = index === globalSearchSelectedIndex ? 'selected' : '';
                        const itemHtml = `
                            <div class="search-result-item ${selected}" data-index="${index}" onclick="selectSearchResult(${index})">
                                <div class="search-result-icon">
                                    <span class="material-icons">${r.icon}</span>
                                </div>
                                <div class="search-result-content">
                                    <div class="search-result-title">${r.title}</div>
                                    <div class="search-result-subtitle">${r.subtitle}</div>
                                </div>
                                <span class="search-result-badge status-${getStatusClass(r.status)}">${r.status}</span>
                            </div>
                        `;
                        index++;
                        return itemHtml;
                    }).join('')}
                </div>`;
            }
            
            if (instrutores.length > 0) {
                html += `<div class="search-result-group">
                    <div class="search-result-group-title">Instrutores</div>
                    ${instrutores.map(r => {
                        const selected = index === globalSearchSelectedIndex ? 'selected' : '';
                        const itemHtml = `
                            <div class="search-result-item ${selected}" data-index="${index}" onclick="selectSearchResult(${index})">
                                <div class="search-result-icon">
                                    <span class="material-icons">${r.icon}</span>
                                </div>
                                <div class="search-result-content">
                                    <div class="search-result-title">${r.title}</div>
                                    <div class="search-result-subtitle">${r.subtitle}</div>
                                </div>
                            </div>
                        `;
                        index++;
                        return itemHtml;
                    }).join('')}
                </div>`;
            }
            
            if (tarefas.length > 0) {
                html += `<div class="search-result-group">
                    <div class="search-result-group-title">Tarefas</div>
                    ${tarefas.map(r => {
                        const selected = index === globalSearchSelectedIndex ? 'selected' : '';
                        const itemHtml = `
                            <div class="search-result-item ${selected}" data-index="${index}" onclick="selectSearchResult(${index})">
                                <div class="search-result-icon">
                                    <span class="material-icons">${r.icon}</span>
                                </div>
                                <div class="search-result-content">
                                    <div class="search-result-title">${r.title}</div>
                                    <div class="search-result-subtitle">${r.subtitle}</div>
                                </div>
                            </div>
                        `;
                        index++;
                        return itemHtml;
                    }).join('')}
                </div>`;
            }
            
            container.innerHTML = html;
        }
        
        function selectSearchResult(index) {
            const result = globalSearchResults[index];
            if (!result) return;
            
            closeGlobalSearch();
            
            switch (result.type) {
                case 'curso':
                    navigateTo('courses');
                    setTimeout(() => openCourseModal(result.id), 300);
                    break;
                case 'instrutor':
                    navigateTo('instructors');
                    setTimeout(() => openInstructorModal(result.id), 300);
                    break;
                case 'tarefa':
                    navigateTo('tasks');
                    setTimeout(() => openTaskModal(result.id), 300);
                    break;
            }
        }
        
        // ==================== ATALHOS DE TECLADO ====================
        let lastKeyPressed = null;
        let lastKeyTime = 0;
        
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                const activeElement = document.activeElement;
                const isInputFocused = activeElement.tagName === 'INPUT' || 
                                       activeElement.tagName === 'TEXTAREA' || 
                                       activeElement.isContentEditable;
                
                // Ctrl+K - Busca global
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    openGlobalSearch();
                    return;
                }
                
                // Ctrl+Shift+L - Alternar tema
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'L') {
                    e.preventDefault();
                    document.getElementById('themeToggle')?.click();
                    return;
                }
                
                // ESC - Fechar modais/busca
                if (e.key === 'Escape') {
                    if (document.getElementById('globalSearchOverlay').classList.contains('active')) {
                        closeGlobalSearch();
                        return;
                    }
                    document.querySelectorAll('.modal-overlay.active').forEach(m => {
                        closeModal(m.id);
                    });
                    return;
                }
                
                // Se estiver em input, não processar atalhos de navegação
                if (isInputFocused) return;
                
                // Navegação na busca
                if (document.getElementById('globalSearchOverlay').classList.contains('active')) {
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        globalSearchSelectedIndex = Math.min(globalSearchSelectedIndex + 1, globalSearchResults.length - 1);
                        renderSearchResults();
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        globalSearchSelectedIndex = Math.max(globalSearchSelectedIndex - 1, 0);
                        renderSearchResults();
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        selectSearchResult(globalSearchSelectedIndex);
                    }
                    return;
                }
                
                // ? - Mostrar atalhos
                if (e.key === '?') {
                    document.getElementById('shortcutsModal').classList.add('active');
                    return;
                }
                
                const now = Date.now();
                const isCombo = now - lastKeyTime < 500;
                
                // Combos G+X (navegação)
                if (isCombo && lastKeyPressed === 'g') {
                    switch (e.key.toLowerCase()) {
                        case 'd': navigateTo('dashboard'); break;
                        case 'c': navigateTo('courses'); break;
                        case 'a': navigateTo('calendar'); break;
                        case 't': navigateTo('tasks'); break;
                        case 'i': navigateTo('instructors'); break;
                        case 's': navigateTo('settings'); break;
                    }
                }
                
                // Combos N+X (novo)
                if (isCombo && lastKeyPressed === 'n') {
                    switch (e.key.toLowerCase()) {
                        case 'c': openCourseModal(); break;
                        case 't': openTaskModal(); break;
                        case 'i': openInstructorModal(); break;
                    }
                }
                
                lastKeyPressed = e.key.toLowerCase();
                lastKeyTime = now;
            });
            
            // Busca global - input
            document.getElementById('globalSearchInput')?.addEventListener('input', (e) => {
                performGlobalSearch(e.target.value);
            });
        }
        
        // ==================== SELETOR DE TEMAS ====================
        function setColorTheme(theme) {
            const root = document.documentElement;
            
            // Remover todas as classes de tema
            root.classList.remove('theme-blue', 'theme-green', 'theme-purple', 'theme-rose', 'theme-orange', 'theme-cyan');
            
            // Adicionar nova classe se não for default
            if (theme !== 'default') {
                root.classList.add(`theme-${theme}`);
            }
            
            // Salvar preferência
            localStorage.setItem('colorTheme', theme);
            
            // Atualizar botões
            document.querySelectorAll('.theme-color-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === theme);
            });
        }
        
        function initThemeSelector() {
            const savedTheme = localStorage.getItem('colorTheme') || 'default';
            setColorTheme(savedTheme);
            
            document.querySelectorAll('.theme-color-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    setColorTheme(btn.dataset.theme);
                });
            });
        }
        
        // ==================== SKELETON LOADING ====================
        function showSkeletonLoading(container, count = 6) {
            let html = '';
            for (let i = 0; i < count; i++) {
                html += `
                    <div class="skeleton skeleton-card" style="animation-delay: ${i * 0.1}s;"></div>
                `;
            }
            container.innerHTML = html;
        }
        
        // ==================== DASHBOARD CHARTS ====================
        let coursesTimelineChart = null;
        let coursesStatusChart = null;
        
        function renderDashboardCharts() {
            renderCoursesTimelineChart();
            renderCoursesStatusChart();
            renderDashboardTimeline();
        }
        
        function renderCoursesTimelineChart() {
            const ctx = document.getElementById('coursesTimelineChart');
            if (!ctx) return;
            
            // Destruir gráfico anterior se existir
            if (coursesTimelineChart) {
                coursesTimelineChart.destroy();
            }
            
            // Calcular dados dos últimos 6 meses
            const months = [];
            const iniciados = [];
            const concluidos = [];
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const year = date.getFullYear();
                const month = date.getMonth();
                
                const monthNames = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                months.push(monthNames[month]);
                
                const iniciadosCount = cursos.filter(c => {
                    if (!c.inicio) return false;
                    const d = new Date(c.inicio);
                    return d.getFullYear() === year && d.getMonth() === month;
                }).length;
                
                const concluidosCount = cursos.filter(c => {
                    if (!c.fim) return false;
                    const d = new Date(c.fim);
                    return d.getFullYear() === year && d.getMonth() === month && normalizeStatus(c.status) === 'Concluído';
                }).length;
                
                iniciados.push(iniciadosCount);
                concluidos.push(concluidosCount);
            }
            
            const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#6366f1';
            const successColor = getComputedStyle(document.documentElement).getPropertyValue('--success').trim() || '#10b981';
            
            coursesTimelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Iniciados',
                            data: iniciados,
                            borderColor: primaryColor,
                            backgroundColor: primaryColor + '20',
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: primaryColor,
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        },
                        {
                            label: 'Concluídos',
                            data: concluidos,
                            borderColor: successColor,
                            backgroundColor: successColor + '20',
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: successColor,
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim(),
                                usePointStyle: true,
                                padding: 20
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--border').trim()
                            },
                            ticks: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted').trim()
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted').trim()
                            }
                        }
                    }
                }
            });
        }
        
        function renderCoursesStatusChart() {
            const ctx = document.getElementById('coursesStatusChart');
            if (!ctx) return;
            
            if (coursesStatusChart) {
                coursesStatusChart.destroy();
            }
            
            const statusCounts = {
                'Pendente': cursos.filter(c => normalizeStatus(c.status) === 'Pendente').length,
                'Em Andamento': cursos.filter(c => normalizeStatus(c.status) === 'Em Andamento').length,
                'Concluído': cursos.filter(c => normalizeStatus(c.status) === 'Concluído').length,
                'Cancelado': cursos.filter(c => normalizeStatus(c.status) === 'Cancelado').length
            };
            
            coursesStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: ['#f59e0b', '#3b82f6', '#10b981', '#ef4444'],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim(),
                                usePointStyle: true,
                                padding: 15
                            }
                        }
                    }
                }
            });
        }
        
        function renderDashboardTimeline() {
            const container = document.getElementById('dashboardTimeline');
            if (!container) return;
            
            // Pegar últimas atividades
            const recentLogs = activityLogs.slice(0, 8);
            
            if (recentLogs.length === 0) {
                container.innerHTML = `
                    <div class="timeline-empty">
                        <span class="material-icons">history</span>
                        <p>Nenhuma atividade recente</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = recentLogs.map(log => {
                const iconMap = {
                    'add': 'add',
                    'edit': 'edit',
                    'delete': 'delete',
                    'complete': 'check'
                };
                const icon = iconMap[log.type] || 'info';
                
                return `
                    <div class="timeline-item">
                        <div class="timeline-icon ${log.type || 'default'}">
                            <span class="material-icons">${icon}</span>
                        </div>
                        <div class="timeline-details">
                            <div class="timeline-title">${log.action}</div>
                            <div class="timeline-description">${log.description}</div>
                            <div class="timeline-time">${formatTimestamp(log.timestamp)}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Sobrescrever showToast para salvar no histórico (apenas alertas automáticos)
        const originalShowToast = showToast;
        showToast = function(message, type = 'success', options = {}) {
            // Lista de mensagens que NÃO devem ser salvas no histórico
            const ignoredPatterns = [
                /curso (criado|atualizado|salvo)/i,
                /curso exclu[ií]do/i,
                /erro ao (salvar|excluir) curso/i,
                /instrutor (criado|atualizado|salvo)/i,
                /instrutor exclu[ií]do/i,
                /erro ao (salvar|excluir) instrutor/i,
                /usu[aá]rio exclu[ií]do/i,
                /erro ao excluir usu[aá]rio/i,
                /email inválido/i,
                /telefone inválido/i,
                /importa(ção|dos|r)/i,
                /id do lote/i,
                /data de fim não pode/i,
                /url .* inválid/i,
                /número de concludentes/i,
                /lote deve ter/i,
                /backup/i,
                /restaur/i,
                /export/i,
                /modo (normal|compacto) ativ/i,
                /notificação removida/i,
                /marcado como conclu[ií]do/i,
                /alerta\(s\) encontrado/i,
                /dados foram exclu[ií]dos/i,
                /sucesso/i,
                /evento (adicionado|removido|criado|exclu[ií]do)/i,
                /tarefa (criada|atualizada|exclu[ií]da)/i,
                /tarefa .* conclu[ií]da/i
            ];
            
            // Verificar se deve ignorar
            const shouldIgnore = ignoredPatterns.some(pattern => pattern.test(message));
            
            // Salvar no histórico apenas se NÃO estiver na lista de ignorados
            if (!shouldIgnore) {
                saveNotificationToHistory(message, type, options.title);
            }
            
            // Chamar função original (sempre mostra o toast)
            return originalShowToast(message, type, options);
        };

        async function logActivity(action, description, type = 'add') {
            const logEntry = {
                action,
                description,
                type,
                user: currentUser?.name || 'Sistema',
                timestamp: firebaseAvailable ? firebase.firestore.FieldValue.serverTimestamp() : new Date()
            };

            try {
                if (firebaseAvailable) {
                    await db.collection('activities').add(logEntry);
                } else {
                    const currentLogs = JSON.parse(localStorage.getItem('activityLogs') || '[]');
                    currentLogs.unshift({...logEntry, timestamp: new Date()});
                    localStorage.setItem('activityLogs', JSON.stringify(currentLogs.slice(0, 100)));
                    renderActivityLogs();
                }
            } catch (error) {
                console.error('Error logging activity:', error);
            }
        }
        
        // ========== SISTEMA DE HISTÓRICO DE ALTERAÇÕES COMPLETO ==========
        
        // Armazenar histórico de alterações por curso
        let courseHistory = {};
        
        function loadCourseHistory() {
            const saved = localStorage.getItem('courseHistory');
            if (saved) {
                courseHistory = JSON.parse(saved);
            }
        }
        
        function saveCourseHistory() {
            localStorage.setItem('courseHistory', JSON.stringify(courseHistory));
        }
        
        function addCourseHistoryEntry(courseId, action, changes, oldData = null) {
            if (!courseHistory[courseId]) {
                courseHistory[courseId] = [];
            }
            
            const entry = {
                id: Date.now() + Math.random(),
                action, // 'created', 'updated', 'deleted'
                changes, // { field: { old: value, new: value } }
                user: currentUser?.name || 'Sistema',
                userId: currentUser?.id || null,
                timestamp: new Date().toISOString(),
                oldData: oldData ? JSON.parse(JSON.stringify(oldData)) : null
            };
            
            courseHistory[courseId].unshift(entry);
            
            // Manter apenas últimas 50 alterações por curso
            if (courseHistory[courseId].length > 50) {
                courseHistory[courseId] = courseHistory[courseId].slice(0, 50);
            }
            
            saveCourseHistory();
            
            // Salvar no Firebase se disponível
            if (firebaseAvailable) {
                db.collection('courseHistory').add({
                    courseId,
                    ...entry
                }).catch(err => console.error('Erro ao salvar histórico no Firebase:', err));
            }
        }
        
        function getCourseHistory(courseId) {
            return courseHistory[courseId] || [];
        }
        
        function renderCourseHistory(courseId) {
            const history = getCourseHistory(courseId);
            if (history.length === 0) {
                return '<div style="padding: 1rem; text-align: center; color: var(--text-muted);">Nenhuma alteração registrada</div>';
            }
            
            const fieldLabels = {
                curso: 'Nome do Curso',
                status: 'Status',
                alunos: 'Concludentes',
                cidade: 'Cidade',
                inicio: 'Data de Início',
                fim: 'Data de Fim',
                instrutor: 'Instrutor',
                cargaHoraria: 'Carga Horária',
                local: 'Local',
                driveLink: 'Link do Drive',
                nota: 'Observação'
            };
            
            return '<div class="course-history-timeline">' +
                history.map(entry => {
                    const changesHtml = Object.keys(entry.changes || {}).map(field => {
                        const change = entry.changes[field];
                        const oldValue = change.old !== null && change.old !== undefined && change.old !== '' ? 
                            '<span class="history-change-old-value">' + (change.old || '(vazio)') + '</span><span class="history-change-arrow">→</span>' : '';
                        return '<div class="history-change">' +
                            '<span class="history-change-field">' + (fieldLabels[field] || field) + ':</span>' +
                            oldValue +
                            '<span class="history-change-new-value">' + (change.new || '(vazio)') + '</span>' +
                            '</div>';
                    }).join('');
                    
                    const actionText = entry.action === 'created' ? 'Criou o curso' : 
                                      entry.action === 'updated' ? 'Atualizou o curso' :
                                      entry.action === 'deleted' ? 'Excluiu o curso' : 'Alterou o curso';
                    
                    const changesSection = Object.keys(entry.changes || {}).length > 0 ? 
                        '<div class="history-entry-changes">' + changesHtml + '</div>' : '';
                    
                    return '<div class="history-entry">' +
                        '<div class="history-entry-header">' +
                            '<div class="history-entry-user">' +
                                '<span class="material-icons" style="font-size: 16px; vertical-align: middle;">person</span>' +
                                entry.user +
                            '</div>' +
                            '<div class="history-entry-time">' + formatTimestamp(new Date(entry.timestamp)) + '</div>' +
                        '</div>' +
                        '<div class="history-entry-action">' + actionText + '</div>' +
                        changesSection +
                        '</div>';
                }).join('') +
                '</div>';
        }
        
        // Carregar histórico ao inicializar
        loadCourseHistory();
        
        // Tornar funções globais
        window.getCourseHistory = getCourseHistory;
        window.renderCourseHistory = renderCourseHistory;

        function setupDragAndDrop() {
            const uploadZone = document.getElementById('uploadZone');
            const excelFileInput = document.getElementById('excelFileInput');

            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('drag-over');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('drag-over');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('drag-over');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    excelFileInput.files = files;
                    handleExcelUpload({ target: excelFileInput });
                }
            });

            // Prevent default drag behaviors for the whole document
            document.addEventListener('dragover', (e) => e.preventDefault());
            document.addEventListener('drop', (e) => e.preventDefault());
        }

        // Função para filtrar cursos por LOTE

        // Função para renderizar cursos organizados por LOTE
        // Função para verificar alertas nos cards
        function getCourseAlerts(course) {
            const alerts = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const normalizedStatus = normalizeStatus(course.status);
            
            // Alerta 1: Data de fim chegou mas status ainda é "Em Andamento"
            if (course.fim && normalizedStatus === 'Em Andamento') {
                const endDate = new Date(course.fim);
                endDate.setHours(0, 0, 0, 0);
                
                if (endDate <= today) {
                    alerts.push({
                        type: 'end-date-passed',
                        severity: 'error',
                        title: '⚠️ Curso Finalizado - Ação Necessária',
                        message: `A data de fim (${formatDate(course.fim)}) já passou. Por favor, altere o status para "Concluído" e informe o número de concludentes.`,
                        concludentes: course.alunos || 0,
                        actionText: 'Atualizar Status',
                        action: () => {
                            openCourseModal(course.id);
                            // Focar no campo de status após abrir o modal
                            setTimeout(() => {
                                const statusSelect = document.getElementById('courseStatus');
                                if (statusSelect) {
                                    statusSelect.focus();
                                    statusSelect.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }
                            }, 300);
                        }
                    });
                }
            }
            
            // Alerta 2: Data de início chegou mas status ainda é "Pendente"
            if (course.inicio && normalizedStatus === 'Pendente') {
                const startDate = new Date(course.inicio);
                startDate.setHours(0, 0, 0, 0);
                
                if (startDate <= today) {
                    alerts.push({
                        type: 'start-date-passed',
                        severity: 'warning',
                        title: '⏰ Curso Deveria Ter Iniciado',
                        message: `A data de início (${formatDate(course.inicio)}) já chegou. Por favor, altere o status para "Em Andamento".`,
                        actionText: 'Atualizar para Em Andamento',
                        action: () => {
                            openCourseModal(course.id);
                            // Focar no campo de status após abrir o modal
                            setTimeout(() => {
                                const statusSelect = document.getElementById('courseStatus');
                                if (statusSelect) {
                                    statusSelect.value = 'Em Andamento';
                                    statusSelect.focus();
                                    statusSelect.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }
                            }, 300);
                        }
                    });
                }
            }
            
            return alerts;
        }
        
        // Função para renderizar alertas
        function renderCourseAlerts(alerts, courseId) {
            // Não mostrar alertas para visualizadores
            if (currentUser?.role === 'viewer') return '';
            if (!alerts || alerts.length === 0) return '';
            
            return alerts.map((alert, index) => {
                const alertId = `alert-${courseId}-${index}`;
                return `
                <div class="course-alert ${alert.severity === 'warning' ? 'warning' : ''}" onclick="event.stopPropagation()">
                    <div class="course-alert-icon">
                        <span class="material-icons">${alert.severity === 'warning' ? 'schedule' : 'error'}</span>
                    </div>
                    <div class="course-alert-content">
                        <div class="course-alert-title">${alert.title}</div>
                        <div class="course-alert-message">${alert.message}</div>
                        ${alert.concludentes !== undefined ? `
                            <div style="margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">
                                <strong>Concludentes atuais:</strong> ${alert.concludentes}
                            </div>
                        ` : ''}
                        <button class="course-alert-action" onclick="handleAlertAction('${courseId}', '${alert.type}'); event.stopPropagation();">
                            <span class="material-icons" style="font-size: 18px;">edit</span>
                            ${alert.actionText}
                        </button>
                    </div>
                </div>
            `;
            }).join('');
        }
        
        // Função para lidar com ações dos alertas
        function handleAlertAction(courseId, alertType) {
            try {
                // Garantir que courseId seja string para comparação
                const course = cursos.find(c => String(c.id) === String(courseId));
                if (!course) {
                    console.error('Curso não encontrado:', courseId);
                    showToast('Erro: Curso não encontrado', 'error');
                    return;
                }
                
                // Abrir modal de edição
                if (typeof openCourseModal === 'function') {
                    openCourseModal(courseId);
                } else {
                    console.error('openCourseModal não está definida');
                    showToast('Erro ao abrir modal de edição', 'error');
                    return;
                }
                
                // Aguardar o modal abrir e então atualizar o campo de status
                setTimeout(() => {
                    const statusSelect = document.getElementById('courseStatus');
                    if (statusSelect) {
                        if (alertType === 'end-date-passed') {
                            // Focar no status para mudar para Concluído
                            statusSelect.value = 'Concluído';
                            statusSelect.focus();
                            // Disparar evento change para garantir que seja salvo
                            statusSelect.dispatchEvent(new Event('change', { bubbles: true }));
                        } else if (alertType === 'start-date-passed') {
                            // Mudar para Em Andamento
                            statusSelect.value = 'Em Andamento';
                            statusSelect.focus();
                            // Disparar evento change para garantir que seja salvo
                            statusSelect.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                        statusSelect.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        showToast('Status atualizado. Clique em "Salvar" para confirmar.', 'info');
                    } else {
                        console.error('Campo de status não encontrado');
                        // Tentar novamente após mais tempo
                        setTimeout(() => {
                            const retrySelect = document.getElementById('courseStatus');
                            if (retrySelect) {
                                if (alertType === 'end-date-passed') {
                                    retrySelect.value = 'Concluído';
                                } else if (alertType === 'start-date-passed') {
                                    retrySelect.value = 'Em Andamento';
                                }
                                retrySelect.focus();
                                retrySelect.dispatchEvent(new Event('change', { bubbles: true }));
                            }
                        }, 500);
                    }
                }, 500);
            } catch (error) {
                console.error('Erro em handleAlertAction:', error);
                showToast('Erro ao processar ação do alerta', 'error');
            }
        }
        
        // Tornar função acessível globalmente
        window.handleAlertAction = handleAlertAction;

        function renderCoursesByLote() {
            const container = document.getElementById('coursesByLoteContainer');
            if (!container) return;

            let filtered = cursos;
            
            // Aplicar filtros avançados
            filtered = filterCourses(filtered);
            
            // Aplicar ordenação
            filtered = sortCourses(filtered);
            
            // Aplicar paginação
            const totalItems = filtered.length;
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedCourses = filtered.slice(startIndex, endIndex);
            
            // Renderizar paginação
            renderPagination(totalItems);
            
            // Renderizar todos os cursos sem organização por LOTE
            if (paginatedCourses.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <span class="material-icons">school</span>
                        <h3>Nenhum curso encontrado</h3>
                        <p>${filtered.length === 0 ? 'Adicione seu primeiro curso' : 'Nenhum curso corresponde aos filtros aplicados'}</p>
                    </div>
                `;
                return;
            }

            // Renderizar baseado no modo de visualização
            let coursesHTML = '';
            const statusClass = (course) => getStatusClass(course.status);
            const canEdit = currentUser?.role !== 'viewer';

            if (currentViewMode === 'list') {
                // Modo Lista
                coursesHTML = `
                    <div class="courses-list" style="display: flex; flex-direction: column; gap: 1rem;">
                        ${paginatedCourses.map(course => {
                            const alerts = getCourseAlerts(course);
                            const hasAlert = alerts.length > 0 && currentUser?.role !== 'viewer';
                            const alertClass = hasAlert ? (alerts[0].severity === 'warning' ? 'warning-alert' : '') : '';
                            
                            return `
                            <div class="course-card ${hasAlert ? 'has-alert ' + alertClass : ''}" style="display: flex; flex-direction: column; gap: 1rem; padding: 1.5rem;" onclick="openViewCourseModal('${course.id}')">
                                <div style="display: flex; align-items: center; gap: 1.5rem;">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                                            <h3 style="margin: 0; font-size: 1.1rem;">${course.curso || 'Sem nome'}</h3>
                                            <span class="status-badge ${statusClass(course)}">${normalizeStatus(course.status)}</span>
                                        </div>
                                        <div style="display: flex; gap: 2rem; flex-wrap: wrap; color: var(--text-secondary); font-size: 0.875rem;">
                                            <span><span class="material-icons" style="font-size: 16px; vertical-align: middle;">location_on</span> ${course.cidade || 'N/A'}</span>
                                            <span><span class="material-icons" style="font-size: 16px; vertical-align: middle;">event</span> ${course.inicio && course.fim ? formatDate(course.inicio) + ' - ' + formatDate(course.fim) : 'N/A'}</span>
                                            <span><span class="material-icons" style="font-size: 16px; vertical-align: middle;">person</span> ${course.instrutor || 'N/A'}</span>
                                            <span><span class="material-icons" style="font-size: 16px; vertical-align: middle;">groups</span> ${course.alunos || 0} concludentes</span>
                                        </div>
                                    </div>
                                    ${canEdit ? `
                                        <div class="course-actions" onclick="event.stopPropagation()">
                                            <button onclick="openCourseModal('${course.id}')" title="Editar">
                                                <span class="material-icons">edit</span>
                                            </button>
                                            <button class="delete" onclick="deleteCourse('${course.id}')" title="Excluir">
                                                <span class="material-icons">delete</span>
                                            </button>
                                        </div>
                                    ` : ''}
                                </div>
                                ${renderCourseAlerts(alerts, course.id)}
                            </div>
                        `;
                        }).join('')}
                    </div>
                `;
            } else if (currentViewMode === 'timeline') {
                // Modo Timeline
                const sortedByDate = [...paginatedCourses].sort((a, b) => {
                    const dateA = a.inicio ? new Date(a.inicio) : new Date(0);
                    const dateB = b.inicio ? new Date(b.inicio) : new Date(0);
                    return dateA - dateB;
                });
                
                coursesHTML = `
                    <div class="courses-timeline" style="position: relative; padding-left: 2rem;">
                        ${sortedByDate.map((course, index) => {
                            const date = course.inicio ? new Date(course.inicio) : null;
                                return `
                                <div class="timeline-item" style="position: relative; margin-bottom: 2rem; padding-left: 2rem;">
                                    <div style="position: absolute; left: -8px; top: 0; width: 16px; height: 16px; background: var(--primary); border-radius: 50%; border: 3px solid var(--background);"></div>
                                    ${index < sortedByDate.length - 1 ? '<div style="position: absolute; left: -1px; top: 16px; width: 2px; height: calc(100% + 1rem); background: var(--border);"></div>' : ''}
                                    <div class="course-card" onclick="openViewCourseModal('${course.id}')">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                            <div>
                                                <div style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 0.5rem;">
                                                    ${date ? date.toLocaleDateString('pt-BR') : 'Data não informada'}
                                                </div>
                                                <h3 style="margin: 0; font-size: 1.1rem;">${course.curso || 'Sem nome'}</h3>
                                            </div>
                                            <span class="status-badge ${statusClass(course)}">${normalizeStatus(course.status)}</span>
                                        </div>
                                        <div style="display: flex; gap: 1.5rem; flex-wrap: wrap; color: var(--text-secondary); font-size: 0.875rem;">
                                            <span><span class="material-icons" style="font-size: 16px; vertical-align: middle;">location_on</span> ${course.cidade || 'N/A'}</span>
                                            <span><span class="material-icons" style="font-size: 16px; vertical-align: middle;">person</span> ${course.instrutor || 'N/A'}</span>
                                            <span><span class="material-icons" style="font-size: 16px; vertical-align: middle;">groups</span> ${course.alunos || 0} concludentes</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else {
                // Modo Grid (padrão)
                coursesHTML = `
                    <div class="courses-grid">
                        ${paginatedCourses.map(course => {
                            const alerts = getCourseAlerts(course);
                            const hasAlert = alerts.length > 0 && currentUser?.role !== 'viewer';
                            const alertClass = hasAlert ? (alerts[0].severity === 'warning' ? 'warning-alert' : '') : '';
                            
                            return `
                                    <div class="course-card ${hasAlert ? 'has-alert ' + alertClass : ''}" onclick="openViewCourseModal('${course.id}')">
                                        <div class="course-header">
                                            <div>
                                                <div class="course-title">${course.curso || 'Sem nome'}</div>
                                        <div class="course-id">ID: ${course.idLote || 'N/A'}${course.lote || course.loteResponsavel ? ' | LOTE: ' + (course.lote || course.loteResponsavel) : ''}</div>
                                            </div>
                                            ${canEdit ? `
                                                <div class="course-actions" onclick="event.stopPropagation()">
                                                    ${course.driveLink ? `
                                                        <button class="drive" onclick="openDriveLink('${course.driveLink}')" title="Abrir Google Drive">
                                                            <span class="material-icons">folder</span>
                                                        </button>
                                                    ` : ''}
                                                    <button onclick="openCourseModal('${course.id}')" title="Editar">
                                                        <span class="material-icons">edit</span>
                                                    </button>
                                                    <button class="delete" onclick="deleteCourse('${course.id}')" title="Excluir">
                                                        <span class="material-icons">delete</span>
                                                    </button>
                                                </div>
                                            ` : ''}
                                        </div>
                                        <div class="course-info">
                                            <div class="course-info-item">
                                                <span class="material-icons">location_on</span>
                                                ${course.cidade || 'Local não definido'}${course.local ? ' - ' + course.local : ''}
                                            </div>
                                            <div class="course-info-item">
                                                <span class="material-icons">event</span>
                                        <span>Período: ${course.inicio && course.fim ? formatDate(course.inicio) + ' - ' + formatDate(course.fim) : course.inicio ? formatDate(course.inicio) : course.fim ? formatDate(course.fim) : 'Não informado'}</span>
                                            </div>
                                            <div class="course-info-item">
                                                <span class="material-icons">person</span>
                                                ${course.instrutor || 'Instrutor não definido'}
                                            </div>
                                            <div class="course-info-item">
                                                <span class="material-icons">groups</span>
                                                ${course.alunos || 0} concludentes
                                            </div>
                                            <div>
                                        <span class="status-badge ${statusClass(course)}">${normalizeStatus(course.status)}</span>
                                            </div>
                                        </div>
                                        ${course.nota ? `
                                            <div class="course-note">
                                                <span class="material-icons">sticky_note_2</span>
                                                <span class="course-note-text">${course.nota}</span>
                                            </div>
                                        ` : ''}
                                        ${renderCourseAlerts(alerts, course.id)}
                                    </div>
                        `;
                        }).join('')}
                    </div>
                `;
            }

            container.innerHTML = coursesHTML;
        }

        function getDisplayLoteName(lote) {
            return loteNames[lote] || lote;
        }

        function editLoteName(lote) {
            const titleElement = document.getElementById(`lote-title-${lote.replace(/\s+/g, '-')}`);
            if (!titleElement) return;

            const currentName = getDisplayLoteName(lote);
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'lote-edit-input';
            input.value = currentName;
            
            const saveBtn = document.createElement('button');
            saveBtn.className = 'btn btn-success btn-icon';
            saveBtn.innerHTML = '<span class="material-icons">save</span>';
            saveBtn.onclick = () => saveLoteName(lote, input.value);

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'btn btn-secondary btn-icon';
            cancelBtn.innerHTML = '<span class="material-icons">close</span>';
            cancelBtn.onclick = () => {
                titleElement.parentElement.innerHTML = `<span id="lote-title-${lote.replace(/\s+/g, '-')}">${getDisplayLoteName(lote)}</span><span class="lote-count">${cursos.filter(c => (c.lote || c.loteResponsavel || 'Sem LOTE') === lote).length} curso${cursos.filter(c => (c.lote || c.loteResponsavel || 'Sem LOTE') === lote).length !== 1 ? 's' : ''}</span>`;
            };

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'lote-edit-actions';
            actionsDiv.appendChild(saveBtn);
            actionsDiv.appendChild(cancelBtn);

            titleElement.parentElement.innerHTML = '';
            titleElement.parentElement.appendChild(input);
            titleElement.parentElement.appendChild(actionsDiv);
            input.focus();
        }

        async function saveLoteName(lote, newName) {
            if (!newName.trim()) {
                showToast('Nome do LOTE não pode estar vazio', 'error');
                return;
            }

            if (newName.trim().length < 2) {
                showToast('Nome do LOTE deve ter pelo menos 2 caracteres', 'error');
                return;
            }

            setLoadingState(true);
            
            try {
            loteNames[lote] = newName.trim();
            localStorage.setItem('loteNames', JSON.stringify(loteNames));

                // Salvar no Firebase se disponível
                if (firebaseAvailable) {
                    try {
                        await db.collection('loteNames').doc(lote).set({ name: newName.trim() });
                    } catch (error) {
                        console.warn('Erro ao salvar loteName no Firebase:', error);
                    }
                }

                // Atualizar cursos com o novo nome do lote (otimizado)
                const coursesToUpdate = cursos.filter(course => 
                    (course.lote || course.loteResponsavel || 'Sem LOTE') === lote
                );

            if (firebaseAvailable) {
                    // Atualizar em batch no Firebase
                    const batch = db.batch();
                    coursesToUpdate.forEach(course => {
                        const courseRef = db.collection('cursos').doc(course.id);
                        batch.update(courseRef, {
                            lote: newName.trim(),
                            loteResponsavel: newName.trim()
                        });
                        // Atualizar localmente também
                        course.lote = newName.trim();
                        course.loteResponsavel = newName.trim();
                });
                    await batch.commit();
            } else {
                    coursesToUpdate.forEach(course => {
                        course.lote = newName.trim();
                        course.loteResponsavel = newName.trim();
                    });
                localStorage.setItem('cursos', JSON.stringify(cursos));
            }

            showToast('Nome do LOTE atualizado!', 'success');
                logActivity('Edição de LOTE', `Renomeou o LOTE "${lote}" para "${newName.trim()}"`, 'edit');
                
                // Renderizar de forma otimizada
                requestAnimationFrame(() => {
                    renderCoursesByLote();
                });
            } catch (error) {
                console.error('Erro ao salvar nome do LOTE:', error);
                showToast('Erro ao atualizar nome do LOTE', 'error');
            } finally {
                setLoadingState(false);
            }
        }

        function renderDashboardReport() {
            const container = document.getElementById('dashboardReport');
            if (!container) return;

            const total = cursos.length;
            const concluidos = cursos.filter(c => normalizeStatus(c.status) === 'Concluído').length;
            const andamento = cursos.filter(c => normalizeStatus(c.status) === 'Em Andamento').length;
            const pendentes = cursos.filter(c => normalizeStatus(c.status) === 'Pendente').length;
            const cancelados = cursos.filter(c => normalizeStatus(c.status) === 'Cancelado').length;
            const totalAlunos = cursos.reduce((sum, c) => sum + (parseInt(c.alunos) || 0), 0);
            
            // Estatísticas adicionais
            const cursosPorCidade = {};
            const cursosPorInstrutor = {};
            const cursosPorLote = {};
            const cargaHorariaTotal = cursos.reduce((sum, c) => {
                const carga = parseInt(c.cargaHoraria) || 0;
                return sum + carga;
            }, 0);
            
            cursos.forEach(c => {
                const cidade = c.cidade || 'Não definido';
                cursosPorCidade[cidade] = (cursosPorCidade[cidade] || 0) + 1;
                
                const instrutor = c.instrutor || 'Não definido';
                cursosPorInstrutor[instrutor] = (cursosPorInstrutor[instrutor] || 0) + 1;
                
                const lote = c.lote || c.loteResponsavel || 'Sem LOTE';
                cursosPorLote[lote] = (cursosPorLote[lote] || 0) + 1;
            });
            
            const topCidades = Object.entries(cursosPorCidade)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            const topInstrutores = Object.entries(cursosPorInstrutor)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            const totalLotes = Object.keys(cursosPorLote).length;
            
            // Calcular percentuais
            const percentConcluidos = total > 0 ? ((concluidos / total) * 100).toFixed(1) : 0;
            const percentAndamento = total > 0 ? ((andamento / total) * 100).toFixed(1) : 0;
            const percentPendentes = total > 0 ? ((pendentes / total) * 100).toFixed(1) : 0;
            const percentCancelados = total > 0 ? ((cancelados / total) * 100).toFixed(1) : 0;
            const mediaAlunos = total > 0 ? (totalAlunos / total).toFixed(1) : 0;

            container.innerHTML = `
                <div class="report-kpi-grid">
                    <div class="report-kpi-card purple">
                        <div class="report-kpi-value">${total}</div>
                        <div class="report-kpi-label">Total de Cursos</div>
                    </div>
                    <div class="report-kpi-card green">
                        <div class="report-kpi-value">${concluidos}</div>
                        <div class="report-kpi-label">Concluídos (${percentConcluidos}%)</div>
                    </div>
                    <div class="report-kpi-card blue">
                        <div class="report-kpi-value">${andamento}</div>
                        <div class="report-kpi-label">Em Andamento (${percentAndamento}%)</div>
                    </div>
                    <div class="report-kpi-card yellow">
                        <div class="report-kpi-value">${pendentes}</div>
                        <div class="report-kpi-label">Pendentes (${percentPendentes}%)</div>
                    </div>
                    ${cancelados > 0 ? `
                    <div class="report-kpi-card red">
                        <div class="report-kpi-value">${cancelados}</div>
                        <div class="report-kpi-label">Cancelados (${percentCancelados}%)</div>
                    </div>
                    ` : ''}
                    <div class="report-kpi-card">
                        <div class="report-kpi-value">${totalAlunos}</div>
                        <div class="report-kpi-label">Total Concludentes</div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem; margin-top: 2rem;">
                    <!-- Gráfico Pizza de Status -->
                    <div class="settings-card">
                        <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 8px;">
                            <span class="material-icons">pie_chart</span>
                            Distribuição por Status
                        </h3>
                        <div style="display: flex; justify-content: center; margin: 1.5rem 0;">
                            <canvas id="dashboardStatusChart" width="300" height="300"></canvas>
                        </div>
                    </div>
                    
                    <!-- Top Cidades -->
                    <div class="settings-card">
                        <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 8px;">
                            <span class="material-icons">location_city</span>
                            Top 5 Cidades
                        </h3>
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            ${topCidades.map(([cidade, qtd]) => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--background); border-radius: 8px; border: 1px solid var(--border);">
                                    <span style="color: var(--text-primary);">${cidade}</span>
                                    <span style="background: var(--primary); color: white; padding: 4px 12px; border-radius: 12px; font-weight: 600; font-size: 0.875rem;">${qtd}</span>
                                </div>
                            `).join('')}
                            ${topCidades.length === 0 ? '<p style="color: var(--text-muted); text-align: center;">Nenhuma cidade cadastrada</p>' : ''}
                        </div>
                    </div>
                    
                    <!-- Top Instrutores -->
                    <div class="settings-card">
                        <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 8px;">
                            <span class="material-icons">people</span>
                            Top 5 Instrutores
                        </h3>
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            ${topInstrutores.map(([instrutor, qtd]) => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--background); border-radius: 8px; border: 1px solid var(--border);">
                                    <span style="color: var(--text-primary);">${instrutor}</span>
                                    <span style="background: var(--success); color: white; padding: 4px 12px; border-radius: 12px; font-weight: 600; font-size: 0.875rem;">${qtd}</span>
                                </div>
                            `).join('')}
                            ${topInstrutores.length === 0 ? '<p style="color: var(--text-muted); text-align: center;">Nenhum instrutor cadastrado</p>' : ''}
                        </div>
                    </div>
                    
                    <!-- Distribuição por LOTE -->
                    <div class="settings-card">
                        <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 8px;">
                            <span class="material-icons">folder</span>
                            Distribuição por LOTE
                        </h3>
                        <div style="display: flex; flex-direction: column; gap: 1rem; max-height: 300px; overflow-y: auto;">
                            ${Object.entries(cursosPorLote).sort((a, b) => b[1] - a[1]).map(([lote, qtd]) => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--background); border-radius: 8px; border: 1px solid var(--border);">
                                    <span style="color: var(--text-primary);">${getDisplayLoteName(lote)}</span>
                                    <span style="background: var(--info); color: white; padding: 4px 12px; border-radius: 12px; font-weight: 600; font-size: 0.875rem;">${qtd}</span>
                                </div>
                            `).join('')}
                            ${Object.keys(cursosPorLote).length === 0 ? '<p style="color: var(--text-muted); text-align: center;">Nenhum LOTE cadastrado</p>' : ''}
                        </div>
                    </div>
                </div>
            `;
            
            // Renderizar gráfico pizza após um pequeno delay para garantir que o canvas esteja no DOM
            setTimeout(() => {
                const ctx = document.getElementById('dashboardStatusChart')?.getContext('2d');
                if (ctx && Chart) {
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Concluídos', 'Em Andamento', 'Pendentes', 'Cancelados'],
                            datasets: [{
                                data: [concluidos, andamento, pendentes, cancelados],
                                backgroundColor: ['#34d399', '#60a5fa', '#fbbf24', '#f87171'],
                                borderWidth: 0,
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            cutout: '60%',
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        color: '#f8fafc',
                                        padding: 15,
                                        font: {
                                            size: 12,
                                            weight: '500'
                                        }
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    padding: 12,
                                    titleFont: {
                                        size: 14,
                                        weight: '600'
                                    },
                                    bodyFont: {
                                        size: 13
                                    },
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed || 0;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                            return `${label}: ${value} (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }, 100);
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Login
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const page = item.dataset.page;
                    navigateTo(page);
                });
            });

            // Mobile Bottom Navigation
            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const page = item.dataset.page;
                    navigateTo(page);
                    // Update active state
                    document.querySelectorAll('.mobile-nav-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                });
            });

            // Mobile FAB
            const mobileFab = document.getElementById('mobileFab');
            if (mobileFab) {
                mobileFab.addEventListener('click', () => {
                    const activePage = document.querySelector('.page-section.active')?.id;
                    if (activePage === 'coursesPage') {
                        openCourseModal();
                    } else if (activePage === 'instructorsPage') {
                        openInstructorModal();
                    } else if (activePage === 'usersPage') {
                        openUserModal();
                    } else {
                        openCourseModal(); // Default
                    }
                });
            }

            // Sidebar Overlay
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', () => {
                    document.getElementById('sidebar').classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                });
            }

            // Mobile menu
            document.getElementById('mobileMenuBtn').addEventListener('click', toggleSidebar);

            // Filtro de LOTE na página de Cursos

            // Buttons
            const newCourseBtn = document.getElementById('newCourseBtn');
            if (newCourseBtn) {
                newCourseBtn.addEventListener('click', () => openCourseModal());
            }
            const newInstructorBtn = document.getElementById('newInstructorBtn');
            if (newInstructorBtn) {
                newInstructorBtn.addEventListener('click', () => openInstructorModal());
            }
            const importInstructorsBtn = document.getElementById('importInstructorsBtn');
            if (importInstructorsBtn) {
                importInstructorsBtn.addEventListener('click', () => {
                    document.getElementById('instructorsFileInput').click();
                });
            }
            document.getElementById('newUserBtn').addEventListener('click', () => openUserModal());
            
            // Mobile menu
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('click', toggleSidebar);
            }
            
            // Botão fixo para abrir sidebar no mobile
            const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
            if (mobileSidebarToggle) {
                mobileSidebarToggle.addEventListener('click', toggleSidebar);
            }
            
            // Botão de download do relatório
            const downloadReportBtn = document.getElementById('downloadReportBtn');
            if (downloadReportBtn) {
                downloadReportBtn.addEventListener('click', () => {
                    downloadReportAsImage();
                });
            }

            // Calendar
            document.getElementById('prevMonth').addEventListener('click', () => changeMonth(-1));
            document.getElementById('nextMonth').addEventListener('click', () => changeMonth(1));
            document.getElementById('todayBtn').addEventListener('click', goToToday);

            // Forms
            document.getElementById('courseForm').addEventListener('submit', handleCourseSubmit);
            document.getElementById('instructorForm').addEventListener('submit', handleInstructorSubmit);
            document.getElementById('quickInstructorForm').addEventListener('submit', handleQuickInstructorSubmit);
            document.getElementById('userForm').addEventListener('submit', handleUserSubmit);
            document.getElementById('changePasswordForm').addEventListener('submit', handleChangePassword);
            document.getElementById('changeNameForm').addEventListener('submit', handleChangeName); 

            // Settings - O preview será tratado em initializeImportPreview
            document.getElementById('instructorsFileInput').addEventListener('change', handleInstructorsUpload);
            document.getElementById('exportCoursesBtn').addEventListener('click', exportCoursesToCsv);
            if (document.getElementById('exportCoursesExcelBtn')) {
                document.getElementById('exportCoursesExcelBtn').addEventListener('click', exportCoursesToExcel);
            }
            if (document.getElementById('exportCoursesPDFBtn')) {
                document.getElementById('exportCoursesPDFBtn').addEventListener('click', exportCoursesToPDF);
            }
            document.getElementById('exportInstructorsBtn').addEventListener('click', exportInstructorsToCsv);
            document.getElementById('clearDataBtn').addEventListener('click', clearAllData);
            
            // Filtros de auditoria
            document.getElementById('auditFilterAction')?.addEventListener('change', renderAuditLogs);
            document.getElementById('auditFilterUser')?.addEventListener('change', renderAuditLogs);
            document.getElementById('auditFilterDate')?.addEventListener('change', renderAuditLogs);
            
            // Novas funcionalidades
            initializeAdvancedFeatures();
        }

        function handleLogout() {
            // Registrar logout no audit log antes de limpar
            if (currentUser) {
                addAuditLog('logout', 'session', currentUser.id, `${currentUser.name} fez logout`);
            }
            
            // Salvar automaticamente antes de sair
            saveAllChanges();
            currentUser = null;
            localStorage.removeItem('currentUser');
            window.location.reload();
        }
        
        // ========== IMPLEMENTAÇÃO DAS NOVAS FUNCIONALIDADES ==========
        
        // Variáveis globais para novas funcionalidades
        let currentFilters = {};
        let currentSort = { field: 'name', direction: 'asc' };
        let currentPage = 1;
        let itemsPerPage = 10000; // Mostrar todos os cursos
        let notifications = [];
        let changeHistory = [];
        let unsavedChanges = false;
        let previewData = null;
        let backupInterval = null;
        // Inicializar todas as novas funcionalidades
        function initializeAdvancedFeatures() {
            initializeTheme();
            initializeSearchAndFilters();
            initializePagination();
            initializeSorting();
            initializeKeyboardShortcuts();
            initializeAutoSave();
            initializeBackup();
            initializeTooltips();
            initializeChangeHistory();
            initializeImportPreview();
            initializeCustomTheme();
            initializeProjectName();
            initializeCompactMode();
            initializeBreadcrumbs();
            initializePushNotifications();
            initializePWA();
            initializeSwipeGestures();
            initializeSkeletonLoading();
        }
        
        // ==================== MODO COMPACTO ====================
        function initializeCompactMode() {
            const compactBtn = document.getElementById('compactModeBtn');
            if (!compactBtn) return;
            
            const savedCompact = localStorage.getItem('compactMode') === 'true';
            if (savedCompact) {
                document.body.classList.add('compact-mode');
                compactBtn.classList.add('active');
            }
            
            compactBtn.addEventListener('click', () => {
                document.body.classList.toggle('compact-mode');
                compactBtn.classList.toggle('active');
                const isCompact = document.body.classList.contains('compact-mode');
                localStorage.setItem('compactMode', isCompact);
                showToast(isCompact ? 'Modo compacto ativado' : 'Modo normal ativado', 'success');
            });
        }
        
        // ==================== BREADCRUMBS ====================
        const pageNames = {
            dashboard: 'Dashboard',
            courses: 'Cursos',
            calendar: 'Calendário',
            instructors: 'Instrutores',
            users: 'Usuários',
            settings: 'Configurações'
        };
        
        function initializeBreadcrumbs() {
            document.querySelectorAll('.breadcrumb-item[data-page]').forEach(item => {
                item.addEventListener('click', () => {
                    const page = item.dataset.page;
                    if (page) navigateTo(page);
                });
            });
        }
        
        function updateBreadcrumbs(page) {
            const currentBreadcrumb = document.getElementById('currentPageBreadcrumb');
            if (currentBreadcrumb) {
                currentBreadcrumb.textContent = pageNames[page] || page;
                currentBreadcrumb.classList.add('animate-fade-in');
                setTimeout(() => currentBreadcrumb.classList.remove('animate-fade-in'), 300);
            }
        }
        
        // ==================== NOTIFICAÇÕES PUSH ====================
        let pushNotificationQueue = [];
        let pushNotificationTimer = null;
        
        function initializePushNotifications() {
            // Solicitar permissão para notificações do navegador
            if ('Notification' in window && Notification.permission === 'default') {
                setTimeout(() => {
                    Notification.requestPermission();
                }, 5000);
            }
            
            // Verificar cursos com alertas periodicamente
            setInterval(checkCourseAlerts, 60000); // A cada minuto
            setTimeout(checkCourseAlerts, 3000); // Verificar após 3s do carregamento
        }
        
        function checkCourseAlerts() {
            if (!cursos || cursos.length === 0) return;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            cursos.forEach(course => {
                // Alerta: curso inicia em 3 dias
                if (course.inicio) {
                    const startDate = new Date(course.inicio);
                    startDate.setHours(0, 0, 0, 0);
                    const daysUntilStart = Math.ceil((startDate - today) / (1000 * 60 * 60 * 24));
                    
                    if (daysUntilStart > 0 && daysUntilStart <= 3 && normalizeStatus(course.status) === 'Pendente') {
                        const notifId = `start-${course.id}-${startDate.toISOString()}`;
                        if (!localStorage.getItem(`notif-dismissed-${notifId}`)) {
                            showPushNotification(
                                'Curso prestes a iniciar',
                                `"${course.curso}" inicia em ${daysUntilStart} dia(s) - ${formatDate(course.inicio)}`,
                                'schedule',
                                [{ text: 'Ver curso', action: () => openViewCourseModal(course.id) }],
                                notifId
                            );
                        }
                    }
                }
                
                // Alerta: curso finaliza em 3 dias
                if (course.fim) {
                    const endDate = new Date(course.fim);
                    endDate.setHours(0, 0, 0, 0);
                    const daysUntilEnd = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
                    
                    if (daysUntilEnd > 0 && daysUntilEnd <= 3 && normalizeStatus(course.status) === 'Em Andamento') {
                        const notifId = `end-${course.id}-${endDate.toISOString()}`;
                        if (!localStorage.getItem(`notif-dismissed-${notifId}`)) {
                            showPushNotification(
                                'Curso prestes a finalizar',
                                `"${course.curso}" termina em ${daysUntilEnd} dia(s) - ${formatDate(course.fim)}`,
                                'event_available',
                                [{ text: 'Ver curso', action: () => openViewCourseModal(course.id) }],
                                notifId
                            );
                        }
                    }
                }
            });
        }
        
        function showPushNotification(title, message, icon = 'notifications', actions = [], notifId = null) {
            // Notificação in-app
            const banner = document.getElementById('pushNotificationBanner');
            const titleEl = document.getElementById('pushNotificationTitle');
            const bodyEl = document.getElementById('pushNotificationBody');
            const actionsEl = document.getElementById('pushNotificationActions');
            
            if (banner && titleEl && bodyEl) {
                titleEl.textContent = title;
                bodyEl.textContent = message;
                
                actionsEl.innerHTML = '';
                actions.forEach(action => {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-primary';
                    btn.textContent = action.text;
                    btn.onclick = () => {
                        action.action();
                        closePushNotification(notifId);
                    };
                    actionsEl.appendChild(btn);
                });
                
                banner.classList.add('show');
                banner.dataset.notifId = notifId || '';
                
                // Auto-hide após 10s
                if (pushNotificationTimer) clearTimeout(pushNotificationTimer);
                pushNotificationTimer = setTimeout(() => closePushNotification(), 10000);
            }
            
            // Notificação do navegador (se permitido)
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: message,
                    icon: '/favicon.ico',
                    badge: '/favicon.ico'
                });
            }
        }
        
        function closePushNotification(notifId = null) {
            const banner = document.getElementById('pushNotificationBanner');
            if (banner) {
                const id = notifId || banner.dataset.notifId;
                if (id) {
                    localStorage.setItem(`notif-dismissed-${id}`, 'true');
                }
                banner.classList.add('hiding');
                setTimeout(() => {
                    banner.classList.remove('show', 'hiding');
                }, 300);
            }
        }
        window.closePushNotification = closePushNotification;
        
        // ==================== PWA ====================
        let deferredPrompt = null;
        
        function initializePWA() {
            // Registrar Service Worker apenas em ambiente HTTP/HTTPS
            if ('serviceWorker' in navigator && window.location.protocol !== 'file:') {
                navigator.serviceWorker.register('sw.js').catch(err => {
                    console.log('Service Worker não registrado:', err);
                });
            }
            
            // Capturar evento de instalação
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                // Mostrar prompt de instalação após 30s se não foi instalado
                if (!localStorage.getItem('pwa-installed') && !localStorage.getItem('pwa-dismissed')) {
                    setTimeout(() => {
                        const prompt = document.getElementById('pwaInstallPrompt');
                        if (prompt) prompt.classList.add('show');
                    }, 30000);
                }
            });
            
            window.addEventListener('appinstalled', () => {
                localStorage.setItem('pwa-installed', 'true');
                deferredPrompt = null;
                showToast('App instalado com sucesso!', 'success');
            });
        }
        
        function installPWA() {
            const prompt = document.getElementById('pwaInstallPrompt');
            if (prompt) prompt.classList.remove('show');
            
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(choice => {
                    if (choice.outcome === 'accepted') {
                        showToast('Instalando app...', 'success');
                    }
                    deferredPrompt = null;
                });
            }
        }
        window.installPWA = installPWA;
        
        function dismissPWAPrompt() {
            const prompt = document.getElementById('pwaInstallPrompt');
            if (prompt) prompt.classList.remove('show');
            localStorage.setItem('pwa-dismissed', 'true');
        }
        window.dismissPWAPrompt = dismissPWAPrompt;
        
        // ==================== SWIPE GESTURES ====================
        function initializeSwipeGestures() {
            // Só ativar em dispositivos touch
            if (!('ontouchstart' in window)) return;
            
            document.addEventListener('touchstart', handleTouchStart, { passive: true });
            document.addEventListener('touchmove', handleTouchMove, { passive: false });
            document.addEventListener('touchend', handleTouchEnd, { passive: true });
        }
        
        let touchStartX = 0;
        let touchStartY = 0;
        let currentSwipeCard = null;
        
        function handleTouchStart(e) {
            const card = e.target.closest('.course-card');
            if (!card || currentUser?.role === 'viewer') return;
            
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            currentSwipeCard = card;
        }
        
        function handleTouchMove(e) {
            if (!currentSwipeCard) return;
            
            const touchX = e.touches[0].clientX;
            const touchY = e.touches[0].clientY;
            const diffX = touchStartX - touchX;
            const diffY = Math.abs(touchStartY - e.touches[0].clientY);
            
            // Só swipe horizontal
            if (diffY > 30) {
                currentSwipeCard = null;
                return;
            }
            
            if (diffX > 50) {
                e.preventDefault();
                currentSwipeCard.style.transform = `translateX(-${Math.min(diffX, 120)}px)`;
                currentSwipeCard.classList.add('swiping');
            }
        }
        
        function handleTouchEnd(e) {
            if (!currentSwipeCard) return;
            
            const card = currentSwipeCard;
            const transform = card.style.transform;
            const translateX = transform ? parseInt(transform.match(/-?\d+/)?.[0] || 0) : 0;
            
            card.classList.remove('swiping');
            
            if (Math.abs(translateX) > 80) {
                // Mostrar ações
                card.style.transform = 'translateX(-120px)';
                
                // Adicionar botões de ação se não existirem
                if (!card.querySelector('.swipe-actions-container')) {
                    const courseId = card.getAttribute('onclick')?.match(/'([^']+)'/)?.[1];
                    if (courseId) {
                        const actionsHtml = `
                            <div class="swipe-actions-container" style="position: absolute; right: 0; top: 0; height: 100%; display: flex; z-index: 10;">
                                <button onclick="event.stopPropagation(); openCourseModal('${courseId}')" style="background: var(--primary); color: white; border: none; padding: 0 1rem; cursor: pointer;">
                                    <span class="material-icons">edit</span>
                                </button>
                                <button onclick="event.stopPropagation(); deleteCourse('${courseId}')" style="background: var(--danger); color: white; border: none; padding: 0 1rem; cursor: pointer;">
                                    <span class="material-icons">delete</span>
                                </button>
                            </div>
                        `;
                        card.style.position = 'relative';
                        card.style.overflow = 'hidden';
                        card.insertAdjacentHTML('beforeend', actionsHtml);
                    }
                }
                
                // Fechar ao clicar fora
                setTimeout(() => {
                    const closeHandler = (ev) => {
                        if (!card.contains(ev.target)) {
                            card.style.transform = '';
                            const actions = card.querySelector('.swipe-actions-container');
                            if (actions) actions.remove();
                            document.removeEventListener('touchstart', closeHandler);
                            document.removeEventListener('click', closeHandler);
                        }
                    };
                    document.addEventListener('touchstart', closeHandler);
                    document.addEventListener('click', closeHandler);
                }, 100);
            } else {
                card.style.transform = '';
            }
            
            currentSwipeCard = null;
        }
        
        // ==================== SKELETON LOADING ====================
        function initializeSkeletonLoading() {
            // Mostrar skeleton ao carregar
            showSkeletonLoading();
        }
        
        function showSkeletonLoading() {
            const container = document.getElementById('coursesByLoteContainer');
            if (!container) return;
            
            const skeletonHtml = `
                <div class="courses-grid">
                    ${Array(6).fill().map(() => `
                        <div class="skeleton skeleton-card"></div>
                    `).join('')}
                </div>
            `;
            container.innerHTML = skeletonHtml;
        }
        
        function hideSkeletonLoading() {
            // O skeleton é automaticamente substituído pelo renderCoursesByLote
        }
        
        // 1. Modo Escuro/Claro e Temas
        function initializeTheme() {
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = document.getElementById('themeIcon');
            const savedTheme = localStorage.getItem('theme') || 'dark';
            const savedColorTheme = localStorage.getItem('colorTheme') || 'default';
            
            // Aplicar modo claro/escuro primeiro
            if (savedTheme === 'light') {
                document.documentElement.classList.add('light-mode');
                if (themeIcon) themeIcon.textContent = 'light_mode';
            }
            
            // Toggle claro/escuro
            if (themeToggle && themeIcon) {
                themeToggle.addEventListener('click', () => {
                    document.documentElement.classList.toggle('light-mode');
                    const isLight = document.documentElement.classList.contains('light-mode');
                    themeIcon.textContent = isLight ? 'light_mode' : 'dark_mode';
                    localStorage.setItem('theme', isLight ? 'light' : 'dark');
                });
            }
            
            // Aplicar tema de cor salvo (depois do modo claro/escuro)
            applyColorTheme(savedColorTheme);
            
            // Inicializar seleção de temas de cor
            initializeColorThemes();
        }
        
        function initializeColorThemes() {
            const themeOptions = document.querySelectorAll('.theme-option');
            const savedColorTheme = localStorage.getItem('colorTheme') || 'default';
            
            // Marcar tema ativo
            themeOptions.forEach(option => {
                const theme = option.dataset.theme;
                if (theme === savedColorTheme) {
                    option.classList.add('active');
                }
                
                option.addEventListener('click', () => {
                    // Remover active de todos
                    themeOptions.forEach(opt => opt.classList.remove('active'));
                    // Adicionar active ao selecionado
                    option.classList.add('active');
                    // Aplicar tema
                    applyColorTheme(theme);
                    localStorage.setItem('colorTheme', theme);
                    showToast(`Tema "${option.querySelector('h4').textContent}" aplicado!`, 'success');
                });
            });
        }
        
        function applyColorTheme(theme) {
            // Remover todos os temas de cor
            document.documentElement.classList.remove('theme-blue', 'theme-green', 'theme-purple', 'theme-orange', 'theme-pink', 'theme-custom');
            
            // Se for tema customizado, aplicar cores salvas
            if (theme === 'custom') {
                applyCustomTheme();
                document.documentElement.classList.add('theme-custom');
            } else if (theme && theme !== 'default') {
                // Aplicar novo tema (default não precisa de classe)
                document.documentElement.classList.add(`theme-${theme}`);
                // Limpar cores customizadas quando trocar para tema pré-definido
                clearCustomTheme();
            } else {
                // Tema padrão
                clearCustomTheme();
            }
        }
        
        function applyCustomTheme() {
            const customColors = JSON.parse(localStorage.getItem('customThemeColors') || '{}');
            if (Object.keys(customColors).length > 0) {
                Object.entries(customColors).forEach(([key, value]) => {
                    document.documentElement.style.setProperty(`--${key}`, value);
                });
            }
        }
        
        function clearCustomTheme() {
            // Remover estilos inline de cores customizadas
            const customColorKeys = ['primary', 'primary-hover', 'background', 'sidebar', 'surface', 'surface-hover'];
            customColorKeys.forEach(key => {
                document.documentElement.style.removeProperty(`--${key}`);
            });
        }
        
        function initializeCustomTheme() {
            const applyBtn = document.getElementById('applyCustomThemeBtn');
            const resetBtn = document.getElementById('resetCustomThemeBtn');
            const primaryInput = document.getElementById('customPrimaryColor');
            const backgroundInput = document.getElementById('customBackgroundColor');
            const sidebarInput = document.getElementById('customSidebarColor');
            const surfaceInput = document.getElementById('customSurfaceColor');
            
            // Carregar cores salvas
            const savedColors = JSON.parse(localStorage.getItem('customThemeColors') || '{}');
            if (savedColors.primary) primaryInput.value = savedColors.primary;
            if (savedColors.background) backgroundInput.value = savedColors.background;
            if (savedColors.sidebar) sidebarInput.value = savedColors.sidebar;
            if (savedColors.surface) surfaceInput.value = savedColors.surface;
            
            if (applyBtn) {
                applyBtn.addEventListener('click', () => {
                    const customColors = {
                        primary: primaryInput.value,
                        'primary-hover': adjustColorBrightness(primaryInput.value, -10),
                        background: backgroundInput.value,
                        sidebar: sidebarInput.value,
                        surface: surfaceInput.value,
                        'surface-hover': adjustColorBrightness(surfaceInput.value, 10)
                    };
                    
                    localStorage.setItem('customThemeColors', JSON.stringify(customColors));
                    localStorage.setItem('colorTheme', 'custom');
                    
                    // Aplicar tema customizado
                    applyColorTheme('custom');
                    
                    // Atualizar seleção visual
                    document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('active'));
                    
                    showToast('Tema personalizado aplicado com sucesso!', 'success');
                });
            }
            
            if (resetBtn) {
                resetBtn.addEventListener('click', () => {
                    if (confirm('Deseja restaurar as cores padrão do tema?')) {
                        localStorage.removeItem('customThemeColors');
                        localStorage.setItem('colorTheme', 'default');
                        
                        // Restaurar valores padrão
                        primaryInput.value = '#6366f1';
                        backgroundInput.value = '#0f172a';
                        sidebarInput.value = '#020617';
                        surfaceInput.value = '#1e293b';
                        
                        applyColorTheme('default');
                        
                        // Atualizar seleção visual
                        document.querySelectorAll('.theme-option').forEach(opt => {
                            opt.classList.toggle('active', opt.dataset.theme === 'default');
                        });
                        
                        showToast('Cores padrão restauradas!', 'success');
                    }
                });
            }
        }
        
        function adjustColorBrightness(hex, percent) {
            // Converter hex para RGB
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            
            // Ajustar brilho
            const newR = Math.max(0, Math.min(255, r + (r * percent / 100)));
            const newG = Math.max(0, Math.min(255, g + (g * percent / 100)));
            const newB = Math.max(0, Math.min(255, b + (b * percent / 100)));
            
            // Converter de volta para hex
            return '#' + [newR, newG, newB].map(x => {
                const hex = Math.round(x).toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            }).join('');
        }
        
        // Gerenciamento de Nome do Projeto
        function initializeProjectName() {
            const projectNameInput = document.getElementById('projectNameInput');
            const saveProjectNameBtn = document.getElementById('saveProjectNameBtn');
            
            // Carregar nome salvo
            const savedName = localStorage.getItem('projectName') || 'Ceará Sem Fome + Qualificação e Renda';
            if (projectNameInput) {
                projectNameInput.value = savedName;
            }
            
            // Salvar nome do projeto
            if (saveProjectNameBtn) {
                saveProjectNameBtn.addEventListener('click', () => {
                    const projectName = projectNameInput.value.trim();
                    if (!projectName) {
                        showToast('Por favor, digite um nome para o projeto', 'warning');
                        return;
                    }
                    
                    localStorage.setItem('projectName', projectName);
                    updateProjectName(projectName);
                    showToast('Nome do projeto atualizado!', 'success');
                });
            }
            
            // Permitir salvar com Enter
            if (projectNameInput) {
                projectNameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        saveProjectNameBtn.click();
                    }
                });
            }
        }
        
        function loadProjectName() {
            const projectName = localStorage.getItem('projectName') || 'Ceará Sem Fome + Qualificação e Renda';
            updateProjectName(projectName);
        }
        
        function updateProjectName(name) {
            const loginProjectName = document.getElementById('loginProjectName');
            const sidebarProjectName = document.getElementById('sidebarProjectName');
            
            if (loginProjectName) {
                loginProjectName.textContent = name;
            }
            
            if (sidebarProjectName) {
                sidebarProjectName.textContent = name;
            }
        }
        
        // Aplicar tema ao carregar a página
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                const savedColorTheme = localStorage.getItem('colorTheme') || 'default';
                applyColorTheme(savedColorTheme);
            });
        } else {
            const savedColorTheme = localStorage.getItem('colorTheme') || 'default';
            applyColorTheme(savedColorTheme);
        }
        
        // Funções de notificação removidas conforme solicitado
        
        // 3. Busca Avançada e Filtros
        function initializeSearchAndFilters() {
            const toggleFiltersBtn = document.getElementById('toggleFiltersBtn');
            const filtersContainer = document.getElementById('filtersContainer');
            const applyFiltersBtn = document.getElementById('applyFiltersBtn');
            const clearFiltersBtn = document.getElementById('clearFiltersBtn');
            const filterIdInput = document.getElementById('filterId');
            
            if (toggleFiltersBtn && filtersContainer) {
                toggleFiltersBtn.addEventListener('click', () => {
                    filtersContainer.style.display = filtersContainer.style.display === 'none' ? 'grid' : 'none';
                });
            }
            
            if (applyFiltersBtn) {
                applyFiltersBtn.addEventListener('click', applyFilters);
            }
            
            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', () => {
                    currentFilters = {};
                    document.getElementById('filterStatus').value = '';
                    document.getElementById('filterLote').value = '';
                    document.getElementById('filterCurso').value = '';
                    document.getElementById('filterId').value = '';
                    applyFilters();
                });
            }
            
            // Filtro por ID em tempo real (atualiza automaticamente enquanto digita)
            if (filterIdInput) {
                let idFilterTimeout;
                filterIdInput.addEventListener('input', (e) => {
                    clearTimeout(idFilterTimeout);
                    const idValue = e.target.value.trim();
                    
                    // Atualizar filtro imediatamente
                    if (idValue === '') {
                        currentFilters.id = '';
                    } else {
                        currentFilters.id = idValue;
                    }
                    
                    // Aplicar filtro com pequeno delay para melhor performance
                    idFilterTimeout = setTimeout(() => {
                        applyFilters();
                    }, 300);
                });
            }
            
            // Popular selects de filtros
            updateLoteFilter();
            updateCursoFilter();
        }
        
        function applyFilters() {
            // Coletar valores atuais dos filtros
            currentFilters = {
                status: document.getElementById('filterStatus')?.value || '',
                lote: document.getElementById('filterLote')?.value || '',
                curso: document.getElementById('filterCurso')?.value || '',
                id: document.getElementById('filterId')?.value || ''
            };
            
            currentPage = 1;
            if (document.getElementById('coursesPage')?.classList.contains('active')) {
                renderCoursesByLote();
            }
        }
        
        function filterCourses(courses) {
            if (!courses || courses.length === 0) return [];
            
            // Se não houver filtros definidos, retornar todos os cursos
            if (!currentFilters || Object.keys(currentFilters).length === 0) {
                return [...courses];
            }
            
            let filtered = [...courses];
            
            // Filtro por status
            if (currentFilters.status && currentFilters.status !== '') {
                filtered = filtered.filter(c => normalizeStatus(c.status) === currentFilters.status);
            }
            
            // Filtro por LOTE
            if (currentFilters.lote && currentFilters.lote !== '') {
                filtered = filtered.filter(c => {
                    const lote = c.lote || c.loteResponsavel || c.idLote || '';
                    return lote === currentFilters.lote;
                });
            }
            
            // Filtro por Curso
            if (currentFilters.curso && currentFilters.curso !== '') {
                filtered = filtered.filter(c => {
                    const curso = c.curso || c.nome || '';
                    return curso === currentFilters.curso;
                });
            }
            
            // Filtro por ID (busca parcial - contém o número digitado)
            if (currentFilters.id && currentFilters.id !== '') {
                const filterId = String(currentFilters.id).trim().toLowerCase();
                filtered = filtered.filter(c => {
                    // Buscar no ID do curso (case-insensitive)
                    const courseId = String(c.id || '').trim().toLowerCase();
                    if (courseId.includes(filterId)) {
                        return true;
                    }
                    
                    // Também buscar no idLote se for número
                    const idLote = String(c.idLote || '').trim().toLowerCase();
                    if (idLote && idLote.includes(filterId)) {
                        return true;
                    }
                    
                    // Buscar também em qualquer parte do ID que contenha o número
                    // Por exemplo, se o ID for "course_123_abc" e digitar "123", deve encontrar
                    const fullId = courseId + '_' + idLote;
                    if (fullId.includes(filterId)) {
                        return true;
                    }
                    
                    return false;
                });
            }
            
            return filtered;
        }
        
        function updateLoteFilter() {
            const select = document.getElementById('filterLote');
            if (!select) return;
            
            // Coletar todos os lotes únicos (incluindo dados importados)
            const lotes = [...new Set(cursos.map(c => c.lote || c.loteResponsavel || c.idLote).filter(Boolean))];
            lotes.sort();
            select.innerHTML = '<option value="">Todos</option>' + 
                lotes.map(l => `<option value="${l}">${l}</option>`).join('');
        }
        
        function updateCursoFilter() {
            const select = document.getElementById('filterCurso');
            if (!select) return;
            
            // Coletar todos os cursos únicos (sem repetir nomes, incluindo dados importados)
            const cursosUnicos = [...new Set(cursos.map(c => c.curso || c.nome).filter(Boolean))];
            cursosUnicos.sort();
            select.innerHTML = '<option value="">Todos</option>' + 
                cursosUnicos.map(c => `<option value="${c}">${c}</option>`).join('');
        }
        
        // 4. Paginação
        function initializePagination() {
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            
            if (prevBtn) prevBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderCoursesByLote();
                }
            });
            
            if (nextBtn) nextBtn.addEventListener('click', () => {
                currentPage++;
                renderCoursesByLote();
            });
        }
        
        function renderPagination(totalItems) {
            const container = document.getElementById('paginationContainer');
            const pageInfo = document.getElementById('pageInfo');
            
            if (!container) return;
            
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            
            // Ocultar paginação se mostrar todos os cursos ou se houver apenas 1 página
            if (totalPages <= 1 || itemsPerPage >= 10000) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'flex';
            if (pageInfo) {
                pageInfo.textContent = `Página ${currentPage} de ${totalPages}`;
            }
            
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            
            if (prevBtn) prevBtn.disabled = currentPage === 1;
            if (nextBtn) nextBtn.disabled = currentPage === totalPages;
        }
        
        // 5. Ordenação
        function initializeSorting() {
            const sortSelect = document.getElementById('sortCourses');
            if (sortSelect) {
                sortSelect.addEventListener('change', (e) => {
                    const value = e.target.value;
                    if (value === 'name') currentSort = { field: 'nome', direction: 'asc' };
                    else if (value === 'date') currentSort = { field: 'inicio', direction: 'desc' };
                    else if (value === 'status') currentSort = { field: 'status', direction: 'asc' };
                    else if (value === 'city') currentSort = { field: 'cidade', direction: 'asc' };
                    
                    currentPage = 1;
                    renderCoursesByLote();
                });
            }
        }
        
        function sortCourses(courses) {
            return [...courses].sort((a, b) => {
                // Primeiro: ordenar por data (mais recentes primeiro, sem datas por último)
                const aDate = a.inicio ? new Date(a.inicio).getTime() : null;
                const bDate = b.inicio ? new Date(b.inicio).getTime() : null;
                
                // Cursos sem data vão para o final
                if (aDate === null && bDate === null) {
                    // Ambos sem data - usar ordenação secundária
                } else if (aDate === null) {
                    return 1; // a (sem data) vai para o final
                } else if (bDate === null) {
                    return -1; // b (sem data) vai para o final
                } else {
                    // Ambos têm data - mais recente primeiro (ordem decrescente)
                    if (bDate !== aDate) {
                        return bDate - aDate;
                    }
                }
                
                // Ordenação secundária pelo campo selecionado
                let aVal = a[currentSort.field] || '';
                let bVal = b[currentSort.field] || '';
                
                if (currentSort.field === 'inicio' || currentSort.field === 'fim') {
                    aVal = aVal ? new Date(aVal).getTime() : 0;
                    bVal = bVal ? new Date(bVal).getTime() : 0;
                } else {
                    aVal = String(aVal).toLowerCase();
                    bVal = String(bVal).toLowerCase();
                }
                
                if (currentSort.direction === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });
        }
        
        // 6. Atalhos de Teclado
        function initializeKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Não processar se estiver digitando em input/textarea (exceto Esc e Ctrl+F)
                if ((e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') && 
                    !(e.key === 'Escape' || (e.ctrlKey && (e.key === 'f' || e.key === 'F')))) {
                    return;
                }
                
                // Ctrl+N: Novo curso
                if (e.ctrlKey && (e.key === 'n' || e.key === 'N')) {
                    e.preventDefault();
                    const btn = document.getElementById('newCourseBtn');
                    if (btn && !btn.disabled) {
                        btn.click();
                    }
                }
                
                
                // Esc: Fechar modais
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal-overlay.active').forEach(overlay => {
                        overlay.classList.remove('active');
                    });
                    const notificationsPanel = document.getElementById('notificationsPanel');
                    if (notificationsPanel) {
                        notificationsPanel.classList.remove('active');
                    }
                }
            });
        }
        
        // 7. Salvamento automático de alterações
        function initializeAutoSave() {
            // Salvar automaticamente ao detectar mudanças em formulários
            document.querySelectorAll('input, select, textarea').forEach(input => {
                input.addEventListener('change', () => {
                    // Salvar automaticamente após um pequeno delay
                    setTimeout(() => {
                        autoSaveChanges();
                    }, 500);
                });
            });
            
            // Salvar automaticamente ao sair da página
            window.addEventListener('beforeunload', () => {
                saveAllChanges();
            });
        }
        
        function autoSaveChanges() {
            // Salvar dados atuais automaticamente
            if (firebaseAvailable) {
                // Firebase salva automaticamente via onSnapshot
                return;
            }
            
            // Salvar no localStorage
            try {
                if (cursos && cursos.length > 0) {
                    localStorage.setItem('cursos', JSON.stringify(cursos));
                }
                if (instrutores && instrutores.length > 0) {
                    localStorage.setItem('instrutores', JSON.stringify(instrutores));
                }
                if (usuarios && usuarios.length > 0) {
                    localStorage.setItem('usuarios', JSON.stringify(usuarios));
                }
            } catch (error) {
                console.error('Erro ao salvar automaticamente:', error);
            }
        }
        
        function saveAllChanges() {
            // Salvar todas as alterações pendentes
            autoSaveChanges();
            
            // Se houver formulários abertos, salvá-los
            const courseForm = document.getElementById('courseForm');
            if (courseForm && courseForm.checkValidity()) {
                // Os formulários já são salvos ao submeter, então apenas garantimos que está tudo salvo
            }
        }
        
        // 8. Tooltips
        function initializeTooltips() {
            // Tooltips são adicionados via atributo title ou data-tooltip
            document.querySelectorAll('[data-tooltip]').forEach(el => {
                el.classList.add('tooltip');
                const tooltip = document.createElement('div');
                tooltip.className = 'tooltip-content';
                tooltip.textContent = el.dataset.tooltip;
                el.appendChild(tooltip);
            });
        }
        
        // 9. Estatísticas por Período
        
        // 10. Backup Automático
        function initializeBackup() {
            // Backup a cada 5 minutos
            backupInterval = setInterval(() => {
                performBackup();
            }, 5 * 60 * 1000);
            
            // Backup inicial
            performBackup();
        }
        
        function performBackup() {
            try {
                const backup = {
                    timestamp: new Date().toISOString(),
                    cursos: cursos,
                    instrutores: instrutores,
                    usuarios: usuarios,
                    loteNames: loteNames
                };
                
                localStorage.setItem('backup_' + Date.now(), JSON.stringify(backup));
                
                // Manter apenas os 10 backups mais recentes
                const backupKeys = Object.keys(localStorage)
                    .filter(k => k.startsWith('backup_'))
                    .sort()
                    .reverse();
                
                if (backupKeys.length > 10) {
                    backupKeys.slice(10).forEach(k => localStorage.removeItem(k));
                }
                
                console.log('Backup automático realizado');
            } catch (error) {
                console.error('Erro ao realizar backup:', error);
            }
        }
        
        // 11. Preview antes de importar
        function initializeImportPreview() {
            const excelInput = document.getElementById('excelFileInput');
            if (excelInput) {
                excelInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) {
                        console.log('Nenhum arquivo selecionado');
                        return;
                    }
                    
                    console.log('Arquivo selecionado:', file.name, file.type, file.size);
                    
                    // Validar tipo de arquivo
                    const validTypes = ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 
                                       'application/vnd.ms-excel',
                                       'application/excel'];
                    const validExtensions = ['.xlsx', '.xls'];
                    const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
                    
                    if (!validTypes.includes(file.type) && !validExtensions.includes(fileExtension)) {
                        showToast('Por favor, selecione um arquivo Excel (.xlsx ou .xls)', 'error');
                        excelInput.value = '';
                        return;
                    }
                    
                    // Validar tamanho (máximo 10MB)
                    if (file.size > 10 * 1024 * 1024) {
                        showToast('Arquivo muito grande. Tamanho máximo: 10MB', 'error');
                        excelInput.value = '';
                        return;
                    }
                    
                    const fileNameEl = document.getElementById('selectedFileName');
                    const fileInfoBox = document.getElementById('fileInfoBox');
                    if (fileNameEl) fileNameEl.textContent = file.name;
                    if (fileInfoBox) fileInfoBox.classList.add('show');
                    
                    try {
                        console.log('Lendo arquivo Excel...');
                        const data = await readExcelFile(file);
                        console.log('Dados lidos:', data.length, 'linhas');
                        if (data && data.length > 0) {
                            previewData = data;
                            showImportPreview(data);
                        } else {
                            showToast('Arquivo vazio ou sem dados válidos', 'warning');
                            if (fileInfoBox) fileInfoBox.classList.remove('show');
                            excelInput.value = '';
                        }
                    } catch (error) {
                        console.error('Erro ao ler arquivo:', error);
                        showToast('Erro ao ler arquivo Excel: ' + (error.message || 'Erro desconhecido'), 'error');
                        if (fileInfoBox) fileInfoBox.classList.remove('show');
                        excelInput.value = '';
                    }
                });
            } else {
                console.warn('Elemento excelFileInput não encontrado');
            }
            
            // Botão confirmar importação
            const confirmBtn = document.getElementById('confirmImportBtn');
            if (confirmBtn) {
                confirmBtn.addEventListener('click', async () => {
                    if (previewData && previewData.length > 0) {
                        await importPreviewData();
                    } else {
                        showToast('Nenhum dado para importar', 'warning');
                    }
                });
            }
            
            // Botão cancelar
            const cancelBtn = document.getElementById('cancelImportBtn');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', () => {
                    const preview = document.getElementById('importPreview');
                    if (preview) preview.style.display = 'none';
                    previewData = null;
                    const excelInput = document.getElementById('excelFileInput');
                    if (excelInput) excelInput.value = '';
                    const fileInfoBox = document.getElementById('fileInfoBox');
                    if (fileInfoBox) fileInfoBox.classList.remove('show');
                });
            }
        }
        
        async function readExcelFile(file) {
            // Verificar se a biblioteca XLSX está disponível
            if (typeof XLSX === 'undefined') {
                throw new Error('Biblioteca XLSX não está carregada. Por favor, recarregue a página.');
            }
            
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        if (!e.target || !e.target.result) {
                            reject(new Error('Erro ao ler arquivo: resultado vazio'));
                            return;
                        }
                        
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                            reject(new Error('Arquivo Excel não contém planilhas'));
                            return;
                        }
                        
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        
                        if (!worksheet) {
                            reject(new Error('Erro ao acessar planilha'));
                            return;
                        }
                        
                        const json = XLSX.utils.sheet_to_json(worksheet, { defval: '', raw: false });
                        
                        if (!json || json.length === 0) {
                            reject(new Error('Planilha vazia ou sem dados'));
                            return;
                        }
                        
                        console.log('Arquivo lido com sucesso:', json.length, 'linhas');
                        resolve(json);
                    } catch (error) {
                        console.error('Erro ao processar arquivo Excel:', error);
                        reject(new Error('Erro ao processar arquivo Excel: ' + (error.message || 'Erro desconhecido')));
                    }
                };
                reader.onerror = (error) => {
                    console.error('Erro ao ler arquivo:', error);
                    reject(new Error('Erro ao ler arquivo: ' + (error.message || 'Erro desconhecido')));
                };
                reader.readAsArrayBuffer(file);
            });
        }
        
        function showImportPreview(data) {
            const preview = document.getElementById('importPreview');
            const container = document.getElementById('previewTableContainer');
            
            if (!preview) {
                console.error('Elemento importPreview não encontrado');
                return;
            }
            
            if (!container) {
                console.error('Elemento previewTableContainer não encontrado');
                return;
            }
            
            if (!data || data.length === 0) {
                container.innerHTML = '<p style="padding: 1rem; color: var(--text-muted);">Nenhum dado encontrado no arquivo</p>';
                preview.style.display = 'block';
                return;
            }
            
            console.log('Exibindo preview de', data.length, 'registros');
            
            // Mostrar primeiras 10 linhas
            const previewData = data.slice(0, 10);
            const headers = Object.keys(previewData[0] || {});
            
            if (headers.length === 0) {
                container.innerHTML = '<p style="padding: 1rem; color: var(--text-muted);">Nenhuma coluna encontrada nos dados</p>';
                preview.style.display = 'block';
                return;
            }
            
            let html = `
                <p style="margin-bottom: 1rem; color: var(--text-secondary);">
                    Mostrando ${previewData.length} de ${data.length} registros
                </p>
                <div style="overflow-x: auto; max-height: 400px;">
                    <table class="preview-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--surface);">
                                ${headers.map(h => `<th style="padding: 0.5rem; border: 1px solid var(--border); text-align: left;">${h}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${previewData.map(row => `
                                <tr>
                                    ${headers.map(h => `<td style="padding: 0.5rem; border: 1px solid var(--border);">${row[h] !== undefined && row[h] !== null ? String(row[h]) : ''}</td>`).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
            preview.style.display = 'block';
            console.log('Preview exibido com sucesso');
        }
        
        async function importPreviewData() {
            if (!previewData || previewData.length === 0) {
                showToast('Nenhum dado para importar', 'warning');
                return;
            }
            
            const preview = document.getElementById('importPreview');
            if (preview) preview.style.display = 'none';
            
            try {
                await processExcelData(previewData);
                previewData = null;
                
                // Limpar o input de arquivo após importação bem-sucedida
                const excelInput = document.getElementById('excelFileInput');
                if (excelInput) excelInput.value = '';
                const fileInfoBox = document.getElementById('fileInfoBox');
                if (fileInfoBox) fileInfoBox.classList.remove('show');
            } catch (error) {
                console.error('Erro ao importar dados:', error);
                showToast('Erro ao importar dados: ' + (error.message || 'Erro desconhecido'), 'error');
            }
        }
        
        async function processExcelData(json) {
            if (!json || json.length === 0) {
                showToast('Nenhum dado para processar', 'warning');
                return;
            }
            
            setLoadingState(true);
            try {
                let imported = 0;
                let errors = [];
                
                console.log('Processando', json.length, 'linhas de dados');
                
                // Reutilizar a lógica de handleExcelUpload
                const batchSize = 10;
                for (let i = 0; i < json.length; i += batchSize) {
                    const batch = json.slice(i, i + batchSize);
                    
                    for (const row of batch) {
                        try {
                            // Reutilizar a mesma lógica de processamento de handleExcelUpload
                            // (copiar a lógica de processamento de linha)
                            const loteValue = row['LOTE'] || row['lote'] || row['Lote'] || row['LOTE-RESPONSÁVEL'] || row['lote-responsavel'] || '';
                            
                            // Função auxiliar para obter valor da coluna
                            function getColumnValue(row, variations) {
                                // Primeiro, tentar variações exatas
                                for (const variation of variations) {
                                    if (row[variation] !== undefined && row[variation] !== null && row[variation] !== '') {
                                        const value = row[variation];
                                        if (value instanceof Date) {
                                            const year = value.getFullYear();
                                            const month = String(value.getMonth() + 1).padStart(2, '0');
                                            const day = String(value.getDate()).padStart(2, '0');
                                            return `${year}-${month}-${day}`;
                                        }
                                        return String(value).trim();
                                    }
                                }
                                
                                // Tentar busca case-insensitive
                                const rowKeys = Object.keys(row);
                                for (const variation of variations) {
                                    const variationLower = variation.toLowerCase().trim();
                                    for (const key of rowKeys) {
                                        if (key.toLowerCase().trim() === variationLower) {
                                            const value = row[key];
                                            if (value !== undefined && value !== null && value !== '') {
                                                if (value instanceof Date) {
                                                    const year = value.getFullYear();
                                                    const month = String(value.getMonth() + 1).padStart(2, '0');
                                                    const day = String(value.getDate()).padStart(2, '0');
                                                    return `${year}-${month}-${day}`;
                                                }
                                                return String(value).trim();
                                            }
                                        }
                                    }
                                }
                                
                                return '';
                            }
                            
                            const endereco = getColumnValue(row, [
                                'ENDEREÇO', 'ENDERECO', 'endereço', 'endereco',
                                'LOCAL DO CURSO', 'local do curso', 'Local do Curso',
                                'LOCAL', 'local', 'Local'
                            ]) || '';
                            
                            const courseData = {
                                curso: getColumnValue(row, ['CURSO', 'curso', 'Curso', 'NOME', 'nome']) || '',
                                idLote: parseInt(getColumnValue(row, ['ID', 'id', 'Id', 'ID POR LOTE', 'id por lote']) || '0') || 0,
                                lote: loteValue,
                                loteResponsavel: loteValue,
                                cidade: getColumnValue(row, ['CIDADE', 'cidade', 'Cidade']) || '',
                                inicio: (() => {
                                    const dateValue = getColumnValue(row, [
                                        'DATA INÍCIO', 'DATA INICIO', 'data início', 'data inicio', 
                                        'INÍCIO', 'inicio', 'INICIO', 'Data Início', 'Data Inicio'
                                    ]);
                                    return formatExcelDate(dateValue);
                                })(),
                                fim: (() => {
                                    const dateValue = getColumnValue(row, [
                                        'DATA FIM', 'data fim', 'FIM', 'fim', 'Data Fim'
                                    ]);
                                    return formatExcelDate(dateValue);
                                })(),
                                local: endereco,
                                status: normalizeStatus(getColumnValue(row, ['STATUS', 'status', 'Status']) || 'Pendente'),
                                alunos: parseInt(getColumnValue(row, ['CONCLUDENTES', 'concludentes', 'Concludentes']) || '0') || 0,
                                cargaHoraria: getColumnValue(row, [
                                    'CARGA HORÁRIA', 'carga horária', 'CARGA HORARIA', 'carga horaria',
                                    'Carga Horária', 'Carga Horaria'
                                ]) || '',
                                instrutor: getColumnValue(row, ['INSTRUTOR', 'instrutor', 'Instrutor']) || '',
                                telefone: getColumnValue(row, ['TELEFONE', 'telefone', 'Telefone']) || '',
                                driveLink: '',
                                nota: ''
                            };
                            
                            if (firebaseAvailable) {
                                await db.collection('cursos').add(courseData);
                            } else {
                                const newId = 'course_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                                courseData.id = newId;
                                const existingCourses = JSON.parse(localStorage.getItem('cursos') || '[]');
                                existingCourses.push(courseData);
                                localStorage.setItem('cursos', JSON.stringify(existingCourses));
                            }
                            
                            imported++;
                        } catch (error) {
                            errors.push(`Linha ${i + 1}: ${error.message}`);
                        }
                    }
                }
                
                // Atualizar dados
                if (firebaseAvailable) {
                    // Aguardar um pouco para garantir que os dados foram salvos
                    setTimeout(async () => {
                        await loadData();
                        // Atualizar filtros com os novos dados importados
                        updateLoteFilter();
                        updateCursoFilter();
                    }, 500);
                } else {
                    loadFromLocalStorage();
                    // Atualizar filtros com os novos dados importados
                    updateLoteFilter();
                    updateCursoFilter();
                }
                
                // Mostrar mensagem de sucesso
                let message = `${imported} curso${imported !== 1 ? 's' : ''} importado${imported !== 1 ? 's' : ''} com sucesso!`;
                if (errors.length > 0) {
                    message += ` (${errors.length} erro${errors.length !== 1 ? 's' : ''})`;
                }
                showToast(message, errors.length > 0 ? 'warning' : 'success');
                
                // Atualizar renderização
                requestAnimationFrame(() => {
                    updateKPIs();
                    renderCalendar();
                    renderDashboardReport();
                    if (document.getElementById('coursesPage')?.classList.contains('active')) {
                        renderCoursesByLote();
                    }
                });
            } catch (error) {
                console.error('Erro ao importar dados:', error);
                showToast('Erro ao importar dados: ' + (error.message || 'Erro desconhecido'), 'error');
            } finally {
                setLoadingState(false);
            }
        }
        
        
        // 13. Histórico de Alterações
        function initializeChangeHistory() {
            loadChangeHistory();
        }
        
        function addToChangeHistory(type, entity, changes) {
            const historyItem = {
                id: Date.now(),
                type, // 'create', 'update', 'delete'
                entity, // 'course', 'instructor', 'user'
                changes,
                user: currentUser?.username || 'Sistema',
                timestamp: new Date()
            };
            
            changeHistory.unshift(historyItem);
            if (changeHistory.length > 100) changeHistory.pop();
            
            saveChangeHistory();
        }
        
        function saveChangeHistory() {
            localStorage.setItem('changeHistory', JSON.stringify(changeHistory));
        }
        
        function loadChangeHistory() {
            const saved = localStorage.getItem('changeHistory');
            if (saved) {
                changeHistory = JSON.parse(saved).map(h => ({
                    ...h,
                    timestamp: new Date(h.timestamp)
                }));
            }
        }
        
        function renderChangeHistory() {
            const container = document.getElementById('changeHistoryContainer');
            if (!container) return;
            
            container.innerHTML = `
                <div class="history-timeline">
                    ${changeHistory.slice(0, 50).map(item => `
                        <div class="history-item">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <strong>${item.user}</strong> - ${getHistoryActionText(item.type)} ${item.entity}
                                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;">
                                        ${formatTimestamp(item.timestamp)}
                                    </div>
                                </div>
                            </div>
                            ${item.changes && Object.keys(item.changes).length > 0 ? `
                                <div class="history-changes">
                                    ${Object.entries(item.changes).map(([key, value]) => `
                                        <div class="history-change-item">
                                            <span>${key}:</span>
                                            ${value.old ? `<span class="history-change-old">${value.old}</span> → ` : ''}
                                            <span class="history-change-new">${value.new || value}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function getHistoryActionText(type) {
            const actions = {
                'create': 'criou',
                'update': 'atualizou',
                'delete': 'excluiu'
            };
            return actions[type] || type;
        }
        
        // Modificar renderCoursesByLote para usar filtros, ordenação e paginação
        const originalRenderCoursesByLote = window.renderCoursesByLote;
        window.renderCoursesByLote = function() {
            let coursesToRender = [...cursos];
            
            // Aplicar filtros
            coursesToRender = filterCourses(coursesToRender);
            
            // Aplicar ordenação
            coursesToRender = sortCourses(coursesToRender);
            
            // Atualizar contador
            
            // Aplicar paginação
            const totalItems = coursesToRender.length;
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            coursesToRender = coursesToRender.slice(startIndex, endIndex);
            
            // Renderizar paginação
            renderPagination(totalItems);
            
            // Chamar função original com cursos filtrados
            // (precisamos modificar a lógica para aceitar cursos pré-filtrados)
            // Por enquanto, vamos manter a lógica original mas aplicar os filtros
            if (originalRenderCoursesByLote) {
                // Salvar cursos filtrados temporariamente
                const originalCursos = cursos;
                cursos = coursesToRender;
                originalRenderCoursesByLote();
                cursos = originalCursos;
            }
        };
        
        // A função applyFilters já coleta os valores dos filtros, então não precisamos duplicar aqui

        // ========== MELHORIAS SOLICITADAS ==========

        // 1. Animações de loading mais elaboradas
        function showAdvancedLoading(message = 'Carregando...') {
            const overlay = document.createElement('div');
            overlay.className = 'loading-overlay';
            overlay.id = 'advancedLoading';
            overlay.innerHTML = `
                <div>
                    <div class="loading-spinner"></div>
                    <div class="loading-content">${message}</div>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        function hideAdvancedLoading() {
            const overlay = document.getElementById('advancedLoading');
            if (overlay) {
                overlay.style.opacity = '0';
                setTimeout(() => overlay.remove(), 300);
            }
        }

        // 2. Feedback visual em ações
        function showActionFeedback(message, type = 'success') {
            const feedback = document.createElement('div');
            feedback.className = 'action-feedback';
            feedback.style.background = type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--danger)' : 'var(--warning)';
            feedback.innerHTML = `
                <span class="material-icons">${type === 'success' ? 'check_circle' : type === 'error' ? 'error' : 'warning'}</span>
                <span>${message}</span>
            `;
            document.body.appendChild(feedback);
            setTimeout(() => {
                feedback.style.opacity = '0';
                setTimeout(() => feedback.remove(), 300);
            }, 3000);
        }

        // Funções de notificação removidas conforme solicitado

        // 4. Modo de visualização - Lista, grid e timeline
        let currentViewMode = 'grid'; // 'grid', 'list', 'timeline'

        function initializeViewModes() {
            const viewModeContainer = document.createElement('div');
            viewModeContainer.className = 'view-mode-selector';
            viewModeContainer.style.cssText = 'display: flex; gap: 8px; margin-bottom: 1rem; align-items: center;';
            viewModeContainer.innerHTML = `
                <span style="margin-right: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">Visualização:</span>
                <button class="view-mode-btn ${currentViewMode === 'grid' ? 'active' : ''}" data-mode="grid" title="Grid">
                    <span class="material-icons">grid_view</span>
                </button>
                <button class="view-mode-btn ${currentViewMode === 'list' ? 'active' : ''}" data-mode="list" title="Lista">
                    <span class="material-icons">view_list</span>
                </button>
                <button class="view-mode-btn ${currentViewMode === 'timeline' ? 'active' : ''}" data-mode="timeline" title="Timeline">
                    <span class="material-icons">timeline</span>
                </button>
            `;

            // Adicionar estilos para os botões
            if (!document.getElementById('viewModeStyles')) {
                const style = document.createElement('style');
                style.id = 'viewModeStyles';
                style.textContent = `
                    .view-mode-btn {
                        padding: 8px 12px;
                        background: var(--surface);
                        border: 1px solid var(--border);
                        border-radius: 8px;
                        color: var(--text-secondary);
                        cursor: pointer;
                        transition: all 0.3s ease;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                    .view-mode-btn:hover {
                        background: var(--surface-hover);
                        color: var(--text-primary);
                    }
                    .view-mode-btn.active {
                        background: var(--primary);
                        color: white;
                        border-color: var(--primary);
                    }
                `;
                document.head.appendChild(style);
            }

            const coursesPage = document.getElementById('coursesPage');
            if (coursesPage) {
                const header = coursesPage.querySelector('.page-header');
                if (header && !header.querySelector('.view-mode-selector')) {
                    header.appendChild(viewModeContainer);
                }
            }

            viewModeContainer.querySelectorAll('.view-mode-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentViewMode = btn.dataset.mode;
                    viewModeContainer.querySelectorAll('.view-mode-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    localStorage.setItem('viewMode', currentViewMode);
                    renderCoursesByLote();
                });
            });

            // Carregar modo salvo
            const savedMode = localStorage.getItem('viewMode');
            if (savedMode && ['grid', 'list', 'timeline'].includes(savedMode)) {
                currentViewMode = savedMode;
                viewModeContainer.querySelectorAll('.view-mode-btn').forEach(b => {
                    b.classList.toggle('active', b.dataset.mode === currentViewMode);
                });
            }
        }

        // 5. Integração com WhatsApp
        function sendWhatsAppMessage(phone, message) {
            const cleanPhone = phone.replace(/\D/g, '');
            const url = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }

        function openWhatsAppForCourse(courseId) {
            const course = cursos.find(c => c.id === courseId);
            if (!course || !course.instrutor) {
                showToast('Instrutor não encontrado ou sem telefone', 'error');
                return;
            }
            
            const instructor = instrutores.find(i => i.nome === course.instrutor);
            if (!instructor || !instructor.telefone) {
                showToast('Telefone do instrutor não encontrado', 'error');
                return;
            }

            const message = `Olá ${instructor.nome}! Gostaria de falar sobre o curso: ${course.curso}`;
            sendWhatsAppMessage(instructor.telefone, message);
        }

        // 6. Backup e restauração - Interface para gerenciar backups
        function initializeBackupManager() {
            // Apenas admins podem ver backup e restauração
            if (currentUser?.role !== 'admin') return;
            
            // Verificar se já existe
            if (document.getElementById('backupRestoreCard')) return;
            
            const backupSection = document.createElement('div');
            backupSection.className = 'settings-option-card';
            backupSection.id = 'backupRestoreCard';
            backupSection.innerHTML = `
                <div class="settings-option-header">
                    <div class="settings-option-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                        <span class="material-icons">backup</span>
                    </div>
                    <div class="settings-option-info">
                        <h4>Backup e Restauração</h4>
                        <p>Gerencie backups do sistema</p>
                    </div>
                </div>
                <div class="backup-buttons" style="display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap;">
                    <button class="btn btn-primary btn-sm" onclick="createManualBackup()">
                        <span class="material-icons">save</span>
                        Criar Backup
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="showBackupList()">
                        <span class="material-icons">history</span>
                        Ver Backups
                    </button>
                </div>
            `;

            // Adicionar na seção de dados (section-data)
            const dataSection = document.getElementById('section-data');
            if (dataSection) {
                dataSection.appendChild(backupSection);
            }
        }

        function createManualBackup() {
            const backup = {
                timestamp: new Date().toISOString(),
                cursos: cursos,
                instrutores: instrutores,
                usuarios: usuarios,
                loteNames: loteNames
            };
            
            const backupKey = 'manual_backup_' + Date.now();
            localStorage.setItem(backupKey, JSON.stringify(backup));
            showActionFeedback('Backup criado com sucesso!', 'success');
        }

        function showBackupList() {
            const backups = Object.keys(localStorage)
                .filter(k => k.startsWith('backup_') || k.startsWith('manual_backup_'))
                .map(k => ({
                    key: k,
                    data: JSON.parse(localStorage.getItem(k))
                }))
                .sort((a, b) => new Date(b.data.timestamp) - new Date(a.data.timestamp));

            // Criar modal para listar backups
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.innerHTML = `
                <div class="modal" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3>Backups Disponíveis</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                            <span class="material-icons">close</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="backup-list">
                            ${backups.map(backup => `
                                <div class="backup-item" style="padding: 1rem; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 1rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>${new Date(backup.data.timestamp).toLocaleString('pt-BR')}</strong>
                                            <p style="margin: 0.5rem 0 0 0; color: var(--text-muted); font-size: 0.875rem;">
                                                ${backup.data.cursos?.length || 0} cursos, ${backup.data.instrutores?.length || 0} instrutores
                                            </p>
                                        </div>
                                        <button class="btn btn-primary" onclick="restoreBackup('${backup.key}')">
                                            <span class="material-icons">restore</span>
                                            Restaurar
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function restoreBackup(backupKey) {
            if (!confirm('Tem certeza que deseja restaurar este backup? Todos os dados atuais serão substituídos.')) return;
            
            const backup = JSON.parse(localStorage.getItem(backupKey));
            if (backup) {
                cursos = backup.cursos || [];
                instrutores = backup.instrutores || [];
                usuarios = backup.usuarios || usuarios;
                loteNames = backup.loteNames || {};
                
                saveAllChanges();
                loadData();
                showActionFeedback('Backup restaurado com sucesso!', 'success');
                document.querySelector('.modal-overlay.active')?.remove();
            }
        }

        // 7. Auditoria - Log detalhado
        function logAuditAction(action, details, type = 'info') {
            const auditLog = {
                timestamp: new Date().toISOString(),
                user: currentUser?.name || 'Sistema',
                action: action,
                details: details,
                type: type
            };
            
            let auditLogs = JSON.parse(localStorage.getItem('auditLogs') || '[]');
            auditLogs.push(auditLog);
            
            // Manter apenas os últimos 1000 logs
            if (auditLogs.length > 1000) {
                auditLogs = auditLogs.slice(-1000);
            }
            
            localStorage.setItem('auditLogs', JSON.stringify(auditLogs));
        }

        function showAuditReport() {
            const auditLogs = JSON.parse(localStorage.getItem('auditLogs') || '[]');
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.innerHTML = `
                <div class="modal" style="max-width: 1000px; max-height: 90vh;">
                    <div class="modal-header">
                        <h3>Relatório de Auditoria</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                            <span class="material-icons">close</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div style="overflow-y: auto; max-height: 70vh;">
                            ${auditLogs.slice().reverse().map(log => `
                                <div class="audit-log-item" style="padding: 1rem; border-bottom: 1px solid var(--border);">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div>
                                            <strong>${log.action}</strong>
                                            <p style="margin: 0.5rem 0 0 0; color: var(--text-muted); font-size: 0.875rem;">
                                                ${log.details}
                                            </p>
                                            <p style="margin: 0.5rem 0 0 0; color: var(--text-muted); font-size: 0.75rem;">
                                                Por: ${log.user} - ${new Date(log.timestamp).toLocaleString('pt-BR')}
                                            </p>
                                        </div>
                                        <span class="status-badge ${log.type}" style="font-size: 0.7rem;">${log.type}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // 8. PWA - Service Worker e Manifest
        if ('serviceWorker' in navigator && window.location.protocol !== 'file:') {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(() => {
                    // Service worker não disponível, continuar normalmente
                });
            });
        }

        // 9. Gestos no mobile - Swipe para ações (movido para initializeSwipeGestures principal)


        // 11. Integração com calendário - Lembretes automáticos
        function initializeCalendarIntegration() {
            // Configurar lembretes automáticos
            setupAutomaticReminders();
        }

        function setupAutomaticReminders() {
            // Verificar cursos próximos do vencimento diariamente
            setInterval(() => {
                const today = new Date();
                const nextWeek = new Date(today);
                nextWeek.setDate(today.getDate() + 7);

                const upcomingCourses = cursos.filter(course => {
                    if (!course.fim) return false;
                    const endDate = new Date(course.fim);
                    return endDate >= today && endDate <= nextWeek && normalizeStatus(course.status) !== 'Concluído';
                });

                if (upcomingCourses.length > 0) {
                    // Criar notificação
                    if ('Notification' in window && Notification.permission === 'granted') {
                        new Notification(`Cursos Próximos do Vencimento`, {
                            body: `${upcomingCourses.length} curso(s) vence(m) nos próximos 7 dias`,
                            icon: '/icon.png',
                            tag: 'course-reminder'
                        });
                    }
                }
            }, 24 * 60 * 60 * 1000); // Verificar uma vez por dia

            // Solicitar permissão para notificações
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        // Inicializar todas as melhorias
        setTimeout(() => {
            initializeViewModes();
            initializeBackupManager();
            initializeSwipeGestures();
            initializeCalendarIntegration();
            initializeSecurityFeatures();
            initializeUndoRedo();
            initializeEnhancedKeyboardShortcuts();
        }, 1000);

        // ==================== SEGURANÇA ====================

        function initializeSecurityFeatures() {
            // Inicializar 2FA inputs
            initialize2FAInputs();
            
            // Mostrar onboarding se for primeiro acesso
            if (currentUser && !hasSeenOnboarding) {
                setTimeout(() => showOnboarding(), 1000);
            }
        }

        // 2FA Functions
        function initialize2FAInputs() {
            const inputs = document.querySelectorAll('.code-input');
            inputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    if (e.target.value.length === 1) {
                        const next = inputs[index + 1];
                        if (next) next.focus();
                    }
                });
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value) {
                        const prev = inputs[index - 1];
                        if (prev) prev.focus();
                    }
                });
                
                // Permitir colar código completo
                input.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const paste = e.clipboardData.getData('text').replace(/\D/g, '').slice(0, 6);
                    paste.split('').forEach((char, i) => {
                        if (inputs[i]) inputs[i].value = char;
                    });
                    if (inputs[paste.length - 1]) inputs[paste.length - 1].focus();
                });
            });
        }

        function show2FAModal() {
            openModal('twofaModal');
            document.querySelector('.code-input')?.focus();
        }

        function verify2FACode() {
            const inputs = document.querySelectorAll('.code-input');
            const code = Array.from(inputs).map(i => i.value).join('');
            
            if (code.length !== 6) {
                showToast('Digite o código completo de 6 dígitos', 'error');
                return;
            }
            
            // Simular verificação (em produção, verificar no servidor)
            // Para demo, aceitar qualquer código de 6 dígitos
            showToast('Código verificado com sucesso!', 'success');
            closeModal('twofaModal');
            inputs.forEach(i => i.value = '');
        }

        // Audit Logs
        function addAuditLog(action, entity, entityId, details, oldData = null, newData = null) {
            const log = {
                id: Date.now().toString(),
                timestamp: new Date().toISOString(),
                user: currentUser?.name || 'Sistema',
                userId: currentUser?.id || null,
                action: action, // create, update, delete, login, logout
                entity: entity, // course, instructor, user, session
                entityId: entityId,
                details: details,
                oldData: oldData,
                newData: newData
            };
            
            auditLogs.unshift(log);
            
            // Manter apenas os últimos 500 logs
            if (auditLogs.length > 500) {
                auditLogs = auditLogs.slice(0, 500);
            }
            
            localStorage.setItem('auditLogs', JSON.stringify(auditLogs));
        }

        function showAuditLogs() {
            renderAuditLogs();
            openModal('auditLogsModal');
        }

        function renderAuditLogs() {
            const tbody = document.getElementById('auditLogsBody');
            if (!tbody) return;
            
            const filterAction = document.getElementById('auditFilterAction')?.value || '';
            const filterUser = document.getElementById('auditFilterUser')?.value || '';
            const filterDate = document.getElementById('auditFilterDate')?.value || '';
            
            let filteredLogs = auditLogs || [];
            
            if (filterAction) {
                filteredLogs = filteredLogs.filter(l => l.action === filterAction);
            }
            if (filterUser) {
                filteredLogs = filteredLogs.filter(l => l.userId === filterUser);
            }
            if (filterDate) {
                filteredLogs = filteredLogs.filter(l => l.timestamp && l.timestamp.startsWith(filterDate));
            }
            
            if (filteredLogs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                            <span class="material-icons" style="font-size: 48px; display: block; margin-bottom: 1rem;">history</span>
                            Nenhum log de auditoria encontrado.<br>
                            <small>As ações realizadas no sistema serão registradas aqui.</small>
                        </td>
                    </tr>
                `;
                return;
            }
            
            const actionLabels = {
                create: 'Criação',
                update: 'Atualização',
                delete: 'Exclusão',
                login: 'Login',
                logout: 'Logout'
            };
            
            const entityLabels = {
                course: 'Curso',
                instructor: 'Instrutor',
                user: 'Usuário',
                session: 'Sessão'
            };
            
            tbody.innerHTML = filteredLogs.slice(0, 100).map(log => {
                return `
                    <tr>
                        <td>${new Date(log.timestamp).toLocaleString('pt-BR')}</td>
                        <td>${log.user || 'Sistema'}</td>
                        <td><span class="audit-action ${log.action}">${actionLabels[log.action] || log.action}</span></td>
                        <td>${entityLabels[log.entity] || log.entity}</td>
                        <td>${log.details || '-'}</td>
                    </tr>
                `;
            }).join('');
            
            // Preencher filtro de usuários
            const userSelect = document.getElementById('auditFilterUser');
            if (userSelect && userSelect.options.length <= 1) {
                const users = [...new Set(auditLogs.map(l => l.userId).filter(Boolean))];
                users.forEach(userId => {
                    const user = usuarios.find(u => u.id === userId) || auditLogs.find(l => l.userId === userId);
                    if (user) {
                        const option = document.createElement('option');
                        option.value = userId;
                        option.textContent = user.name || user.user;
                        userSelect.appendChild(option);
                    }
                });
            }
        }

        // Permissions Manager
        const defaultPermissions = [
            { id: 'view_courses', name: 'Visualizar Cursos', desc: 'Ver lista de cursos', icon: 'visibility' },
            { id: 'edit_courses', name: 'Editar Cursos', desc: 'Criar e editar cursos', icon: 'edit' },
            { id: 'delete_courses', name: 'Excluir Cursos', desc: 'Remover cursos do sistema', icon: 'delete' },
            { id: 'view_instructors', name: 'Visualizar Instrutores', desc: 'Ver lista de instrutores', icon: 'people' },
            { id: 'edit_instructors', name: 'Editar Instrutores', desc: 'Criar e editar instrutores', icon: 'person_add' },
            { id: 'export_data', name: 'Exportar Dados', desc: 'Exportar dados em CSV/Excel', icon: 'download' },
            { id: 'import_data', name: 'Importar Dados', desc: 'Importar dados de planilhas', icon: 'upload' },
            { id: 'manage_users', name: 'Gerenciar Usuários', desc: 'Criar e editar usuários', icon: 'manage_accounts' },
            { id: 'view_audit', name: 'Ver Auditoria', desc: 'Acessar logs de auditoria', icon: 'history' },
            { id: 'danger_zone', name: 'Zona de Perigo', desc: 'Limpar dados do sistema', icon: 'warning' }
        ];

        function showPermissionsModal() {
            renderPermissionsModal();
            openModal('permissionsModal');
        }

        function renderPermissionsModal() {
            const userSelect = document.getElementById('permissionUserSelect');
            const grid = document.getElementById('permissionsGrid');
            
            if (!userSelect || !grid) return;
            
            // Preencher select de usuários
            if (usuarios.length === 0) {
                userSelect.innerHTML = '<option value="">Nenhum usuário encontrado</option>';
                grid.innerHTML = '<p style="text-align: center; color: var(--text-muted);">Cadastre usuários primeiro.</p>';
                return;
            }
            
            userSelect.innerHTML = usuarios.map(u => 
                `<option value="${u.id}">${u.name} (${u.role})</option>`
            ).join('');
            
            // Renderizar permissões
            grid.innerHTML = defaultPermissions.map(perm => `
                <div class="permission-item">
                    <div class="permission-info">
                        <span class="material-icons">${perm.icon}</span>
                        <div>
                            <div class="permission-name">${perm.name}</div>
                            <div class="permission-desc">${perm.desc}</div>
                        </div>
                    </div>
                    <label class="permission-toggle">
                        <input type="checkbox" data-permission="${perm.id}">
                        <span class="slider"></span>
                    </label>
                </div>
            `).join('');
            
            // Carregar permissões do primeiro usuário
            if (userSelect.value) {
                loadUserPermissions(userSelect.value);
            }
            
            // Listener para mudança de usuário
            userSelect.onchange = () => loadUserPermissions(userSelect.value);
        }

        function loadUserPermissions(userId) {
            const user = usuarios.find(u => u.id === userId);
            if (!user) return;
            
            const permissions = user.permissions || getDefaultPermissionsForRole(user.role);
            
            document.querySelectorAll('[data-permission]').forEach(checkbox => {
                checkbox.checked = permissions.includes(checkbox.dataset.permission);
            });
        }

        function getDefaultPermissionsForRole(role) {
            switch (role) {
                case 'admin':
                    return defaultPermissions.map(p => p.id);
                case 'editor':
                    return ['view_courses', 'edit_courses', 'view_instructors', 'edit_instructors', 'export_data'];
                case 'viewer':
                    return ['view_courses', 'view_instructors'];
                default:
                    return [];
            }
        }

        function savePermissions() {
            const userId = document.getElementById('permissionUserSelect').value;
            const permissions = Array.from(document.querySelectorAll('[data-permission]:checked'))
                .map(cb => cb.dataset.permission);
            
            const userIndex = usuarios.findIndex(u => u.id === userId);
            if (userIndex !== -1) {
                usuarios[userIndex].permissions = permissions;
                
                if (firebaseAvailable) {
                    db.collection('usuarios').doc(userId).update({ permissions });
                } else {
                    localStorage.setItem('usuarios', JSON.stringify(usuarios));
                }
                
                addAuditLog('update', 'user', userId, `Permissões atualizadas para ${usuarios[userIndex].name}`);
                showToast('Permissões salvas com sucesso!', 'success');
                closeModal('permissionsModal');
            }
        }

        // ==================== ONBOARDING ====================
        let currentOnboardingStep = 1;
        const totalOnboardingSteps = 3;

        function showOnboarding() {
            document.getElementById('onboardingOverlay').classList.add('active');
            currentOnboardingStep = 1;
            updateOnboardingStep();
        }

        function updateOnboardingStep() {
            document.querySelectorAll('.onboarding-step').forEach(step => {
                step.classList.toggle('active', parseInt(step.dataset.step) === currentOnboardingStep);
            });
            
            document.querySelectorAll('.onboarding-dot').forEach(dot => {
                dot.classList.toggle('active', parseInt(dot.dataset.step) === currentOnboardingStep);
            });
            
            const nextBtn = document.getElementById('nextOnboarding');
            if (currentOnboardingStep === totalOnboardingSteps) {
                nextBtn.innerHTML = '<span class="material-icons">check</span> Começar';
            } else {
                nextBtn.innerHTML = 'Próximo <span class="material-icons">arrow_forward</span>';
            }
        }

        function nextOnboardingStep() {
            if (currentOnboardingStep < totalOnboardingSteps) {
                currentOnboardingStep++;
                updateOnboardingStep();
            } else {
                closeOnboarding();
            }
        }

        function closeOnboarding() {
            document.getElementById('onboardingOverlay').classList.remove('active');
            localStorage.setItem('hasSeenOnboarding', 'true');
            hasSeenOnboarding = true;
        }

        // Event listeners para onboarding
        document.getElementById('nextOnboarding')?.addEventListener('click', nextOnboardingStep);
        document.getElementById('skipOnboarding')?.addEventListener('click', closeOnboarding);

        // ==================== UNDO/REDO ====================
        const MAX_UNDO_STACK = 20;
        let undoToastTimeout = null;

        function initializeUndoRedo() {
            // Ctrl+Z para desfazer
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'z' && !e.shiftKey) {
                    e.preventDefault();
                    performUndo();
                }
                // Ctrl+Shift+Z ou Ctrl+Y para refazer
                if ((e.ctrlKey && e.shiftKey && e.key === 'z') || (e.ctrlKey && e.key === 'y')) {
                    e.preventDefault();
                    performRedo();
                }
            });
        }

        function pushToUndoStack(action) {
            undoStack.push(action);
            if (undoStack.length > MAX_UNDO_STACK) {
                undoStack.shift();
            }
            redoStack = []; // Limpar redo ao fazer nova ação
            showUndoToast(action.message);
        }

        function showUndoToast(message) {
            const toast = document.getElementById('undoToast');
            const msgEl = document.getElementById('undoMessage');
            if (!toast || !msgEl) return;
            
            msgEl.textContent = message;
            toast.classList.add('active');
            
            if (undoToastTimeout) clearTimeout(undoToastTimeout);
            undoToastTimeout = setTimeout(() => {
                toast.classList.remove('active');
            }, 5000);
        }

        function performUndo() {
            if (undoStack.length === 0) {
                showToast('Nada para desfazer', 'info');
                return;
            }
            
            const action = undoStack.pop();
            redoStack.push(action);
            
            switch (action.type) {
                case 'delete_course':
                    // Restaurar curso deletado
                    if (firebaseAvailable) {
                        db.collection('cursos').doc(action.data.id).set(action.data);
                    } else {
                        cursos.push(action.data);
                        localStorage.setItem('cursos', JSON.stringify(cursos));
                    }
                    renderCoursesByLote();
                    showToast('Curso restaurado!', 'success');
                    break;
                    
                case 'delete_instructor':
                    if (firebaseAvailable) {
                        db.collection('instrutores').doc(action.data.id).set(action.data);
                    } else {
                        instrutores.push(action.data);
                        localStorage.setItem('instrutores', JSON.stringify(instrutores));
                    }
                    renderInstructors();
                    showToast('Instrutor restaurado!', 'success');
                    break;
                    
                case 'update_course':
                    if (firebaseAvailable) {
                        db.collection('cursos').doc(action.oldData.id).set(action.oldData);
                    } else {
                        const idx = cursos.findIndex(c => c.id === action.oldData.id);
                        if (idx !== -1) cursos[idx] = action.oldData;
                        localStorage.setItem('cursos', JSON.stringify(cursos));
                    }
                    renderCoursesByLote();
                    showToast('Alteração desfeita!', 'success');
                    break;
                    
                case 'bulk_delete':
                    action.data.forEach(course => {
                        if (firebaseAvailable) {
                            db.collection('cursos').doc(course.id).set(course);
                        } else {
                            cursos.push(course);
                        }
                    });
                    if (!firebaseAvailable) {
                        localStorage.setItem('cursos', JSON.stringify(cursos));
                    }
                    renderCoursesByLote();
                    showToast(`${action.data.length} cursos restaurados!`, 'success');
                    break;
            }
            
            document.getElementById('undoToast')?.classList.remove('active');
            showShortcutIndicator('Ctrl+Z', 'Desfazer');
        }

        function performRedo() {
            if (redoStack.length === 0) {
                showToast('Nada para refazer', 'info');
                return;
            }
            
            const action = redoStack.pop();
            undoStack.push(action);
            
            switch (action.type) {
                case 'delete_course':
                    if (firebaseAvailable) {
                        db.collection('cursos').doc(action.data.id).delete();
                    } else {
                        cursos = cursos.filter(c => c.id !== action.data.id);
                        localStorage.setItem('cursos', JSON.stringify(cursos));
                    }
                    renderCoursesByLote();
                    showToast('Exclusão refeita', 'info');
                    break;
                    
                case 'delete_instructor':
                    if (firebaseAvailable) {
                        db.collection('instrutores').doc(action.data.id).delete();
                    } else {
                        instrutores = instrutores.filter(i => i.id !== action.data.id);
                        localStorage.setItem('instrutores', JSON.stringify(instrutores));
                    }
                    renderInstructors();
                    showToast('Exclusão refeita', 'info');
                    break;
            }
            
            showShortcutIndicator('Ctrl+Y', 'Refazer');
        }

        // ==================== GERENCIADOR DE CURSOS ====================
        
        // Campos padrão do formulário
        const defaultFormFields = [
            { id: 'curso', name: 'Nome do Curso', key: 'curso', icon: 'school', type: 'text', placeholder: 'Ex: Segurança do Trabalho', enabled: true, order: 1, isSystem: true },
            { id: 'idLote', name: 'ID', key: 'idLote', icon: 'tag', type: 'number', placeholder: 'Ex: 1001', enabled: true, order: 2, isSystem: true },
            { id: 'lote', name: 'LOTE', key: 'lote', icon: 'inventory_2', type: 'text', placeholder: 'Ex: Lote A', enabled: true, order: 3, isSystem: true },
            { id: 'cargaHoraria', name: 'Carga Horária', key: 'cargaHoraria', icon: 'schedule', type: 'select', options: ['20H', '40H', '60H'], enabled: true, order: 4, isSystem: true },
            { id: 'cidade', name: 'Cidade', key: 'cidade', icon: 'location_on', type: 'text', placeholder: 'Ex: Fortaleza', enabled: true, order: 5, isSystem: true },
            { id: 'local', name: 'Local/Endereço', key: 'local', icon: 'place', type: 'text', placeholder: 'Ex: Centro de Treinamento', enabled: true, order: 6, isSystem: true },
            { id: 'inicio', name: 'Data Início', key: 'inicio', icon: 'event', type: 'date', enabled: true, order: 7, isSystem: true },
            { id: 'fim', name: 'Data Fim', key: 'fim', icon: 'event', type: 'date', enabled: true, order: 8, isSystem: true },
            { id: 'status', name: 'Status', key: 'status', icon: 'flag', type: 'select', options: ['Pendente', 'Em Andamento', 'Concluído', 'Cancelado'], enabled: true, order: 9, isSystem: true },
            { id: 'concludentes', name: 'Concludentes', key: 'alunos', icon: 'groups', type: 'number', placeholder: '0', enabled: true, order: 10, isSystem: true },
            { id: 'instrutor', name: 'Instrutor', key: 'instrutor', icon: 'person', type: 'instructor', enabled: true, order: 11, isSystem: true },
            { id: 'driveLink', name: 'Link do Drive', key: 'driveLink', icon: 'link', type: 'url', placeholder: 'https://drive.google.com/...', enabled: true, order: 12, isSystem: true },
            { id: 'nota', name: 'Anotação', key: 'nota', icon: 'notes', type: 'textarea', placeholder: 'Digite uma anotação...', enabled: true, order: 13, isSystem: true }
        ];

        // Campos padrão dos cards
        const defaultCardFields = [
            { id: 'cidade', name: 'Cidade', key: 'cidade', icon: 'location_on', enabled: true, order: 1 },
            { id: 'periodo', name: 'Período', key: 'periodo', icon: 'event', enabled: true, order: 2, isComputed: true },
            { id: 'instrutor', name: 'Instrutor', key: 'instrutor', icon: 'person', enabled: true, order: 3 },
            { id: 'lote', name: 'Lote', key: 'lote', icon: 'inventory_2', enabled: true, order: 4 },
            { id: 'cargaHoraria', name: 'Carga Horária', key: 'cargaHoraria', icon: 'schedule', enabled: true, order: 5 },
            { id: 'concludentes', name: 'Concludentes', key: 'alunos', icon: 'groups', enabled: false, order: 6 },
            { id: 'local', name: 'Endereço', key: 'local', icon: 'place', enabled: false, order: 7 }
        ];

        // Ícones disponíveis para seleção
        const availableIcons = [
            'person', 'people', 'groups', 'location_on', 'place', 'map', 
            'event', 'calendar_today', 'schedule', 'access_time', 'timer',
            'phone', 'email', 'contact_phone', 'contacts',
            'school', 'menu_book', 'auto_stories', 'class',
            'inventory_2', 'category', 'label', 'bookmark', 'tag',
            'work', 'business', 'corporate_fare', 'apartment',
            'attach_money', 'payments', 'credit_card', 'monetization_on',
            'star', 'favorite', 'thumb_up', 'verified', 'flag',
            'info', 'description', 'notes', 'assignment', 'edit_note',
            'link', 'language', 'public', 'cloud',
            'folder', 'file_present', 'picture_as_pdf',
            'numbers', 'pin', 'confirmation_number', 'badge'
        ];

        // Estado
        let formFields = JSON.parse(localStorage.getItem('formFields')) || [...defaultFormFields];
        let cardFields = JSON.parse(localStorage.getItem('cardFields')) || [...defaultCardFields];
        let editingFieldId = null;
        let editingFormFieldId = null;
        let dragFieldItem = null;
        let currentManagerTab = 'form-manager';
        let currentSettingsSection = 'appearance';

        // Navegação entre seções de configurações
        function initSettingsNav() {
            document.querySelectorAll('.settings-nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const section = item.dataset.section;
                    switchSettingsSection(section);
                });
            });

            // Também atualizar seletores de cor de tema
            document.querySelectorAll('.theme-color-option').forEach(btn => {
                btn.addEventListener('click', () => {
                    const theme = btn.dataset.theme;
                    document.querySelectorAll('.theme-color-option').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    // Aplicar tema
                    document.querySelectorAll('.theme-color-btn').forEach(b => {
                        if (b.dataset.theme === theme) b.click();
                    });
                });
            });
        }

        function switchSettingsSection(sectionId) {
            currentSettingsSection = sectionId;
            
            // Atualizar nav
            document.querySelectorAll('.settings-nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.section === sectionId);
            });
            
            // Atualizar seção
            document.querySelectorAll('.settings-section').forEach(section => {
                section.classList.toggle('active', section.id === `section-${sectionId}`);
            });

            // Inicializar gerenciador se for a aba de cursos
            if (sectionId === 'courses') {
                initializeCourseManager();
            }
        }

        function toggleCustomColors() {
            const panel = document.getElementById('customColorsPanel');
            if (panel) {
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            }
        }

        // Inicializar navegação ao carregar
        document.addEventListener('DOMContentLoaded', () => {
            initSettingsNav();
        });

        // Alternar entre abas do gerenciador
        function switchManagerTab(tabId) {
            currentManagerTab = tabId;
            
            // Atualizar tabs (ambos os seletores para compatibilidade)
            document.querySelectorAll('.manager-tab, .settings-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabId);
            });
            
            // Atualizar conteúdo
            document.querySelectorAll('.manager-content').forEach(content => {
                content.classList.toggle('active', content.id === tabId);
            });

            // Renderizar conteúdo da aba
            if (tabId === 'form-manager') {
                renderFormFieldsList();
                renderFormPreview();
            } else {
                renderCardFieldsList();
                renderCardPreview();
            }
        }

        // ==================== GERENCIADOR DE FORMULÁRIO ====================

        function initializeCourseManager() {
            renderFormFieldsList();
            renderFormPreview();
            renderCardFieldsList();
            renderCardPreview();
            renderFormIconSelector();
            
            // Listener para mostrar/ocultar opções de select
            document.getElementById('formFieldType')?.addEventListener('change', function() {
                const optionsGroup = document.getElementById('selectOptionsGroup');
                if (optionsGroup) {
                    optionsGroup.style.display = this.value === 'select' ? 'block' : 'none';
                }
            });
        }

        function renderFormFieldsList() {
            const list = document.getElementById('formFieldsList');
            if (!list) return;

            const sortedFields = [...formFields].sort((a, b) => a.order - b.order);

            list.innerHTML = sortedFields.map(field => `
                <div class="manager-field-item ${field.isSystem ? 'system-field' : ''}" 
                     draggable="true" data-field-id="${field.id}"
                     ondragstart="handleFormFieldDragStart(event)" 
                     ondragend="handleFormFieldDragEnd(event)"
                     ondragover="handleFormFieldDragOver(event)"
                     ondrop="handleFormFieldDrop(event)">
                    <div class="manager-field-drag">
                        <span class="material-icons">drag_indicator</span>
                    </div>
                    <div class="manager-field-icon">
                        <span class="material-icons">${field.icon}</span>
                    </div>
                    <div class="manager-field-info">
                        <div class="manager-field-name">
                            ${field.name}
                            ${field.isSystem ? '<span class="system-badge">Sistema</span>' : ''}
                        </div>
                        <div class="manager-field-type">${getFieldTypeName(field.type)}</div>
                    </div>
                    <div class="manager-field-actions">
                        <label class="manager-field-toggle">
                            <input type="checkbox" ${field.enabled ? 'checked' : ''} 
                                   onchange="toggleFormFieldEnabled('${field.id}', this.checked)">
                            <span class="slider"></span>
                        </label>
                        <button class="manager-field-btn" onclick="openEditFormFieldModal('${field.id}')" title="Editar">
                            <span class="material-icons">edit</span>
                        </button>
                        ${!field.isSystem ? `
                            <button class="manager-field-btn delete" onclick="deleteFormField('${field.id}')" title="Excluir">
                                <span class="material-icons">delete</span>
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function getFieldTypeName(type) {
            const types = {
                'text': 'Texto',
                'number': 'Número',
                'date': 'Data',
                'select': 'Seleção',
                'textarea': 'Área de Texto',
                'url': 'URL/Link',
                'instructor': 'Instrutor'
            };
            return types[type] || type;
        }

        function renderFormPreview() {
            const preview = document.getElementById('formPreviewBody');
            if (!preview) return;

            const enabledFields = formFields
                .filter(f => f.enabled)
                .sort((a, b) => a.order - b.order);

            let html = '';
            let i = 0;
            
            while (i < enabledFields.length) {
                const field = enabledFields[i];
                const nextField = enabledFields[i + 1];
                
                // Agrupar campos pequenos em pares
                const isSmallField = ['number', 'date'].includes(field.type);
                const nextIsSmallField = nextField && ['number', 'date'].includes(nextField.type);
                
                if (isSmallField && nextIsSmallField) {
                    html += `
                        <div class="form-preview-field-row">
                            ${renderPreviewField(field)}
                            ${renderPreviewField(nextField)}
                        </div>
                    `;
                    i += 2;
                } else {
                    html += renderPreviewField(field);
                    i++;
                }
            }

            preview.innerHTML = html || '<p style="color: var(--text-muted); text-align: center;">Nenhum campo ativo</p>';
        }

        function renderPreviewField(field) {
            let inputHtml = '';
            
            switch (field.type) {
                case 'select':
                    inputHtml = `<div class="preview-input">▼ Selecione...</div>`;
                    break;
                case 'textarea':
                    inputHtml = `<div class="preview-input" style="height: 60px;">${field.placeholder || ''}</div>`;
                    break;
                case 'instructor':
                    inputHtml = `<div class="preview-input">▼ Selecione instrutor</div>`;
                    break;
                default:
                    inputHtml = `<div class="preview-input">${field.placeholder || ''}</div>`;
            }

            return `
                <div class="form-preview-field">
                    <label><span class="material-icons" style="font-size: 14px; vertical-align: middle; margin-right: 4px;">${field.icon}</span>${field.name}</label>
                    ${inputHtml}
                </div>
            `;
        }

        function renderFormIconSelector() {
            const selector = document.getElementById('formIconSelector');
            if (!selector) return;

            selector.innerHTML = availableIcons.map(icon => `
                <div class="icon-option" data-icon="${icon}" onclick="selectFormIcon('${icon}')">
                    <span class="material-icons">${icon}</span>
                </div>
            `).join('');
        }

        function selectFormIcon(icon) {
            document.getElementById('formFieldIcon').value = icon;
            document.querySelectorAll('#formIconSelector .icon-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.icon === icon);
            });
        }

        function toggleFormFieldEnabled(fieldId, enabled) {
            const field = formFields.find(f => f.id === fieldId);
            if (field) {
                field.enabled = enabled;
                saveFormFields();
                renderFormPreview();
            }
        }

        function openAddFormFieldModal() {
            editingFormFieldId = null;
            document.getElementById('formFieldEditorTitle').innerHTML = '<span class="material-icons">add_circle</span> Novo Campo';
            document.getElementById('formFieldName').value = '';
            document.getElementById('formFieldKey').value = '';
            document.getElementById('formFieldType').value = 'text';
            document.getElementById('formFieldPlaceholder').value = '';
            document.getElementById('formFieldOptions').value = '';
            document.getElementById('formFieldIcon').value = 'info';
            document.getElementById('selectOptionsGroup').style.display = 'none';
            
            // Reset radio
            const radioAll = document.querySelector('input[name="applyTo"][value="all"]');
            if (radioAll) radioAll.checked = true;
            
            // Renderizar ícones e resetar seleção
            renderFormIconSelector();
            setTimeout(() => {
                document.querySelectorAll('#formIconSelector .icon-option').forEach(opt => {
                    opt.classList.toggle('selected', opt.dataset.icon === 'info');
                });
            }, 50);

            openModal('formFieldEditorModal');
        }

        function openEditFormFieldModal(fieldId) {
            const field = formFields.find(f => f.id === fieldId);
            if (!field) return;

            editingFormFieldId = fieldId;
            document.getElementById('formFieldEditorTitle').innerHTML = '<span class="material-icons">edit</span> Editar Campo';
            document.getElementById('formFieldName').value = field.name;
            document.getElementById('formFieldKey').value = field.key;
            document.getElementById('formFieldType').value = field.type || 'text';
            document.getElementById('formFieldPlaceholder').value = field.placeholder || '';
            document.getElementById('formFieldOptions').value = (field.options || []).join('\n');
            document.getElementById('formFieldIcon').value = field.icon;
            
            // Mostrar opções se for select
            document.getElementById('selectOptionsGroup').style.display = field.type === 'select' ? 'block' : 'none';

            // Renderizar ícones e setar seleção
            renderFormIconSelector();
            setTimeout(() => {
                document.querySelectorAll('#formIconSelector .icon-option').forEach(opt => {
                    opt.classList.toggle('selected', opt.dataset.icon === field.icon);
                });
            }, 50);

            openModal('formFieldEditorModal');
        }

        function saveFormField() {
            const name = document.getElementById('formFieldName').value.trim();
            const key = document.getElementById('formFieldKey').value.trim().replace(/\s+/g, '');
            const type = document.getElementById('formFieldType').value;
            const placeholder = document.getElementById('formFieldPlaceholder').value.trim();
            const optionsText = document.getElementById('formFieldOptions').value.trim();
            const icon = document.getElementById('formFieldIcon').value;
            const applyTo = document.querySelector('input[name="applyTo"]:checked').value;

            if (!name || !key) {
                showToast('Preencha o nome e a chave do campo', 'error');
                return;
            }

            // Verificar chave duplicada
            const existingField = formFields.find(f => f.key === key && f.id !== editingFormFieldId);
            if (existingField) {
                showToast('Já existe um campo com essa chave', 'error');
                return;
            }

            const options = type === 'select' ? optionsText.split('\n').filter(o => o.trim()) : [];

            if (editingFormFieldId) {
                // Editando campo existente
                const field = formFields.find(f => f.id === editingFormFieldId);
                if (field) {
                    field.name = name;
                    field.key = key;
                    field.type = type;
                    field.placeholder = placeholder;
                    field.options = options;
                    field.icon = icon;
                }
            } else {
                // Novo campo
                const newField = {
                    id: 'custom_' + Date.now(),
                    name: name,
                    key: key,
                    type: type,
                    placeholder: placeholder,
                    options: options,
                    icon: icon,
                    enabled: true,
                    order: formFields.length + 1,
                    isSystem: false
                };
                formFields.push(newField);

                // Também adicionar ao cardFields
                const newCardField = {
                    id: 'custom_' + Date.now(),
                    name: name,
                    key: key,
                    icon: icon,
                    enabled: true,
                    order: cardFields.length + 1
                };
                cardFields.push(newCardField);
                saveCardFields();
            }

            saveFormFields();
            renderFormFieldsList();
            renderFormPreview();
            renderCardFieldsList();
            renderCardPreview();
            closeModal('formFieldEditorModal');
            showToast(editingFormFieldId ? 'Campo atualizado!' : 'Campo adicionado!', 'success');
        }

        function deleteFormField(fieldId) {
            const field = formFields.find(f => f.id === fieldId);
            if (!field) return;
            
            if (field.isSystem) {
                showToast('Campos do sistema não podem ser excluídos', 'error');
                return;
            }

            if (!confirm(`Excluir o campo "${field.name}"?`)) return;

            formFields = formFields.filter(f => f.id !== fieldId);
            cardFields = cardFields.filter(f => f.key !== field.key);
            
            saveFormFields();
            saveCardFields();
            renderFormFieldsList();
            renderFormPreview();
            renderCardFieldsList();
            renderCardPreview();
            showToast('Campo excluído!', 'success');
        }

        function saveFormFields() {
            localStorage.setItem('formFields', JSON.stringify(formFields));
        }

        // Drag and drop para formulário
        function handleFormFieldDragStart(e) {
            dragFieldItem = e.target.closest('.manager-field-item');
            dragFieldItem.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleFormFieldDragEnd(e) {
            if (dragFieldItem) {
                dragFieldItem.classList.remove('dragging');
            }
            document.querySelectorAll('.manager-field-item').forEach(item => {
                item.classList.remove('drag-over');
            });
            dragFieldItem = null;
        }

        function handleFormFieldDragOver(e) {
            e.preventDefault();
            const item = e.target.closest('.manager-field-item');
            if (item && item !== dragFieldItem) {
                item.classList.add('drag-over');
            }
        }

        function handleFormFieldDrop(e) {
            e.preventDefault();
            const dropTarget = e.target.closest('.manager-field-item');
            if (!dropTarget || !dragFieldItem || dropTarget === dragFieldItem) return;

            dropTarget.classList.remove('drag-over');

            const dragId = dragFieldItem.dataset.fieldId;
            const dropId = dropTarget.dataset.fieldId;

            const dragField = formFields.find(f => f.id === dragId);
            const dropField = formFields.find(f => f.id === dropId);

            if (dragField && dropField) {
                const tempOrder = dragField.order;
                dragField.order = dropField.order;
                dropField.order = tempOrder;

                saveFormFields();
                renderFormFieldsList();
                renderFormPreview();
            }
        }

        // ==================== GERENCIADOR DE CARDS ====================

        function renderCardFieldsList() {
            const list = document.getElementById('cardFieldsList');
            if (!list) return;

            const sortedFields = [...cardFields].sort((a, b) => a.order - b.order);

            list.innerHTML = sortedFields.map(field => `
                <div class="manager-field-item" draggable="true" data-field-id="${field.id}"
                     ondragstart="handleCardFieldDragStart(event)" 
                     ondragend="handleCardFieldDragEnd(event)"
                     ondragover="handleCardFieldDragOver(event)"
                     ondrop="handleCardFieldDrop(event)">
                    <div class="manager-field-drag">
                        <span class="material-icons">drag_indicator</span>
                    </div>
                    <div class="manager-field-icon">
                        <span class="material-icons">${field.icon}</span>
                    </div>
                    <div class="manager-field-info">
                        <div class="manager-field-name">${field.name}</div>
                        <div class="manager-field-type">${field.key}</div>
                    </div>
                    <div class="manager-field-actions">
                        <label class="manager-field-toggle">
                            <input type="checkbox" ${field.enabled ? 'checked' : ''} 
                                   onchange="toggleCardFieldEnabled('${field.id}', this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            `).join('');
        }

        function renderCardPreview() {
            const preview = document.getElementById('cardPreview');
            if (!preview) return;

            const enabledFields = cardFields
                .filter(f => f.enabled)
                .sort((a, b) => a.order - b.order);

            const sampleData = {
                curso: 'Capacitação Profissional',
                idLote: '2024-001',
                cidade: 'Fortaleza',
                local: 'Av. Santos Dumont, 1500',
                instrutor: 'Maria Silva',
                lote: 'LOTE 15',
                inicio: '2024-01-15',
                fim: '2024-02-15',
                cargaHoraria: '40H',
                alunos: '25'
            };

            const getFieldValue = (field) => {
                if (field.key === 'periodo') {
                    return `15/01/2024 - 15/02/2024`;
                }
                return sampleData[field.key] || '-';
            };

            preview.innerHTML = `
                <div class="card-preview-header">
                    <div>
                        <div class="card-preview-course-name">${sampleData.curso}</div>
                        <div class="card-preview-course-id">ID: ${sampleData.idLote}</div>
                    </div>
                    <span class="card-preview-status">Concluído</span>
                </div>
                <div class="card-preview-fields">
                    ${enabledFields.map(field => `
                        <div class="card-preview-field">
                            <span class="material-icons">${field.icon}</span>
                            <span>${getFieldValue(field)}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function toggleCardFieldEnabled(fieldId, enabled) {
            const field = cardFields.find(f => f.id === fieldId);
            if (field) {
                field.enabled = enabled;
                saveCardFields();
                renderCardPreview();
            }
        }

        function saveCardFields() {
            localStorage.setItem('cardFields', JSON.stringify(cardFields));
        }

        // Drag and drop para cards
        function handleCardFieldDragStart(e) {
            dragFieldItem = e.target.closest('.manager-field-item');
            dragFieldItem.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleCardFieldDragEnd(e) {
            if (dragFieldItem) {
                dragFieldItem.classList.remove('dragging');
            }
            document.querySelectorAll('.manager-field-item').forEach(item => {
                item.classList.remove('drag-over');
            });
            dragFieldItem = null;
        }

        function handleCardFieldDragOver(e) {
            e.preventDefault();
            const item = e.target.closest('.manager-field-item');
            if (item && item !== dragFieldItem) {
                item.classList.add('drag-over');
            }
        }

        function handleCardFieldDrop(e) {
            e.preventDefault();
            const dropTarget = e.target.closest('.manager-field-item');
            if (!dropTarget || !dragFieldItem || dropTarget === dragFieldItem) return;

            dropTarget.classList.remove('drag-over');

            const dragId = dragFieldItem.dataset.fieldId;
            const dropId = dropTarget.dataset.fieldId;

            const dragField = cardFields.find(f => f.id === dragId);
            const dropField = cardFields.find(f => f.id === dropId);

            if (dragField && dropField) {
                const tempOrder = dragField.order;
                dragField.order = dropField.order;
                dropField.order = tempOrder;

                saveCardFields();
                renderCardFieldsList();
                renderCardPreview();
            }
        }

        // ==================== FUNÇÕES AUXILIARES ====================

        function getEnabledCardFields() {
            return cardFields
                .filter(f => f.enabled)
                .sort((a, b) => a.order - b.order);
        }

        function getEnabledFormFields() {
            return formFields
                .filter(f => f.enabled)
                .sort((a, b) => a.order - b.order);
        }

        // Inicializar quando abrir configurações
        function initializeCardFieldsCustomizer() {
            initializeCourseManager();
        }

        // Funções legadas mantidas para compatibilidade
        function renderIconSelector() {
            renderFormIconSelector();
        }

        function selectIcon(icon) {
            selectFormIcon(icon);
        }

        function openAddFieldModal() {
            openAddFormFieldModal();
        }

        function openEditFieldModal(fieldId) {
            openEditFormFieldModal(fieldId);
        }

        function saveField() {
            saveFormField();
        }

        function deleteField(fieldId) {
            deleteFormField(fieldId);
        }

        function toggleFieldEnabled(fieldId, enabled) {
            toggleCardFieldEnabled(fieldId, enabled);
        }

        function handleFieldDragStart(e) {
            handleCardFieldDragStart(e);
        }

        function handleFieldDragEnd(e) {
            handleCardFieldDragEnd(e);
        }

        function handleFieldDragOver(e) {
            handleCardFieldDragOver(e);
        }

        function handleFieldDrop(e) {
            handleCardFieldDrop(e);
        }

        // Inicializar quando a página de configurações for aberta
        setTimeout(() => {
            initializeCardFieldsCustomizer();
        }, 500);

        // Mapeamento de IDs do formulário para cada campo
        const fieldIdMap = {
            'curso': 'courseName',
            'idLote': 'courseIdLote',
            'lote': 'courseLote',
            'cargaHoraria': 'courseCargaHoraria',
            'cidade': 'courseCity',
            'local': 'courseLocation',
            'inicio': 'courseStart',
            'fim': 'courseEnd',
            'status': 'courseStatus',
            'concludentes': 'courseStudents',
            'instrutor': 'courseInstructor',
            'driveLink': 'courseDriveLink',
            'nota': 'courseNote'
        };

        // Renderizar formulário de curso dinamicamente
        function renderCourseFormFields() {
            const container = document.getElementById('courseFormBody');
            if (!container) return;

            // Obter campos ativos e ordenados
            const enabledFields = formFields
                .filter(f => f.enabled)
                .sort((a, b) => a.order - b.order);

            let html = '';

            enabledFields.forEach(field => {
                const inputId = fieldIdMap[field.id] || `customField_${field.key}`;
                const isCustom = !field.isSystem;
                
                html += renderFormFieldHTML(field, inputId, isCustom);
            });

            container.innerHTML = html;
            
            // Popular select de instrutores
            populateInstructorSelect();
        }

        function renderFormFieldHTML(field, inputId, isCustom) {
            let inputHtml = '';
            const dataAttr = isCustom ? `data-field-key="${field.key}"` : '';
            const customClass = isCustom ? 'custom-field-input' : '';
            
            switch (field.type) {
                case 'select':
                    if (field.id === 'status') {
                        inputHtml = `
                            <select class="form-select ${customClass}" id="${inputId}" ${dataAttr}>
                                <option value="Pendente">Pendente</option>
                                <option value="Em Andamento">Em Andamento</option>
                                <option value="Concluído">Concluído</option>
                                <option value="Cancelado">Cancelado</option>
                            </select>
                        `;
                    } else if (field.id === 'cargaHoraria') {
                        inputHtml = `
                            <select class="form-select ${customClass}" id="${inputId}" ${dataAttr}>
                                <option value="">Selecione a carga horária</option>
                                <option value="20H">20H</option>
                                <option value="40H">40H</option>
                                <option value="60H">60H</option>
                            </select>
                        `;
                    } else {
                        inputHtml = `
                            <select class="form-select ${customClass}" id="${inputId}" ${dataAttr}>
                                <option value="">Selecione...</option>
                                ${(field.options || []).map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                            </select>
                        `;
                    }
                    break;
                    
                case 'instructor':
                    inputHtml = `
                        <div style="display: flex; gap: 8px;">
                            <select class="form-select" id="${inputId}" style="flex: 1;">
                                <option value="">Selecione um instrutor</option>
                            </select>
                            <button type="button" class="btn btn-secondary btn-icon" onclick="openQuickInstructorModal()" title="Adicionar Instrutor">
                                <span class="material-icons">person_add</span>
                            </button>
                        </div>
                    `;
                    break;
                    
                case 'textarea':
                    inputHtml = `
                        <textarea class="form-input ${customClass}" id="${inputId}" ${dataAttr}
                                  placeholder="${field.placeholder || ''}" rows="3" style="resize: vertical;"></textarea>
                    `;
                    break;
                    
                case 'number':
                    inputHtml = `
                        <input type="number" class="form-input ${customClass}" id="${inputId}" ${dataAttr}
                               placeholder="${field.placeholder || ''}" min="0">
                    `;
                    break;
                    
                case 'date':
                    inputHtml = `
                        <input type="date" class="form-input ${customClass}" id="${inputId}" ${dataAttr}>
                    `;
                    break;
                    
                case 'url':
                    inputHtml = `
                        <input type="url" class="form-input ${customClass}" id="${inputId}" ${dataAttr}
                               placeholder="${field.placeholder || ''}">
                    `;
                    break;
                    
                default:
                    inputHtml = `
                        <input type="text" class="form-input ${customClass}" id="${inputId}" ${dataAttr}
                               placeholder="${field.placeholder || ''}">
                    `;
            }

            return `
                <div class="form-group">
                    <label class="form-label">
                        ${field.name} <span class="optional-label">(opcional)</span>
                    </label>
                    ${inputHtml}
                </div>
            `;
        }

        function populateInstructorSelect() {
            const select = document.getElementById('courseInstructor');
            if (!select) return;
            
            select.innerHTML = '<option value="">Selecione um instrutor</option>';
            instrutores.forEach(inst => {
                select.innerHTML += `<option value="${inst.nome}">${inst.nome}</option>`;
            });
        }

        // Função legada mantida para compatibilidade
        function renderCustomFieldsInModal() {
            // Agora integrado em renderCourseFormFields
        }

        // Coletar valores dos campos personalizados
        function getCustomFieldValues() {
            const values = {};
            document.querySelectorAll('.custom-field-input').forEach(input => {
                const key = input.dataset.fieldKey;
                const value = input.value.trim();
                if (key && value) {
                    values[key] = value;
                }
            });
            return values;
        }

        // Preencher campos personalizados ao editar curso
        function fillCustomFieldValues(course) {
            document.querySelectorAll('.custom-field-input').forEach(input => {
                const key = input.dataset.fieldKey;
                if (key && course[key]) {
                    input.value = course[key];
                } else {
                    input.value = '';
                }
            });
        }

        // Limpar campos personalizados
        function clearCustomFields() {
            document.querySelectorAll('.custom-field-input').forEach(input => {
                input.value = '';
            });
        }

        // ==================== ENHANCED KEYBOARD SHORTCUTS ====================
        function initializeEnhancedKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ignorar se estiver em input/textarea
                if (['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement?.tagName)) {
                    return;
                }
                
                // N - Novo curso
                if (e.key === 'n' && !e.ctrlKey && !e.altKey) {
                    e.preventDefault();
                    openCourseModal();
                    showShortcutIndicator('N', 'Novo Curso');
                }
                
                // I - Novo instrutor
                if (e.key === 'i' && !e.ctrlKey && !e.altKey) {
                    e.preventDefault();
                    openInstructorModal();
                    showShortcutIndicator('I', 'Novo Instrutor');
                }
                
                // / - Busca rápida
                if (e.key === '/' && !e.ctrlKey) {
                    e.preventDefault();
                    openGlobalSearch();
                    showShortcutIndicator('/', 'Buscar');
                }
                
                // ? - Mostrar atalhos
                if (e.key === '?' && e.shiftKey) {
                    e.preventDefault();
                    openModal('shortcutsModal');
                    showShortcutIndicator('?', 'Atalhos');
                }
                
                // H - Ir para home/dashboard
                if (e.key === 'h' && !e.ctrlKey) {
                    e.preventDefault();
                    navigateTo('dashboard');
                    showShortcutIndicator('H', 'Dashboard');
                }
                
                // R - Atualizar dados
                if (e.key === 'r' && !e.ctrlKey) {
                    e.preventDefault();
                    loadData();
                    showToast('Dados atualizados', 'success');
                    showShortcutIndicator('R', 'Atualizar');
                }
            });
        }

        function showShortcutIndicator(key, action) {
            const indicator = document.getElementById('shortcutIndicator');
            const keyEl = document.getElementById('shortcutKey');
            const actionEl = document.getElementById('shortcutAction');
            
            if (!indicator || !keyEl || !actionEl) return;
            
            keyEl.textContent = key;
            actionEl.textContent = action;
            indicator.classList.add('active');
            
            setTimeout(() => {
                indicator.classList.remove('active');
            }, 1500);
        }


        // Interceptar ações para auditoria
        const originalDeleteCourse = window.deleteCourse;
        window.deleteCourse = function(id) {
            const course = cursos.find(c => c.id === id);
            if (course) {
                logAuditAction('Exclusão de Curso', `Curso "${course.curso}" foi excluído`, 'danger');
            }
            return originalDeleteCourse.apply(this, arguments);
        };

        const originalSaveCourse = window.handleCourseSubmit;
        if (originalSaveCourse) {
            // Log será feito dentro da função original
        }
    </script>
</body>
</html>
